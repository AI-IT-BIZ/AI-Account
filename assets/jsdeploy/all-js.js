
Ext.define('Account.AP.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from AP No., Vendor or GR No.',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.AP.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"ap/loads",reader:{type:'json',root:'rows',idProperty:'invnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['invnr','bldat','mbeln','lifnr','name1','netwr','statx'],remoteSort:true,sorters:[{property:'invnr',direction:'ASC'}]});this.columns=[{text:"AP Doc",flex:true,dataIndex:'invnr',align:'center',sortable:true},{text:"AP Date",width:125,xtype:'datecolumn',align:'center',format:'d/m/Y',dataIndex:'bldat',sortable:true},{text:"GR Doc",flex:true,dataIndex:'mbeln',align:'center',sortable:true},{text:"Vendor Code",flex:true,dataIndex:'lifnr',align:'center',sortable:true},{text:"Vendor Name",flex:true,dataIndex:'name1',sortable:true},{text:"Net Amount",flex:true,xtype:'numbercolumn',align:'right',dataIndex:'netwr',sortable:true},{text:"AP Status",flex:true,dataIndex:'statx',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.AP.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'ap/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grDialog=Ext.create('Account.GR.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.vendorDialog=Ext.create('Account.SVendor.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.gridItem=Ext.create('Account.AP.Item.Grid_i',{height:320,region:'center'});this.gridGL=Ext.create('Account.AP.Item.Grid_gl',{border:true,region:'center',title:'GL Posting'});this.formTotal=Ext.create('Account.AP.Item.Form_t',{title:'AP Total',border:true,split:true,region:'south'});this.gridPrice=Ext.create('Account.AP.Item.Grid_pc',{border:true,split:true,title:'Item Pricing',region:'south'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('AP'),fieldLabel:'AP Status',name:'statu',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat Type',name:'taxnr',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select data --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payments',name:'ptype',width:280,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.hdnApItem=Ext.create('Ext.form.Hidden',{name:'ebrp',});this.hdnGlItem=Ext.create('Ext.form.Hidden',{name:'bven',});this.trigGR=Ext.create('Ext.form.field.Trigger',{name:'mbeln',fieldLabel:'GR No',labelAlign:'letf',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigVendor=Ext.create('Ext.form.field.Trigger',{name:'lifnr',fieldLabel:'Vendor Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',labelAlign:'right',width:170,hideTrigger:false,align:'right'});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:240,labelAlign:'right',allowBlank:false});this.numberVat=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Vat Value',name:'taxpr',labelAlign:'right',width:170,align:'right'});this.numberWHT=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'WHT Value',name:'whtpr',labelAlign:'right',width:170,align:'right'});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnApItem,this.hdnGlItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},{xtype:'hidden',name:'loekz'},this.trigGR,{xtype:'displayfield',width:290,allowBlank:true},{xtype:'displayfield',fieldLabel:'AP No',name:'invnr',value:'IPXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'container',flex:0,layout:'anchor',items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigVendor,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:160,allowBlank:true}]},{xtype:'textarea',fieldLabel:'Vendor Address',name:'adr01',width:450,rows:3,},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboPay,this.numberVat]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Reference No',width:280,name:'refnr',},this.numberWHT]}]},{xtype:'container',flex:0,layout:'anchor',margin:'0 0 0 70',items:[this.comboPtype,{xtype:'datefield',fieldLabel:'AP Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',},this.comboTax,this.trigCurrency,{xtype:'container',layout:'hbox',defaultType:'textfield',margin:'0 0 5 0',items:[this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:25,value:'Days'}]},{xtype:'datefield',fieldLabel:'Due Date',name:'duedt',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},this.comboQStatus]}]}]}]};this.items=[mainFormPanel,this.gridItem,{xtype:'tabpanel',region:'south',activeTab:0,height:195,items:[this.formTotal,this.gridPrice,this.gridGL]}];this.trigGR.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'gr/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.mbeln);_this.getForm().findField('lifnr').setValue(r.data.lifnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('loekz').setValue(r.data.loekz);}else{o.markInvalid('Could not find GR no : '+o.getValue());}}});}},this);_this.grDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigGR.setValue(record.data.mbeln);_this.getForm().findField('lifnr').setValue(record.data.lifnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.mbeln;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'gr/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('loekz').setValue(r.data.loekz);}}});grid.getSelectionModel().deselectAll();var grdgrnr=_this.trigGR.value;_this.gridItem.load({grdgrnr:grdgrnr});_this.grDialog.hide();});this.trigGR.onTriggerClick=function(){_this.grDialog.show();};this.trigVendor.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.vendorDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor.setValue(record.data.lifnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.lifnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}}});grid.getSelectionModel().deselectAll();_this.vendorDialog.hide();});this.trigVendor.onTriggerClick=function(){_this.vendorDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);_this.formTotal.getForm().findField('curr').setValue(r.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',r.data.ctype);});_this.gridItem.curValue=r.data.ctype;}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);_this.formTotal.getForm().findField('curr1').setValue(record.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',record.data.ctype);});_this.gridItem.curValue=record.data.ctype;grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.gridItem.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.gridItem.getSelectionModel().on('viewready',this.onViewReady,this);this.numberCredit.on('keyup',this.getDuedate,this);this.numberCredit.on('change',this.getDuedate,this);this.comboTax.on('change',this.calculateTotal,this);return this.callParent(arguments);},onSelectChange:function(selModel,selections){var _this=this;var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:this.comboTax.getValue()});}},onViewReady:function(grid){grid.getSelectionModel().select(0);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'ap/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnApItem.setValue(Ext.encode(rsItem));var rsGL=_this.gridGL.getData();this.hdnGlItem.setValue(Ext.encode(rsGL));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{invnr:invnr},url:__site_url+'ap/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({invnr:0});this.gridGL.load({netpr:0});this.comboQStatus.setValue('01');this.comboTax.setValue('01');this.trigCurrency.setValue('THB');this.numberVat.setValue(7);this.numberWHT.setValue(3);this.getForm().findField('bldat').setValue(new Date());this.getForm().findField('duedt').setValue(new Date());this.formTotal.getForm().findField('exchg').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=this.gridItem.store;var sum=0;var vats=0;sum2=0;var whts=0;var discounts=0;var saknr_list=[];var vattype=this.comboTax.getValue();store.each(function(r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']),discount=parseFloat(r.data['disit']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;discount=isNaN(discount)?0:discount;var amt=qty*price;if(vattype=='02'){amt=amt*100;amt=amt/107;}
sum+=amt;discounts+=discount;amt=amt-discount;sum2+=amt;if(r.data['chk01']==true){var vat=_this.numberVat.getValue();vat=(amt*vat)/100;vats+=vat;}
var item=r.data['saknr']+'|'+amt;saknr_list.push(item);if(r.data['chk02']==true){var wht=_this.numberWHT.getValue();wht=(amt*wht)/100;whts+=wht;}});this.formTotal.getForm().findField('beamt').setValue(sum);this.formTotal.getForm().findField('vat01').setValue(vats);this.formTotal.getForm().findField('wht01').setValue(whts);this.formTotal.getForm().findField('dismt').setValue(discounts);var net=this.formTotal.calculate();this.formTotal.taxType=this.comboTax.getValue();this.gridItem.vatValue=this.numberVat.getValue();var currency=this.trigCurrency.getValue();this.gridItem.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);this.gridItem.vendorValue=this.trigVendor.getValue();if(currency!='THB'){var rate=this.formTotal.getForm().findField('exchg').getValue();sum=sum*rate;sum2=sum2*rate;vats=vats*rate;whts=whts*rate;}
if(sum>0&&this.trigVendor.getValue()!=''){_this.gridGL.load({netpr:sum2,vvat:vats,lifnr:this.trigVendor.getValue(),items:saknr_list.join(',')});}
var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:this.comboTax.getValue()});}},getDuedate:function(){var bForm=this.getForm(),credit=this.numberCredit.getValue(),startDate=bForm.findField('bldat').getValue();if(!Ext.isEmpty(credit)&&credit>0){var result=Ext.Date.add(startDate,Ext.Date.DAY,credit),dueDateField=bForm.findField('duedt');if(!Ext.isEmpty(credit)&&!Ext.isEmpty(dueDateField))
dueDateField.setValue(result);}}});;Ext.define('Account.AP.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'ap/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',}});return this.callParent(arguments);},initComponent:function(){var _this=this;var myStorecomboWHTno=Ext.create('Ext.data.Store',{fields:['idWHT','name'],data:[{"idWHT":"01","name":"นิติบุคคล"},{"idWHT":"02","name":"บุคคลธรรมดา"}]});this.whtDialog=Ext.create('Account.WHT.Window');this.trigWHT=Ext.create('Ext.form.field.Trigger',{name:'whtnr',labelAlign:'letf',width:50,triggerCls:'x-form-search-trigger',enableKeyEvents:true,margin:'3 0 0 10'});this.comboWHType=Ext.create('Ext.form.ComboBox',{fieldLabel:'Witholding Tax',name:'whtyp',width:240,triggerAction:'all',clearFilterOnReset:true,emptyText:'--Select WHT Typ--',margin:'3 0 0 0',store:myStorecomboWHTno,labelAlign:'left',queryMode:'local',displayField:'name',valueField:'idWHT'});this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',xtype:'textfield',fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:150,width:270,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt',align:'right',width:270,labelWidth:150,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',name:'vat01',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,margin:'4 0 0 0',readOnly:true});this.txtWHTValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'WHT Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,name:'wht01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:270,hideTrigger:true,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',alwaysDisplayDecimals:true,style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'},{xtype:'container',layout:'hbox',anchor:'100%',items:[this.comboWHType,this.trigWHT,{xtype:'textfield',name:'whtxt',margin:'3 0 0 7',emptyText:'อื่นๆ ระบุประเภทการหักภาษี ณ ที่จ่าย',width:250}]}]},{xtype:'container',layout:'anchor',margins:'0 0 0 20',items:[this.txtTotal,this.txtDiscountValue,this.txtDiscountSum,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];this.trigWHT.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/loads_wht',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.whtnr);if(r.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(r.data.whtxt);}}else{o.markInvalid('Could not find wht code : '+o.getValue());}}});}},this);_this.whtDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigWHT.setValue(record.data.whtnr);if(record.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(record.data.whtxt);}
grid.getSelectionModel().deselectAll();_this.whtDialog.hide();});this.trigWHT.onTriggerClick=function(){_this.whtDialog.show();};var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtTaxValue.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtWHTValue.on('render',setAlignRight);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'ap/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},calculate:function(){var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discountValue=this.txtDiscountValue.getValue();if(discountValue>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var wht=this.txtWHTValue.getValue();var net=(total-discountValue)+(vat-wht);this.txtNet.setValue(net);}});;Ext.define('Account.AP.Item.Grid_gl',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',disabled:true,iconCls:'b-small-copy'});this.glDialog=Ext.create('Account.GL.MainWindow');this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"ap/loads_gl_item",reader:{type:'json',root:'rows',idProperty:'belnr,belpr'}},fields:['belnr','belpr','saknr','sgtxt','debit','credi','txz01'],remoteSort:true,sorters:['belpr ASC']});this.columns=[{id:'RowNumber2',text:"No.",dataIndex:'belpr',width:50,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"GL No.",width:100,dataIndex:'saknr',align:'center',sortable:false,},{text:"GL Description",width:215,dataIndex:'sgtxt',sortable:true},{text:"Debit",width:100,dataIndex:'debit',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,},{text:"Credit",width:100,dataIndex:'credi',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,},{text:"Comment",width:250,dataIndex:'txz01',sortable:true,field:{type:'textfield'}}];this.plugins=[this.editing];this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='saknr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.saknr);rModel.set('sgtxt',r.data.sgtxt);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.glDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('saknr',record.data.saknr);rModel.set('sgtxt',record.data.sgtxt);}
grid.getSelectionModel().deselectAll();_this.glDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addDefaultRecord:function(){this.store.removeAll();var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;for(var i=0;i<5;i++){rec={id:i};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();}},addRecord2:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();},removeRecord2:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow2();},runNumRow2:function(){var row_num=0;this.store.each(function(r){r.set('belpr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.AP.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMatAsset.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"ap/loads_ap_item",reader:{type:'json',root:'rows',idProperty:'invnr,vbelp'}},fields:['invnr','vbelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctype','chk01','chk02','saknr'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete AP Item',scope:this,handler:this.removeRecord}]},{id:'APiRowNumber',header:"Items",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:80,dataIndex:'matnr',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.materialDialog.show();}},},{text:"Description",width:220,dataIndex:'maktx',sortable:false,field:{type:'textfield'},},{text:"Qty",xtype:'numbercolumn',width:70,dataIndex:'menge',sortable:false,align:'right',field:{type:'numberfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Unit",width:50,dataIndex:'meins',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.unitDialog.show();}},},{text:"Price/Unit",xtype:'numbercolumn',width:100,dataIndex:'unitp',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Discount",xtype:'numbercolumn',width:80,dataIndex:'disit',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{xtype:'checkcolumn',text:'Vat',dataIndex:'chk01',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{xtype:'checkcolumn',text:'WHT',dataIndex:'chk02',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Amount",width:90,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:65,dataIndex:'ctype',sortable:false,align:'center',field:{type:'textfield'},},{dataIndex:'saknr',hidden:true,sortable:false}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='matnr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.matnr);rModel.set('maktx',r.data.maktx);rModel.set('meins',r.data.meins);rModel.set('saknr',r.data.saknr);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.materialDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('matnr',record.data.matnr);rModel.set('maktx',record.data.maktx);rModel.set('meins',record.data.meins);rModel.set('saknr',record.data.saknr);}
grid.getSelectionModel().deselectAll();_this.materialDialog.hide();});_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('meins',record.data.meins);}
grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,ctype:'THB'};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('ebelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.AP.Item.Grid_pc',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"quotation/loads_conp_item",reader:{type:'json',root:'rows',idProperty:'conty'}},fields:['conty','contx','vtamt','ttamt'],remoteSort:true,sorters:['conty ASC']});this.columns=[{text:"Condition type",width:170,dataIndex:'contx',sortable:true},{text:"Amount",width:100,xtype:'numbercolumn',dataIndex:'vtamt',sortable:true,align:'right'},{text:"Condition Amount",xtype:'numbercolumn',width:120,dataIndex:'ttamt',align:'right'}];return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.AP.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'AP preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/ap/index/'+id+'/'+copies;},});;Ext.define('Account.AP.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Account Payable',closeAction:'hide',height:670,width:940,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.AP.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.AP.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({invnr:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}}});;Ext.define('Account.AP.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Account Payable',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('AP')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('AP')||UMS.CAN.CREATE('AP')||UMS.CAN.EDIT('AP'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('AP')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('AP')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.AP.Item.Window');this.grid=Ext.create('Account.AP.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.AP.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save AP number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/ap/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Asset.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Asset No., Asset Type or Group',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Asset.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"asset/loads",reader:{type:'json',root:'rows',idProperty:'matnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['matnr','maktx','serno','mtart','mtype','matkl','mgrpp','saknr','brand','sgtxt','holds','statx','resid','assnr','depnr'],remoteSort:true,sorters:[{property:'matnr',direction:'ASC'}]});this.columns=[{text:"Asset No",width:80,dataIndex:'matnr',sortable:true},{text:"Asset Name",width:130,dataIndex:'maktx',sortable:true},{text:"Serial No",width:100,dataIndex:'serno',sortable:true},{text:"Type",width:50,dataIndex:'mtart',sortable:true},{text:"Type Desc",width:100,dataIndex:'mtype',sortable:true},{text:"Group",width:50,dataIndex:'matkl',sortable:true},{text:"Group Desc",width:100,dataIndex:'mgrpp',sortable:true},{text:"Brand",width:120,dataIndex:'brand',sortable:true},{text:"GL No",width:80,dataIndex:'saknr',sortable:true},{text:"GL Description",width:130,dataIndex:'sgtxt',sortable:true},{text:"Asset Holder",width:80,dataIndex:'meins',sortable:true},{text:"Department",width:100,dataIndex:'depnr',sortable:true},{text:"Residual Value",width:100,dataIndex:'resid',sortable:true},{text:"Under Asset",width:80,dataIndex:'assnr',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Asset.Import.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center',border:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.uploadAct=new Ext.Action({text:'Upload',iconCls:'b-small-save'});this.items=[{xtype:'filefield',name:'userfile',fieldLabel:'Excel file',labelAlign:'right',msgTarget:'side',allowBlank:false,anchor:'70%',buttonText:'Select Excel file...',allowBlank:false}];this.buttons=[this.uploadAct];this.uploadAct.setHandler(function(){_this.save();});return this.callParent(arguments);},save:function(){var _this=this,form=this.getForm();if(form.isValid()){_this.fireEvent('upload_click');form.submit({url:__site_url+'import/upload/do_upload',waitMsg:'Uploading excel file...',success:function(form,action){_this.fireEvent('upload_success',action.result.file);},failure:function(form,action){Ext.Msg.show({title:'An error occured.',msg:action.result.msg.error,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});}},reset:function(){this.getForm().reset();}});;Ext.define('Account.Asset.Import.Grid',{extend:'Ext.grid.Panel',constructor:function(config){Ext.apply(this,{viewConfig:{getRowClass:function(r,rowIndex,rowParams,store){var s=r.get('error');if(s&&s.length>0)
return'red-bg-row';}},buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.importAct=new Ext.Action({text:'Import',iconCls:'b-small-save'});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"import/asset/read",reader:{type:'json',root:'rows',idProperty:'row_id'},simpleSortMode:true},fields:['row_id','matnr','maktx','matkl','mtart','meins','saknr','beqty','beval','cosav','enqty','enval','unit1','cost1','unit2','cost2','unit3','cost3','statu','error'],remoteSort:false});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{text:"Asset Code",width:100,align:'center',dataIndex:'matnr',sortable:false},{text:"Asset Name",width:150,align:'center',dataIndex:'maktx',sortable:false},{text:"Asset Group",width:100,align:'center',dataIndex:'matkl',sortable:false},{text:"Asset Type",width:80,align:'center',dataIndex:'mtart',sortable:false},{text:"Unit",width:80,align:'center',dataIndex:'unit1',sortable:false},{text:"Cost",width:80,align:'center',dataIndex:'cost1',sortable:false},{text:"Error",width:250,dataIndex:'error',sortable:false,renderer:function(v,p,r){return(v&&v.length>0)?v:'-';}}];this.buttons=[this.importAct];this.importAct.setHandler(function(){_this.importData();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},showMask:function(msg,msgClass){msg=msg||'Please select excel file for upload.';msgClass=msgClass||'grid-disable';this.importAct.setDisabled(true);this.getEl().mask(msg,msgClass);},hideMask:function(){this.importAct.setDisabled(false);this.getEl().unmask();},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();grid.getSelectionModel().deselectAll();},importData:function(){var _this=this;var rs=[];this.store.each(function(r){rs.push(r.getData());});if(rs.length>0){this.showMask('Importing please wait','');var data_json=Ext.encode(rs);Ext.Ajax.request({url:__site_url+'import/material/import',params:{data:data_json},success:function(response){var text=response.responseText;var data=Ext.decode(text);if(data.success){Ext.Msg.show({title:'Import success.',msg:'Import '+data.rows.length+' rows success.',buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO});_this.fireEvent('import_success',data);}else{_this.hideMask();Ext.Msg.show({title:'An error occured.',msg:response,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}},failure:function(response){Ext.Msg.show({title:'An error occured.',msg:response.responseText,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});}else{Ext.Msg.alert('Status','No datas to import.');}}});;Ext.define('Account.Asset.Import.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Material Import',closeAction:'hide',height:600,minHeight:480,width:900,minWidth:600,resizable:true,modal:true,layout:'border',maximizable:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Material.Import.Form',{region:'north',height:80});this.grid=Ext.create('Account.Material.Import.Grid',{region:'center',disbled:true});this.items=[this.form,this.grid];this.form.on('upload_success',function(file_name){_this.grid.hideMask();_this.grid.load({file:file_name});});return this.callParent(arguments);},openDialog:function(){this.form.reset();this.grid.store.removeAll();this.show(false,function(){this.grid.showMask();});}});;Ext.define('Account.Asset.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'asset/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'right',msgTarget:'qtip',labelWidth:105,}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.typeDialog=Ext.create('Account.Assettype.Window');this.trigType=Ext.create('Ext.form.field.Trigger',{name:'mtart',fieldLabel:'Asset Type',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.grpDialog=Ext.create('Account.Assetgrp.Window');this.trigGrp=Ext.create('Ext.form.field.Trigger',{name:'matkl',fieldLabel:'Asset Group',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('FA'),fieldLabel:'Asset Status',name:'statu',labelAlign:'right',editable:false,allowBlank:false,triggerAction:'all',margin:'0 0 0 10',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.glnoDialog=Ext.create('Account.GL.MainWindow');this.trigGlno=Ext.create('Ext.form.field.Trigger',{name:'saknr',fieldLabel:'GL Account',triggerCls:'x-form-search-trigger',allowBlank:false,enableKeyEvents:true,});this.empDialog=Ext.create('Account.SEmployee.MainWindow');this.trigEmp=Ext.create('Ext.form.field.Trigger',{name:'reque',fieldLabel:'Requesting By',triggerCls:'x-form-search-trigger',enableKeyEvents:true,});this.emp2Dialog=Ext.create('Account.SEmployee.MainWindow');this.trigEmp2=Ext.create('Ext.form.field.Trigger',{name:'holds',fieldLabel:'Asset Holder',triggerCls:'x-form-search-trigger',enableKeyEvents:true,});this.emp3Dialog=Ext.create('Account.SEmployee.MainWindow');this.trigEmp3=Ext.create('Ext.form.field.Trigger',{name:'lastn',fieldLabel:'Last Holder',triggerCls:'x-form-search-trigger',enableKeyEvents:true,});this.depDialog=Ext.create('Account.SDepartment.MainWindow');this.trigDep=Ext.create('Ext.form.field.Trigger',{name:'depnr',fieldLabel:'Department',triggerCls:'x-form-search-trigger',enableKeyEvents:true,});this.assetDialog=Ext.create('Account.SAsset.MainWindow');this.trigAsset=Ext.create('Ext.form.field.Trigger',{name:'assnr',fieldLabel:'Under Asset',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.unitDialog=Ext.create('Account.Unit.Window');this.trigUnit=Ext.create('Ext.form.field.Trigger',{name:'meins',fieldLabel:'Unit',triggerCls:'x-form-search-trigger',editable:false,enableKeyEvents:true});this.txtResidValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Residual Value',name:'resid',margins:'3 0 0 5',alwaysDisplayDecimals:true});this.txtCostValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Cost Value',name:'costv',margins:'3 0 0 5',alwaysDisplayDecimals:true});this.txtLifeValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Use full life(year)',name:'lifes'});this.txtDepreValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Depreciation(%)',name:'costs'});this.items=[{xtype:'hidden',name:'id'},{xtype:'fieldset',title:'Asset Data',collapsible:true,defaultType:'textfield',layout:'anchor',items:[{xtype:'displayfield',fieldLabel:'Asset Code',name:'matnr',readOnly:true,value:'FAXXXXX'},{xtype:'textfield',fieldLabel:'Asset Name',name:'maktx',width:400,allowBlank:false},{xtype:'container',layout:'hbox',items:[this.trigType,{xtype:'displayfield',name:'mtype',margins:'3 0 0 5',width:286}]},{xtype:'container',layout:'hbox',items:[this.trigGrp,{xtype:'displayfield',name:'mgrpp',margins:'3 0 0 5',width:286}]},{xtype:'container',layout:'hbox',items:[this.trigGlno,{xtype:'displayfield',name:'sgtxt',margins:'3 0 0 5',width:286}]},{xtype:'textfield',fieldLabel:'Serial No',name:'serno',},{xtype:'textfield',fieldLabel:'Brand',name:'brand',},{xtype:'textfield',fieldLabel:'Model',name:'model',},{xtype:'textfield',fieldLabel:'Specification',name:'specs',},{xtype:'textfield',fieldLabel:'Picture',name:'pictu',},this.trigUnit]},{xtype:'fieldset',title:'General Data',collapsible:true,defaultType:'textfield',layout:'anchor',items:[{xtype:'container',layout:'hbox',items:[this.trigAsset,{xtype:'displayfield',name:'asstx',margins:'3 0 0 5',width:286}]},{xtype:'container',layout:'hbox',items:[this.trigEmp,{xtype:'displayfield',name:'name1',margins:'3 0 0 5',width:286}]},{xtype:'container',layout:'hbox',items:[this.trigEmp2,{xtype:'displayfield',name:'name2',margins:'3 0 0 5',width:286}]},{xtype:'container',layout:'hbox',items:[this.trigEmp3,{xtype:'displayfield',name:'name3',margins:'3 0 0 5',width:286}]},{xtype:'container',layout:'hbox',items:[this.trigDep,{xtype:'displayfield',name:'deptx',margins:'3 0 0 5',width:286}]},{xtype:'container',layout:'hbox',items:[{xtype:'textfield',fieldLabel:'Keeping Area',name:'keepi',},this.txtResidValue]},{xtype:'container',layout:'hbox',items:[this.txtDepreValue,{xtype:'textfield',fieldLabel:'PO No',margins:'3 0 0 5',name:'ebeln',}]},{xtype:'container',layout:'hbox',items:[{xtype:'datefield',fieldLabel:'PO Date',name:'bldat',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},this.txtCostValue]}]},this.comboQStatus];this.trigType.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'asset/load_type',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.trigType.setValue(r.data.mtart);_this.getForm().findField('matxt').setValue(r.data.matxt);}else{o.markInvalid('Could not find asset type : '+o.getValue());}}});}},this);_this.typeDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigType.setValue(record.data.mtart);_this.getForm().findField('matxt').setValue(record.data.matxt);grid.getSelectionModel().deselectAll();_this.typeDialog.hide();});this.trigType.onTriggerClick=function(){_this.typeDialog.show();};this.trigGrp.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'asset/load_grp',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.trigGrp.setValue(r.data.matkl);_this.getForm().findField('matxt2').setValue(r.data.matxt);_this.getForm().findField('saknr').setValue(r.data.saknr);_this.getForm().findField('sgtxt').setValue(r.data.sgtxt);}else{o.markInvalid('Could not find asset group : '+o.getValue());}}});}},this);_this.grpDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigGrp.setValue(record.data.matkl);_this.getForm().findField('matxt2').setValue(record.data.matxt);_this.getForm().findField('saknr').setValue(record.data.saknr);_this.getForm().findField('sgtxt').setValue(record.data.sgtxt);grid.getSelectionModel().deselectAll();_this.grpDialog.hide();});this.trigGrp.onTriggerClick=function(){_this.grpDialog.show();};this.trigUnit.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'unit/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.meins);}else{o.markInvalid('Could not find Unit : '+o.getValue());}}});}},this);_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigUnit.setValue(record.data.meins);grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});this.trigUnit.onTriggerClick=function(){_this.unitDialog.show();};this.trigGlno.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.saknr);_this.getForm().findField('sgtxt').setValue(record.data.sgtxt);}else{o.markInvalid('Could not find GL Account : '+o.getValue());}}});}},this);_this.glnoDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigGlno.setValue(record.data.saknr);_this.getForm().findField('sgtxt').setValue(record.data.sgtxt);grid.getSelectionModel().deselectAll();_this.glnoDialog.hide();});this.trigGlno.onTriggerClick=function(){_this.glnoDialog.show();};this.trigEmp.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'employee/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.empnr);_this.getForm().findField('name1').setValue(record.data.name1);}else{o.markInvalid('Could not find Employee : '+o.getValue());}}});}},this);_this.empDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigEmp.setValue(record.data.empnr);_this.getForm().findField('name1').setValue(record.data.name1);grid.getSelectionModel().deselectAll();_this.empDialog.hide();});this.trigEmp.onTriggerClick=function(){_this.empDialog.show();};this.trigEmp2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'employee/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.empnr);_this.getForm().findField('name2').setValue(record.data.name1);}else{o.markInvalid('Could not find Employee : '+o.getValue());}}});}},this);_this.emp2Dialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigEmp.setValue(record.data.empnr);_this.getForm().findField('name2').setValue(record.data.name1);grid.getSelectionModel().deselectAll();_this.emp2Dialog.hide();});this.trigEmp2.onTriggerClick=function(){_this.emp2Dialog.show();};this.trigEmp3.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'employee/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.empnr);_this.getForm().findField('name3').setValue(record.data.name1);}else{o.markInvalid('Could not find Employee : '+o.getValue());}}});}},this);_this.emp3Dialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigEmp.setValue(record.data.empnr);_this.getForm().findField('name3').setValue(record.data.name1);grid.getSelectionModel().deselectAll();_this.emp3Dialog.hide();});this.trigEmp3.onTriggerClick=function(){_this.emp3Dialog.show();};this.trigAsset.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'asset/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.matnr);_this.getForm().findField('asstx').setValue(record.data.maktx);}else{o.markInvalid('Could not find Fixed Asset : '+o.getValue());}}});}},this);_this.assetDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigAsset.setValue(record.data.matnr);_this.getForm().findField('asstx').setValue(record.data.maktx);grid.getSelectionModel().deselectAll();_this.assetDialog.hide();});this.trigAsset.onTriggerClick=function(){_this.assetDialog.show();};this.trigDep.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'sdepartment/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.depnr);_this.getForm().findField('deptx').setValue(record.data.deptx);}else{o.markInvalid('Could not find Department : '+o.getValue());}}});}},this);_this.depDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigDep.setValue(record.data.depnr);_this.getForm().findField('deptx').setValue(record.data.deptx);grid.getSelectionModel().deselectAll();_this.depDialog.hide();});this.trigDep.onTriggerClick=function(){_this.depDialog.show();};return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'asset/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},reset:function(){this.getForm().reset();this.comboQStatus.setValue('01');},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'asset/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});}});;Ext.define('Account.Asset.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Asset',closeAction:'hide',height:670,width:550,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Asset.Item.Form');this.items=this.form;this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);}else{this.dialogId=null;this.form.reset();this.show(false);}}});;Ext.define('Account.Asset.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Asset Management',closeAction:'hide',height:600,minHeight:380,width:1200,minWidth:100,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('FA')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('FA')||UMS.CAN.CREATE('FA')||UMS.CAN.EDIT('FA'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('FA')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('FA')});this.importAct=new Ext.Action({text:'Import',iconCls:'b-small-import',disabled:!UMS.CAN.CREATE('FA')});this.itemDialog=Ext.create('Account.Asset.Item.Window');this.importDialog=Ext.create('Account.Asset.Import.Window');this.grid=Ext.create('Account.Asset.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});this.searchForm=Ext.create('Account.Asset.FormSearch',{region:'north',height:100});this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/asset/index?'+query;});this.importAct.setHandler(function(){_this.importDialog.openDialog();});this.itemDialog.form.on('afterSave',function(){_this.itemDialog.hide();_this.grid.load();});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();opts.params=Ext.apply(opts.params,formValues);}});if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.importDialog.grid.on('import_success',function(){_this.importDialog.hide();_this.grid.load();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Assetgrp.GridItem',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.glnoDialog=Ext.create('Account.GL.MainWindow');this.tbar=[this.addAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'asset/loads_grp',reader:{type:'json',root:'rows',idProperty:'id_mgrp',totalProperty:'totalCount'}},fields:[{name:'id_mgrp',type:'int'},'matkl','matxt','saknr','sgtxt'],remoteSort:false,sorters:['id_mgrp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{id:'FAiRowNumber002',header:"Type ID",dataIndex:'id_mgrp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Group Code",width:80,dataIndex:'matkl',sortable:true,field:{type:'textfield'},},{text:"Group Description",width:150,dataIndex:'matxt',sortable:true,field:{type:'textfield'},},{text:"GL no",width:100,dataIndex:'saknr',sortable:true,field:{xtype:'triggerfield',enableKeyEvents:true,allowBlank:false,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.glnoDialog.show();}},sortable:false},{text:"GL Description",width:170,dataIndex:'sgtxt',sortable:true}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='saknr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.saknr);rModel.set('sgtxt',r.data.sgtxt);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.glnoDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('saknr',record.data.saknr);rModel.set('sgtxt',record.data.sgtxt);}
grid.getSelectionModel().deselectAll();_this.glnoDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options,proxy:{type:'ajax',url:__site_url+'asset/loads_grp',reader:{type:'json',root:'rows',idProperty:'id_mgrp'}},fields:[{name:'id_mgrp',type:'int'},'mtart','matxt','saknr','sgtxt'],remoteSort:false,sorters:['id_mgrp ASC']});},addRecord:function(){var newId=-1;var i=0;this.store.each(function(r){i++;if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(i,rec);edit.startEditByPosition({row:i,column:0});this.runNumRow();},save:function(){var _this=this;var r_data=this.getData();Ext.Ajax.request({url:__site_url+'asset/save_grp',method:'POST',params:{fgrp:Ext.encode(r_data)},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){}else{Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}}});},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},reset:function(){this.grid.load({matkl:0});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('id_mgrp',row_num++);});}});;Ext.define('Account.Assetgrp.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Asset Group',closeAction:'hide',height:420,width:600,layout:'border',resizable:true,modal:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.Assetgrp.GridItem',{region:'center'});this.items=[this.grid];this.buttons=[{text:'Save',handler:function(){Ext.Msg.show({title:"Warning",msg:"Are you sure you want to update item(s) ?",icon:Ext.Msg.WARNING,buttons:Ext.Msg.YESNO,fn:function(bt){if(bt=="yes"){_this.grid.save();}}});}},{text:'Cancel',handler:function(){_this.hide();}}];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Assettype.GridItem',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.tbar=[this.addAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'asset/loads_type',reader:{type:'json',root:'rows',idProperty:'id_mtype'}},fields:[{name:'id_mtype',type:'int'},'mtart','matxt'],remoteSort:false,sorters:['id_mtype ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{id:'FAiRowNumber001',header:"Type ID",dataIndex:'id_mtype',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Type Code",width:100,dataIndex:'mtart',sortable:true,field:{type:'textfield'},},{text:"Type Description",width:250,dataIndex:'matxt',sortable:true,field:{type:'textfield'},}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});return this.callParent(arguments);},load:function(options){this.store.load({params:options,proxy:{type:'ajax',url:__site_url+'asset/loads_type',reader:{type:'json',root:'rows',idProperty:'id_mtype'}},fields:[{name:'id_mtype',type:'int'},'mtart','matxt'],remoteSort:false,sorters:['id_mtype ASC']});},addRecord:function(){var newId=-1;var i=0;this.store.each(function(r){i++;if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(i,rec);edit.startEditByPosition({row:i,column:0});this.runNumRow();},save:function(){var _this=this;var r_data=this.getData();Ext.Ajax.request({url:__site_url+'asset/save_type',method:'POST',params:{ftyp:Ext.encode(r_data)},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){}else{Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}}});},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},reset:function(){this.grid.load({mtart:0});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('id_mtype',row_num++);});}});;Ext.define('Account.Assettype.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Asset Type',closeAction:'hide',height:420,width:450,layout:'border',resizable:true,modal:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.Assettype.GridItem',{region:'center'});this.items=[this.grid];this.buttons=[{text:'Save',handler:function(){Ext.Msg.show({title:"Warning",msg:"Are you sure you want to update item(s) ?",icon:Ext.Msg.WARNING,buttons:Ext.Msg.YESNO,fn:function(bt){if(bt=="yes"){_this.grid.save();}}});}},{text:'Cancel',handler:function(){_this.hide();}}];this.grid.load();return this.callParent(arguments);}});;function PageLoad()
{var rec_empl=null;var rec_doct=null;var rec_limit_amount=null;var store_limit_amount=Ext.create('Ext.data.ArrayStore',{storeId:'store_limit_amount-AuthenDoc-MainWindow',fields:[{name:'amoid',type:'string'},{name:'rowid',type:'string'},{name:'grptx',type:'string'},{name:'docty',type:'string'},{name:'liamo',type:'string'}],sortInfo:{field:'amoid',direction:'ASC'}});var grid_limit_amount=Ext.create('Ext.grid.Panel',{id:'grid_limit_amount-AuthenDoc-MainWindow',title:'Doc Type : ',store:store_limit_amount,columns:[{text:"  ",align:'center',width:30,renderer:RenderfieldDelete,dataIndex:'limit_amount_row_delete',sortable:true},{text:"  ",align:'center',width:30,renderer:RenderFieldDetail,dataIndex:'limit_amount_row_edit',sortable:true},{text:"�ӴѺ���",align:'center',width:60,dataIndex:'rowid',sortable:true},{text:"grptx",align:'center',width:240,dataIndex:'grptx',sortable:true},{text:"docty",align:'center',width:180,dataIndex:'docty',sortable:true},{text:"Limit Amount",align:'center',width:180,dataIndex:'liamo',sortable:true}],autoExpandColumn:'budget_limit_doc_name',tbar:[{text:'Add',iconCls:'b-small-plus',width:60,handler:function(){win_add_limit_amount.show();}}]});var lblLimitAmount=Ext.create('Ext.form.Label',{id:'lblLimitAmount-AuthenDoc-MainWindow',layout:'absolute',x:20,y:20,text:'Limit Amount : '});var txtLimitAmount=Ext.create('Ext.form.Text',{id:'txtLimitAmount-AuthenDoc-MainWindow',layout:'absolute',fieldStyle:'text-align: right;',width:140,x:110,y:20});var btnOkAddLimitAmount=Ext.create('Ext.Button',{id:'btnOkAddLimitAmount-AuthenDoc-MainWindow',text:'��ŧ',x:110,y:50,width:80,handler:function(){var amount_param=txtLimitAmount.getRawValue();AddLimitAmount(amount_param);win_add_limit_amount.hide();txtLimitAmount.setValue('');}});var form_add_limit_amount=Ext.create('Ext.form.Panel',{id:'form_add_limit_amount-AuthenDoc-MainWindow',layout:'absolute',frame:true,height:140,width:200,items:[lblLimitAmount,txtLimitAmount,btnOkAddLimitAmount]});var win_add_limit_amount=Ext.create('Ext.Window',{id:'win_add_limit_amount-AuthenDoc-MainWindow',title:'',closeAction:'hide',height:140,width:300,resizable:false,modal:true,layout:'fit',maximizable:false,items:[form_add_limit_amount]});var TopPanel=Ext.create('Ext.Panel',{id:'TopPanel-AuthenDoc-MainWindow',layout:'fit',width:1000,height:370,items:[grid_limit_amount]});var store_authen_aprove=Ext.create('Ext.data.ArrayStore',{storeId:'store_authen_aprove-AuthenDoc-MainWindow',fields:[{name:'levid',type:'string'},{name:'amoid',type:'string'},{name:'empnr',type:'string'},{name:'name1',type:'string'},{name:'postx',type:'string'},{name:'deptx',type:'string'}],sortInfo:{field:'levid',direction:'ASC'}});var grid_authen_aprove=Ext.create('Ext.grid.Panel',{id:'grid_authen_aprove-AuthenDoc-MainWindow',height:200,store:store_authen_aprove,plugins:[Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1})],columns:[{text:"  ",align:'center',width:30,renderer:RenderfieldDelete,dataIndex:'authen_aprove_row_delete',sortable:true},{text:"�ӴѺ���",align:'center',width:60,dataIndex:'levid',sortable:false},{text:"����",align:'center',width:200,dataIndex:'name1',field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){win_add_emp_approve.show();}},sortable:true},{text:"���˹�",align:'center',width:170,dataIndex:'postx',sortable:true},{text:"˹��§ҹ",align:'center',width:170,dataIndex:'deptx',sortable:true}],autoExpandColumn:'name1',tbar:[{text:'Add',id:'btnAddEmpWindowPop-AuthenDoc-MainWindow',iconCls:'b-small-plus',width:60,handler:function(){win_add_emp_approve.show();}}],bbar:['->',{text:'Save',hidden:true,width:100,handler:function(){}},{text:'Cancel',hidden:true,width:100,handler:function(){}}]});var ButtomPanel=Ext.create('Ext.Panel',{id:'ButtomPanel-AuthenDoc-MainWindow',layout:'fit',width:740,height:200,items:[grid_authen_aprove]});var store_doct=Ext.create('Ext.data.ArrayStore',{storeId:'store_doct-AuthenDoc-MainWindow',fields:[{name:'grptx',type:'string'},{name:'docty',type:'string'},{name:'doctx',type:'string'},{name:'grpmo',type:'string'}],sortInfo:{field:'grptx',direction:'ASC'}});var grid_doct=Ext.create('Ext.grid.Panel',{id:'grid_doct-AuthenDoc-MainWindow',title:'All Doc Type ',store:store_doct,columns:[{id:'grptx',text:"grptx",align:'center',width:90,dataIndex:'grptx',sortable:true},{id:'docty',text:"docty",align:'center',width:90,dataIndex:'docty',sortable:true},{id:'doctx',text:"doctx",align:'center',width:90,dataIndex:'doctx',sortable:true},{id:'grpmo',text:"grpmo",align:'center',width:90,dataIndex:'grpmo',sortable:true}],autoExpandColumn:'doctx'});var LeftPanel=Ext.create('Ext.Panel',{id:'LeftPanel-AuthenDoc-MainWindow',layout:'fit',width:350,height:600,items:[grid_doct]});var RightPanel=Ext.create('Ext.Panel',{id:'RightPanel-AuthenDoc-MainWindow',layout:'vbox',width:750,height:600,items:[TopPanel,ButtomPanel]});var store_add_emp_approve=Ext.create('Ext.data.ArrayStore',{storeId:'store_add_emp_approve-AuthenDoc-MainWindow',fields:[{name:'empnr',type:'string'},{name:'name1',type:'string'},{name:'postx',type:'string'},{name:'deptx',type:'string'}],sortInfo:{field:'name1',direction:'ASC'}});var grid_add_emp_approve=Ext.create('Ext.grid.Panel',{id:'grid_add_emp_approve-AuthenDoc-MainWindow',store:store_add_emp_approve,columns:[{id:'name1',text:"���;�ѡ�ҹ",align:'left',width:120,dataIndex:'name1',sortable:true},{id:'postx',text:"���˹�",align:'left',width:140,dataIndex:'postx',sortable:true}],autoExpandColumn:'name1',tbar:[{text:'Add',iconCls:'b-small-plus',width:60,handler:function(){AddEmplAuth();win_add_emp_approve.hide();}}]});var win_add_emp_approve=Ext.create('Ext.Window',{id:'win_add_emp_approve-AuthenDoc-MainWindow',title:'',closeAction:'hide',height:400,width:300,resizable:false,modal:true,layout:'fit',maximizable:false,items:[grid_add_emp_approve]});var win_authen_doc=Ext.create('Ext.Window',{id:'win_authen_doc-AuthenDoc-MainWindow',title:'',closeAction:'hide',height:600,minHeight:380,width:1100,minWidth:500,resizable:true,modal:true,layout:'hbox',maximizable:true,items:[LeftPanel,RightPanel]});function GET_TBL_DOCT()
{var strResult=remoteFunction("GET_TBL_DOCT","");var arrDoct=strResult.split('|');var detail=arrDoct;var data;var myData=new Array();var i;var strTemp;if(detail!=''){for(i=0;i<arrDoct.length;i++){data=new Array();strTemp=arrDoct[i].split('+')
data[0]=strTemp[0];data[1]=strTemp[1];data[2]=strTemp[2];data[3]=strTemp[3];myData[i]=data;}}
else{data=new Array();myData=data;}
store_doct.loadData(myData);}
function GET_Initial_Grid_Approve()
{var data;var myData=new Array();for(i=0;i<1;i++){data=new Array();data[0]="4";data[1]="";data[2]="";data[3]="";data[4]="";data[5]="";data[6]="";myData[i]=data;}
store_authen_aprove.loadData(myData);}
function GET_EMP($deptx)
{var strResult=remoteFunction("GET_EMP",$deptx);var arrEmp=strResult.split('|');var detail=arrEmp;var data;var myData=new Array();var i;var strTemp;if(detail!=''){for(i=0;i<arrEmp.length;i++){data=new Array();strTemp=arrEmp[i].split('+')
data[0]=strTemp[0];data[1]=strTemp[1];data[2]=strTemp[2];data[3]=strTemp[3];myData[i]=data;}}
else{data=new Array();myData=data;}
store_add_emp_approve.loadData(myData);}
function GET_TBL_AMOU($docty)
{var strResult=remoteFunction("GET_TBL_AMOU",$docty);var arrEmp=strResult.split('|');var detail=arrEmp;var data;var myData=new Array();var i;var strTemp;if(detail!=''){for(i=0;i<arrEmp.length;i++){data=new Array();strTemp=arrEmp[i].split('+')
data[0]=strTemp[0];data[1]=strTemp[1];data[2]=strTemp[2];data[3]=strTemp[3];data[4]=strTemp[4];myData[i]=data;}}
else{data=new Array();myData=data;}
store_limit_amount.loadData(myData);}
function GET_TBL_AUAM(amoid)
{var strResult=remoteFunction("GET_TBL_AUAM",amoid);var arrAuam=strResult.split('|');var detail=arrAuam;var data;var myData=new Array();var i;var strTemp;if(detail!=''){for(i=0;i<arrAuam.length;i++){data=new Array();strTemp=arrAuam[i].split('+')
data[0]=strTemp[0];data[1]=strTemp[1];data[2]=strTemp[2];data[3]=strTemp[3];data[4]=strTemp[4];data[5]=strTemp[5];myData[i]=data;}}
else{data=new Array();myData=data;}
store_authen_aprove.loadData(myData);}
function AddLimitAmount(amount_param)
{var myRowid=store_limit_amount.getCount()+1;var myAmoid="";var myDocty=rec_doct.get('docty');var strData=myRowid+"|"+myDocty+"|"+amount_param;GetSaveAmount(strData);GET_TBL_AMOU(myDocty);}
function AddEmplAuth()
{var myLevid=store_authen_aprove.getCount()+1;var myAmoid=rec_limit_amount.get('amoid');var myEmpnr=rec_empl.get('empnr');var strData=myLevid+"|"+myAmoid+"|"+myEmpnr;GetSaveEmplAuthen(strData);GET_TBL_AUAM(myAmoid);}
function GetSaveAmount(strData)
{var strResult=remoteFunction("GetSaveAmount",strData);}
function GetSaveEmplAuthen(strData)
{var strResult=remoteFunction("GetSaveEmplAuthen",strData);}
function GetSaveData(strData)
{var strLimitAmount="";var strEmplAuthen="";var strData="";for(i=0;i<store_limit_amount.getCount();i++)
{rt=store_limit_amount.getAt(i);strLimitAmount=strLimitAmount+rt.get('rowid')+"+"+rt.get('grptx')+"+"+rt.get('docty')+"+"+rt.get('liamo')+"|";}
for(i=0;i<store_authen_aprove.getCount();i++)
{rt=store_authen_aprove.getAt(i);strEmplAuthen=strEmplAuthen+rt.get('levid')+"+"+rt.get('amoid')+"+"+rt.get('empnr')+"|";}
strData=rec_doct.get('docty')+"#"+str}
function RenderfieldDelete(val)
{return'<div  style="text-align: center"><img style="cursor:pointer"   alt="" src="../../images/icons/bin.gif" /></div>';}
function RenderFieldDetail(val)
{return'<div  style="text-align: center"><img style="cursor:pointer"   alt="" src="../../images/icons/detail.png" /></div>';}
GET_TBL_DOCT();GET_EMP();win_authen_doc.show();grid_doct.on('cellclick',function(grid_doct,td,cellIndex,record,tr,rowIndex,e,eOpts){rec_doct=record;GET_TBL_AMOU(record.get('docty'));GET_EMP(record.get('grptx'));store_authen_aprove.removeAll();grid_limit_amount.setTitle('Doc Type : '+record.get('doctx'));Ext.getCmp('btnAddEmpWindowPop-AuthenDoc-MainWindow').setDisabled(true);});grid_add_emp_approve.on('cellclick',function(grid_add_emp_approve,td,cellIndex,record,tr,rowIndex,e,eOpts){rec_empl=record;});grid_limit_amount.on('cellclick',function(grid_authen_aprove,td,cellIndex,record,tr,rowIndex,e,eOpts){if(cellIndex==1)
{Ext.getCmp('btnAddEmpWindowPop-AuthenDoc-MainWindow').setDisabled(false);rec_limit_amount=record;GET_TBL_AUAM(record.get('amoid'));}});};Ext.define('Account.Bankname.GridItem',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.glnoDialog=Ext.create('Account.GL.MainWindow');this.tbar=[this.addAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'bankname/loads',reader:{type:'json',root:'rows',idProperty:'id_bname',totalProperty:'totalCount'}},fields:[{name:'id_bname',type:'int'},'bcode','bname','addrs','saknr','sgtxt'],remoteSort:true,sorters:['id_bname ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{id:'PMiRowNumber005',header:"No",dataIndex:'id_bname',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Bank Code",align:'center',width:100,dataIndex:'bcode',sortable:true,field:{type:'textfield'}},{text:"Bank Name",width:150,dataIndex:'bname',sortable:true,field:{type:'textfield'}},{text:"Address",width:125,dataIndex:'addrs',sortable:true,field:{type:'textfield'}},{text:"GL no",width:100,dataIndex:'saknr',sortable:true,field:{xtype:'triggerfield',enableKeyEvents:true,allowBlank:false,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.glnoDialog.show();}},sortable:false},{text:"GL Description",width:170,dataIndex:'sgtxt',sortable:true}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='saknr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.saknr);rModel.set('sgtxt',r.data.sgtxt);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.glnoDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('saknr',record.data.saknr);rModel.set('sgtxt',record.data.sgtxt);}
grid.getSelectionModel().deselectAll();_this.glnoDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load(options);},addRecord:function(){var newId=-1;var i=0;this.store.each(function(r){i++;if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(i,rec);edit.startEditByPosition({row:i,column:0});this.runNumRow();},save:function(){var _this=this;var r_data=this.getData();Ext.Ajax.request({url:__site_url+'bankname/save',method:'POST',params:{bnam:Ext.encode(r_data)},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){}else{Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}}});},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},reset:function(){this.grid.load({bcode:0});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('id_bname',row_num++);});}});;Ext.define('Account.Bankname.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Bank Name',closeAction:'hide',height:380,minHeight:380,width:700,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true,defaultFocus:'code'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.Bankname.GridItem',{region:'center',border:false});this.items=[this.grid];this.buttons=[{text:'Save',handler:function(){Ext.Msg.show({title:"Warning",msg:"Are you sure you want to update item(s) ?",icon:Ext.Msg.WARNING,buttons:Ext.Msg.YESNO,fn:function(bt){if(bt=="yes"){_this.grid.save();}}});}},{text:'Cancel',handler:function(){_this.hide();}}];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Billfrom.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Billing No, Vendor code or Vendor Name',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Billfrom.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"billfrom/loads",reader:{type:'json',root:'rows',idProperty:'bilnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['bilnr','bldat','duedt','lifnr','name1','txz01','statu','netwr','ctype'],remoteSort:true,sorters:[{property:'bilnr',direction:'ASC'}]});this.columns=[{text:"Bill From No",width:120,align:'center',dataIndex:'bilnr',sortable:true},{text:"Doc Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Receipt Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'duedt',sortable:true},{text:"Vendor No",width:80,align:'center',dataIndex:'lifnr',sortable:true},{text:"Vendor Name",width:150,dataIndex:'name1',sortable:true},{text:"Text Note",width:200,dataIndex:'txz01',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Amount",xtype:'numbercolumn',width:80,align:'right',dataIndex:'netwr',sortable:true},{text:"Currency",width:60,align:'center',dataIndex:'ctype',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Billfrom.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'billfrom/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.vendorDialog=Ext.create('Account.SVendor.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.gridItem=Ext.create('Account.Billfrom.Item.Grid_i',{height:320,region:'center'});this.formTotal=Ext.create('Account.Billfrom.Item.Form_t',{border:true,split:true,title:'Total Bill From',region:'south'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payments',name:'ptype',width:350,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'invoice/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('BF'),fieldLabel:'Billing Status',name:'statu',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.hdnBtItem=Ext.create('Ext.form.Hidden',{name:'ebkp'});this.trigVendor=Ext.create('Ext.form.field.Trigger',{name:'lifnr',labelAlign:'letf',width:240,fieldLabel:'Vendor Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnBtItem,{xtype:'fieldset',title:'Header Data',collapsible:true,defaultType:'textfield',layout:'anchor',defaults:{anchor:'100%'},items:[{xtype:'container',layout:'hbox',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',items:[{xtype:'hidden',name:'id'},this.trigVendor,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:350,allowBlank:true}]},{xtype:'textarea',fieldLabel:'Address',name:'adr01',width:400,rows:3}]},{xtype:'container',layout:'anchor',items:[{xtype:'displayfield',fieldLabel:'Billing No',name:'bilnr',value:'BFXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'},{xtype:'datefield',fieldLabel:'Document Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false},{xtype:'datefield',fieldLabel:'Receipt Date',name:'duedt',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false},this.comboQStatus]}]}]}]};this.items=[mainFormPanel,this.gridItem,{xtype:'tabpanel',region:'south',activeTab:0,height:150,items:[this.formTotal,this.gridPayment]}];this.trigVendor.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.lifnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.vendorDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor.setValue(record.data.lifnr);_this.getForm().findField('name1').setValue(record.data.name1);var _addr=record.data.adr01;if(!Ext.isEmpty(record.data.distx))
_addr+=' '+record.data.distx;if(!Ext.isEmpty(record.data.pstlz))
_addr+=' '+record.data.pstlz;if(!Ext.isEmpty(record.data.telf1))
_addr+='\n'+'Tel: '+record.data.telf1;if(!Ext.isEmpty(record.data.telfx))
_addr+=' '+'Fax: '+record.data.telfx;if(!Ext.isEmpty(record.data.email))
_addr+='\n'+'Email: '+record.data.email;_this.getForm().findField('adr01').setValue(_addr);grid.getSelectionModel().deselectAll();_this.vendorDialog.hide();_this.gridItem.setVendorCode(record.data.lifnr);});this.trigVendor.onTriggerClick=function(){_this.vendorDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);return this.callParent(arguments);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'billfrom/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);_this.gridItem.setVendorCode(act.result.data.lifnr);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnBtItem.setValue(Ext.encode(rsItem));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'billfrom/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({bilnr:0});this.getForm().findField('bldat').setValue(new Date());this.comboQStatus.setValue('01');},calculateTotal:function(){var store=this.gridItem.store;var sum=0;store.each(function(r){var itamt=parseFloat(r.data['itamt'].replace(/[^0-9.]/g,''));itamt=isNaN(itamt)?0:itamt;var amt=itamt;sum+=amt;});this.formTotal.getForm().findField('beamt').setValue(Ext.util.Format.usMoney(sum).replace(/\$/,''));var net=this.formTotal.calculate();}});;Ext.define('Account.Billfrom.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'billfrom/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip'}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',xtype:'textfield',fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:155,width:270,readOnly:true});this.txtDiscount=Ext.create('Ext.form.field.Text',{fieldLabel:'Discount',disabled:true,name:'dispc',align:'right',labelWidth:80,width:150,enableKeyEvents:true,validator:function(v){if(!Ext.isEmpty(v)){var regEx=/^([0-9]*)(\.[1-9]*)?$|^([0-9]|[1-9][0-9]|100)(\.[1-9]*)?(%)$/gi;if(regEx.test(v))
return true;else
return'Value can be only numbers or percent';}else
return true;}});this.txtDiscountValue=Ext.create('Ext.form.field.Text',{name:'dismt',disabled:true,align:'right',width:110,margin:'0 0 0 10',readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',disabled:true,align:'right',width:270,labelWidth:155,margin:'4 0 0 0',readOnly:true});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',width:270,labelWidth:155,alwaysDisplayDecimals:true,margin:'4 0 0 0',style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',items:[{xtype:'displayfield',width:240,align:'right',},{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:60,}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr1'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'}]},{xtype:'container',layout:'anchor',margins:'0 0 0 200',items:[this.txtTotal,{xtype:'container',layout:'hbox',items:[this.txtDiscount,this.txtDiscountValue]},this.txtDiscountSum,{xtype:'container',layout:'hbox',defaultType:'textfield',items:[this.txtInterest]},this.txtNet]}]}];var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtDiscount.on('keyup',this.calculate,this);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'billto/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'billto/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},calculate:function(){var total=this.txtTotal.getValue();total=parseFloat(total),total=isNaN(total)?0:total;if(total<=0)return;var discount=this.txtDiscount.getValue(),discountValue=0;if(this.txtDiscount.isValid()&&!Ext.isEmpty(discount)){if(discount.match(/%$/gi)){discount=discount.replace('%','');var discountPercent=parseFloat(discount);discountValue=total*discountPercent/100;}else{discountValue=parseFloat(discount);}
discountValue=isNaN(discountValue)?0:discountValue;this.txtDiscountValue.setValue(Ext.util.Format.usMoney(discountValue).replace(/\$/,''));if(discountValue>0)
this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscount.setValue('');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var net=total;this.txtNet.setValue(net);return net;}});;Ext.define('Account.Billfrom.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.apDialog=Ext.create('Account.SAp.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"billfrom/loads_bt_item",reader:{type:'json',root:'rows',idProperty:'bilnr,vbelp'}},fields:['bilnr','vbelp','invnr','refnr','invdt','texts','itamt','ctyp1'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Receipt Item',scope:this,handler:this.removeRecord}]},{id:'RowNumber25',header:"No.",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Billing Code",width:100,dataIndex:'invnr',align:'center',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.apDialog.show();}},},{text:"Ref.No",width:150,dataIndex:'refnr',sortable:false,field:{type:'textfield'},},{text:"Billing Date",width:80,xtype:'datecolumn',dataIndex:'invdt',sortable:false,renderer:Ext.util.Format.dateRenderer('m/d/Y')},{text:"Text Note",width:200,dataIndex:'texts',sortable:false,field:{type:'textfield'},},{text:"Billing Amt",xtype:'numbercolumn',width:120,dataIndex:'itamt',sortable:false,align:'right',readOnly:true},{text:"Currency",width:55,dataIndex:'ctyp1',sortable:false,align:'center',field:{type:'textfield'},}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='invnr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'ap/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.invnr);rModel.set('refnr',r.data.refnr);rModel.set('invdt',r.data.bldat);rModel.set('texts',r.data.txz01);rModel.set('itamt',r.data.netwr);rModel.set('ctyp1',r.data.ctype);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.apDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('invnr',record.data.invnr);rModel.set('refnr',record.data.refnr);rModel.set('invdt',record.data.bldat);rModel.set('texts',record.data.txz01);rModel.set('itamt',record.data.netwr);rModel.set('ctyp1',record.data.ctype);}
grid.getSelectionModel().deselectAll();_this.apDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,invnr:''};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();this.getSelectionModel().deselectAll();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('ebelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},setVendorCode:function(lifnr){this.vendorCode=lifnr;var field=this.apDialog.searchForm.form.findField('lifnr');field.setValue(lifnr);this.apDialog.grid.load();}});;Ext.define('Account.Billfrom.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'Bill from Vendor preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/billfrom/index/'+id+'/'+copies;}});;Ext.define('Account.Billfrom.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Billing Received',closeAction:'hide',height:650,width:950,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Billfrom.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.Billfrom.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({bilnr:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}}});;Ext.define('Account.Billfrom.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Billing Received',closeAction:'hide',height:600,minHeight:380,width:950,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;var fibasic=Ext.create('Ext.form.field.File',{width:200,x:50,y:50,hideLabel:true});this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('BF')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('BF')||UMS.CAN.CREATE('BF')||UMS.CAN.EDIT('BF'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('BF')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('BF')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.Billfrom.Item.Window');this.grid=Ext.create('Account.Billfrom.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.Billfrom.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/po/index?'+query;});this.itemDialog.form.on('afterSave',function(){_this.itemDialog.hide();_this.grid.load();});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Billto.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Billing Note, Customer, Invoice',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Billto.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"billto/loads",reader:{type:'json',root:'rows',idProperty:'bilnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['bilnr','bldat','duedt','kunnr','name1','txz01','statu','netwr','ctype'],remoteSort:true,sorters:[{property:'bilnr',direction:'ASC'}]});this.columns=[{text:"Billing No",width:120,align:'center',dataIndex:'bilnr',sortable:true},{text:"Doc Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Billing Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'duedt',sortable:true},{text:"Customer No",width:80,align:'center',dataIndex:'kunnr',sortable:true},{text:"Customer Name",width:150,dataIndex:'name1',sortable:true},{text:"Text Note",width:200,dataIndex:'txz01',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Amount",xtype:'numbercolumn',width:80,align:'right',dataIndex:'netwr',sortable:true},{text:"Currency",width:60,align:'center',dataIndex:'ctype',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Billto.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'billto/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.customerDialog=Ext.create('Account.SCustomer.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.gridItem=Ext.create('Account.Billto.Item.Grid_i',{height:320,region:'center'});this.formTotal=Ext.create('Account.Billto.Item.Form_t',{border:true,split:true,title:'Total Billing',region:'south'});this.comboPay=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('BT'),fieldLabel:'Payments',name:'ptype',width:350,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'invoice/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'Billing Status',name:'statu',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.hdnBtItem=Ext.create('Ext.form.Hidden',{name:'vbkp'});this.trigCustomer=Ext.create('Ext.form.field.Trigger',{name:'kunnr',labelAlign:'letf',width:240,fieldLabel:'Customer Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnBtItem,{xtype:'fieldset',title:'Header Data',collapsible:true,defaultType:'textfield',layout:'anchor',defaults:{anchor:'100%'},items:[{xtype:'container',layout:'hbox',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',items:[{xtype:'hidden',name:'id'},this.trigCustomer,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:350,allowBlank:true}]},{xtype:'textarea',fieldLabel:'Address',name:'adr01',width:400,rows:3}]},{xtype:'container',layout:'anchor',items:[{xtype:'displayfield',fieldLabel:'Billing No',name:'bilnr',value:'BTXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'},{xtype:'datefield',fieldLabel:'Document Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false},{xtype:'datefield',fieldLabel:'Billing Date',name:'duedt',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false},this.comboQStatus]}]}]}]};this.items=[mainFormPanel,this.gridItem,{xtype:'tabpanel',region:'south',activeTab:0,height:150,items:[this.formTotal,this.gridPayment]}];this.trigCustomer.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer.setValue(record.data.kunnr);_this.getForm().findField('name1').setValue(record.data.name1);var _addr=record.data.adr01;if(!Ext.isEmpty(record.data.distx))
_addr+=' '+record.data.distx;if(!Ext.isEmpty(record.data.pstlz))
_addr+=' '+record.data.pstlz;if(!Ext.isEmpty(record.data.telf1))
_addr+='\n'+'Tel: '+record.data.telf1;if(!Ext.isEmpty(record.data.telfx))
_addr+=' '+'Fax: '+record.data.telfx;if(!Ext.isEmpty(record.data.email))
_addr+='\n'+'Email: '+record.data.email;_this.getForm().findField('adr01').setValue(_addr);grid.getSelectionModel().deselectAll();_this.customerDialog.hide();_this.gridItem.setCustomerCode(record.data.kunnr);});this.trigCustomer.onTriggerClick=function(){_this.customerDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);return this.callParent(arguments);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'billto/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);_this.gridItem.setCustomerCode(act.result.data.kunnr);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnBtItem.setValue(Ext.encode(rsItem));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'billto/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({bilnr:0});this.getForm().findField('bldat').setValue(new Date());this.comboQStatus.setValue('01');},calculateTotal:function(){var store=this.gridItem.store;var sum=0;store.each(function(r){var itamt=parseFloat(r.data['itamt'].replace(/[^0-9.]/g,''));itamt=isNaN(itamt)?0:itamt;var amt=itamt;sum+=amt;});this.formTotal.getForm().findField('beamt').setValue(Ext.util.Format.usMoney(sum).replace(/\$/,''));var net=this.formTotal.calculate();}});;Ext.define('Account.Billto.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'billto/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip'}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',xtype:'textfield',fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:155,width:270,readOnly:true});this.txtDiscount=Ext.create('Ext.form.field.Text',{fieldLabel:'Discount',name:'dispc',disabled:true,align:'right',labelWidth:80,width:150,enableKeyEvents:true,validator:function(v){if(!Ext.isEmpty(v)){var regEx=/^([0-9]*)(\.[1-9]*)?$|^([0-9]|[1-9][0-9]|100)(\.[1-9]*)?(%)$/gi;if(regEx.test(v))
return true;else
return'Value can be only numbers or percent';}else
return true;}});this.txtDiscountValue=Ext.create('Ext.form.field.Text',{name:'dismt',align:'right',disabled:true,width:110,margin:'0 0 0 10',readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',align:'right',disabled:true,width:270,labelWidth:155,margin:'4 0 0 0',readOnly:true});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',width:270,labelWidth:155,alwaysDisplayDecimals:true,margin:'4 0 0 0',style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',items:[{xtype:'displayfield',width:240,align:'right',},{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:60,}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr1'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'}]},{xtype:'container',layout:'anchor',margins:'0 0 0 200',items:[this.txtTotal,{xtype:'container',layout:'hbox',items:[this.txtDiscount,this.txtDiscountValue]},this.txtDiscountSum,this.txtNet]}]}];var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtDiscount.on('keyup',this.calculate,this);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'billto/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'billto/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},calculate:function(){var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discount=this.txtDiscount.getValue(),discountValue=0;if(this.txtDiscount.isValid()&&!Ext.isEmpty(discount)){if(discount.match(/%$/gi)){discount=discount.replace('%','');var discountPercent=parseFloat(discount);discountValue=total*discountPercent/100;}else{discountValue=parseFloat(discount);}
discountValue=isNaN(discountValue)?0:discountValue;this.txtDiscountValue.setValue(Ext.util.Format.usMoney(discountValue).replace(/\$/,''));if(discountValue>0)
this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscount.setValue('');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var net=total;this.txtNet.setValue(net);return net;}});;Ext.define('Account.Billto.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.invoiceDialog=Ext.create('Account.SInvoice.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"billto/loads_bt_item",reader:{type:'json',root:'rows',idProperty:'bilnr,vbelp'}},fields:['bilnr','vbelp','invnr','refnr','invdt','texts','itamt','ctyp1'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Receipt Item',scope:this,handler:this.removeRecord}]},{id:'RowNumber26',header:"No.",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Invoice Code",width:100,dataIndex:'invnr',align:'center',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.invoiceDialog.show();}},},{text:"Ref.No",width:150,dataIndex:'refnr',sortable:false,field:{type:'textfield'},},{text:"Invoice Date",width:80,xtype:'datecolumn',dataIndex:'invdt',sortable:false,renderer:Ext.util.Format.dateRenderer('m/d/Y')},{text:"Text Note",width:250,dataIndex:'texts',sortable:false,field:{type:'textfield'},},{text:"Invoice Amt",xtype:'numbercolumn',width:120,dataIndex:'itamt',sortable:false,align:'right',readOnly:true},{text:"Currency",width:55,dataIndex:'ctyp1',sortable:false,align:'center',field:{type:'textfield'},}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='invnr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'invoice/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.invnr);rModel.set('refnr',r.data.refnr);rModel.set('invdt',r.data.bldat);rModel.set('texts',r.data.txz01);rModel.set('itamt',r.data.netwr);rModel.set('ctyp1',r.data.ctype);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.invoiceDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('invnr',record.data.invnr);rModel.set('refnr',record.data.refnr);rModel.set('invdt',record.data.bldat);rModel.set('texts',record.data.txz01);rModel.set('itamt',record.data.netwr);rModel.set('ctyp1',record.data.ctype);}
grid.getSelectionModel().deselectAll();_this.invoiceDialog.hide();});this.store.on('load',function(store,rs){if(_this.readOnly){var view=_this.getView();var t=_this.getView().getEl().down('table');t.addCls('mask-grid-readonly');_this.readOnlyMask=new Ext.LoadMask(t,{msg:"..."});_this.readOnlyMask.show();}else{if(_this.readOnlyMask)
_this.readOnlyMask.hide();}});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,invnr:''};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();this.getSelectionModel().deselectAll();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},setCustomerCode:function(kunnr){this.customerCode=kunnr;var field=this.invoiceDialog.searchForm.form.findField('kunnr');field.setValue(kunnr);this.invoiceDialog.grid.load();}});;Ext.define('Account.Billto.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'Billing Note preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/billto/index/'+id+'/'+copies;}});;Ext.define('Account.Billto.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Billing Note',closeAction:'hide',height:650,width:950,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Billto.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.Billto.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.btnSave=Ext.create('Ext.Button',{text:'Save',disabled:!(UMS.CAN.CREATE('BT')||UMS.CAN.EDIT('BT')||UMS.CAN.APPROVE('BT')),handler:function(){_this.form.save();}});this.buttons=[this.btnSave,{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({bilnr:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}},setReadOnly:function(readOnly){var children=this.items?this.items.items:[];for(var i=0;i<children.length;i++){var child=children[i];child.query('.field').forEach(function(c){if(!c.initialConfig.readOnly){c.setReadOnly(readOnly);}});child.query('.button').forEach(function(c){if(c.xtype!='tab'){if(!c.initialConfig.disabled)
c.setDisabled(readOnly);}});}
this.form.gridItem.readOnly=readOnly;if(!this.btnSave.initialConfig.disabled)
this.btnSave.setDisabled(readOnly);}});;Ext.define('Account.Billto.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Bill To Customer',closeAction:'hide',height:600,minHeight:380,width:960,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('BT')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('BT')||UMS.CAN.CREATE('BT')||UMS.CAN.EDIT('BT'))});this.displayAct=new Ext.Action({text:'Display',iconCls:'b-small-search',disabled:!UMS.CAN.DISPLAY('BT')});this.deleteAct=new Ext.Action({text:'Delete',disabled:true,iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('BT')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('BT')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.Billto.Item.Window');this.grid=Ext.create('Account.Billto.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.displayAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.Billto.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(false);}});this.displayAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(true);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save Billing Note number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/billto/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.ChartOfAccounts.Import.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center',border:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.uploadAct=new Ext.Action({text:'Upload',iconCls:'b-small-save'});this.items=[{xtype:'filefield',name:'userfile',fieldLabel:'Excel file',labelAlign:'right',msgTarget:'side',allowBlank:false,anchor:'70%',buttonText:'Select Excel file...',allowBlank:false}];this.buttons=[this.uploadAct];this.uploadAct.setHandler(function(){_this.save();});return this.callParent(arguments);},save:function(){var _this=this,form=this.getForm();if(form.isValid()){_this.fireEvent('upload_click');form.submit({url:__site_url+'import/upload/do_upload',waitMsg:'Uploading excel file...',success:function(form,action){_this.fireEvent('upload_success',action.result.file);},failure:function(form,action){Ext.Msg.show({title:'An error occured.',msg:action.result.msg.error,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});}},reset:function(){this.getForm().reset();}});;Ext.define('Account.ChartOfAccounts.Import.Grid',{extend:'Ext.grid.Panel',constructor:function(config){Ext.apply(this,{viewConfig:{getRowClass:function(r,rowIndex,rowParams,store){var s=r.get('error');if(s&&s.length>0)
return'red-bg-row';}},buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.importAct=new Ext.Action({text:'Import',iconCls:'b-small-save'});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"import/ChartOfAccounts/read",reader:{type:'json',root:'rows',idProperty:'row_id'},simpleSortMode:true},fields:['row_id','saknr','sgtxt','entxt','glgrp','gllev','gltyp','overs','glcre','error'],remoteSort:false});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{text:"GL Code",width:50,align:'center',dataIndex:'saknr',sortable:false},{text:"GL Name",width:100,align:'center',dataIndex:'sgtxt',sortable:false},{text:"GL Name Eng",width:100,align:'center',dataIndex:'entxt',sortable:false},{text:"GL Group",width:50,align:'center',dataIndex:'glgrp',sortable:false},{text:"Level",width:30,align:'center',dataIndex:'gllev',sortable:false},{text:"GL Type",width:30,align:'center',dataIndex:'gltyp',sortable:false},{text:"GL Over",width:50,align:'center',dataIndex:'overs',sortable:false},{text:"Error",width:250,dataIndex:'error',sortable:false,renderer:function(v,p,r){return(v&&v.length>0)?v:'-';}}];this.buttons=[this.importAct];this.importAct.setHandler(function(){_this.importData();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},showMask:function(msg,msgClass){msg=msg||'Please select excel file for upload.';msgClass=msgClass||'grid-disable';this.importAct.setDisabled(true);this.getEl().mask(msg,msgClass);},hideMask:function(){this.importAct.setDisabled(false);this.getEl().unmask();},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();grid.getSelectionModel().deselectAll();},importData:function(){var _this=this;var rs=[];this.store.each(function(r){rs.push(r.getData());});if(rs.length>0){this.showMask('Importing please wait','');var data_json=Ext.encode(rs);Ext.Ajax.request({url:__site_url+'import/ChartOfAccounts/import',params:{data:data_json},success:function(response){var text=response.responseText;var data=Ext.decode(text);if(data.success){Ext.Msg.show({title:'Import success.',msg:'Import '+data.rows.length+' rows success.',buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO});_this.fireEvent('import_success',data);}else{_this.hideMask();Ext.Msg.show({title:'An error occured.',msg:response,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}},failure:function(response){Ext.Msg.show({title:'An error occured.',msg:response.responseText,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});}else{Ext.Msg.alert('Status','No datas to import.');}}});;Ext.define('Account.ChartOfAccounts.Import.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Chart of Accounts Import',closeAction:'hide',height:600,minHeight:480,width:1000,minWidth:600,resizable:true,modal:true,layout:'border',maximizable:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.ChartOfAccounts.Import.Form',{region:'north',height:80});this.grid=Ext.create('Account.ChartOfAccounts.Import.Grid',{region:'center',disbled:true});this.items=[this.form,this.grid];this.form.on('upload_success',function(file_name){_this.grid.hideMask();_this.grid.load({file:file_name});});return this.callParent(arguments);},openDialog:function(){this.form.reset();this.grid.store.removeAll();this.show(false,function(){this.grid.showMask();});}});;Ext.define('Account.ChartOfAccounts.MainWindow',{extend:'Ext.window.Window',constructor:function(config){var treid_edit="";var store_chart_account=Ext.create('Ext.data.ArrayStore',{fields:[{name:'treid',type:'string'},{name:'level',type:'string'},{name:'text1',type:'string'},{name:'leaf1',type:'string'},{name:'child',type:'string'},{name:'accid',type:'string'},{name:'tname',type:'string'},{name:'ename',type:'string'},{name:'accty',type:'string'},{name:'accgr',type:'string'},{name:'deptx',type:'string'},{name:'glgrp',type:'string'}],sortInfo:{field:'treid',direction:'ASC'}});var store_account_group=Ext.create('Ext.data.Store',{fields:['glgrp','name'],data:[{"glgrp":"1","name":"สินทรัพย์"},{"glgrp":"2","name":"หนี้สิน"},{"glgrp":"3","name":"ส่วนของเจ้าของ"},{"glgrp":"4","name":"รายได้"},{"glgrp":"5","name":"ค่าใช้จ่าย"}],sortInfo:{field:'glgrp',direction:'ASC'}});var store_group_account=Ext.create('Ext.data.ArrayStore',{fields:[{name:'treid',type:'string'},{name:'accid',type:'string'}],sortInfo:{field:'accid',direction:'ASC'}});var store_department=Ext.create('Ext.data.ArrayStore',{fields:[{name:'depid',type:'string'},{name:'deptx',type:'string'}],sortInfo:{field:'deptx',direction:'ASC'}});var store_tree_chart=Ext.create('Ext.data.TreeStore',{proxy:{type:'ajax',reader:'json',url:__site_url+'chartofaccounts/GetTreeChart'}});var tree=Ext.create('Ext.tree.Panel',{loadMask:true,width:230,autoScroll:true,useArrows:true,rootVisible:false,store:store_tree_chart});var LeftPanel=Ext.create('Ext.Panel',{layout:'fit',width:550,height:440,items:[tree]});var loadMask=new Ext.LoadMask(LeftPanel,{msg:'Wait message',store:store_tree_chart});var txtID=Ext.create('Ext.form.Text',{fieldLabel:'GL No',layout:'absolute',fieldStyle:'text-align: left;',width:300,x:50,y:25});var txtNameT=Ext.create('Ext.form.TextArea',{fieldLabel:'Name Thai',layout:'absolute',fieldStyle:'text-align: left;',width:300,height:60,x:50,y:55});var txtNameE=Ext.create('Ext.form.TextArea',{fieldLabel:'Name Eng',layout:'absolute',fieldStyle:'text-align: left;',width:300,height:60,x:50,y:125});var rdSmallAccount=Ext.create('Ext.form.Radio',{fieldLabel:'Account Type',x:50,y:195,boxLabel:'Sub Account',checked:true,inputValue:'2'});var rdGroupAccount=Ext.create('Ext.form.Radio',{x:280,y:195,boxLabel:'Group Account',inputValue:'1'});var cbAccount=Ext.create('Ext.form.ComboBox',{rtl:false,fieldLabel:'Account Group',x:50,y:225,width:300,emptyText:'Select Account Group',triggerAction:'all',lazyRender:true,selectOnFocus:true,store:store_account_group,queryMode:'local',displayField:'name',valueField:'glgrp'});var cbAccountGroup=Ext.create('Ext.form.ComboBox',{rtl:false,fieldLabel:'Account Under',x:50,y:255,width:300,emptyText:'Select Account',triggerAction:'all',lazyRender:true,selectOnFocus:true,store:store_group_account,queryMode:'local',displayField:'accid',valueField:'treid'});var cbDepartment=Ext.create('Ext.form.ComboBox',{rtl:false,fieldLabel:'Department',x:50,y:285,width:300,emptyText:'Select Department',triggerAction:'all',lazyRender:true,selectOnFocus:true,store:store_department,queryMode:'local',displayField:'deptx',valueField:'depid'});var btnSave=Ext.create('Ext.Button',{text:'Save',width:80,x:180,y:320,handler:function(){SaveData();}});var btnCancel=Ext.create('Ext.Button',{text:'Cancel',width:80,x:270,y:320,handler:function(){GetDisable();GetReset();btnEdit.setDisabled(true);}});var btnAdd=Ext.create('Ext.Button',{text:'Add',iconCls:'b-small-plus',width:60,disable:!UMS.CAN.CREATE('CA'),handler:function(){txtID.setReadOnly(false);GetEnable();btnEdit.setDisabled(true);GetReset();}});var btnEdit=Ext.create('Ext.Button',{text:'Edit',iconCls:'b-small-pencil',width:60,handler:function(){if(txtID.getRawValue()!="")
{GetEnable();}}});var btnImport=Ext.create('Ext.Button',{text:'Import',iconCls:'b-small-import',width:60,disable:!UMS.CAN.CREATE('CA'),handler:function(){this.importDialog=Ext.create('Account.ChartOfAccounts.Import.Window');this.importDialog.show();}});var RightPanel=Ext.create('Ext.Panel',{bodyPadding:'5 10 0 10',layout:'fit',border:true,width:440,height:435,items:[{xtype:'fieldset',title:'Account Detail',defaultType:'textfield',layout:'absolute',items:[txtID,txtNameT,txtNameE,rdSmallAccount,rdGroupAccount,cbAccount,cbAccountGroup,cbDepartment,btnSave,btnCancel]}]});function WaitBox(){Ext.MessageBox.show({msg:'กรุณารอสักครู่.....',closable:false,width:150});}
function HideWaitBox(){Ext.MessageBox.hide();}
function GetAccountChart()
{Ext.Ajax.request({url:__site_url+'chartofaccounts/GetAccountChart',disableCaching:false,success:function(res){var arrChart=res.responseText.split('|');var detail=arrChart;var data;var myData=new Array();var i;var strTemp;if(detail!=''){for(i=0;i<arrChart.length;i++){data=new Array();strTemp=arrChart[i].split('+');data[0]=strTemp[0];data[1]=strTemp[1];data[2]=strTemp[2];data[3]=strTemp[3];data[4]=strTemp[4];data[5]=strTemp[5];data[6]=strTemp[6];data[7]=strTemp[7];data[8]=strTemp[8];data[9]=strTemp[9];data[10]=strTemp[10];data[11]=strTemp[11];myData[i]=data;}}
else{data=new Array();myData=data;}
store_chart_account.loadData(myData);}});}
function GetGroupAccount()
{Ext.Ajax.request({url:__site_url+'chartofaccounts/GetGroupAccount',disableCaching:false,success:function(res){var arrGRACC=res.responseText.split('|');var detail=arrGRACC;var data;var myData=new Array();var i;var strTemp;if(detail!=''){for(i=0;i<arrGRACC.length;i++){data=new Array();strTemp=arrGRACC[i].split('+');data[0]=strTemp[0];data[1]=strTemp[1];myData[i]=data;}}
else{data=new Array();myData=data;}
store_group_account.loadData(myData);}});}
function GetDepartment()
{Ext.Ajax.request({url:__site_url+'chartofaccounts/GetDepartment',disableCaching:false,success:function(res){var arrDep=res.responseText.split('|');var detail=arrDep;var data;var myData=new Array();var i;var strTemp;if(detail!=''){for(i=0;i<arrDep.length;i++){data=new Array();strTemp=arrDep[i].split('+');data[0]=strTemp[0];data[1]=strTemp[1];myData[i]=data;}}
else{data=new Array();myData=data;}
store_department.loadData(myData);}});}
function SaveData()
{if(txtID.getRawValue()=="")
{Ext.MessageBox.alert('','please insert id');return;}
if(cbDepartment.getRawValue()=="")
{Ext.MessageBox.alert('','please select department');return;}
if(txtNameT.getRawValue()=="")
{Ext.MessageBox.alert('','please insert thai name');return;}
var treid=treid_edit;var level="";var leaf1="";var child="";var accid=txtID.getRawValue();var tname=txtNameT.getRawValue();var ename=txtNameE.getRawValue();var accty="";var accgr=cbAccountGroup.getRawValue();var deptx=cbDepartment.getRawValue();var glgrp=cbAccount.getValue();if(rdSmallAccount.getValue())
{accty="2";leaf1="true";}
else{accty="1";leaf1="false";}
var index=store_chart_account.find('accid',accgr);if(index>-1)
{rt=store_chart_account.getAt(index);level=parseInt(rt.get('level'))+1;child=rt.get('treid');}
else{if(rdGroupAccount.getValue())
{level=1;child="";}
else
{level=1;child="";}}
var strParam="?treid="+treid+"&level="+level+"&leaf1="+leaf1+"&child="+child+"&accid="+accid;strParam=strParam+"&tname="+tname+"&ename="+ename+"&accty="+accty+"&accgr="+accgr;strParam=strParam+"&deptx="+deptx+"&glgrp="+glgrp;Ext.Ajax.request({url:__site_url+'chartofaccounts/SaveTree'+strParam,disableCaching:false,success:function(res){store_tree_chart.load();GetAccountChart();GetGroupAccount();GetReset();GetDisable();btnEdit.setDisabled(true);}});}
function GetReset()
{txtID.setValue('');txtNameT.setValue('');txtNameE.setValue('');cbAccount.setValue('');cbAccountGroup.reset();cbDepartment.reset();treid_edit="";}
function GetDisable()
{txtID.setReadOnly(true);txtNameT.setReadOnly(true);txtNameE.setReadOnly(true);cbAccount.setReadOnly(true);cbAccountGroup.setReadOnly(true);cbDepartment.setReadOnly(true);rdGroupAccount.setReadOnly(true);rdSmallAccount.setReadOnly(true);btnSave.setDisabled(true);btnCancel.setDisabled(true);}
function GetEnable()
{txtNameT.setReadOnly(false);txtNameE.setReadOnly(false);cbAccount.setReadOnly(false);cbAccountGroup.setReadOnly(false);cbDepartment.setReadOnly(false);rdGroupAccount.setReadOnly(false);rdSmallAccount.setReadOnly(false);btnSave.setDisabled(false);btnCancel.setDisabled(false);btnEdit.setDisabled(false);}
GetAccountChart();GetGroupAccount();GetDepartment();GetDisable();btnEdit.setDisabled(true);Ext.apply(this,{title:'Chart Of Accounts',closeAction:'hide',height:500,width:1000,minWidth:750,resizable:false,modal:true,layout:'hbox',maximizable:false,items:[LeftPanel,RightPanel],tbar:[btnAdd,btnEdit,btnImport],buttons:[]});tree.on('cellclick',function(tree,td,cellIndex,rec,tr,rowIndex,e,eOpts){btnEdit.setDisabled(false);GetDisable();var strText=rec.get('id');var index=store_chart_account.find('treid',strText);if(index>-1)
{rt=store_chart_account.getAt(index);txtID.setValue(rt.get('accid'));txtNameT.setValue(rt.get('tname'));txtNameE.setValue(rt.get('ename'));cbAccount.setValue(rt.get('glgrp'));cbAccountGroup.setValue(rt.get('accgr'));cbDepartment.setValue(rt.get('deptx'));treid_edit=rt.get('treid');if(rt.get('accty')=="2")
{rdSmallAccount.setValue(true);rdGroupAccount.setValue(false);}
else{rdGroupAccount.setValue(true);rdSmallAccount.setValue(false);}}});rdSmallAccount.on('change',function(rdSmallAccount,newValue,oldValue,eOpts){if(rdSmallAccount.getValue()){rdGroupAccount.setValue(false);return;}});rdGroupAccount.on('change',function(rdGroupAccount,newValue,oldValue,eOpts){if(rdGroupAccount.getValue()){rdSmallAccount.setValue(false);return;}});return this.callParent(arguments);}});;Ext.define('Account.Company.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'company/loads',reader:{type:'json',root:'rows',idProperty:'comid',totalProperty:'totalCount'}},fields:['comid','name1','name2','adr01','distx','pstlz','telf1','telfx','email'],remoteSort:true,sorters:['lifnr ASC']});this.columns=[{text:"Code",width:50,dataIndex:'comid',sortable:true},{text:"Name",width:150,dataIndex:'name1',sortable:true},{text:"Eng-Name",width:150,dataIndex:'name2',sortable:true},{text:"Address",width:200,dataIndex:'adr01',sortable:true},{text:"District",flex:true,dataIndex:'distx',sortable:true},{text:"Postcode",width:50,dataIndex:'pstlz',sortable:true},{text:"Telephon",flex:true,dataIndex:'telf1',sortable:true},{text:"Fax No",flex:true,dataIndex:'telfx',sortable:true},{text:"Email",width:120,dataIndex:'email',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Company.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'company/save',border:false,fieldDefaults:{msgTarget:'side',labelWidth:120,}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.distrDialog=Ext.create('Account.SDistrict.MainWindow');this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'Company Status',name:'statu',labelWidth:110,width:290,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'customer/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payments',name:'ptype',width:290,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'customer/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});var myStorecomboLang=Ext.create('Ext.data.Store',{fields:['idLang','name'],data:[{"idLang":"01","name":"TH"},{"idLang":"02","name":"EN"}]});this.comboLang=Ext.create('Ext.form.ComboBox',{fieldLabel:'Language',name:'langu',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select Language --',labelWidth:110,width:290,store:myStorecomboLang,queryMode:'local',displayField:'name',valueField:'idLang'});var myStorecomboCO=Ext.create('Ext.data.Store',{fields:['idCO','name'],data:[{"idCO":"01","name":"First Come First Out"},{"idCO":"02","name":"Average"}]});this.comboCO=Ext.create('Ext.form.ComboBox',{fieldLabel:'Cost of Goods Sold',name:'cotyp',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select Cost --',labelWidth:110,width:290,store:myStorecomboCO,queryMode:'local',displayField:'name',valueField:'idCO'});var myStorecomboPost=Ext.create('Ext.data.Store',{fields:['idPost','name'],data:[{"idPost":"01","name":"Periodic"},{"idPost":"02","name":"Perpetual"}]});this.comboPost=Ext.create('Ext.form.ComboBox',{fieldLabel:'Meditation',name:'recty',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select Post --',labelWidth:110,width:290,store:myStorecomboPost,queryMode:'local',displayField:'name',valueField:'idPost'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat Type',name:'taxnr',width:290,labelWidth:110,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select Type --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.numberVat=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Vat Value',name:'vat01',labelWidth:110,width:290,hideTrigger:false});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:290,labelWidth:110});this.trigDistr=Ext.create('Ext.form.field.Trigger',{name:'distx',fieldLabel:'Province',triggerCls:'x-form-search-trigger',enableKeyEvents:true,labelWidth:100,width:290});this.items=[{xtype:'hidden',name:'id'},{items:[{xtype:'container',layout:'anchor',margin:'10',items:[{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{},{xtype:'displayfield',fieldLabel:'Company Code',name:'comid',emptyText:'XXXXX',readOnly:true,width:200,labelWidth:110,value:'XXXXX',labelStyle:'font-weight:bold'}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',fieldLabel:'Company Name',name:'name1',labelWidth:110,allowBlank:false,width:470}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',fieldLabel:'English Name',name:'name2',labelWidth:110,width:470}]},{xtype:'fieldset',title:'Address',items:[{xtype:'textarea',fieldLabel:'Address',name:'adr01',labelWidth:100,width:460},this.trigDistr,{xtype:'textfield',fieldLabel:'Post Code',name:'pstlz',emptyText:'xxxxx',width:290,labelWidth:100,maskRe:/[\d\-]/,regex:/^\d{5}$/,regexText:'Must be in the format xxxxx'},{xtype:'textfield',fieldLabel:'Phone Number',name:'telf1',labelWidth:100,width:290,emptyText:'xxx-xxxxxxx',maskRe:/[\d\-]/,},{xtype:'textfield',fieldLabel:'Fax Number',name:'telfx',width:290,labelWidth:100},{xtype:'textfield',fieldLabel:'Email',name:'email',labelWidth:100,width:460},{xtype:'textfield',fieldLabel:'Tax ID',name:'taxid',maskRe:/[\d]/,labelWidth:100,width:290},{xtype:'textfield',fieldLabel:'Business Register',name:'regno',maskRe:/[\d]/,labelWidth:100,width:290}]},this.comboCO,this.comboPost,this.comboTax,this.numberVat,this.trigCurrency,this.comboLang,this.comboQStatus]}]}];this.trigDistr.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'sdistrict/loads',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.trigDistr.setValue(record.data.distx);}else{o.markInvalid('Could not find Province : '+o.getValue());}}});}},this);_this.distrDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigDistr.setValue(record.data.distx);grid.getSelectionModel().deselectAll();_this.distrDialog.hide();});this.trigDistr.onTriggerClick=function(){_this.distrDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};return this.callParent(arguments);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'company/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},reset:function(){this.getForm().reset();this.comboQStatus.setValue('01');},remove:function(lifnr){var _this=this;this.getForm().load({params:{lifnr:lifnr},url:__site_url+'company/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});}});;Ext.define('Account.Company.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Company',closeAction:'hide',height:650,width:530,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Company.Item.Form');this.items=this.form;this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);}else{this.dialogId=null;this.form.reset();this.show(false);}}});;Ext.define('Account.Company.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Company Management',closeAction:'hide',height:380,minHeight:380,width:1000,minWidth:1000,resizable:true,modal:true,layout:'border',maximizable:true,defaultFocus:'code'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('CC')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('CC')||UMS.CAN.CREATE('CC')||UMS.CAN.EDIT('CC'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('CC')});this.itemDialog=Ext.create('Account.Company.Item.Window');this.grid=Ext.create('Account.Company.Grid',{region:'center'});this.items=[this.grid];this.tbar=[this.addAct,this.editAct,this.deleteAct];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form){_this.itemDialog.hide();_this.grid.load();});this.itemDialog.form.on('afterDelete',function(form){_this.grid.load();});this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Configauthen.MainWindow',{extend:'Ext.window.Window',constructor:function(config){var nodeUserAuthen={text:'User Authen',leaf:true};var nodeDocLimitAmount={text:'Document limit amount',leaf:true};var groupNodeAuthen={text:'ConfigAuthen',leaf:false,expanded:true,singleClickExpand:true,children:[nodeUserAuthen,nodeDocLimitAmount]};var tree=Ext.create('Ext.tree.TreePanel',{region:'west',collapsible:false,width:230,autoScroll:true,split:true,useArrows:true,rootVisible:false,root:{expanded:true,children:[groupNodeAuthen]}});var LeftPanel=Ext.create('Ext.Panel',{layout:'fit',width:200,height:600,items:[tree]});var UserDefine=Ext.create('Account.Configauthen.UserDefine',{region:'center'});var PanelAuthenDoc=Ext.create('Account.Configauthen.PanelAuthenDoc',{region:'center'});var RightPanel=Ext.create('Ext.Panel',{layout:'fit',items:[UserDefine,PanelAuthenDoc]});Ext.apply(this,{title:'Config Authen',closeAction:'hide',height:600,minHeight:570,width:1000,minWidth:750,resizable:false,modal:true,layout:'hbox',maximizable:false,items:[LeftPanel,RightPanel],buttons:[]});tree.on('cellclick',function(tree,td,cellIndex,rec,tr,rowIndex,e,eOpts){if(tr.innerHTML.indexOf('Document limit amount')>-1)
{UserDefine.setVisible(false);PanelAuthenDoc.setVisible(true);return;}
if(tr.innerHTML.indexOf('User Authen')>-1)
{UserDefine.setVisible(true);PanelAuthenDoc.setVisible(false);return;}});return this.callParent(arguments);}});;Ext.define('Account.Configauthen.MainWindowxx',{extend:'Ext.window.Window',constructor:function(config){var store_edit_authen=Ext.create('Ext.data.ArrayStore',{fields:[{name:'doctx',type:'string'},{name:'docty',type:'string'},{name:'create',type:'string'},{name:'edit',type:'string'},{name:'delete',type:'string'},{name:'export',type:'string'},{name:'approve',type:'string'},{name:'uname',type:'string'}],sortInfo:{field:'doctx',direction:'ASC'}});var grid_edit_authen=Ext.create('Ext.grid.Panel',{title:'',store:store_edit_authen,columns:[{id:'doctx',text:"Doc Type",align:'left',width:180,dataIndex:'doctx',sortable:true},{text:"Create",align:'center',width:100,renderer:SetFieldAuthen,dataIndex:'create',sortable:true},{text:"Edit",align:'center',width:100,renderer:SetFieldAuthen,dataIndex:'edit',sortable:true},{text:"Delete",align:'center',width:100,renderer:SetFieldAuthen,dataIndex:'delete',sortable:true},{text:"Export",align:'center',width:100,renderer:SetFieldAuthen,dataIndex:'export',sortable:true},{text:"Approve",align:'center',width:100,renderer:SetFieldAuthen,dataIndex:'approve',sortable:true}],autoExpandColumn:'doctx',bbar:[]});var store_employee=Ext.create('Ext.data.ArrayStore',{fields:[{name:'empnr',type:'string'},{name:'name1',type:'string'},{name:'email',type:'string'},{name:'postx',type:'string'},{name:'deptx',type:'string'},{name:'uname',type:'string'},{name:'passw',type:'string'}],sortInfo:{field:'name1',direction:'ASC'}});var grid_employee=Ext.create('Ext.grid.Panel',{title:'',store:store_employee,columns:[{text:"Code",align:'left',width:50,dataIndex:'empnr',sortable:true},{id:'name1',text:"Name",align:'left',width:120,dataIndex:'name1',sortable:true},{text:"Email",align:'left',width:160,dataIndex:'email',sortable:true},{text:"Position",align:'left',width:120,dataIndex:'postx',sortable:true},{text:"Department",align:'left',width:120,dataIndex:'deptx',sortable:true}],autoExpandColumn:'name1',bbar:[]});var txtEmployee=Ext.create('Ext.form.field.Trigger',{x:20,y:16,width:200,fieldLabel:'Employee Code',triggerCls:'x-form-search-trigger',labelAlign:'left',enableKeyEvents:true,allowBlank:false});var lblEmployeeName=Ext.create('Ext.form.Label',{x:260,y:20,margin:'0 0 0 20',text:""});var cbEmployee=Ext.create('Ext.form.ComboBox',{rtl:false,x:140,y:16,width:200,emptyText:'Select Employee',triggerAction:'all',lazyRender:true,selectOnFocus:true,queryMode:'local',displayField:'company_name',valueField:'company_id',});var txtUserName=Ext.create('Ext.form.Text',{fieldLabel:'User Name',layout:'absolute',margin:'5 0 0 0',fieldStyle:'text-align: left;',width:300,x:20,y:45});var txtPassword=Ext.create('Ext.form.Text',{fieldLabel:'Password',margin:'5 0 5 0',layout:'absolute',fieldStyle:'text-align: left;',width:300,x:20,y:75});var form_configauthen=Ext.create('Ext.form.Panel',{layout:'absolute',frame:true,items:[txtEmployee,lblEmployeeName,txtUserName,txtPassword]});var TopPanel=Ext.create('Ext.Panel',{bodyPadding:'5 10 0 10',layout:'fit',border:true,width:740,height:160,items:[{xtype:'fieldset',title:'User Data',collapsible:true,defaultType:'textfield',layout:'anchor',items:[{xtype:'container',layout:'hbox',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',items:[{xtype:'hidden',name:'id'},txtEmployee,lblEmployeeName,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:350,allowBlank:true}]},txtUserName,txtPassword]},{xtype:'container',layout:'anchor',items:[]}]}]}]});var ButtomPanel=Ext.create('Ext.Panel',{layout:'fit',width:740,height:380,items:[grid_edit_authen]});var win_employee_pop_up=Ext.create('Ext.Window',{title:'',closeAction:'hide',height:300,width:600,resizable:false,modal:true,layout:'fit',maximizable:false,items:[grid_employee]});var btnSave=Ext.create('Ext.Button',{text:'Save',width:80,handler:function(){var empnr=txtEmployee.getRawValue();GetSaveEditApprove(empnr);}});var btnCancel=Ext.create('Ext.Button',{text:'Cancel',width:80,handler:function(){}});function AjaxCaller()
{var xmlhttp=false;try{xmlhttp=new ActiveXObject("Msxml2.XMLHTTP");}catch(e){try{xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");}catch(E){xmlhttp=false;}}
if(!xmlhttp&&typeof XMLHttpRequest!='undefined'){xmlhttp=new XMLHttpRequest();}
return xmlhttp;}
function callPage(url,func,param){ajax=AjaxCaller();ajax.open("GET",url+func+param,true);ajax.onreadystatechange=function(){if(ajax.readyState==4){if(ajax.status==200){switch(func)
{case"GetUserAuthen":GetUserAuthen(ajax.responseText);break;case"GetSaveEditApprove":Ext.MessageBox.show({title:'',msg:'Save Complete',icon:Ext.MessageBox.INFO});callPage(__site_url+"Configauthen?func=","GetUserAuthen","&empnr="+txtEmployee.getRawValue());break;case"GetEmployee":GetEmployee(ajax.responseText);break;}}}}
ajax.send(null);}
function SetFieldAuthen(val)
{if(val==1)
{return"<img src='assets/images/icons/accept.png' />";}
return"<img src='assets/images/icons/cross.png' />";}
function GetEmployee(strData)
{var arrEmp=strData.split('|');var detail=arrEmp;var data;var myData=new Array();var i;var strTemp;if(detail!=''){for(i=0;i<arrEmp.length;i++){data=new Array();strTemp=arrEmp[i].split('+')
data[0]=strTemp[0];data[1]=strTemp[1];data[2]=strTemp[2];data[3]=strTemp[3];data[4]=strTemp[4];data[5]=strTemp[5];data[6]=strTemp[6];myData[i]=data;}}
else{data=new Array();myData=data;}
store_employee.loadData(myData);}
function GetUserAuthen(strData)
{var arrEmp=strData.split('|');var detail=arrEmp;var data;var myData=new Array();var i;var strTemp;if(detail!=''){for(i=0;i<arrEmp.length;i++){data=new Array();strTemp=arrEmp[i].split('+')
data[0]=strTemp[0];data[1]=strTemp[1];data[2]=strTemp[2];data[3]=strTemp[3];data[4]=strTemp[4];data[5]=strTemp[5];data[6]=strTemp[6];myData[i]=data;}}
else{data=new Array();myData=data;}
store_edit_authen.loadData(myData);}
function GetSaveEditApprove(empnr)
{var sSql="";var strResult="";var uname=txtUserName.getRawValue();var passw=txtPassword.getRawValue();if(uname==""||passw=="")
{Ext.MessageBox.show({title:'',msg:'Please enter name and password !!!'});return;}
for(i=0;i<store_edit_authen.getCount();i++)
{rt=store_edit_authen.getAt(i);sSql=sSql+rt.get('docty')+"+"+rt.get('create')+rt.get('edit')+rt.get('delete')+rt.get('export')+rt.get('approve')+"|";}
if(sSql!="")
{sSql=sSql.substr(0,sSql.length-1);}
strResult="&passw="+passw+"&uname="+uname+"&empnr="+empnr+"&authen="+sSql;callPage(__site_url+"Configauthen?func=","GetSaveEditApprove",strResult);}
grid_edit_authen.on('cellclick',function(grid_edit_authen,td,cellIndex,record,tr,rowIndex,e,eOpts){if(cellIndex==1)
{if(record.get('create')=="0")
{record.set('create',1);}
else{record.set('create',"0");}
return;}
if(cellIndex==2)
{if(record.get('edit')=="0")
{record.set('edit',1);}
else{record.set('edit',"0");}
return;}
if(cellIndex==3)
{if(record.get('delete')=="0")
{record.set('delete',1);}
else{record.set('delete',"0");}
return;}
if(cellIndex==4)
{if(record.get('export')=="0")
{record.set('export',1);}
else{record.set('export',"0");}
return;}
if(cellIndex==5)
{if(record.get('approve')=="0")
{record.set('approve',1);}
else{record.set('approve',"0");}
return;}});txtEmployee.onTriggerClick=function(){callPage(__site_url+"Configauthen?func=","GetEmployee","");win_employee_pop_up.show();};grid_employee.on('cellclick',function(grid_employee,td,cellIndex,rec,tr,rowIndex,e,eOpts){txtEmployee.setValue(rec.get('empnr'));txtUserName.setValue(rec.get('uname'));txtPassword.setValue(rec.get('passw'));lblEmployeeName.setText(rec.get('name1'));callPage(__site_url+"Configauthen?func=","GetUserAuthen","&empnr="+rec.get('empnr'));win_employee_pop_up.hide();});Ext.apply(this,{title:'Config Document',closeAction:'hide',height:570,minHeight:570,width:750,minWidth:750,resizable:true,modal:true,layout:'vbox',maximizable:true,items:[TopPanel,ButtomPanel],buttons:['->',btnSave,btnCancel]});return this.callParent(arguments);}});;Ext.define('Account.Configauthen.PanelAuthenDoc',{extend:'Ext.form.Panel',constructor:function(config){var rec_empl=null;var rec_doct=null;var rec_limit_amount=null;var store_limit_amount=Ext.create('Ext.data.ArrayStore',{fields:[{name:'rowno',type:'string'},{name:'amoid',type:'string'},{name:'rowid',type:'string'},{name:'grptx',type:'string'},{name:'docty',type:'string'},{name:'liamo',type:'string'}],sortInfo:{field:'amoid',direction:'ASC'}});var btnAddLimitPopUp=Ext.create('Ext.Button',{text:'Add',iconCls:'b-small-plus',width:60,handler:function(){win_add_limit_amount.show();}});var grid_limit_amount=Ext.create('Ext.grid.Panel',{title:'Doc Type : ',store:store_limit_amount,columns:[{text:"  ",align:'center',width:30,renderer:RenderfieldDelete,dataIndex:'limit_amount_row_delete',sortable:true},{text:"  ",align:'center',width:30,renderer:RenderFieldDetail,dataIndex:'limit_amount_row_edit',sortable:true},{text:"No.",align:'center',width:40,dataIndex:'rowno',sortable:true},{text:"grptx",align:'center',width:220,dataIndex:'grptx',sortable:true},{text:"docty",align:'center',width:80,dataIndex:'docty',sortable:true},{text:"Limit Amount",align:'center',width:140,dataIndex:'liamo',sortable:true}],autoExpandColumn:'budget_limit_doc_name',tbar:[btnAddLimitPopUp]});var lblLimitAmount=Ext.create('Ext.form.Label',{layout:'absolute',x:20,y:20,text:'Limit Amount : '});var txtLimitAmount=Ext.create('Ext.form.Text',{layout:'absolute',fieldStyle:'text-align: right;',width:140,x:110,y:20});var btnOkAddLimitAmount=Ext.create('Ext.Button',{text:'ตกลง',x:110,y:50,width:80,handler:function(){var amount_param=txtLimitAmount.getRawValue();AddLimitAmount(amount_param);win_add_limit_amount.hide();txtLimitAmount.setValue('');}});var form_add_limit_amount=Ext.create('Ext.form.Panel',{layout:'absolute',frame:true,height:140,width:200,items:[lblLimitAmount,txtLimitAmount,btnOkAddLimitAmount]});var win_add_limit_amount=Ext.create('Ext.Window',{title:'',closeAction:'hide',height:140,width:300,resizable:false,modal:true,layout:'fit',maximizable:false,items:[form_add_limit_amount]});var TopPanel=Ext.create('Ext.Panel',{layout:'fit',width:1000,height:370,items:[grid_limit_amount]});var store_authen_aprove=Ext.create('Ext.data.ArrayStore',{fields:[{name:'rowno',type:'string'},{name:'levid',type:'string'},{name:'amoid',type:'string'},{name:'empnr',type:'string'},{name:'name1',type:'string'},{name:'postx',type:'string'},{name:'deptx',type:'string'}],sortInfo:{field:'levid',direction:'ASC'}});var btnAddEmpPopUp=Ext.create('Ext.Button',{text:'Add',iconCls:'b-small-plus',width:60,handler:function(){win_add_emp_approve.show();}});var grid_authen_aprove=Ext.create('Ext.grid.Panel',{height:200,title:'Doc Type:',store:store_authen_aprove,plugins:[Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1})],columns:[{text:"  ",align:'center',width:30,renderer:RenderfieldDelete,dataIndex:'authen_aprove_row_delete',sortable:true},{text:"No.",align:'center',width:40,dataIndex:'rowno',sortable:false},{text:"Name",align:'center',width:160,dataIndex:'name1',field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){win_add_emp_approve.show();}},sortable:true},{text:"Postx",align:'center',width:160,dataIndex:'postx',sortable:true},{text:"Deptx",align:'center',width:160,dataIndex:'deptx',sortable:true}],autoExpandColumn:'name1',tbar:[btnAddEmpPopUp],bbar:['->',{text:'Save',hidden:true,width:100,handler:function(){}},{text:'Cancel',hidden:true,width:100,handler:function(){}}]});var ButtomPanel=Ext.create('Ext.Panel',{layout:'fit',width:740,height:200,items:[grid_authen_aprove]});var store_doct=Ext.create('Ext.data.ArrayStore',{fields:[{name:'grptx',type:'string'},{name:'docty',type:'string'},{name:'doctx',type:'string'},{name:'grpmo',type:'string'}],sortInfo:{field:'grptx',direction:'ASC'}});var grid_doct=Ext.create('Ext.grid.Panel',{title:'All Doc Type ',store:store_doct,columns:[{text:"Doctx",align:'left',width:160,dataIndex:'doctx',sortable:true}]});var LeftPanel=Ext.create('Ext.Panel',{layout:'fit',width:200,height:600,items:[grid_doct]});var RightPanel=Ext.create('Ext.Panel',{layout:'vbox',width:750,height:600,items:[TopPanel,ButtomPanel]});var store_add_emp_approve=Ext.create('Ext.data.ArrayStore',{fields:[{name:'empnr',type:'string'},{name:'name1',type:'string'},{name:'postx',type:'string'},{name:'deptx',type:'string'}],sortInfo:{field:'name1',direction:'ASC'}});var grid_add_emp_approve=Ext.create('Ext.grid.Panel',{store:store_add_emp_approve,columns:[{text:"Name",align:'left',width:120,dataIndex:'name1',sortable:true},{text:"Position",align:'left',width:140,dataIndex:'postx',sortable:true}],tbar:[{text:'Add',iconCls:'b-small-plus',width:60,handler:function(){AddEmplAuth();win_add_emp_approve.hide();}}]});var win_add_emp_approve=Ext.create('Ext.Window',{title:'',closeAction:'hide',height:400,width:300,resizable:false,modal:true,layout:'fit',maximizable:false,items:[grid_add_emp_approve]});function GET_TBL_DOCT()
{Ext.Ajax.request({url:__site_url+'configauthen/GET_TBL_DOCT',disableCaching:false,success:function(res){var arrDoct=res.responseText.split('|');var detail=arrDoct;var data;var myData=new Array();var i;var strTemp;if(detail!=''){for(i=0;i<arrDoct.length;i++){data=new Array();strTemp=arrDoct[i].split('+')
data[0]=strTemp[0];data[1]=strTemp[1];data[2]=strTemp[2];data[3]=strTemp[3];myData[i]=data;}}
else{data=new Array();myData=data;}
store_doct.loadData(myData);}});}
function GET_EMPL_APPROVE(docty)
{Ext.Ajax.request({url:__site_url+'configauthen/GET_EMPL_APPROVE?docty='+docty,disableCaching:false,success:function(res){var arrEmp=res.responseText.split('|');var detail=arrEmp;var data;var myData=new Array();var i;var strTemp;if(detail!=''){for(i=0;i<arrEmp.length;i++){data=new Array();strTemp=arrEmp[i].split('+')
data[0]=strTemp[0];data[1]=strTemp[1];data[2]=strTemp[2];data[3]=strTemp[3];myData[i]=data;}}
else{data=new Array();myData=data;}
store_add_emp_approve.loadData(myData);}});}
function GET_TBL_AMOU(docty)
{Ext.Ajax.request({url:__site_url+'configauthen/GET_TBL_AMOU?docty='+docty,disableCaching:false,success:function(res){var arrLimit=res.responseText.split('|');var detail=arrLimit;var data;var myData=new Array();var i;var strTemp;if(detail!=''){for(i=0;i<arrLimit.length;i++){data=new Array();strTemp=arrLimit[i].split('+')
data[0]=strTemp[0];data[1]=strTemp[1];data[2]=strTemp[2];data[3]=strTemp[3];data[4]=strTemp[4];data[5]=strTemp[5];myData[i]=data;}}
else{data=new Array();myData=data;}
store_limit_amount.loadData(myData);}});}
function GET_TBL_AUAM(amoid)
{Ext.Ajax.request({url:__site_url+'configauthen/GET_TBL_AUAM?amoid='+amoid,disableCaching:false,success:function(res){var arrAuam=res.responseText.split('|');var detail=arrAuam;var data;var myData=new Array();var i;var strTemp;if(detail!=''){for(i=0;i<arrAuam.length;i++){data=new Array();strTemp=arrAuam[i].split('+')
data[0]=strTemp[0];data[1]=strTemp[1];data[2]=strTemp[2];data[3]=strTemp[3];data[4]=strTemp[4];data[5]=strTemp[5];data[6]=strTemp[6];myData[i]=data;}}
else{data=new Array();myData=data;}
store_authen_aprove.loadData(myData);}});}
function AddLimitAmount(amount_param)
{var myRowid=store_limit_amount.getCount()+1;var myAmoid="";var myDocty=rec_doct.get('docty');Ext.Ajax.request({url:__site_url+'configauthen/GetSaveAmount?rowid='+myRowid+'&amoid='+myAmoid+'&docty='+myDocty+'&liamo='+amount_param,disableCaching:false,success:function(res){GET_TBL_AMOU(myDocty);}});}
function AddEmplAuth()
{var myLevid=store_authen_aprove.getCount()+1;var myAmoid=rec_limit_amount.get('amoid');var myEmpnr=rec_empl.get('empnr');Ext.Ajax.request({url:__site_url+'configauthen/GetSaveEmplAuthen?levid='+myLevid+'&amoid='+myAmoid+'&empnr='+myEmpnr,disableCaching:false,success:function(res){GET_TBL_AUAM(myAmoid);}});}
function GetSaveData(strData)
{var strLimitAmount="";var strEmplAuthen="";var strData="";for(i=0;i<store_limit_amount.getCount();i++)
{rt=store_limit_amount.getAt(i);strLimitAmount=strLimitAmount+rt.get('rowid')+"+"+rt.get('grptx')+"+"+rt.get('docty')+"+"+rt.get('liamo')+"|";}
for(i=0;i<store_authen_aprove.getCount();i++)
{rt=store_authen_aprove.getAt(i);strEmplAuthen=strEmplAuthen+rt.get('levid')+"+"+rt.get('amoid')+"+"+rt.get('empnr')+"|";}
strData=rec_doct.get('docty')+"#"+str}
function DeleteAmount(amoid)
{Ext.Ajax.request({url:__site_url+'configauthen/DeleteAmount?amoid='+amoid,disableCaching:false,success:function(res){GET_TBL_AMOU(rec_doct.get('docty'));store_authen_aprove.removeAll();}});}
function DeleteEmplAuthen(amoid,empnr)
{Ext.Ajax.request({url:__site_url+'configauthen/DeleteEmplAuthen?amoid='+amoid+'&empnr='+empnr,disableCaching:false,success:function(res){GET_TBL_AUAM(amoid);}});}
function RenderfieldDelete(val)
{return'<div  style="text-align: center"><img style="cursor:pointer"   alt="" src="assets/images/icons/bin.gif" /></div>';}
function RenderFieldDetail(val)
{return'<div  style="text-align: center"><img style="cursor:pointer"   alt="" src="assets/images/icons/detail.png" /></div>';}
GET_TBL_DOCT();btnAddLimitPopUp.setDisabled(true);btnAddEmpPopUp.setDisabled(true);grid_doct.on('cellclick',function(grid_doct,td,cellIndex,record,tr,rowIndex,e,eOpts){btnAddLimitPopUp.setDisabled(false);btnAddEmpPopUp.setDisabled(true);rec_doct=record;GET_TBL_AMOU(record.get('docty'));store_authen_aprove.removeAll();GET_EMPL_APPROVE(record.get('docty'));grid_limit_amount.setTitle('Doc Type : '+record.get('doctx'));grid_authen_aprove.setTitle('Doc Type : ');});grid_add_emp_approve.on('cellclick',function(grid_add_emp_approve,td,cellIndex,record,tr,rowIndex,e,eOpts){rec_empl=record;});grid_limit_amount.on('cellclick',function(grid_limit_amount,td,cellIndex,record,tr,rowIndex,e,eOpts){if(cellIndex==0)
{DeleteAmount(record.get('amoid'));grid_authen_aprove.setTitle('Doc Type:');btnAddEmpPopUp.setDisabled(true);}
if(cellIndex==1)
{rec_limit_amount=record;GET_TBL_AUAM(record.get('amoid'));btnAddEmpPopUp.setDisabled(false);grid_authen_aprove.setTitle('Doc Type : '+rec_doct.get('doctx')+'Limit Amount : '+record.get('liamo'));return;}});grid_authen_aprove.on('cellclick',function(grid_authen_aprove,td,cellIndex,record,tr,rowIndex,e,eOpts){if(cellIndex==0)
{DeleteEmplAuthen(record.get('amoid'),record.get('empnr'));}});Ext.apply(this,{title:'',height:570,width:800,layout:'hbox',items:[LeftPanel,RightPanel]});return this.callParent(arguments);}});;Ext.define('Account.Configauthen.UserDefine',{extend:'Ext.form.Panel',constructor:function(config){var store_edit_authen=Ext.create('Ext.data.ArrayStore',{fields:[{name:'doctx',type:'string'},{name:'docty',type:'string'},{name:'display',type:'string'},{name:'create',type:'string'},{name:'edit',type:'string'},{name:'delete',type:'string'},{name:'export',type:'string'},{name:'approve',type:'string'},{name:'uname',type:'string'}],sortInfo:{field:'doctx',direction:'ASC'}});var grid_edit_authen=Ext.create('Ext.grid.Panel',{title:'',store:store_edit_authen,columns:[{id:'doctx',text:"Doc Type",align:'left',width:160,dataIndex:'doctx',sortable:true},{text:"Display",align:'center',width:100,renderer:SetFieldAuthen,dataIndex:'display',sortable:true},{text:"Create",align:'center',width:100,renderer:SetFieldAuthen,dataIndex:'create',sortable:true},{text:"Edit",align:'center',width:100,renderer:SetFieldAuthen,dataIndex:'edit',sortable:true},{text:"Delete",align:'center',width:100,renderer:SetFieldAuthen,dataIndex:'delete',sortable:true},{text:"Export",align:'center',width:100,renderer:SetFieldAuthen,dataIndex:'export',sortable:true},{text:"Approve",align:'center',width:100,renderer:SetFieldAuthen,dataIndex:'approve',sortable:true}],autoExpandColumn:'doctx',bbar:[]});var store_employee=Ext.create('Ext.data.ArrayStore',{fields:[{name:'empnr',type:'string'},{name:'name1',type:'string'},{name:'email',type:'string'},{name:'postx',type:'string'},{name:'deptx',type:'string'},{name:'uname',type:'string'},{name:'passw',type:'string'}],sortInfo:{field:'name1',direction:'ASC'}});var grid_employee=Ext.create('Ext.grid.Panel',{title:'',store:store_employee,columns:[{text:"Code",align:'left',width:50,dataIndex:'empnr',sortable:true},{id:'name1',text:"Name",align:'left',width:120,dataIndex:'name1',sortable:true},{text:"Email",align:'left',width:160,dataIndex:'email',sortable:true},{text:"Position",align:'left',width:120,dataIndex:'postx',sortable:true},{text:"Department",align:'left',width:120,dataIndex:'deptx',sortable:true}],autoExpandColumn:'name1',bbar:[]});var txtEmployee=Ext.create('Ext.form.field.Trigger',{x:20,y:16,width:200,fieldLabel:'Employee Code',triggerCls:'x-form-search-trigger',labelAlign:'left',enableKeyEvents:true,allowBlank:false});var lblEmployeeName=Ext.create('Ext.form.Label',{x:260,y:20,margin:'0 0 0 20',text:""});var cbEmployee=Ext.create('Ext.form.ComboBox',{rtl:false,x:140,y:16,width:200,emptyText:'Select Employee',triggerAction:'all',lazyRender:true,selectOnFocus:true,queryMode:'local',displayField:'company_name',valueField:'company_id',});var txtUserName=Ext.create('Ext.form.Text',{fieldLabel:'User Name',layout:'absolute',margin:'5 0 0 0',fieldStyle:'text-align: left;',width:300,x:20,y:45});var txtPassword=Ext.create('Ext.form.Text',{fieldLabel:'Password',margin:'5 0 5 0',layout:'absolute',fieldStyle:'text-align: left;',width:300,x:20,y:75});var form_configauthen=Ext.create('Ext.form.Panel',{layout:'absolute',frame:true,items:[txtEmployee,lblEmployeeName,txtUserName,txtPassword]});var TopPanel=Ext.create('Ext.Panel',{bodyPadding:'5 10 0 10',layout:'fit',border:true,width:790,height:160,items:[{xtype:'fieldset',title:'User Data',defaultType:'textfield',layout:'anchor',items:[{xtype:'container',layout:'hbox',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',items:[{xtype:'hidden',name:'id'},txtEmployee,lblEmployeeName,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:350,allowBlank:true}]},txtUserName,txtPassword]},{xtype:'container',layout:'anchor',items:[]}]}]}]});var btnSave=Ext.create('Ext.Button',{text:'Save',width:80,handler:function(){var empnr=txtEmployee.getRawValue();GetSaveEditApprove(empnr);}});var btnCancel=Ext.create('Ext.Button',{text:'Cancel',width:80,handler:function(){}});var ButtomPanel=Ext.create('Ext.Panel',{layout:'fit',frame:true,width:790,height:400,items:[grid_edit_authen],buttons:[btnSave,btnCancel]});var win_employee_pop_up=Ext.create('Ext.Window',{title:'',closeAction:'hide',height:300,width:600,resizable:false,modal:true,layout:'fit',maximizable:false,items:[grid_employee]});function SetFieldAuthen(val)
{if(val==1)
{return"<img src='assets/images/icons/accept.png' />";}
return"<img src='assets/images/icons/cross.png' />";}
function GetEmployee()
{Ext.Ajax.request({url:__site_url+'configauthen/GetEmployee',disableCaching:false,success:function(res){var arrEmp=res.responseText.split('|');var detail=arrEmp;var data;var myData=new Array();var i;var strTemp;if(detail!=''){for(i=0;i<arrEmp.length;i++){data=new Array();strTemp=arrEmp[i].split('+')
data[0]=strTemp[0];data[1]=strTemp[1];data[2]=strTemp[2];data[3]=strTemp[3];data[4]=strTemp[4];data[5]=strTemp[5];data[6]=strTemp[6];myData[i]=data;}}
else{data=new Array();myData=data;}
store_employee.loadData(myData);}});}
function GetUserAuthen(empnr)
{Ext.Ajax.request({url:__site_url+'configauthen/GetUserAuthen?empnr='+empnr,disableCaching:false,success:function(res){var arrEmp=res.responseText.split('|');var detail=arrEmp;var data;var myData=new Array();var i;var strTemp;if(detail!=''){for(i=0;i<arrEmp.length;i++){data=new Array();strTemp=arrEmp[i].split('+')
data[0]=strTemp[0];data[1]=strTemp[1];data[2]=strTemp[2];data[3]=strTemp[3];data[4]=strTemp[4];data[5]=strTemp[5];data[6]=strTemp[6];data[7]=strTemp[7];data[8]=strTemp[8];myData[i]=data;}}
else{data=new Array();myData=data;}
store_edit_authen.loadData(myData);}});}
function GetSaveEditApprove(empnr)
{var sSql="";var strResult="";var uname=txtUserName.getRawValue();var passw=txtPassword.getRawValue();for(i=0;i<store_edit_authen.getCount();i++)
{rt=store_edit_authen.getAt(i);sSql=sSql+rt.get('docty')+"+"+rt.get('display')+rt.get('create')+rt.get('edit')+rt.get('delete')+rt.get('export')+rt.get('approve')+"|";}
if(sSql!="")
{sSql=sSql.substr(0,sSql.length-1);}
strResult="passw="+passw+"&uname="+uname+"&empnr="+empnr+"&authen="+sSql;Ext.Ajax.request({url:__site_url+'configauthen/GetSaveEditApprove?'+strResult,disableCaching:false,success:function(res){GetUserAuthen(empnr);}});}
grid_edit_authen.on('cellclick',function(grid_edit_authen,td,cellIndex,record,tr,rowIndex,e,eOpts){if(cellIndex==1)
{if(record.get('display')=="0")
{record.set('display',1);}
else{record.set('display',"0");}
return;}
if(cellIndex==2)
{if(record.get('create')=="0")
{record.set('create',1);}
else{record.set('create',"0");}
return;}
if(cellIndex==3)
{if(record.get('edit')=="0")
{record.set('edit',1);}
else{record.set('edit',"0");}
return;}
if(cellIndex==4)
{if(record.get('delete')=="0")
{record.set('delete',1);}
else{record.set('delete',"0");}
return;}
if(cellIndex==5)
{if(record.get('export')=="0")
{record.set('export',1);}
else{record.set('export',"0");}
return;}
if(cellIndex==6)
{if(record.get('approve')=="0")
{record.set('approve',1);}
else{record.set('approve',"0");}
return;}});txtEmployee.onTriggerClick=function(){GetEmployee();win_employee_pop_up.show();};grid_employee.on('cellclick',function(grid_employee,td,cellIndex,rec,tr,rowIndex,e,eOpts){txtEmployee.setValue(rec.get('empnr'));txtUserName.setValue(rec.get('uname'));txtPassword.setValue(rec.get('passw'));lblEmployeeName.setText(rec.get('name1'));GetUserAuthen(rec.get('empnr'));win_employee_pop_up.hide();});Ext.apply(this,{title:'',height:570,width:800,layout:'vbox',items:[TopPanel,ButtomPanel]});return this.callParent(arguments);}});;Ext.define('Account.Configauthen.WinUserDefine',{extend:'Ext.window.Window',constructor:function(config){var UserDefine=Ext.create('Account.Configauthen.UserDefine',{region:'center'});Ext.apply(this,{title:'Config Authen',closeAction:'hide',height:600,minHeight:570,width:800,minWidth:750,resizable:false,modal:true,layout:'hbox',maximizable:false,items:[UserDefine],buttons:[]});return this.callParent(arguments);}});;Ext.define('Account.Customer.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Customer Code, Customer Name',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'textfield',name:'kunnr',hideLabel:false,fieldLabel:'Customer Code',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'textfield',name:'kunnr2',hideLabel:false,fieldLabel:'To',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Customer.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'customer/loads',reader:{type:'json',root:'rows',idProperty:'kunnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['kunnr','name1','adr01','distx','pstlz','telf1','telfx','email','pson1','statx'],remoteSort:true,sorters:[{property:'kunnr',direction:'ASC'}]});this.columns=[{text:"Customer Code",width:100,dataIndex:'kunnr',sortable:true},{text:"Name",width:150,dataIndex:'name1',sortable:true},{text:"Address",width:200,dataIndex:'adr01',sortable:true},{text:"Province",flex:true,dataIndex:'distx',sortable:true},{text:"Postcode",width:60,dataIndex:'pstlz',sortable:true},{text:"Telephone",flex:true,dataIndex:'telf1',sortable:true},{text:"Fax No",flex:true,dataIndex:'telfx',sortable:true},{text:"Email",width:120,dataIndex:'email',sortable:true},{text:"Contact Person",flex:true,dataIndex:'pson1',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Customer.Import.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center',border:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.uploadAct=new Ext.Action({text:'Upload',iconCls:'b-small-save'});this.items=[{xtype:'filefield',name:'userfile',fieldLabel:'Excel file',labelAlign:'right',msgTarget:'side',allowBlank:false,anchor:'70%',buttonText:'Select Excel file...',allowBlank:false}];this.buttons=[this.uploadAct];this.uploadAct.setHandler(function(){_this.save();});return this.callParent(arguments);},save:function(){var _this=this,form=this.getForm();if(form.isValid()){_this.fireEvent('upload_click');form.submit({url:__site_url+'import/upload/do_upload',waitMsg:'Uploading excel file...',success:function(form,action){_this.fireEvent('upload_success',action.result.file);},failure:function(form,action){Ext.Msg.show({title:'An error occured.',msg:action.result.msg.error,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});}},reset:function(){this.getForm().reset();}});;Ext.define('Account.Customer.Import.Grid',{extend:'Ext.grid.Panel',constructor:function(config){Ext.apply(this,{viewConfig:{getRowClass:function(r,rowIndex,rowParams,store){var s=r.get('error');if(s&&s.length>0)
return'red-bg-row';}},buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.importAct=new Ext.Action({text:'Import',iconCls:'b-small-save'});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"import/customer/read",reader:{type:'json',root:'rows',idProperty:'row_id'},simpleSortMode:true},fields:['row_id','kunnr','ktype','name1','adr01','distx','cunt1','pstlz','email','telf1','telfx','pson1','adr02','dis02','cunt2','pst02','emai2','tel02','telf2','pson2','ptype','terms','apamt','pleve','taxnr','vat01','begin','endin','taxid','saknr','note1','statu','error'],remoteSort:false});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{text:"Customer Code",width:100,align:'center',dataIndex:'kunnr',sortable:false},{text:"Customer Name",width:150,align:'center',dataIndex:'name1',sortable:false},{text:"Address",width:200,align:'center',dataIndex:'adr01',sortable:false},{text:"Province",width:80,align:'center',dataIndex:'distx',sortable:false},{text:"Post Code",width:80,align:'center',dataIndex:'pstlz',sortable:false},{text:"GL Number",width:80,align:'center',dataIndex:'saknr',sortable:false},{text:"Email",width:100,align:'center',dataIndex:'email',sortable:false},{text:"Error",width:250,dataIndex:'error',sortable:false,renderer:function(v,p,r){return(v&&v.length>0)?v:'-';}}];this.buttons=[this.importAct];this.importAct.setHandler(function(){_this.importData();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},showMask:function(msg,msgClass){msg=msg||'Please select excel file for upload.';msgClass=msgClass||'grid-disable';this.importAct.setDisabled(true);this.getEl().mask(msg,msgClass);},hideMask:function(){this.importAct.setDisabled(false);this.getEl().unmask();},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();grid.getSelectionModel().deselectAll();},importData:function(){var _this=this;var rs=[];this.store.each(function(r){rs.push(r.getData());});if(rs.length>0){this.showMask('Importing please wait','');var data_json=Ext.encode(rs);Ext.Ajax.request({url:__site_url+'import/customer/import',params:{data:data_json},success:function(response){var text=response.responseText;var data=Ext.decode(text);if(data.success){Ext.Msg.show({title:'Import success.',msg:'Import '+data.rows.length+' rows success.',buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO});_this.fireEvent('import_success',data);}else{_this.hideMask();Ext.Msg.show({title:'An error occured.',msg:response,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}},failure:function(response){Ext.Msg.show({title:'An error occured.',msg:response.responseText,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});}else{Ext.Msg.alert('Status','No datas to import.');}}});;Ext.define('Account.Customer.Import.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Import',closeAction:'hide',height:600,minHeight:480,width:1000,minWidth:600,resizable:true,modal:true,layout:'border',maximizable:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Customer.Import.Form',{region:'north',height:80});this.grid=Ext.create('Account.Customer.Import.Grid',{region:'center',disbled:true});this.items=[this.form,this.grid];this.form.on('upload_success',function(file_name){_this.grid.hideMask();_this.grid.load({file:file_name});});return this.callParent(arguments);},openDialog:function(){this.form.reset();this.grid.store.removeAll();this.show(false,function(){this.grid.showMask();});}});;Ext.define('Account.Customer.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'customer/save',border:false,fieldDefaults:{msgTarget:'side',labelWidth:105,}});return this.callParent(arguments);},initComponent:function(){var _this=this;var myStorecomboPleve=Ext.create('Ext.data.Store',{fields:['idPleve','name'],data:[{"idPleve":"01","name":"Level 1"},{"idPleve":"02","name":"Level 2"},{"idPleve":"03","name":"Level 3"}]});this.comboPleve=Ext.create('Ext.form.ComboBox',{fieldLabel:'Price Level',name:'pleve',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Level --',margin:'0 0 0 56',store:myStorecomboPleve,labelAlign:'right',queryMode:'local',displayField:'name',valueField:'idPleve'});this.comboTaxnr=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat Type',name:'taxnr',width:290,labelWidth:105,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select Type --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.distrDialog=Ext.create('Account.SDistrict.MainWindow');this.trigDistr=Ext.create('Ext.form.field.Trigger',{name:'distx',fieldLabel:'Province',triggerCls:'x-form-search-trigger',enableKeyEvents:true,labelWidth:93,width:290,});this.trigDistr.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'sdistrict/loads',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.trigDistr.setValue(record.data.distx);}else{o.markInvalid('Could not find Province : '+o.getValue());}}});}},this);_this.distrDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigDistr.setValue(record.data.distx);grid.getSelectionModel().deselectAll();_this.distrDialog.hide();});this.trigDistr.onTriggerClick=function(){_this.distrDialog.show();};this.distrDialog2=Ext.create('Account.SDistrict.MainWindow');this.trigDistr2=Ext.create('Ext.form.field.Trigger',{name:'dis02',fieldLabel:'Province',triggerCls:'x-form-search-trigger',enableKeyEvents:true,labelWidth:93,width:290,});this.trigDistr2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'sdistrict/loads',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.trigDistr2.setValue(record.data.distx);}else{o.markInvalid('Could not find Province : '+o.getValue());}}});}},this);_this.distrDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigDistr2.setValue(record.data.distx);grid.getSelectionModel().deselectAll();_this.distrDialog2.hide();});this.trigDistr2.onTriggerClick=function(){_this.distrDialog2.show();};this.ktypDialog=Ext.create('Account.Customertype.Window');this.trigKtyp=Ext.create('Ext.form.field.Trigger',{name:'custx',fieldLabel:'Customer Type',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false,width:290,});this.trigKtyp.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customertype/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.trigKtyp.setValue(r.data.custx);_this.getForm().findField('ktype').setValue(r.data.ktype);_this.getForm().findField('saknr').setValue(r.data.saknr);_this.getForm().findField('sgtxt').setValue(r.data.sgtxt);}else{o.markInvalid('Could not find customer type : '+o.getValue());}}});}},this);_this.ktypDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigKtyp.setValue(record.data.custx);_this.getForm().findField('ktype').setValue(record.data.ktype);_this.getForm().findField('saknr').setValue(record.data.saknr);_this.getForm().findField('sgtxt').setValue(record.data.sgtxt);grid.getSelectionModel().deselectAll();_this.ktypDialog.hide();});this.trigKtyp.onTriggerClick=function(){_this.ktypDialog.grid.load();_this.ktypDialog.show();};this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',labelAlign:'right',width:200,hideTrigger:false,allowBlank:false,minValue:0,align:'right',margin:'0 0 0 56'});this.numberMin=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Minimum Amount',name:'begin',labelAlign:'left',width:290,minValue:0,allowBlank:false,hideTrigger:false});this.numberMax=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Maximum Amount',name:'endin',labelAlign:'right',hideTrigger:false,align:'right',minValue:0,allowBlank:false,margin:'0 0 0 56'});this.numberLimit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Limit Amt',name:'apamt',hideTrigger:false,allowBlank:false,minValue:0,width:290});this.numberVat=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Vat Value',name:'vat01',labelAlign:'right',hideTrigger:false,align:'right',minValue:0,margin:'0 0 0 56'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('CS'),fieldLabel:'Customer Status',name:'statu',labelAlign:'right',editable:false,allowBlank:false,triggerAction:'all',margin:'0 0 0 54',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'customer/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payment type',name:'ptype',width:290,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'customer/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.items=[{xtype:'hidden',name:'id',},{xtype:'hidden',name:'ktype'},{items:[{xtype:'container',layout:'anchor',margin:'15',items:[{xtype:'container',flex:1,layout:'hbox',padding:2,items:[this.trigKtyp,{},{xtype:'displayfield',fieldLabel:'Customer Code',name:'kunnr',labelAlign:'right',readOnly:true,width:150,margin:'0 0 0 64',value:'XXXXX',labelStyle:'font-weight:bold',}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',fieldLabel:'Customer Name',name:'name1',allowBlank:false,width:460,}]},{xtype:'fieldset',title:'Bill-to address',items:[{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',fieldLabel:'Address',name:'adr01',allowBlank:false,labelWidth:93,width:450}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[this.trigDistr,{},{xtype:'textfield',fieldLabel:'Country',name:'cunt1',labelAlign:'right',margin:'0 0 0 48'}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',fieldLabel:'Post Code',name:'pstlz',emptyText:'xxxxx',maskRe:/[\d\-]/,regex:/^\d{5}$/,regexText:'Must be in the format xxxxx',labelWidth:93,width:290},{xtype:'textfield',fieldLabel:'Email',name:'email',labelAlign:'right',margin:'0 0 0 50'}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',fieldLabel:'Phone Number',name:'telf1',labelWidth:93,width:290,emptyText:'xxx-xxxxxxx',maskRe:/[\d\-]/},{xtype:'textfield',fieldLabel:'Fax Number',name:'telfx',labelAlign:'right',maskRe:/[\d\-]/,margin:'0 0 0 50'}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',fieldLabel:'Contact Person',name:'pson1',labelWidth:93,width:450,},{xtype:'displayfield',margin:'0 0 0 5',}]}],},{xtype:'fieldset',title:'Ship-to address',items:[{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',fieldLabel:'Address',name:'adr02',allowBlank:false,labelWidth:93,width:450}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[this.trigDistr2,{},{xtype:'textfield',fieldLabel:'Country',name:'cunt2',labelAlign:'right',margin:'0 0 0 48'}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',fieldLabel:'Post Code',name:'pst02',emptyText:'xxxxx',maskRe:/[\d\-]/,regex:/^\d{5}$/,regexText:'Must be in the format xxxxx',labelWidth:93,width:290,},{xtype:'textfield',fieldLabel:'Email',name:'emai2',labelAlign:'right',margin:'0 0 0 50',}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',fieldLabel:'Phone Number',name:'tel02',labelWidth:93,width:290,emptyText:'xxx-xxxxxxx',maskRe:/[\d\-]/,},{xtype:'textfield',fieldLabel:'Fax Number',name:'telf02',labelAlign:'right',maskRe:/[\d\-]/,margin:'0 0 0 50',}]},{xtype:'container',flex:1,layout:'hbox',padding:2,margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Contact Person',name:'pson2',labelWidth:93,width:450,},{xtype:'displayfield',margin:'0 0 0 5',}]}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[this.comboPay,this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:25,value:'Days'}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[this.numberLimit,this.comboPleve]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[this.comboTaxnr,this.numberVat]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[this.numberMin,this.numberMax]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',fieldLabel:'Tax ID',name:'taxid',allowBlank:false,emptyText:'xxxxxxxxxxxxx',maskRe:/[\d\-]/,regex:/^\d{13}$/,width:290},{}],},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',name:'saknr',fieldLabel:'GL Account',redOnly:true,allowBlank:false,width:290},{xtype:'displayfield',name:'sgtxt',margins:'0 0 0 6',width:286,allowBlank:false}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textarea',fieldLabel:'Text Note',name:'note1',rows:2,width:290},this.comboQStatus]}]}]}];this.buttons=[{text:'Save',disabled:!UMS.CAN.EDIT('CS'),handler:function(){var _form_basic=this.up('form').getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}}},{text:'Cancel',handler:function(){this.up('form').getForm().reset();this.up('window').hide();}}];this.comboTaxnr.on('select',this.selectTax,this);return this.callParent(arguments);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'customer/load'});},reset:function(){this.getForm().reset();this.comboQStatus.setValue('01');this.comboPleve.setValue('01');},remove:function(kunnr){var _this=this;this.getForm().load({params:{kunnr:kunnr},url:__site_url+'customer/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},selectTax:function(combo,record,index){var _this=this;if(combo.getValue()=='03'||combo.getValue()=='04'){this.numberVat.setValue(0);this.numberVat.disable();}else{this.numberVat.enable();}}});;Ext.define('Account.Customer.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Customer',closeAction:'hide',height:690,width:660,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Customer.Item.Form');this.items=this.form;return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);}else{this.dialogId=null;this.form.reset();this.show(false);}},setReadOnly:function(readOnly){var children=this.items?this.items.items:[];for(var i=0;i<children.length;i++){var child=children[i];child.query('.field').forEach(function(c){c.setReadOnly(readOnly);});child.query('.button').forEach(function(c){if(c.xtype!='tab')
c.setDisabled(readOnly);});}
this.buttons[0].setDisabled(readOnly);}});;Ext.define('Account.Customer.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Customer Management',closeAction:'hide',height:580,minHeight:380,width:1100,minWidth:1000,resizable:true,modal:true,layout:'border',maximizable:true,defaultFocus:'code'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('CS')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.CREATE('CS')||UMS.CAN.EDIT('CS')||UMS.CAN.APPROVE('CS'))});this.displayAct=new Ext.Action({text:'Display',iconCls:'b-small-search',disabled:!UMS.CAN.DISPLAY('CS')});this.deleteAct=new Ext.Action({text:'Delete',disabled:true,iconCls:'b-small-minus'});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel'});this.importAct=new Ext.Action({text:'Import',iconCls:'b-small-import',disabled:true});this.itemDialog=Ext.create('Account.Customer.Item.Window');this.importDialog=Ext.create('Account.Customer.Import.Window');this.grid=Ext.create('Account.Customer.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.displayAct,this.deleteAct,this.excelAct,this.importAct]});this.searchForm=Ext.create('Account.Customer.FormSearch',{region:'north',height:100});this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(false);}});this.displayAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(true);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.importAct.setHandler(function(){_this.importDialog.openDialog();});this.itemDialog.form.on('afterSave',function(form){_this.itemDialog.hide();_this.grid.load();});this.itemDialog.form.on('afterDelete',function(form){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/customer/index?'+query;});this.importDialog.grid.on('import_success',function(){_this.importDialog.hide();_this.grid.load();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Customertype.GridItem',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({disabled:!UMS.CAN.CREATE('CS'),text:'Add',iconCls:'b-small-plus'});this.glnoDialog=Ext.create('Account.GL.MainWindow');this.tbar=[this.addAct,this.deleteAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'customertype/loads',reader:{type:'json',root:'rows',idProperty:'id_ktype',totalProperty:'totalCount'}},fields:[{name:'id_ktype',type:'int'},'ktype','custx','saknr','sgtxt'],remoteSort:false,sorters:['id_ktype ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{id:'PMiRowNumber',header:"No",dataIndex:'id_ktype',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Customer Type",width:80,dataIndex:'ktype',sortable:true,field:{type:'textfield'},},{text:"Type Description",width:100,dataIndex:'custx',sortable:true,field:{type:'textfield'},},{text:"GL no",width:100,dataIndex:'saknr',sortable:true,field:{xtype:'triggerfield',enableKeyEvents:true,allowBlank:false,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.glnoDialog.show();}},sortable:false},{text:"GL Description",width:150,dataIndex:'sgtxt',sortable:true}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='saknr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.saknr);rModel.set('sgtxt',r.data.sgtxt);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.glnoDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('saknr',record.data.saknr);rModel.set('sgtxt',record.data.sgtxt);}
grid.getSelectionModel().deselectAll();_this.glnoDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options,proxy:{type:'ajax',url:__site_url+'customertype/loads',reader:{type:'json',root:'rows',idProperty:'id_ktype'}},fields:[{name:'id_ktype',type:'int'},'ktype','custx','saknr','sgtxt'],remoteSort:false,sorters:['id_ktype ASC']});},addRecord:function(){var newId=-1;var i=0;this.store.each(function(r){i++;if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();this.store.insert(i,rec);edit.startEditByPosition({row:i,column:0});this.runNumRow();},save:function(){var _this=this;var r_data=this.getData();Ext.Ajax.request({url:__site_url+'customertype/save',method:'POST',params:{ktyp:Ext.encode(r_data)},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){}else{Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}}});},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},reset:function(){this.grid.load({ktype:0});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('id_ktype',row_num++);});}});;Ext.define('Account.Customertype.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Customer Type',closeAction:'hide',height:420,width:450,layout:'border',resizable:true,modal:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.Customertype.GridItem',{region:'center'});this.items=[this.grid];this.buttons=[{disabled:!(UMS.CAN.EDIT('CS')||UMS.CAN.CREATE('CS')),text:'Save',handler:function(){Ext.Msg.show({title:"Warning",msg:"Are you sure you want to update item(s) ?",icon:Ext.Msg.WARNING,buttons:Ext.Msg.YESNO,fn:function(bt){if(bt=="yes"){_this.grid.save();}}});}},{text:'Cancel',handler:function(){_this.hide();}}];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.DepositIn.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Deposit No, Customer or Quotation',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.DepositIn.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"depositin/loads",reader:{type:'json',root:'rows',idProperty:'depnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['depnr','bldat','vbeln','kunnr','name1','ebeln','txz01','statx','netwr','ctype'],remoteSort:true,sorters:[{property:'depnr',direction:'ASC'}]});this.columns=[{text:"Deposit No",width:100,align:'center',dataIndex:'depnr',sortable:true},{text:"Doc Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Quotation No",width:80,align:'center',dataIndex:'vbeln',sortable:true},{text:"Customer No",width:80,align:'center',dataIndex:'kunnr',sortable:true},{text:"Customer Name",width:150,dataIndex:'name1',sortable:true},{text:"Text Note",width:150,dataIndex:'name1',sortable:true},{text:"Text Note",width:200,dataIndex:'txz01',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Amount",xtype:'numbercolumn',width:80,align:'right',dataIndex:'netwr',sortable:true},{text:"Currency",width:60,align:'center',dataIndex:'ctype',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.DepositIn.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'depositin/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.quotationDialog=Ext.create('Account.Quotation.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.customerDialog=Ext.create('Account.SCustomer.MainWindow');this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.gridItem=Ext.create('Account.DepositIn.Item.Grid_i',{height:200,region:'center'});this.gridGL=Ext.create('Account.DepositIn.Item.Grid_gl',{border:true,region:'center',title:'GL Posting'});this.formTotal=Ext.create('Account.DepositIn.Item.Form_t',{border:true,split:true,title:'Total->Deposit',region:'south'});this.formTotalthb=Ext.create('Account.Quotation.Item.Form_thb',{border:true,split:true,title:'Exchange Rate->THB',region:'south'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('DR'),fieldLabel:'Deposit Status',name:'statu',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat type',name:'taxnr',width:240,labelAlign:'right',editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Vat --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.hdnDpItem=Ext.create('Ext.form.Hidden',{name:'vbdp'});this.hdnGlItem=Ext.create('Ext.form.Hidden',{name:'bcus',});this.trigCustomer=Ext.create('Ext.form.field.Trigger',{name:'kunnr',labelAlign:'letf',width:240,fieldLabel:'Customer Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:200,editable:false,labelAlign:'right',allowBlank:false});this.trigQuotation=Ext.create('Ext.form.field.Trigger',{name:'vbeln',fieldLabel:'Quotation No.',width:240,triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.whtDialog=Ext.create('Account.WHT.Window');this.trigWHT=Ext.create('Ext.form.field.Trigger',{fieldLabel:'WHT Value',name:'whtnr',labelAlign:'right',width:150,triggerCls:'x-form-search-trigger',enableKeyEvents:true,});this.numberWHT=Ext.create('Ext.form.field.Display',{name:'whtpr',width:15,align:'right',margin:'0 0 0 8'});this.numberVat=Ext.create('Ext.form.field.Number',{fieldLabel:'Vat Value',name:'taxpr',labelAlign:'right',width:150,});this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',width:180,hideTrigger:false,allowDecimals:false,minValue:0});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnDpItem,this.hdnGlItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,defaultType:'textfield',layout:'anchor',defaults:{anchor:'100%'},items:[{xtype:'container',layout:'hbox',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},{xtype:'hidden',name:'loekz'},this.trigQuotation,{xtype:'displayfield',margins:'0 0 0 6',width:350,allowBlank:true}]},{xtype:'container',layout:'hbox',items:[this.trigCustomer,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:350,allowBlank:true}]},{xtype:'textarea',fieldLabel:'Bill To',name:'adr01',width:400,rows:3,labelAlign:'top'},{xtype:'container',layout:'hbox',defaultType:'textfield',margin:'0 0 5 0',items:[this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:10,value:'Days'},{xtype:'datefield',fieldLabel:'Due Date',name:'duedt',labelAlign:'right',width:200,margin:'0 0 0 5',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]},{xtype:'container',layout:'anchor',items:[{xtype:'displayfield',fieldLabel:'Deposit No',name:'depnr',value:'DRXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'},{xtype:'datefield',fieldLabel:'Document Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false},this.comboTax,{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigWHT,this.numberWHT,{xtype:'displayfield',align:'right',width:15,margin:'0 0 0 5',value:'%'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.numberVat,{xtype:'displayfield',align:'right',width:15,margin:'0 0 0 5',value:'%'}]},this.trigCurrency,this.comboQStatus]}]}]}]};this.items=[mainFormPanel,this.gridItem,{xtype:'tabpanel',region:'south',activeTab:0,height:200,items:[this.formTotal,this.formTotalthb,this.gridGL]}];this.trigQuotation.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'quotation/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.vbeln);_this.getForm().findField('kunnr').setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('whtpr').setValue(r.data.whtpr);_this.getForm().findField('loekz').setValue(r.data.loekz);var qtnr=_this.trigQuotation.value;}else{o.markInvalid('Could not find quotation no : '+o.getValue());}}});}},this);_this.quotationDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigQuotation.setValue(record.data.vbeln);_this.getForm().findField('kunnr').setValue(record.data.kunnr);_this.getForm().findField('name1').setValue(record.data.name1);Ext.Ajax.request({url:__site_url+'quotation/load',method:'POST',params:{id:record.data.vbeln},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('whtpr').setValue(r.data.whtpr);_this.getForm().findField('loekz').setValue(r.data.loekz);}}});grid.getSelectionModel().deselectAll();var qtnr=_this.trigQuotation.value;_this.gridItem.load({qtnr:qtnr});_this.quotationDialog.hide();});this.trigQuotation.onTriggerClick=function(){_this.quotationDialog.grid.load();_this.quotationDialog.show();};this.trigCustomer.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer.setValue(record.data.kunnr);_this.getForm().findField('name1').setValue(record.data.name1);var _addr=record.data.adr01;if(!Ext.isEmpty(record.data.distx))
_addr+=' '+record.data.distx;if(!Ext.isEmpty(record.data.pstlz))
_addr+=' '+record.data.pstlz;if(!Ext.isEmpty(record.data.telf1))
_addr+='\n'+'Tel: '+record.data.telf1;if(!Ext.isEmpty(record.data.telfx))
_addr+=' '+'Fax: '+record.data.telfx;if(!Ext.isEmpty(record.data.email))
_addr+='\n'+'Email: '+record.data.email;_this.getForm().findField('adr01').setValue(_addr);grid.getSelectionModel().deselectAll();_this.customerDialog.hide();});this.trigCustomer.onTriggerClick=function(){_this.customerDialog.grid.load();_this.customerDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);_this.formTotal.getForm().findField('curr').setValue(r.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',r.data.ctype);});_this.gridItem.curValue=r.data.ctype;}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);_this.formTotal.getForm().findField('curr1').setValue(record.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',record.data.ctype);});_this.gridItem.curValue=record.data.ctype;grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};this.trigWHT.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/loads_wht',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.whtnr);_this.getForm().findField('whtpr').setValue(r.data.whtpr);}else{o.markInvalid('Could not find wht code : '+o.getValue());}}});}},this);_this.whtDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigWHT.setValue(record.data.whtnr);_this.getForm().findField('whtpr').setValue(record.data.whtpr);grid.getSelectionModel().deselectAll();_this.whtDialog.hide();});this.trigWHT.onTriggerClick=function(){_this.whtDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.numberCredit.on('keyup',this.getDuedate,this);this.numberCredit.on('change',this.getDuedate,this);this.formTotal.txtRate.on('keyup',this.calculateTotal,this);this.formTotal.txtRate.on('change',this.calculateTotal,this);this.comboTax.on('change',this.calculateTotal,this);this.trigCurrency.on('change',this.changeCurrency,this);this.numberWHT.on('change',this.calculateTotal,this);return this.callParent(arguments);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'depositin/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnDpItem.setValue(Ext.encode(rsItem));var rsGL=_this.gridGL.getData();this.hdnGlItem.setValue(Ext.encode(rsGL));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'depositin/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({depnr:0});this.gridGL.load({netpr:0});this.comboQStatus.setValue('01');this.comboTax.setValue('01');this.numberVat.setValue(7);this.numberWHT.setValue(3);this.trigCurrency.setValue('THB');this.getForm().findField('bldat').setValue(new Date());this.formTotal.txtRate.setValue('1.0000');this.formTotalthb.getForm().findField('exchg2').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=this.gridItem.store;var amt=0;var vats=0;var whts=0;var i=0;var sum=0;discounts=0;discount=0;var sum2=0;var vattype=this.comboTax.getValue();store.each(function(r){var amt=parseFloat(r.data['pramt'].replace(/[^0-9.]/g,''));discountValue=0,discount=r.data['disit'];amt=isNaN(amt)?0:amt;if(vattype=='02'){amt=amt*100;amt=amt/107;}
if(discount.match(/%$/gi)){discount=discount.replace('%','');var discountPercent=parseFloat(discount);discountValue=amt*discountPercent/100;}else{discountValue=parseFloat(discount);}
discountValue=isNaN(discountValue)?0:discountValue;sum+=amt;discounts+=discountValue;amt=amt-discountValue;sum2+=amt;if(r.data['chk01']==true){var vat=_this.numberVat.getValue();vat=(amt*vat)/100;vats+=vat;}
if(r.data['chk02']==true){var wht=_this.numberWHT.getValue();wht=(amt*wht)/100;whts+=wht;}});this.formTotal.getForm().findField('beamt').setValue(sum);var currency=this.trigCurrency.getValue();this.gridItem.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);this.formTotal.getForm().findField('vat01').setValue(vats);this.formTotal.getForm().findField('wht01').setValue(whts);this.formTotal.getForm().findField('dismt').setValue(discounts);var net=this.formTotal.calculate();this.formTotal.taxType=this.comboTax.getValue();this.gridItem.vatValue=this.numberVat.getValue();this.gridItem.whtValue=this.numberWHT.getValue();this.formTotal.getForm().findField('curr1').setValue(currency);var rate=this.formTotal.txtRate.getValue();if(currency!='THB'){sum=sum*rate;vats=vats*rate;sum2=sum2*rate;discounts=discounts*rate;}
this.formTotalthb.getForm().findField('beamt2').setValue(sum);this.formTotalthb.getForm().findField('vat02').setValue(vats);this.formTotalthb.getForm().findField('wht02').setValue(whts);this.formTotalthb.getForm().findField('dismt2').setValue(discounts);this.formTotalthb.getForm().findField('exchg2').setValue(rate);this.formTotalthb.getForm().findField('curr2').setValue(currency);var net2=this.formTotalthb.calculate();if(sum>0&&this.trigCustomer.getValue()!=''){_this.gridGL.load({netpr:sum2,vvat:vats,kunnr:this.trigCustomer.getValue()});}},getDuedate:function(){var bForm=this.getForm(),credit=this.numberCredit.getValue(),startDate=bForm.findField('bldat').getValue(),result=Ext.Date.add(startDate,Ext.Date.DAY,credit);bForm.findField('duedt').setValue(result);},changeCurrency:function(){var _this=this;var store=this.gridItem.store;var sum=0;var currency=this.trigCurrency.getValue();store.each(function(r){r.set('ctyp1',currency);});}});;Ext.define('Account.DepositIn.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'depositin/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip'}});return this.callParent(arguments);},initComponent:function(){var _this=this;var myStorecomboWHTno=Ext.create('Ext.data.Store',{fields:['idWHT','name'],data:[{"idWHT":"01","name":"นิติบุคคล"},{"idWHT":"02","name":"บุคคลธรรมดา"}]});this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:155,width:270,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:155,name:'vat01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtWHTValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'WHT Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:155,name:'wht01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:240,hideTrigger:true,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',width:270,labelWidth:155,alwaysDisplayDecimals:true,margin:'4 0 0 0',style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'}]},{xtype:'container',layout:'anchor',margins:'0 0 0 200',items:[this.txtTotal,this.txtDiscountValue,this.txtDiscountSum,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'depositin/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'invoice/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},calculate:function(){var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discountValue=this.txtDiscountValue.getValue();if(discountValue>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var wht=this.txtWHTValue.getValue();var net=(total-discountValue)+(vat-wht);this.txtNet.setValue(net);return net;}});;Ext.define('Account.DepositIn.Item.Grid_gl',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',disabled:true,iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',disabled:true,iconCls:'b-small-copy'});this.glDialog=Ext.create('Account.GL.MainWindow');this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"depositin/loads_gl_item",reader:{type:'json',root:'rows',idProperty:'belnr,belpr'}},fields:['belnr','belpr','saknr','sgtxt','debit','credi','txz01','statu'],remoteSort:true,sorters:['belpr ASC']});this.columns=[{id:'RowNumber20',text:"No.",dataIndex:'belpr',width:50,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"GL No.",width:100,dataIndex:'saknr',align:'center',sortable:false,},{text:"GL Description",width:215,dataIndex:'sgtxt',sortable:true},{text:"Debit",width:100,dataIndex:'debit',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,},{text:"Credit",width:100,dataIndex:'credi',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,},{text:"Comment",width:250,dataIndex:'txz01',sortable:true,field:{type:'textfield'}}];this.plugins=[this.editing];this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='saknr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.saknr);rModel.set('sgtxt',r.data.sgtxt);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.glDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('saknr',record.data.saknr);rModel.set('sgtxt',record.data.sgtxt);}
grid.getSelectionModel().deselectAll();_this.glDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addDefaultRecord:function(){this.store.removeAll();var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;for(var i=0;i<5;i++){rec={id:i};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();}},addRecord2:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();},removeRecord2:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow2();},runNumRow2:function(){var row_num=0;this.store.each(function(r){r.set('belpr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.DepositIn.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"depositin/loads_dp_item",reader:{type:'json',root:'rows',idProperty:'depnr,paypr',totalProperty:'totalCount'}},fields:['vbelp','sgtxt','duedt','perct','pramt','ctyp1','chk01','chk02','disit'],remoteSort:true,sorters:['paypr ASC']});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Deposit Receipt',scope:this,handler:this.removeRecord2}]},{id:'RowNumber4',text:"Periods No.",dataIndex:'vbelp',width:90,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Period Desc.",width:340,dataIndex:'sgtxt',sortable:true,field:{type:'textfield'}},{text:"Period Date",width:100,xtype:'datecolumn',dataIndex:'duedt',format:'d/m/Y',sortable:true,editor:{xtype:'datefield',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}},{text:"Discount",width:70,dataIndex:'disit',sortable:false,align:'right',field:Ext.create('BASE.form.field.PercentOrNumber'),renderer:function(v,p,r){var regEx=/%$/gi;if(regEx.test(v))
return v;else
return Ext.util.Format.usMoney(v).replace(/\$/,'');}},{xtype:'checkcolumn',text:'Vat',dataIndex:'chk01',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{xtype:'checkcolumn',text:'WHT',dataIndex:'chk02',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Amount/ %",width:100,dataIndex:'perct',sortable:true,align:'right',},{text:"Amount",width:100,dataIndex:'pramt',xtype:'numbercolumn',align:'right',},{text:"Currency",width:70,dataIndex:'ctyp1',sortable:true,align:'center',editor:{xtype:'textfield'},}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.store.on('load',function(store,rs){if(_this.readOnly){var view=_this.getView();var t=_this.getView().getEl().down('table');t.addCls('mask-grid-readonly');_this.readOnlyMask=new Ext.LoadMask(t,{msg:"..."});_this.readOnlyMask.show();}else{if(_this.readOnlyMask)
_this.readOnlyMask.hide();}});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.DepositIn.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'Deposit Receipt preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/depositin/index/'+id+'/'+copies;}});;Ext.define('Account.DepositIn.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Deposit Receipt',closeAction:'hide',height:650,width:950,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.DepositIn.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.DepositIn.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.btnSave=Ext.create('Ext.Button',{text:'Save',disabled:!(UMS.CAN.CREATE('QT')||UMS.CAN.EDIT('QT')||UMS.CAN.APPROVE('QT')),handler:function(){_this.form.save();}});this.buttons=[this.btnSave,{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({depnr:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}},setReadOnly:function(readOnly){var children=this.items?this.items.items:[];for(var i=0;i<children.length;i++){var child=children[i];child.query('.field').forEach(function(c){if(!c.initialConfig.readOnly){c.setReadOnly(readOnly);}});child.query('.button').forEach(function(c){if(c.xtype!='tab'){if(!c.initialConfig.disabled)
c.setDisabled(readOnly);}});}
this.form.gridItem.readOnly=readOnly;if(!this.btnSave.initialConfig.disabled)
this.btnSave.setDisabled(readOnly);}});;Ext.define('Account.DepositIn.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Deposit Receipt',closeAction:'hide',height:600,minHeight:380,width:950,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('DR')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('DR')||UMS.CAN.CREATE('DR')||UMS.CAN.EDIT('DR'))});this.displayAct=new Ext.Action({text:'Display',iconCls:'b-small-search',disabled:!UMS.CAN.DISPLAY('DR')});this.deleteAct=new Ext.Action({text:'Delete',disabled:true,iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('DR')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('DR')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.DepositIn.Item.Window');this.grid=Ext.create('Account.DepositIn.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.displayAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.DepositIn.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(false);}});this.displayAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(true);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save Deposit Receipt number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/depositin/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.DepositOut.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Deposit No, Vendor or PO No.',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.DepositOut.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"depositout/loads",reader:{type:'json',root:'rows',idProperty:'depnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['depnr','bldat','ebeln','lifnr','name1','txz01','statx','netwr','ctype'],remoteSort:true,sorters:[{property:'depnr',direction:'ASC'}]});this.columns=[{text:"Deposit No",width:100,align:'center',dataIndex:'depnr',sortable:true},{text:"Doc Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"PO No",width:80,align:'center',dataIndex:'ebeln',sortable:true},{text:"Vendor No",width:80,align:'center',dataIndex:'lifnr',sortable:true},{text:"Vendor Name",width:150,dataIndex:'name1',sortable:true},{text:"Text Note",width:200,dataIndex:'txz01',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Amount",xtype:'numbercolumn',width:80,align:'right',dataIndex:'netwr',sortable:true},{text:"Currency",width:60,align:'center',dataIndex:'ctype',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.DepositOut.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'depositout/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.poDialog=Ext.create('Account.PO.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.vendorDialog=Ext.create('Account.SVendor.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.gridItem=Ext.create('Account.DepositOut.Item.Grid_i',{height:320,region:'center'});this.gridGL=Ext.create('Account.DepositOut.Item.Grid_gl',{border:true,region:'center',title:'GL Posting'});this.formTotal=Ext.create('Account.DepositOut.Item.Form_t',{border:true,split:true,title:'GR Total',region:'south'});this.gridPrice=Ext.create('Account.DepositOut.Item.Grid_pc',{border:true,split:true,title:'Item Pricing',region:'south'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('DP'),fieldLabel:'Deposit Status',name:'statu',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat Type',name:'taxnr',width:240,labelAlign:'right',editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select data --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payments',name:'ptype',width:280,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.hdnDpItem=Ext.create('Ext.form.Hidden',{name:'ebdp'});this.hdnGlItem=Ext.create('Ext.form.Hidden',{name:'bven',});this.trigPO=Ext.create('Ext.form.field.Trigger',{name:'ebeln',fieldLabel:'PO No',labelAlign:'letf',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigVendor=Ext.create('Ext.form.field.Trigger',{name:'lifnr',fieldLabel:'Vendor Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',labelAlign:'right',width:170,hideTrigger:false,align:'right'});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:240,labelAlign:'right',allowBlank:false});this.numberVat=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Vat Value',name:'taxpr',labelAlign:'right',width:170,align:'right'});this.numberWHT=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'WHT Value',name:'whtpr',labelAlign:'right',width:170,align:'right'});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnDpItem,this.hdnGlItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'loekz'},{xtype:'hidden',name:'id'},this.trigPO,{xtype:'displayfield',width:290,allowBlank:true},{xtype:'displayfield',fieldLabel:'Deposit No',name:'depnr',value:'DPXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'container',flex:0,layout:'anchor',items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigVendor,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:160,allowBlank:true}]},{xtype:'textarea',fieldLabel:'Vendor Address',name:'adr01',width:450,rows:3,},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboPay,this.numberVat]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Reference No',width:280,name:'refnr',},this.numberWHT]}]},{xtype:'container',flex:0,layout:'anchor',margin:'0 0 0 70',items:[this.comboPtype,{xtype:'datefield',fieldLabel:'Deposit Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',},this.comboTax,this.trigCurrency,{xtype:'container',layout:'hbox',defaultType:'textfield',margin:'0 0 5 0',items:[this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:25,value:'Days'}]},{xtype:'datefield',fieldLabel:'Due Date',name:'duedt',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},this.comboQStatus]}]}]}]};this.items=[mainFormPanel,this.gridItem,{xtype:'tabpanel',region:'south',activeTab:0,height:200,items:[this.formTotal,this.gridPrice,this.gridGL]}];this.trigPO.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'po/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ebeln);_this.getForm().findField('lifnr').setValue(r.data.lifnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('loekz').setValue(r.data.loekz);}else{o.markInvalid('Could not find Purchase no : '+o.getValue());}}});}},this);_this.poDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigPO.setValue(record.data.ebeln);_this.getForm().findField('lifnr').setValue(record.data.lifnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.ebeln;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'po/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('loekz').setValue(r.data.loekz);}}});grid.getSelectionModel().deselectAll();var grdponr=_this.trigPO.value;_this.gridItem.load({ponr:grdponr});_this.poDialog.hide();});this.trigPO.onTriggerClick=function(){_this.poDialog.show();};this.trigVendor.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}else{o.markInvalid('Could not find vendor code : '+o.getValue());}}});}},this);_this.vendorDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor.setValue(record.data.lifnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.lifnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}}});grid.getSelectionModel().deselectAll();_this.vendorDialog.hide();});this.trigVendor.onTriggerClick=function(){_this.vendorDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);_this.formTotal.getForm().findField('curr').setValue(r.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctyp1',r.data.ctype);});_this.gridItem.curValue=r.data.ctype;}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);_this.formTotal.getForm().findField('curr1').setValue(record.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctyp1',record.data.ctype);});_this.gridItem.curValue=record.data.ctype;grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.gridItem.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.gridItem.getSelectionModel().on('viewready',this.onViewReady,this);this.numberCredit.on('keyup',this.getDuedate,this);this.numberCredit.on('change',this.getDuedate,this);this.comboTax.on('change',this.calculateTotal,this);return this.callParent(arguments);},onSelectChange:function(selModel,selections){var _this=this;var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vat:sel.get('chk01')});}},onViewReady:function(grid){grid.getSelectionModel().select(0);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'depositout/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnDpItem.setValue(Ext.encode(rsItem));var rsGL=_this.gridGL.getData();this.hdnGlItem.setValue(Ext.encode(rsGL));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(mbeln){var _this=this;this.getForm().load({params:{mbeln:mbeln},url:__site_url+'depositout/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({depnr:0});this.gridGL.load({netpr:0});this.comboQStatus.setValue('01');this.comboTax.setValue('01');this.trigCurrency.setValue('THB');this.numberVat.setValue(7);this.numberWHT.setValue(3);this.getForm().findField('bldat').setValue(new Date());this.formTotal.getForm().findField('exchg').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=this.gridItem.store;var sum2=0;var sum=0;var vats=0;var whts=0;var discounts=0;var vattype=this.comboTax.getValue();store.each(function(r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']),discount=parseFloat(r.data['disit']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;discount=isNaN(discount)?0:discount;var amt=qty*price;if(vattype=='02'){amt=amt*100;amt=amt/107;}
sum+=amt;discounts+=discount;amt=amt-discount;sum2+=amt;if(r.data['chk01']==true){var vat=_this.numberVat.getValue();vat=(amt*vat)/100;vats+=vat;}
if(r.data['chk02']==true){var wht=_this.numberWHT.getValue();wht=(amt*wht)/100;whts+=wht;}});this.formTotal.getForm().findField('beamt').setValue(sum);this.formTotal.getForm().findField('vat01').setValue(vats);this.formTotal.getForm().findField('wht01').setValue(whts);this.formTotal.getForm().findField('dismt').setValue(discounts);this.formTotal.calculate();this.gridItem.vattValue=this.comboTax.getValue();this.gridItem.vatValue=this.numberVat.getValue();var currency=this.trigCurrency.getValue();this.gridItem.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);this.formTotal.getForm().findField('vat01').setValue(vats);var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:vattype});}
if(currency!='THB'){var rate=this.formTotal.getForm().findField('exchg').getValue();sum=sum*rate;}
if(sum>0&&this.trigVendor.getValue()!=''){_this.gridGL.load({netpr:sum2,vvat:vats,lifnr:this.trigVendor.getValue()});}},getDuedate:function(){var bForm=this.getForm(),credit=this.numberCredit.getValue(),startDate=bForm.findField('bldat').getValue();if(!Ext.isEmpty(credit)&&credit>0){var result=Ext.Date.add(startDate,Ext.Date.DAY,credit),dueDateField=bForm.findField('duedt');if(!Ext.isEmpty(credit)&&!Ext.isEmpty(dueDateField))
dueDateField.setValue(result);}}});;Ext.define('Account.DepositOut.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'depositout/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',}});return this.callParent(arguments);},initComponent:function(){var _this=this;var myStorecomboWHTno=Ext.create('Ext.data.Store',{fields:['idWHT','name'],data:[{"idWHT":"01","name":"นิติบุคคล"},{"idWHT":"02","name":"บุคคลธรรมดา"}]});this.whtDialog=Ext.create('Account.WHT.Window');this.trigWHT=Ext.create('Ext.form.field.Trigger',{name:'whtnr',labelAlign:'letf',width:50,triggerCls:'x-form-search-trigger',enableKeyEvents:true,margin:'4 0 0 10'});this.comboWHType=Ext.create('Ext.form.ComboBox',{fieldLabel:'Witholding Tax',name:'whtyp',width:240,triggerAction:'all',clearFilterOnReset:true,emptyText:'--Select WHT Typ--',margin:'4 0 0 0',store:myStorecomboWHTno,labelAlign:'left',queryMode:'local',displayField:'name',valueField:'idWHT'});this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',xtype:'textfield',fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:150,width:270,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt',align:'right',width:270,labelWidth:150,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',name:'vat01',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,margin:'4 0 0 0',readOnly:true});this.txtWHTValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'WHT Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,name:'wht01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:270,hideTrigger:true,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',alwaysDisplayDecimals:true,style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'},{xtype:'container',layout:'hbox',anchor:'100%',items:[this.comboWHType,this.trigWHT,{xtype:'textfield',name:'whtxt',margin:'4 0 0 7',width:250}]}]},{xtype:'container',layout:'anchor',margins:'0 0 0 15',items:[this.txtTotal,this.txtDiscountValue,this.txtDiscountSum,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];this.trigWHT.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/loads_wht',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.whtnr);if(r.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(r.data.whtxt);}}else{o.markInvalid('Could not find wht code : '+o.getValue());}}});}},this);_this.whtDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigWHT.setValue(record.data.whtnr);if(record.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(record.data.whtxt);}
grid.getSelectionModel().deselectAll();_this.whtDialog.hide();});this.trigWHT.onTriggerClick=function(){_this.whtDialog.show();};var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtTaxValue.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtWHTValue.on('render',setAlignRight);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'depositout/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},calculate:function(){var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discountValue=this.txtDiscountValue.getValue();if(discountValue>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var wht=this.txtWHTValue.getValue();var net=(total-discountValue)+(vat-wht);this.txtNet.setValue(net);}});;Ext.define('Account.DepositOut.Item.Grid_gl',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.glDialog=Ext.create('Account.GL.MainWindow');this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"depositout/loads_gl_item",reader:{type:'json',root:'rows',idProperty:'belnr,belpr'}},fields:['belnr','belpr','saknr','sgtxt','debit','credi','txz01','statu'],remoteSort:true,sorters:['belpr ASC']});this.columns=[{id:'RowNumber20',text:"No.",dataIndex:'belpr',width:50,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"GL No.",width:100,dataIndex:'saknr',align:'center',sortable:false,},{text:"GL Description",width:215,dataIndex:'sgtxt',sortable:true},{text:"Debit",width:100,dataIndex:'debit',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2},{text:"Credit",width:100,dataIndex:'credi',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2},{text:"Comment",width:250,dataIndex:'txz01',sortable:true,field:{type:'textfield'}}];this.plugins=[this.editing];this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='saknr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.saknr);rModel.set('sgtxt',r.data.sgtxt);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.glDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('saknr',record.data.saknr);rModel.set('sgtxt',record.data.sgtxt);}
grid.getSelectionModel().deselectAll();_this.glDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addDefaultRecord:function(){this.store.removeAll();var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;for(var i=0;i<5;i++){rec={id:i};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();}},addRecord2:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();},removeRecord2:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow2();},runNumRow2:function(){var row_num=0;this.store.each(function(r){r.set('belpr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.DepositOut.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMaterial.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"depositout/loads_dp_item",reader:{type:'json',root:'rows',idProperty:'depnr,vbelp'}},fields:['vbelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctyp1','chk01','chk02'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Deposit Item',scope:this,handler:this.removeRecord}]},{id:'DPiRowNumber',header:"Items",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:80,dataIndex:'matnr',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.materialDialog.show();}},},{text:"Description",width:220,dataIndex:'maktx',sortable:false,field:{type:'textfield'},},{text:"Qty",xtype:'numbercolumn',width:70,dataIndex:'menge',sortable:false,align:'right',field:{type:'numberfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Unit",width:50,dataIndex:'meins',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.unitDialog.show();}},},{text:"Price/Unit",xtype:'numbercolumn',width:100,dataIndex:'unitp',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Discount",xtype:'numbercolumn',width:80,dataIndex:'disit',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{xtype:'checkcolumn',text:'Vat',dataIndex:'chk01',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{xtype:'checkcolumn',text:'WHT',dataIndex:'chk02',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Amount",width:90,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:65,dataIndex:'ctyp1',sortable:false,align:'center',field:{type:'textfield'},}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='matnr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.matnr);rModel.set('maktx',r.data.maktx);rModel.set('meins',r.data.meins);rModel.set('saknr',r.data.saknr);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.materialDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('matnr',record.data.matnr);rModel.set('maktx',record.data.maktx);rModel.set('meins',record.data.meins);rModel.set('saknr',record.data.saknr);}
grid.getSelectionModel().deselectAll();_this.materialDialog.hide();});_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('meins',record.data.meins);}
grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,ctype:'THB'};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.DepositOut.Item.Grid_pc',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"invoice/loads_conp_item",reader:{type:'json',root:'rows',idProperty:'conty'}},fields:['conty','contx','vtamt','ttamt'],remoteSort:true,sorters:['conty ASC']});this.columns=[{text:"Condition type",width:170,dataIndex:'contx',sortable:true},{text:"Amount",width:100,xtype:'numbercolumn',dataIndex:'vtamt',sortable:true,align:'right'},{text:"Condition Amount",xtype:'numbercolumn',width:120,dataIndex:'ttamt',align:'right'}];return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.DepositOut.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'Deposit Payment preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/depositout/index/'+id+'/'+copies;}});;Ext.define('Account.DepositOut.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Deposit Payment',closeAction:'hide',height:650,width:880,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.DepositOut.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.DepositOut.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({depnr:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}}});;Ext.define('Account.DepositOut.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Deposit Payment',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;var fibasic=Ext.create('Ext.form.field.File',{width:200,x:50,y:50,hideLabel:true});this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('DP')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('DP')||UMS.CAN.CREATE('DP')||UMS.CAN.EDIT('DP'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('DP')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('DP')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.DepositOut.Item.Window');this.grid=Ext.create('Account.DepositOut.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.DepositOut.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save Deposit Payment number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/depositout/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Employee.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Employee Code, Employee Name',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'textfield',name:'empnr',hideLabel:false,fieldLabel:'Employee Code',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'textfield',name:'empnr2',hideLabel:false,fieldLabel:'To',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Employee.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'employee/loads',reader:{type:'json',root:'rows',idProperty:'empnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['empnr','name1','adr01','distx','pstlz','telf1','cidno','email','pson1'],remoteSort:true,sorters:[{property:'empnr',direction:'ASC'}]});this.columns=[{text:"Code",width:50,dataIndex:'empnr',sortable:true},{text:"Name",width:150,dataIndex:'name1',sortable:true},{text:"Address",width:200,dataIndex:'adr01',sortable:true},{text:"District",flex:true,dataIndex:'distx',sortable:true},{text:"Post Code",width:60,dataIndex:'pstlz',sortable:true},{text:"Telephon",flex:true,dataIndex:'telf1',sortable:true},{text:"Email",width:120,dataIndex:'email',sortable:true},{text:"Contact Person",flex:true,dataIndex:'pson1',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Employee.Import.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center',border:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.uploadAct=new Ext.Action({text:'Upload',iconCls:'b-small-save'});this.items=[{xtype:'filefield',name:'userfile',fieldLabel:'Excel file',labelAlign:'right',msgTarget:'side',allowBlank:false,anchor:'70%',buttonText:'Select Excel file...',allowBlank:false}];this.buttons=[this.uploadAct];this.uploadAct.setHandler(function(){_this.save();});return this.callParent(arguments);},save:function(){var _this=this,form=this.getForm();if(form.isValid()){_this.fireEvent('upload_click');form.submit({url:__site_url+'import/upload/do_upload',waitMsg:'Uploading excel file...',success:function(form,action){_this.fireEvent('upload_success',action.result.file);},failure:function(form,action){Ext.Msg.show({title:'An error occured.',msg:action.result.msg.error,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});}},reset:function(){this.getForm().reset();}});;Ext.define('Account.Employee.Import.Grid',{extend:'Ext.grid.Panel',constructor:function(config){Ext.apply(this,{viewConfig:{getRowClass:function(r,rowIndex,rowParams,store){var s=r.get('error');if(s&&s.length>0)
return'red-bg-row';}},buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.importAct=new Ext.Action({text:'Import',iconCls:'b-small-save'});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"import/employee/read",reader:{type:'json',root:'rows',idProperty:'row_id'},simpleSortMode:true},fields:['row_id','empnr','name1','adr01','distx','pstlz','telf1','cidno','email','postx','supnr','begdt','salar','bcode','saknr','pson1','telf2','statu','error'],remoteSort:false});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{text:"Employee Code",width:90,align:'center',dataIndex:'empnr',sortable:false},{text:"Employee Name",width:150,align:'center',dataIndex:'name1',sortable:false},{text:"Address",width:200,align:'center',dataIndex:'adr01',sortable:false},{text:"Province",width:80,align:'center',dataIndex:'distx',sortable:false},{text:"Post Code",width:80,align:'center',dataIndex:'pstlz',sortable:false},{text:"ID Card",width:80,align:'center',dataIndex:'cidno',sortable:false},{text:"Email",width:100,align:'center',dataIndex:'email',sortable:false},{text:"Error",width:250,dataIndex:'error',sortable:false,renderer:function(v,p,r){return(v&&v.length>0)?v:'-';}}];this.buttons=[this.importAct];this.importAct.setHandler(function(){_this.importData();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},showMask:function(msg,msgClass){msg=msg||'Please select excel file for upload.';msgClass=msgClass||'grid-disable';this.importAct.setDisabled(true);this.getEl().mask(msg,msgClass);},hideMask:function(){this.importAct.setDisabled(false);this.getEl().unmask();},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();grid.getSelectionModel().deselectAll();},importData:function(){var _this=this;var rs=[];this.store.each(function(r){rs.push(r.getData());});if(rs.length>0){this.showMask('Importing please wait','');var data_json=Ext.encode(rs);Ext.Ajax.request({url:__site_url+'import/employee/import',params:{data:data_json},success:function(response){var text=response.responseText;var data=Ext.decode(text);if(data.success){Ext.Msg.show({title:'Import success.',msg:'Import '+data.rows.length+' rows success.',buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO});_this.fireEvent('import_success',data);}else{_this.hideMask();Ext.Msg.show({title:'An error occured.',msg:response,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}},failure:function(response){Ext.Msg.show({title:'An error occured.',msg:response.responseText,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});}else{Ext.Msg.alert('Status','No datas to import.');}}});;Ext.define('Account.Employee.Import.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Employee Import',closeAction:'hide',height:600,minHeight:480,width:1000,minWidth:600,resizable:true,modal:true,layout:'border',maximizable:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Employee.Import.Form',{region:'north',height:80});this.grid=Ext.create('Account.Employee.Import.Grid',{region:'center',disbled:true});this.items=[this.form,this.grid];this.form.on('upload_success',function(file_name){_this.grid.hideMask();_this.grid.load({file:file_name});});return this.callParent(arguments);},openDialog:function(){this.form.reset();this.grid.store.removeAll();this.show(false,function(){this.grid.showMask();});}});;Ext.define('Account.Employee.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'employee/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'right',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.distrDialog=Ext.create('Account.SDistrict.MainWindow');this.positDialog=Ext.create('Account.SPosition.MainWindow');this.superDialog=Ext.create('Account.SEmployee.MainWindow');this.bankDialog=Ext.create('Account.Bankname.MainWindow');this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('EP'),fieldLabel:'Employee Status',name:'statu',editable:false,allowBlank:false,triggerAction:'all',margin:'0 0 0 43',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'customer/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.trigDistr=Ext.create('Ext.form.field.Trigger',{name:'distx',fieldLabel:'Province',triggerCls:'x-form-search-trigger',enableKeyEvents:true,labelAlign:'left',labelWidth:110,width:290,});this.trigPosit=Ext.create('Ext.form.field.Trigger',{name:'postx',fieldLabel:'Position',triggerCls:'x-form-search-trigger',enableKeyEvents:true,labelAlign:'left',labelWidth:110,width:290,});this.trigSuper=Ext.create('Ext.form.field.Trigger',{name:'supnr',fieldLabel:'Supervisor',triggerCls:'x-form-search-trigger',enableKeyEvents:true,labelAlign:'left',labelWidth:110,width:290,});this.trigBank=Ext.create('Ext.form.field.Trigger',{name:'bcode',fieldLabel:'Bank Name',triggerCls:'x-form-search-trigger',enableKeyEvents:true,labelAlign:'left',labelWidth:110,width:290,});this.numberSalary=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Base Salary',name:'salar',labelAlign:'right',width:200,hideTrigger:false,align:'right',margin:'0 0 0 43'});this.items=[{xtype:'fieldset',title:'Employee Data',items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Employee Name',name:'name1',width:400,labelWidth:110,labelAlign:'left',allowBlank:false},{xtype:'displayfield',fieldLabel:'Employee Code',name:'empnr',emptyText:'XXXXX',readOnly:true,labelAlign:'left',labelWidth:110,width:160,margin:'0 0 0 15',value:'XXXXX',labelStyle:'font-weight:bold'},{xtype:'hidden',name:'id'},{xtype:'hidden',name:'depnr'},{xtype:'hidden',name:'posnr'}]},{xtype:'textarea',fieldLabel:'Address',labelAlign:'left',name:'adr01',labelWidth:110,width:440,allowBlank:true},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigDistr,{xtype:'textfield',fieldLabel:'Post Code',name:'pstlz',emptyText:'xxxxx',labelAlign:'right',maskRe:/[\d\-]/,regex:/^\d{5}$/,regexText:'Must be in the format xxxxx',margin:'0 0 0 43'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Phone Number',name:'telf1',labelAlign:'left',labelWidth:110,width:290},{xtype:'textfield',fieldLabel:'ID Card',name:'cidno',labelAlign:'right',margin:'0 0 0 43'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Email',name:'email',labelAlign:'left',labelWidth:110,width:440},{}]}]},{xtype:'fieldset',title:'Employee Detail',defaultType:'textfield',items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigPosit,{xtype:'displayfield',fieldLabel:'Department',name:'deptx',labelAlign:'right',margin:'0 0 0 43'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigSuper,{xtype:'displayfield',name:'suptx',margin:'0 0 0 5'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Starting Date',name:'begdt',labelAlign:'left',labelWidth:110,width:290},this.numberSalary]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigBank,{xtype:'textfield',fieldLabel:'Bank Account',name:'saknr',labelAlign:'right',emptyText:'xxxxxxxxxx',maskRe:/[\d\-]/,margin:'0 0 0 43'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Contact Person',name:'pson1',labelAlign:'left',labelWidth:110,width:440},{}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Phone Number',name:'telf2',labelAlign:'left',labelWidth:110,width:290},this.comboQStatus]}]}];this.trigDistr.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'sdistrict/loads',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.trigDistr.setValue(r.data.distx);}else{o.markInvalid('Could not find Province : '+o.getValue());}}});}},this);_this.distrDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigDistr.setValue(record.data.distx);grid.getSelectionModel().deselectAll();_this.distrDialog.hide();});this.trigDistr.onTriggerClick=function(){_this.distrDialog.show();};this.trigPosit.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'sposition/loads',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.trigPosit.setValue(r.data.postx);_this.getForm().findField('depnr').setValue(r.data.depnr);_this.getForm().findField('posnr').setValue(r.data.posnr);_this.getForm().findField('deptx').setValue(r.data.deptx);}else{o.markInvalid('Could not find Position : '+o.getValue());}}});}},this);_this.positDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigPosit.setValue(record.data.postx);_this.getForm().findField('deptx').setValue(record.data.deptx);_this.getForm().findField('depnr').setValue(record.data.depnr);_this.getForm().findField('posnr').setValue(record.data.posnr);grid.getSelectionModel().deselectAll();_this.positDialog.hide();});this.trigPosit.onTriggerClick=function(){_this.positDialog.grid.load();_this.positDialog.show();};this.trigSuper.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'semployee/loads',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.trigSuper.setValue(r.data.empnr);_this.getForm().findField('suptx').setValue(r.data.name1);}else{o.markInvalid('Could not find Supervisor : '+o.getValue());}}});}},this);_this.superDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigSuper.setValue(record.data.empnr);_this.getForm().findField('suptx').setValue(record.data.name1);grid.getSelectionModel().deselectAll();_this.superDialog.hide();});this.trigSuper.onTriggerClick=function(){_this.superDialog.show();};this.trigBank.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'bankname/loads',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.trigBank.setValue(r.data.bcode);}else{o.markInvalid('Could not find Bank Name : '+o.getValue());}}});}},this);_this.bankDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigBank.setValue(record.data.bcode);grid.getSelectionModel().deselectAll();_this.bankDialog.hide();});this.trigBank.onTriggerClick=function(){_this.bankDialog.grid.load();_this.bankDialog.show();};return this.callParent(arguments);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'employee/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'employee/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.comboQStatus.setValue('01');}});;Ext.define('Account.Employee.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Employee',closeAction:'hide',height:520,width:660,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Employee.Item.Form');this.items=this.form;this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);}else{this.dialogId=null;this.form.reset();this.show(false);}}});;Ext.define('Account.Employee.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Employee Management',closeAction:'hide',height:580,minHeight:380,width:1000,minWidth:1000,resizable:true,modal:true,layout:'border',maximizable:true,defaultFocus:'code'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('EP')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('EP')||UMS.CAN.CREATE('EP')||UMS.CAN.EDIT('EP'))});this.deleteAct=new Ext.Action({text:'Delete',disabled:true,iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('EP')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('EP')});this.importAct=new Ext.Action({text:'Import',iconCls:'b-small-import',disabled:!UMS.CAN.CREATE('EP')});this.itemDialog=Ext.create('Account.Employee.Item.Window');this.importDialog=Ext.create('Account.Employee.Import.Window');this.grid=Ext.create('Account.Employee.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.Employee.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.importAct.setHandler(function(){_this.importDialog.openDialog();});this.itemDialog.form.on('afterSave',function(form){_this.itemDialog.hide();_this.grid.load();});this.itemDialog.form.on('afterDelete',function(form){_this.grid.load();});this.itemDialog.form.on('afterSave',function(){_this.itemDialog.hide();_this.grid.load();});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/employee/index?'+query;});this.importDialog.grid.on('import_success',function(){_this.importDialog.hide();_this.grid.load();});this.grid.load();return this.callParent(arguments);}});;Ext.define('GL',{extend:'Ext.data.Model',fields:[{name:'gltyp',type:'int'},{name:'saknr',type:'string'},{name:'sgtxt',type:'string'}]});Ext.define('Account.GL.Grid',{extend:'Ext.grid.Panel',requires:['Ext.ux.grid.FiltersFeature'],initComponent:function(){Ext.QuickTips.init();var filters={ftype:'filters',local:true,filters:[{type:'string',dataIndex:'saknr'},{type:'string',dataIndex:'sgtxt'}]};this.store=Ext.create('Ext.data.JsonStore',{autoDestroy:true,autoLoad:true,model:'GL',proxy:{type:'ajax',url:__site_url+"gl/loads",reader:{type:'json',root:'rows',idProperty:'saknr',totalProperty:'totalCount'},simpleSortMode:true},remoteSort:true,sorters:[{property:'saknr',direction:'ASC'}]});this.columns=[{text:"GL No",width:100,dataIndex:'saknr',sortable:true},{text:"GL Name",width:250,dataIndex:'sgtxt',sortable:true},{text:"1",hidden:true,width:0,sortable:false,dataIndex:'gltyp'}];Ext.apply(this,{forceFit:true,features:[filters]});this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.GL.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'GL Management',closeAction:'hide',height:600,minHeight:380,width:350,minWidth:300,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.GL.Grid',{region:'center'});this.items=[this.grid];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.GR.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from GR No., Vendor or PO No.',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.GR.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"gr/loads",reader:{type:'json',root:'rows',idProperty:'mbeln',totalProperty:'totalCount'},simpleSortMode:true},fields:['mbeln','bldat','lifnr','name1','netwr','statx','adr01','distx','pstlz','telf1','telfx','email'],remoteSort:true,sorters:[{property:'mbeln',direction:'ASC'}]});this.columns=[{text:"GR Doc",flex:true,dataIndex:'mbeln',sortable:true},{text:"GR Date",width:125,xtype:'datecolumn',align:'center',format:'d/m/Y',dataIndex:'bldat',sortable:true},{text:"Vendor Code",flex:true,dataIndex:'lifnr',sortable:true},{text:"Vendor Name",flex:true,dataIndex:'name1',sortable:true},{text:"Net Amount",flex:true,xtype:'numbercolumn',dataIndex:'netwr',sortable:true},{text:"GR Status",flex:true,dataIndex:'statx',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.GR.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'gr/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.poDialog=Ext.create('Account.PO.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.vendorDialog=Ext.create('Account.SVendor.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.gridItem=Ext.create('Account.GR.Item.Grid_i',{height:320,region:'center'});this.formTotal=Ext.create('Account.GR.Item.Form_t',{border:true,split:true,title:'GR Total',region:'south'});this.gridPrice=Ext.create('Account.GR.Item.Grid_pc',{border:true,split:true,title:'Item Pricing',region:'south'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('GR'),fieldLabel:'GR Status',name:'statu',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat Type',name:'taxnr',width:240,labelAlign:'right',editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select data --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payments',name:'ptype',width:280,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.hdnGrItem=Ext.create('Ext.form.Hidden',{name:'mseg',});this.trigPO=Ext.create('Ext.form.field.Trigger',{name:'ebeln',fieldLabel:'PO No',labelAlign:'letf',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigVender=Ext.create('Ext.form.field.Trigger',{name:'lifnr',fieldLabel:'Vendor Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',labelAlign:'right',width:170,hideTrigger:false,align:'right'});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:240,labelAlign:'right',allowBlank:false});this.numberVat=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Vat Value',name:'taxpr',labelAlign:'right',width:170,align:'right'});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnGrItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},{xtype:'hidden',name:'loekz'},this.trigPO,{xtype:'displayfield',width:290,allowBlank:true},{xtype:'displayfield',fieldLabel:'Goods Receipt',name:'mbeln',value:'GRXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'container',flex:0,layout:'anchor',items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigVender,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:160,allowBlank:true}]},{xtype:'textarea',fieldLabel:'Vendor Address',name:'adr01',width:450,rows:3,},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboPay,this.numberVat]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Reference No',width:450,name:'refnr',},{}]}]},{xtype:'container',flex:0,layout:'anchor',margin:'0 0 0 70',items:[this.comboPtype,{xtype:'datefield',fieldLabel:'GR Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',},this.comboTax,this.trigCurrency,{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:25,value:'Days'}]},this.comboQStatus]}]}]}]};this.items=[mainFormPanel,this.gridItem,{xtype:'tabpanel',region:'south',activeTab:0,height:200,items:[this.formTotal,this.gridPrice]}];this.trigPO.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'po/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ebeln);_this.getForm().findField('lifnr').setValue(r.data.lifnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('loekz').setValue(r.data.loekz);}else{o.markInvalid('Could not find Purchase no : '+o.getValue());}}});}},this);_this.poDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigPO.setValue(record.data.ebeln);_this.getForm().findField('lifnr').setValue(record.data.lifnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.ebeln;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'po/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('loekz').setValue(r.data.loekz);}}});grid.getSelectionModel().deselectAll();var grdponr=_this.trigPO.value;_this.gridItem.load({grdponr:grdponr});_this.poDialog.hide();});this.trigPO.onTriggerClick=function(){_this.poDialog.show();};this.trigVender.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}else{o.markInvalid('Could not find vendor code : '+o.getValue());}}});}},this);_this.vendorDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVender.setValue(record.data.lifnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.lifnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}}});grid.getSelectionModel().deselectAll();_this.vendorDialog.hide();});this.trigVender.onTriggerClick=function(){_this.vendorDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);_this.formTotal.getForm().findField('curr').setValue(r.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',r.data.ctype);});_this.gridItem.curValue=r.data.ctype;}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);_this.formTotal.getForm().findField('curr1').setValue(record.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',record.data.ctype);});_this.gridItem.curValue=record.data.ctype;grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.gridItem.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.gridItem.getSelectionModel().on('viewready',this.onViewReady,this);this.comboTax.on('change',this.calculateTotal,this);return this.callParent(arguments);},onSelectChange:function(selModel,selections){var _this=this;var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vat:sel.get('chk01')});}},onViewReady:function(grid){grid.getSelectionModel().select(0);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'gr/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnGrItem.setValue(Ext.encode(rsItem));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(mbeln){var _this=this;this.getForm().load({params:{mbeln:mbeln},url:__site_url+'gr/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({mbeln:0});this.comboQStatus.setValue('01');this.comboTax.setValue('01');this.trigCurrency.setValue('THB');this.numberVat.setValue(7);this.formTotal.getForm().findField('exchg').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=this.gridItem.store;var sum=0;var vats=0;var whts=0;var discounts=0;var vattype=this.comboTax.getValue();store.each(function(r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']),discount=parseFloat(r.data['disit']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;discount=isNaN(discount)?0:discount;var amt=qty*price;if(vattype=='02'){amt=amt*100;amt=amt/107;}
sum+=amt;discounts+=discount;amt=amt-discount;if(r.data['chk01']==true){var vat=_this.numberVat.getValue();vat=(amt*vat)/100;vats+=vat;}});this.formTotal.getForm().findField('beamt').setValue(sum);this.formTotal.getForm().findField('vat01').setValue(vats);this.formTotal.getForm().findField('dismt').setValue(discounts);this.formTotal.calculate();this.gridItem.vattValue=this.comboTax.getValue();this.gridItem.vatValue=this.numberVat.getValue();var currency=this.trigCurrency.getValue();this.gridItem.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);this.formTotal.getForm().findField('vat01').setValue(vats);var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vat:sel.get('chk01'),vattype:vattype});}}});;Ext.define('Account.GR.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'quotation/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',xtype:'textfield',fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:150,width:270,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt',align:'right',width:270,labelWidth:150,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',name:'vat01',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:270,hideTrigger:true,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',alwaysDisplayDecimals:true,style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'}]},{xtype:'container',layout:'anchor',margins:'0 0 0 145',items:[this.txtTotal,this.txtDiscountValue,this.txtDiscountSum,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtTaxValue.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'pr2/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},calculate:function(){var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discountValue=this.txtDiscountValue.getValue();if(discountValue>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var net=(total-discountValue)+vat;this.txtNet.setValue(net);}});;Ext.define('Account.GR.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMatAsset.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"gr/loads_gr_item",reader:{type:'json',root:'rows',idProperty:'mbeln,mbelp'}},fields:['mbeln','mbelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctype','chk01'],remoteSort:true,sorters:['mbelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete GR Item',scope:this,handler:this.removeRecord}]},{id:'GRiRowNumber',header:"Items",dataIndex:'mbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:80,dataIndex:'matnr',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.materialDialog.show();}},},{text:"Description",width:220,dataIndex:'maktx',sortable:false,field:{type:'textfield'},},{text:"Qty",xtype:'numbercolumn',width:70,dataIndex:'menge',sortable:false,align:'right',field:{type:'numberfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Unit",width:50,dataIndex:'meins',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.unitDialog.show();}},},{text:"Price/Unit",xtype:'numbercolumn',width:100,dataIndex:'unitp',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Discount",xtype:'numbercolumn',width:80,dataIndex:'disit',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{xtype:'checkcolumn',text:'Vat',dataIndex:'chk01',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Amount",width:90,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']),discount=parseFloat(r.data['dismt']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;discount=isNaN(discount)?0:discount;var amt=(qty*price)-discount;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:65,dataIndex:'ctype',sortable:false,align:'center',field:{type:'textfield'},}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='matnr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.matnr);rModel.set('maktx',r.data.maktx);rModel.set('meins',r.data.meins);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.materialDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('matnr',record.data.matnr);rModel.set('maktx',record.data.maktx);rModel.set('meins',record.data.meins);}
grid.getSelectionModel().deselectAll();_this.materialDialog.hide();});_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('meins',record.data.meins);}
grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,ctype:'THB'};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('ebelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.GR.Item.Grid_pc',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"pr/loads_conp_item",reader:{type:'json',root:'rows',idProperty:'conty'}},fields:['conty','contx','vtamt','ttamt'],remoteSort:true,sorters:['conty ASC']});this.columns=[{text:"Condition type",width:170,dataIndex:'contx',sortable:true},{text:"Amount",width:100,xtype:'numbercolumn',dataIndex:'vtamt',sortable:true,align:'right'},{text:"Condition Amount",xtype:'numbercolumn',width:120,dataIndex:'ttamt',align:'right'}];return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.GR.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'GR preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/gr/index/'+id+'/'+copies;}});;Ext.define('Account.GR.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Goods Receipt',closeAction:'hide',height:650,width:880,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.GR.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.GR.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({mbeln:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}}});;Ext.define('Account.GR.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Goods Receipts',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;var fibasic=Ext.create('Ext.form.field.File',{width:200,x:50,y:50,hideLabel:true});this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('GR')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('GR')||UMS.CAN.CREATE('GR')||UMS.CAN.EDIT('GR'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('GR')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('GR')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.GR.Item.Window');this.grid=Ext.create('Account.GR.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.GR.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save GR number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/gr/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Initdoc.GridItem',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({disabled:!UMS.CAN.CREATE('ID'),text:'Add',iconCls:'b-small-plus'});this.tbar=[this.addAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'initdoc/loads',reader:{type:'json',root:'rows',idProperty:'id',totalProperty:'totalCount'}},fields:[{name:'id',type:'int'},'objnr','modul','grpmo','sgtxt','short','minnr','perio','tname','tcode'],remoteSort:false,sorters:['id ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,disabled:!UMS.CAN.DELETE('ID'),handler:this.removeRecord}]},{id:'NiRowNumber',header:"No.",dataIndex:'id_doc',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Object Code ",width:80,dataIndex:'objnr',sortable:true,field:{type:'textfield'},},{text:"Object Desc.",width:100,dataIndex:'sgtxt',sortable:true,field:{type:'textfield'},},{text:"Group No.",width:100,dataIndex:'grpmo',sortable:true},{text:"Short",width:100,dataIndex:'grpmo',sortable:true,field:{type:'textfield'}},{text:"Start No.",width:100,dataIndex:'minnr',sortable:true,field:{type:'textfield'}},{text:"Period No.",width:100,dataIndex:'perio',sortable:true,field:{type:'textfield'}},{text:"Table Name",width:100,dataIndex:'tname',sortable:true,field:{type:'textfield'}},{text:"Field Name",width:100,dataIndex:'tcode',sortable:true,field:{type:'textfield'}}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});return this.callParent(arguments);},load:function(options){this.store.load({params:options,proxy:{type:'ajax',url:__site_url+'initdoc/loads',reader:{type:'json',root:'rows',idProperty:'id_doc'}},fields:[{name:'id_doc',type:'int'},'objnr','modul','grpmo','sgtxt','short','minnr','perio'],remoteSort:false,sorters:['id_doc ASC']});},addRecord:function(){var newId=-1;var i=0;this.store.each(function(r){i++;if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,invnr:''};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(i,rec);edit.startEditByPosition({row:i,column:0});this.runNumRow();},save:function(){var _this=this;var r_data=this.getData();Ext.Ajax.request({url:__site_url+'initdoc/save',method:'POST',params:{init:Ext.encode(r_data)},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){}else{Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}}});},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},reset:function(){this.grid.load({objnr:0});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('id_doc',row_num++);});}});;Ext.define('Account.Initdoc.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Initdoc Type',closeAction:'hide',height:580,width:850,layout:'border',resizable:true,modal:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.Initdoc.GridItem',{region:'center'});this.items=[this.grid];this.buttons=[{text:'Save',disabled:!(UMS.CAN.DISPLAY('ID')||UMS.CAN.CREATE('ID')||UMS.CAN.EDIT('ID')),handler:function(){Ext.Msg.show({title:"Warning",msg:"Are you sure you want to update item(s) ?",icon:Ext.Msg.WARNING,buttons:Ext.Msg.YESNO,fn:function(bt){if(bt=="yes"){_this.grid.save();}}});}},{text:'Cancel',handler:function(){_this.hide();}}];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Invoice.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Invoice, Customer, Sale Order',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Invoice.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"invoice/loads",reader:{type:'json',root:'rows',idProperty:'invnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['invnr','bldat','kunnr','name1','ordnr','sname','statx','paytx','netwr','ctype'],remoteSort:true,sorters:[{property:'invnr',direction:'ASC'}]});this.columns=[{text:"Invoice No.",width:80,align:'center',dataIndex:'invnr',sortable:true},{text:"Invoice Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Customer No",width:80,align:'center',dataIndex:'kunnr',sortable:true},{text:"Customer Name",width:150,dataIndex:'name1',sortable:true},{text:"Sale Order No.",width:80,align:'center',dataIndex:'ordnr',sortable:true},{text:"Salesperson",width:120,dataIndex:'sname',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Payment Method",width:100,dataIndex:'paytx',sortable:true},{text:"Amount",xtype:'numbercolumn',width:80,align:'right',dataIndex:'netwr',sortable:true},{text:"Currency",width:60,align:'center',dataIndex:'ctype',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Invoice.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'invoice/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.soDialog=Ext.create('Account.Saleorder.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.customerDialog=Ext.create('Account.SCustomer.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.saleDialog=Ext.create('Account.Saleperson.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.trigSale=Ext.create('Ext.form.field.Trigger',{name:'salnr',fieldLabel:'Salesperson',triggerCls:'x-form-search-trigger',labelAlign:'left',width:170,enableKeyEvents:true});this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.gridItem=Ext.create('Account.Invoice.Item.Grid_i',{height:320,region:'center'});this.gridGL=Ext.create('Account.Invoice.Item.Grid_gl',{border:true,region:'center',title:'GL Posting'});this.formTotal=Ext.create('Account.Invoice.Item.Form_t',{border:true,split:true,title:'Total->Invoice',region:'south'});this.formTotalthb=Ext.create('Account.Saleorder.Item.Form_thb',{border:true,split:true,title:'Exchange Rate->THB',region:'south'});this.gridPrice=Ext.create('Account.Invoice.Item.Grid_pc',{border:true,split:true,title:'Item Pricing',region:'south'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('IV'),fieldLabel:'INV Status',name:'statu',labelAlign:'right',width:240,margin:'0 0 0 27',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payments',name:'ptype',width:350,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.comboCond=Ext.create('Ext.form.ComboBox',{fieldLabel:'Condition',name:'condi',width:240,margin:'0 0 0 20',editable:false,labelAlign:'right',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Condition --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'invoice/loads_condcombo',reader:{type:'json',root:'rows',idProperty:'condi'}},fields:['condi','contx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'contx',valueField:'condi'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat type',name:'taxnr',width:240,margin:'0 0 0 5',labelAlign:'right',editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Vat --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.whtDialog=Ext.create('Account.WHT.Window');this.trigWHT=Ext.create('Ext.form.field.Trigger',{fieldLabel:'WHT Value',name:'whtnr',labelAlign:'right',width:150,triggerCls:'x-form-search-trigger',enableKeyEvents:true,margin:'0 0 0 25'});this.numberWHT=Ext.create('Ext.form.field.Display',{name:'whtpr',width:15,align:'right',margin:'0 0 0 8'});this.numberVat=Ext.create('Ext.form.field.Number',{fieldLabel:'Vat Value',name:'taxpr',labelAlign:'right',width:200,align:'right',margin:'0 0 0 25'});this.trigSO=Ext.create('Ext.form.field.Trigger',{name:'ordnr',fieldLabel:'SO No',labelAlign:'letf',width:240,triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigCustomer=Ext.create('Ext.form.field.Trigger',{name:'kunnr',labelAlign:'letf',width:240,fieldLabel:'Customer Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:240,margin:'0 0 0 6',labelAlign:'right',allowBlank:false});this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',labelAlign:'right',width:200,hideTrigger:false,align:'right',margin:'0 0 0 25',allowDecimals:false,minValue:0});this.hdnIvItem=Ext.create('Ext.form.Hidden',{name:'vbrp'});this.hdnGlItem=Ext.create('Ext.form.Hidden',{name:'bcus',});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnIvItem,this.hdnGlItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,defaultType:'textfield',layout:'anchor',defaults:{anchor:'100%'},items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},{xtype:'hidden',name:'loekz'},this.trigSO,{xtype:'displayfield',width:350,margins:'0 0 0 6',allowBlank:true},{xtype:'displayfield',fieldLabel:'Invoice No',name:'invnr',value:'IVXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigCustomer,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:350,allowBlank:true},{xtype:'datefield',fieldLabel:'Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false}]},{xtype:'container',layout:'hbox',defaultType:'textfield',margin:'0 0 5 0',items:[{xtype:'textarea',fieldLabel:'Bill To',name:'adr01',width:350,rows:3,editable:false,labelAlign:'top'},{xtype:'textarea',fieldLabel:'Ship To',name:'adr02',width:355,rows:3,labelAlign:'top',editable:false,margin:'0 0 0 130'}]},{xtype:'container',layout:'hbox',defaultType:'textfield',margin:'0 0 5 0',items:[this.trigSale,{xtype:'displayfield',name:'emnam',width:174,margins:'0 0 0 6'},this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:10,value:'Days'},this.trigCurrency]},{xtype:'container',layout:'hbox',defaultType:'textfield',margin:'0 0 5 0',items:[this.comboPay,{xtype:'datefield',fieldLabel:'Due Date',name:'duedt',labelAlign:'right',width:200,margin:'0 0 0 25',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},this.comboCond]},{xtype:'container',layout:'hbox',defaultType:'textfield',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Reference No',name:'refnr',width:350},this.numberVat,{xtype:'displayfield',align:'right',width:10,margin:'0 0 0 5',value:'%'},this.comboTax]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'displayfield',width:350},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigWHT,this.numberWHT,{xtype:'displayfield',align:'right',width:15,margin:'0 0 0 5',value:'%'}]},this.comboQStatus]}]}]};this.items=[mainFormPanel,this.gridItem,{xtype:'tabpanel',region:'south',activeTab:0,height:220,items:[this.formTotal,this.formTotalthb,this.gridPrice,this.gridGL]}];this.trigSO.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'saleorder/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ordnr);_this.getForm().findField('kunnr').setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('salnr').setValue(r.data.salnr);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('adr02').setValue(r.data.adr02);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('whtpr').setValue(r.data.whtpr);_this.getForm().findField('loekz').setValue(r.data.loekz);_this.getForm().findField('deamt').setValue(r.data.deamt);var sonr=_this.trigSO.value;_this.gridItem.load({sonr:sonr});}else{o.markInvalid('Could not find saleorder no : '+o.getValue());}}});}},this);_this.soDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigSO.setValue(record.data.ordnr);_this.getForm().findField('kunnr').setValue(record.data.kunnr);_this.getForm().findField('name1').setValue(record.data.name1);_this.getForm().findField('salnr').setValue(record.data.salnr);_this.getForm().findField('ptype').setValue(record.data.ptype);_this.getForm().findField('taxnr').setValue(record.data.taxnr);_this.getForm().findField('terms').setValue(record.data.terms);Ext.Ajax.request({url:__site_url+'saleorder/load',method:'POST',params:{id:record.data.ordnr},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('adr02').setValue(r.data.adr02);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('whtpr').setValue(r.data.whtpr);_this.getForm().findField('loekz').setValue(r.data.loekz);_this.getForm().findField('deamt').setValue(r.data.deamt);}}});grid.getSelectionModel().deselectAll();var sonr=_this.trigSO.value;_this.gridItem.load({sonr:sonr});_this.soDialog.hide();});this.trigSO.onTriggerClick=function(){_this.soDialog.grid.load();_this.soDialog.show();};this.trigCustomer.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('adr02').setValue(r.data.adr02);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer.setValue(record.data.kunnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.kunnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'customer/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('adr02').setValue(r.data.adr02);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}}});grid.getSelectionModel().deselectAll();_this.customerDialog.hide();});this.trigCustomer.onTriggerClick=function(){_this.customerDialog.grid.load();_this.customerDialog.show();};this.trigSale.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'saleperson/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.salnr);_this.getForm().findField('emnam').setValue(r.data.emnam);}else{o.markInvalid('Could not find project owner : '+o.getValue());}}});}},this);_this.saleDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigSale.setValue(record.data.salnr);_this.getForm().findField('emnam').setValue(record.data.emnam);grid.getSelectionModel().deselectAll();_this.saleDialog.hide();});this.trigSale.onTriggerClick=function(){_this.saleDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);_this.formTotal.getForm().findField('curr').setValue(r.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',r.data.ctype);});_this.gridItem.curValue=r.data.ctype;}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);_this.formTotal.getForm().findField('curr1').setValue(record.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',record.data.ctype);});_this.gridItem.curValue=record.data.ctype;grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};this.trigWHT.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/loads_wht',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.whtnr);_this.getForm().findField('whtpr').setValue(r.data.whtpr);}else{o.markInvalid('Could not find wht code : '+o.getValue());}}});}},this);_this.whtDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigWHT.setValue(record.data.whtnr);_this.getForm().findField('whtpr').setValue(record.data.whtpr);grid.getSelectionModel().deselectAll();_this.whtDialog.hide();});this.trigWHT.onTriggerClick=function(){_this.whtDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.gridItem.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.gridItem.getSelectionModel().on('viewready',this.onViewReady,this);this.numberCredit.on('keyup',this.getDuedate,this);this.numberCredit.on('change',this.getDuedate,this);this.comboTax.on('change',this.calculateTotal,this);this.trigCurrency.on('change',this.changeCurrency,this);this.formTotal.txtRate.on('keyup',this.calculateTotal,this);this.formTotal.txtRate.on('change',this.calculateTotal,this);this.numberWHT.on('change',this.calculateTotal,this);return this.callParent(arguments);},onSelectChange:function(selModel,selections){var _this=this;var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:this.comboTax.getValue()});}},onViewReady:function(grid){grid.getSelectionModel().select(0);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'invoice/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnIvItem.setValue(Ext.encode(rsItem));var rsGL=_this.gridGL.getData();this.hdnGlItem.setValue(Ext.encode(rsGL));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){_this.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{invnr:invnr},url:__site_url+'invoice/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({invnr:0});this.gridGL.load({netpr:0});this.gridPrice.load({belnr:0});this.comboQStatus.setValue('01');this.comboTax.setValue('01');this.trigCurrency.setValue('THB');this.numberVat.setValue(7);this.numberWHT.setValue(3);this.getForm().findField('bldat').setValue(new Date());this.formTotal.getForm().findField('exchg').setValue('1.0000');this.formTotalthb.getForm().findField('exchg2').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=this.gridItem.store;var sum=0;var vats=0;sum2=0;var whts=0;var discounts=0;var saknr_list=[];var vattype=this.comboTax.getValue();store.each(function(r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']),discount=parseFloat(r.data['disit']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;discount=isNaN(discount)?0:discount;var amt=qty*price;if(vattype=='02'){amt=amt*100;amt=amt/107;}
sum+=amt;discounts+=discount;amt=amt-discount;sum2+=amt;if(r.data['chk01']==true){var vat=_this.numberVat.getValue();vat=(amt*vat)/100;vats+=vat;}
var item=r.data['saknr']+'|'+amt;saknr_list.push(item);if(r.data['chk02']==true){var wht=_this.numberWHT.getValue();wht=(amt*wht)/100;whts+=wht;}});this.formTotal.getForm().findField('beamt').setValue(sum);this.formTotal.getForm().findField('vat01').setValue(vats);this.formTotal.getForm().findField('wht01').setValue(whts);this.formTotal.getForm().findField('dismt').setValue(discounts);var net=this.formTotal.calculate();this.formTotal.taxType=this.comboTax.getValue();this.gridItem.vatValue=this.numberVat.getValue();var currency=this.trigCurrency.getValue();this.gridItem.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);this.formTotalthb.getForm().findField('curr2').setValue(currency);this.gridItem.customerValue=this.trigCustomer.getValue();var rate=this.formTotal.getForm().findField('exchg').getValue();var deamt=this.formTotal.getForm().findField('deamt').getValue();if(currency!='THB'){sum=sum*rate;sum2=sum2*rate;vats=vats*rate;whts=whts*rate;discounts=discounts*rate;deamt=deamt*rate;}
this.formTotalthb.getForm().findField('beamt2').setValue(sum);this.formTotalthb.getForm().findField('vat02').setValue(vats);this.formTotalthb.getForm().findField('wht02').setValue(whts);this.formTotalthb.getForm().findField('dismt2').setValue(discounts);this.formTotalthb.getForm().findField('exchg2').setValue(rate);this.formTotalthb.getForm().findField('deamt2').setValue(deamt);var net2=this.formTotalthb.calculate();if(sum>0&&this.trigCustomer.getValue()!=''){_this.gridGL.load({netpr:sum2,vvat:vats,kunnr:this.trigCustomer.getValue(),items:saknr_list.join(',')});}
var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:this.comboTax.getValue()});}},getDuedate:function(){var bForm=this.getForm(),credit=this.numberCredit.getValue(),startDate=bForm.findField('bldat').getValue();if(!Ext.isEmpty(credit)&&credit>0){var result=Ext.Date.add(startDate,Ext.Date.DAY,credit),dueDateField=bForm.findField('duedt');if(!Ext.isEmpty(credit)&&!Ext.isEmpty(dueDateField))
dueDateField.setValue(result);}},changeCurrency:function(){var _this=this;var store=this.gridItem.store;var currency=this.trigCurrency.getValue();store.each(function(r){r.set('ctyp1',currency);});}});;Ext.define('Account.Invoice.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'invoice/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip'}});return this.callParent(arguments);},initComponent:function(){var _this=this;var myStorecomboWHTno=Ext.create('Ext.data.Store',{fields:['idWHT','name'],data:[{"idWHT":"01","name":"นิติบุคคล"},{"idWHT":"02","name":"บุคคลธรรมดา"}]});this.whtDialog=Ext.create('Account.WHT.Window');this.trigWHT=Ext.create('Ext.form.field.Trigger',{name:'whtnr',labelAlign:'letf',width:50,triggerCls:'x-form-search-trigger',enableKeyEvents:true,margin:'4 0 0 10'});this.comboWHType=Ext.create('Ext.form.ComboBox',{fieldLabel:'Witholding Tax',name:'whtyp',width:240,triggerAction:'all',clearFilterOnReset:true,emptyText:'--Select WHT Typ--',margin:'4 0 0 0',store:myStorecomboWHTno,labelAlign:'left',queryMode:'local',displayField:'name',valueField:'idWHT'});this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',labelWidth:155,alwaysDisplayDecimals:true,width:270,readOnly:true});this.txtDepositValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Deposit Receipt',name:'deamt',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount & Deposit',name:'bbb',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:155,name:'vat01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtWHTValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'WHT Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:155,name:'wht01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:240,hideTrigger:true,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',width:270,labelWidth:155,alwaysDisplayDecimals:true,margin:'4 0 0 0',style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'},{xtype:'container',layout:'hbox',anchor:'100%',items:[this.comboWHType,this.trigWHT,{xtype:'textfield',name:'whtxt',margin:'4 0 0 7',width:250}]}]},{xtype:'container',layout:'anchor',margins:'0 0 0 20',items:[this.txtTotal,this.txtDiscountValue,this.txtDepositValue,this.txtDiscountSum,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];this.trigWHT.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/loads_wht',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.whtnr);if(r.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(r.data.whtxt);}}else{o.markInvalid('Could not find wht code : '+o.getValue());}}});}},this);_this.whtDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigWHT.setValue(record.data.whtnr);if(record.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(record.data.whtxt);}
grid.getSelectionModel().deselectAll();_this.whtDialog.hide();});this.trigWHT.onTriggerClick=function(){_this.whtDialog.show();};var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtTaxValue.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtWHTValue.on('render',setAlignRight);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'invoice/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},ex_rate:function(id){var _this=this;_this.getForm().calculateTotal();},calculate:function(){var _this=this;var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discountValue=this.txtDiscountValue.getValue();var depositValue=this.txtDepositValue.getValue();if(discountValue>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var wht=this.txtWHTValue.getValue();var net=(total-discountValue)+(vat-wht);net=net-depositValue;this.txtNet.setValue(net);return net;}});;Ext.define('Account.Invoice.Item.Grid_gl',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',disabled:true,iconCls:'b-small-copy'});this.glDialog=Ext.create('Account.GL.MainWindow');this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"invoice/loads_gl_item",reader:{type:'json',root:'rows',idProperty:'belnr,belpr'}},fields:['belnr','belpr','saknr','sgtxt','debit','credi','txz01'],remoteSort:true,sorters:['belpr ASC']});this.columns=[{id:'RowNumber2',text:"No.",dataIndex:'belpr',width:50,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"GL No.",width:100,dataIndex:'saknr',align:'center',sortable:false,},{text:"GL Description",width:215,dataIndex:'sgtxt',sortable:true},{text:"Debit",width:100,dataIndex:'debit',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,},{text:"Credit",width:100,dataIndex:'credi',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,},{text:"Comment",width:250,dataIndex:'txz01',sortable:true,field:{type:'textfield'}}];this.plugins=[this.editing];this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='saknr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.saknr);rModel.set('sgtxt',r.data.sgtxt);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.glDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('saknr',record.data.saknr);rModel.set('sgtxt',record.data.sgtxt);}
grid.getSelectionModel().deselectAll();_this.glDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addDefaultRecord:function(){this.store.removeAll();var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;for(var i=0;i<5;i++){rec={id:i};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();}},addRecord2:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();},removeRecord2:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow2();},runNumRow2:function(){var row_num=0;this.store.each(function(r){r.set('belpr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.Invoice.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMaterial.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"invoice/loads_iv_item",reader:{type:'json',root:'rows',idProperty:'invnr,vbelp'}},fields:['invnr','vbelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctype','chk01','chk02','saknr'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Invoice Item',scope:this,handler:this.removeRecord}]},{id:'RowNumber',text:"No.",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:110,dataIndex:'matnr',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.materialDialog.show();}},},{text:"Description",width:220,dataIndex:'maktx',sortable:false,field:{type:'textfield'},},{text:"Qty",xtype:'numbercolumn',width:60,dataIndex:'menge',sortable:false,align:'right',field:{type:'numberfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Unit",width:50,dataIndex:'meins',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.unitDialog.show();}},},{text:"Price/Unit",xtype:'numbercolumn',width:80,dataIndex:'unitp',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Discount",xtype:'numbercolumn',width:70,dataIndex:'disit',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{xtype:'checkcolumn',text:'Vat',dataIndex:'chk01',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{xtype:'checkcolumn',text:'WHT',dataIndex:'chk02',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Amount",width:120,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge'].replace(/[^0-9.]/g,'')),price=parseFloat(r.data['unitp'].replace(/[^0-9.]/g,'')),qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:55,dataIndex:'ctype',sortable:false,align:'center',field:{type:'textfield'},},{dataIndex:'saknr',width:55,sortable:false}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='matnr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.matnr);rModel.set('maktx',r.data.maktx);rModel.set('meins',r.data.meins);rModel.set('unitp',r.data.cost);rModel.set('saknr',r.data.saknr);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.materialDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('matnr',record.data.matnr);rModel.set('maktx',record.data.maktx);rModel.set('meins',record.data.meins);rModel.set('saknr',r.data.saknr);var v=record.data.matnr;var cusno=_this.customerValue;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v,kunnr:cusno},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success&&r.data.cost){rModel.set('unitp',r.data.cost);}}});}
grid.getSelectionModel().deselectAll();_this.materialDialog.hide();});_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('meins',record.data.meins);}
grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});this.store.on('load',function(store,rs){if(_this.readOnly){var view=_this.getView();var t=_this.getView().getEl().down('table');t.addCls('mask-grid-readonly');_this.readOnlyMask=new Ext.LoadMask(t,{msg:"..."});_this.readOnlyMask.show();}else{if(_this.readOnlyMask)
_this.readOnlyMask.hide();}});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,ctype:'THB'};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();this.getSelectionModel().deselectAll();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.Invoice.Item.Grid_pc',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"quotation/loads_conp_item",reader:{type:'json',root:'rows',idProperty:'conty'}},fields:['conty','contx','vtamt','ttamt'],remoteSort:true,sorters:['conty ASC']});this.columns=[{text:"Condition type",width:180,dataIndex:'contx',sortable:true},{text:"Amount",xtype:'numbercolumn',width:100,xtype:'numbercolumn',dataIndex:'vtamt',sortable:true,align:'right'},{text:"Condition Amount",xtype:'numbercolumn',width:120,dataIndex:'ttamt',align:'right'}];return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.Invoice.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'Invoice preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/invoice/index/'+id+'/'+copies;}});;Ext.define('Account.Invoice.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Invoice',closeAction:'hide',height:700,width:950,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Invoice.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.Invoice.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.btnSave=Ext.create('Ext.Button',{text:'Save',disabled:!(UMS.CAN.CREATE('QT')||UMS.CAN.EDIT('QT')||UMS.CAN.APPROVE('QT')),handler:function(){_this.form.save();}});this.buttons=[this.btnSave,{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({invnr:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}},setReadOnly:function(readOnly){var children=this.items?this.items.items:[];for(var i=0;i<children.length;i++){var child=children[i];child.query('.field').forEach(function(c){if(!c.initialConfig.readOnly){c.setReadOnly(readOnly);}});child.query('.button').forEach(function(c){if(c.xtype!='tab'){if(!c.initialConfig.disabled)
c.setDisabled(readOnly);}});}
this.form.gridItem.readOnly=readOnly;if(!this.btnSave.initialConfig.disabled)
this.btnSave.setDisabled(readOnly);}});;Ext.define('Account.Invoice.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Invoice',closeAction:'hide',height:600,minHeight:380,width:950,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;var fibasic=Ext.create('Ext.form.field.File',{width:200,x:50,y:50,hideLabel:true});this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('IV')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('IV')||UMS.CAN.CREATE('IV')||UMS.CAN.EDIT('IV'))});this.displayAct=new Ext.Action({text:'Display',iconCls:'b-small-search',disabled:!UMS.CAN.DISPLAY('IV')});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('IV')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('IV')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.Invoice.Item.Window');this.grid=Ext.create('Account.Invoice.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.displayAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.Invoice.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(false);}});this.displayAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(true);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save Invoice number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/invoice/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Journal.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Journal No, Ref Doc, Customer',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[{xtype:'displayfield',name:'bbb'},{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Journal.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({pageSize:25,proxy:{type:'ajax',url:__site_url+'journal/loads',reader:{type:'json',root:'rows',idProperty:'belnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['belnr','bldat','typtx','tranr','trantx','refnr','kunnr','txz01','netwr'],remoteSort:true,sorters:[{property:'belnr',direction:'ASC'}]});this.columns=[{text:"Journal Code",align:'center',width:100,dataIndex:'belnr',sortable:true},{text:"Journal Type",align:'center',width:100,dataIndex:'typtx',sortable:true},{text:"Journal Date",align:'center',width:80,dataIndex:'bldat',sortable:true,xtype:'datecolumn',format:'d/m/Y'},{text:"Template Code",align:'center',width:80,dataIndex:'tranr',sortable:true},{text:"Template Name",align:'center',width:100,dataIndex:'trantx',sortable:true},{text:"Reference Doc.",width:100,dataIndex:'refnr',sortable:true},{text:"Custumer Code",width:100,dataIndex:'kunnr',sortable:true},{text:"Text Note",width:200,dataIndex:'txz01',sortable:true},{text:"Amount",xtype:'numbercolumn',width:120,dataIndex:'netwr',sortable:true}];this.bbar={xtype:'pagingtoolbar',store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Journal.Import.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center',border:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.uploadAct=new Ext.Action({text:'Upload',iconCls:'b-small-save'});this.items=[{xtype:'filefield',name:'userfile',fieldLabel:'Excel file',labelAlign:'right',msgTarget:'side',allowBlank:false,anchor:'70%',buttonText:'Select Excel file...',allowBlank:false}];this.buttons=[this.uploadAct];this.uploadAct.setHandler(function(){_this.save();});return this.callParent(arguments);},save:function(){var _this=this,form=this.getForm();if(form.isValid()){_this.fireEvent('upload_click');form.submit({url:__site_url+'import/upload/do_upload',waitMsg:'Uploading excel file...',success:function(form,action){_this.fireEvent('upload_success',action.result.file);},failure:function(form,action){Ext.Msg.show({title:'An error occured.',msg:action.result.msg.error,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});}},reset:function(){this.getForm().reset();}});;Ext.define('Account.Journal.Import.Grid',{extend:'Ext.grid.Panel',constructor:function(config){Ext.apply(this,{viewConfig:{getRowClass:function(r,rowIndex,rowParams,store){var s=r.get('error');if(s&&s.length>0)
return'red-bg-row';}},buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.importAct=new Ext.Action({text:'Import',iconCls:'b-small-save'});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"import/salary/read",reader:{type:'json',root:'rows',idProperty:'row_id'},simpleSortMode:true},fields:['row_id','empnr','name1','glcod','salar','socia','cosoc','withh','netpa','glban','error'],remoteSort:false});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{text:"Employee ID",width:100,align:'center',dataIndex:'empnr',sortable:false},{text:"Employee Name",width:150,align:'center',dataIndex:'name1',sortable:false},{text:"GL Code",width:200,align:'center',dataIndex:'glcod',sortable:false},{text:"Salary",width:80,align:'center',dataIndex:'salar',sortable:false},{text:"Social Fund",width:80,align:'center',dataIndex:'socia',sortable:false},{text:"Social Fund Contribution",width:80,align:'center',dataIndex:'cosoc',sortable:false},{text:"Withholding Tax",width:100,align:'center',dataIndex:'withh',sortable:false},{text:"Net Paid",width:100,align:'center',dataIndex:'netpa',sortable:false},{text:"GL Code Bank",width:100,align:'center',dataIndex:'glban',sortable:false},{text:"Error",width:250,dataIndex:'error',sortable:false,renderer:function(v,p,r){return(v&&v.length>0)?v:'-';}}];this.buttons=[this.importAct];this.importAct.setHandler(function(){_this.importData();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},showMask:function(msg,msgClass){msg=msg||'Please select excel file for upload.';msgClass=msgClass||'grid-disable';this.importAct.setDisabled(true);this.getEl().mask(msg,msgClass);},hideMask:function(){this.importAct.setDisabled(false);this.getEl().unmask();},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();grid.getSelectionModel().deselectAll();},importData:function(){var _this=this;var rs=[];this.store.each(function(r){rs.push(r.getData());});if(rs.length>0){this.showMask('Importing please wait','');var data_json=Ext.encode(rs);Ext.Ajax.request({url:__site_url+'import/salary/import',params:{data:data_json},success:function(response){var text=response.responseText;var data=Ext.decode(text);if(data.success){Ext.Msg.show({title:'Import success.',msg:'Import '+data.rows.length+' rows success.',buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO});_this.fireEvent('import_success',data);}else{_this.hideMask();Ext.Msg.show({title:'An error occured.',msg:response,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}},failure:function(response){Ext.Msg.show({title:'An error occured.',msg:response.responseText,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});}else{Ext.Msg.alert('Status','No datas to import.');}}});;Ext.define('Account.Journal.Import.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Journal Import',closeAction:'hide',height:600,minHeight:480,width:1000,minWidth:600,resizable:true,modal:true,layout:'border',maximizable:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Journal.Import.Form',{region:'north',height:80});this.grid=Ext.create('Account.Journal.Import.Grid',{region:'center',disbled:true});this.items=[this.form,this.grid];this.form.on('upload_success',function(file_name){_this.grid.hideMask();_this.grid.load({file:file_name});});return this.callParent(arguments);},openDialog:function(){this.form.reset();this.grid.store.removeAll();this.show(false,function(){this.grid.showMask();});}});;Ext.define('Account.Journal.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'journal/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.journalDialog=Ext.create('Account.Journaltemp.MainWindow',{disableGridDoubleClick:true});this.gridItem=Ext.create('Account.Journal.Item.Grid_gl',{height:320,region:'center'});this.formTotal=Ext.create('Account.Journal.Item.Form_t',{border:true,split:true,region:'south'});this.comboType=Ext.create('Ext.form.ComboBox',{fieldLabel:'Journal Type',name:'ttype',labelAlign:'letf',width:240,labelWidth:90,allowBlank:false,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Type --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'journal/loads_jtypecombo',reader:{type:'json',root:'rows',idProperty:'ttype'}},fields:['ttype','typtx'],remoteSort:true,sorters:'ttype ASC'}),listeners:{select:function(combo,record,index){var value=combo.getValue();}},queryMode:'remote',displayField:'typtx',valueField:'ttype'});this.trigJournal=Ext.create('Ext.form.field.Trigger',{name:'tranr',labelAlign:'letf',width:240,labelWidth:90,fieldLabel:'Template Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.hdnTrItem=Ext.create('Ext.form.Hidden',{name:'bsid'});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnTrItem,{xtype:'fieldset',title:'Header Data',collapsible:true,defaultType:'textfield',layout:'anchor',defaults:{anchor:'100%'},items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},this.comboType,{xtype:'displayfield',width:255,margins:'0 0 0 6'},{xtype:'displayfield',fieldLabel:'Journal Code',name:'belnr',value:'XXXXXX-XXXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigJournal,{xtype:'displayfield',name:'txz02',margins:'0 0 0 6',width:255},{xtype:'datefield',fieldLabel:'Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Description',name:'txz00',labelWidth:90,labelAlign:'left',width:450},{xtype:'textfield',fieldLabel:'Reference No',name:'refnr',margins:'0 0 0 50',width:240}]}]}]};this.items=[mainFormPanel,this.gridItem,this.formTotal];this.trigJournal.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'journaltemp/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.tranr);_this.getForm().findField('txz02').setValue(r.data.txz01);var tranr=_this.trigJournal.value;_this.gridItem.load({tranr1:tranr});}else{o.markInvalid('Could not find Journal Template : '+o.getValue());}}});}},this);_this.journalDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigJournal.setValue(record.data.tranr);_this.getForm().findField('txz02').setValue(record.data.txz01);grid.getSelectionModel().deselectAll();var tranr=_this.trigJournal.value;_this.gridItem.load({tranr1:tranr});_this.journalDialog.hide();});this.trigJournal.onTriggerClick=function(){_this.journalDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.comboType.on('select',this.setJtype,this);return this.callParent(arguments);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'journal/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnTrItem.setValue(Ext.encode(rsItem));var net=_this.getForm().findField('netwr1').getValue();if(net==0){if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}}else{Ext.Msg.alert('Balance result not equal');}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'journal/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.getForm().findField('bldat').setValue(new Date());},calculateTotal:function(){var store=this.gridItem.store;var debsum=0;var cresum=0;store.each(function(r){var debit=parseFloat(r.data['debit']),credit=parseFloat(r.data['credi']);debit=isNaN(debit)?0:debit;credit=isNaN(credit)?0:credit;debsum+=debit;cresum+=credit;});this.formTotal.getForm().findField('debit').setValue(Ext.util.Format.usMoney(debsum).replace(/\$/,''));this.formTotal.getForm().findField('credi').setValue(Ext.util.Format.usMoney(cresum).replace(/\$/,''));this.formTotal.calculate();},setJtype:function(combo,record,index){var _this=this;var ttype=combo.getValue();var field=this.journalDialog.searchForm.form.findField('ttype');field.setValue(ttype);this.journalDialog.grid.load();}});;Ext.define('Account.Journal.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'journal/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip'}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.txtDebit=Ext.create('widget.numericfield',{fieldLabel:'Total Amount',name:'debit',labelWidth:90,width:190,margin:'0 0 0 290',labelStyle:'font-weight:bold;',readOnly:true});this.txtCredit=Ext.create('widget.numericfield',{name:'credi',width:100,readOnly:true});this.txtNet=Ext.create('widget.numericfield',{xtype:'textfield',fieldLabel:'Balance Amount',name:'netwr1',align:'right',width:220,labelWidth:110,margin:'0 0 0 10',labelStyle:'font-weight:bold;background-color: #15b52c;',readOnly:true});this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.txtDebit,this.txtCredit,this.txtNet]}];var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};var tnet=this.txtNet.getValue();this.txtDebit.on('render',setAlignRight);this.txtCredit.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'journal/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'journal/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},calculate:function(){var debit=this.txtDebit.getValue();var credit=this.txtCredit.getValue();var net=debit-credit;this.txtNet.setValue(Ext.util.Format.usMoney(net).replace(/\$/,''));}});;Ext.define('Account.Journal.Item.Grid_gl',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.glDialog=Ext.create('Account.GL.MainWindow');this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"journal/loads_gl_item",reader:{type:'json',root:'rows',idProperty:'belnr,belpr'}},fields:['belnr','belpr','saknr','sgtxt','debit','credi','txz01'],remoteSort:true,sorters:['belpr ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Journal Item',scope:this,handler:this.removeRecord}]},{id:'RowNumber30',header:"No.",dataIndex:'belpr',width:50,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"GL No.",width:100,dataIndex:'saknr',align:'center',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.glDialog.show();}}},{text:"GL Description",width:215,dataIndex:'sgtxt',sortable:true},{text:"Debit",width:100,dataIndex:'debit',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,field:{type:'numberfield',decimalPrecision:2}},{text:"Credit",width:100,dataIndex:'credi',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,field:{type:'numberfield',decimalPrecision:2}},{text:"Comment",width:250,dataIndex:'txz01',sortable:true,field:{type:'textfield'}}];this.plugins=[this.editing];this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='saknr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.saknr);rModel.set('sgtxt',r.data.sgtxt);if(r.data.gltyp=='1'){rModel.set('debit','1.00');}else if(record.data.gltyp=='2'){rModel.set('credi','1.00');}}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.glDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('saknr',record.data.saknr);rModel.set('sgtxt',record.data.sgtxt);if(record.data.gltyp=='1'){rModel.set('debit','1.00');}else if(record.data.gltyp=='2'){rModel.set('credi','1.00');}}
grid.getSelectionModel().deselectAll();_this.glDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addDefaultRecord:function(){this.store.removeAll();var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;for(var i=0;i<5;i++){rec={id:i};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();}},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('belpr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.Journal.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Journal',closeAction:'hide',height:450,width:860,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Journal.Item.Form',{region:'center'});this.items=[this.form];this.buttons=[{text:'Save',disabled:!(UMS.CAN.CREATE('JN')||UMS.CAN.EDIT('JN')),handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.form.gridItem.load({belnr:0});_this.hide();}}];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({belnr:id});}else{this.dialogId=null;this.form.reset();this.show(false);}}});;Ext.define('Account.Journal.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Journal',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('JN')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('JN')||UMS.CAN.CREATE('JN')||UMS.CAN.EDIT('JN'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('JN')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('QT')});this.importAct=new Ext.Action({text:'Salary Import',disabled:!UMS.CAN.CREATE('JN'),iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.Journal.Item.Window');this.importDialog=Ext.create('Account.Journal.Import.Window');this.grid=Ext.create('Account.Journal.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.Journal.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.importAct.setHandler(function(){_this.importDialog.openDialog();});this.itemDialog.form.on('afterSave',function(form){_this.itemDialog.hide();_this.grid.load();});this.itemDialog.form.on('afterDelete',function(form){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();opts.params=Ext.apply(opts.params,formValues);}});if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
this.importDialog.grid.on('import_success',function(){_this.importDialog.hide();_this.grid.load();});this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/journal/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Journaltemp.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Journal Template and Description',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});this.items=[{name:'ttype',xtype:'hiddenfield'},this.txtQuery];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Journaltemp.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'journaltemp/loads',reader:{type:'json',root:'rows',idProperty:'tranr',totalProperty:'totalCount'},simpleSortMode:true},fields:['typtx','tranr','txz01'],remoteSort:true,sorters:[{property:'tranr',direction:'ASC'}]});this.columns=[{text:"Journal Type",align:'center',width:100,dataIndex:'typtx',sortable:true},{text:"Template Code",align:'center',width:100,dataIndex:'tranr',sortable:true},{text:"Template Name",width:290,dataIndex:'txz01',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Journaltemp.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'journaltemp/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.gridItem=Ext.create('Account.Journaltemp.Item.Grid_gl',{height:320,region:'center'});this.comboType=Ext.create('Ext.form.ComboBox',{fieldLabel:'Journal Type',name:'ttype',labelAlign:'letf',width:240,labelWidth:100,allowBlank:false,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Type --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'journaltemp/loads_jtypecombo',reader:{type:'json',root:'rows',idProperty:'ttype'}},fields:['ttype','typtx'],remoteSort:true,sorters:'ttype ASC'}),queryMode:'remote',displayField:'typtx',valueField:'ttype'});this.hdnTrItem=Ext.create('Ext.form.Hidden',{name:'trpo'});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnTrItem,{xtype:'fieldset',title:'Header Data',collapsible:true,defaultType:'textfield',layout:'anchor',defaults:{anchor:'100%'},items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},this.comboType,{xtype:'displayfield',width:200,margins:'0 0 0 6',allowBlank:true},{xtype:'displayfield',fieldLabel:'Template Code',name:'tranr',value:'XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'}]},{xtype:'textfield',fieldLabel:'Template Name',name:'txz01',width:300,allowBlank:false}]}]};this.items=[mainFormPanel,this.gridItem];return this.callParent(arguments);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'journaltemp/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnTrItem.setValue(Ext.encode(rsItem));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'journaltemp/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.addDefaultRecord();}});;Ext.define('Account.Journaltemp.Item.Grid_gl',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.glDialog=Ext.create('Account.GL.MainWindow');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"journaltemp/loads_gl_item",reader:{type:'json',root:'rows',idProperty:'tranr,trapr'}},fields:['tranr','trapr','saknr','sgtxt','debit','credi','txz01'],remoteSort:true,sorters:['trapr ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Template Item',scope:this,handler:this.removeRecord}]},{id:'RowNumber31',header:"No.",dataIndex:'trapr',width:50,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"GL No.",width:100,dataIndex:'saknr',align:'center',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.glDialog.show();}}},{text:"GL Description",width:300,dataIndex:'sgtxt',sortable:true},{text:"Debit",width:100,dataIndex:'debit',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,field:{type:'numberfield',decimalPrecision:2}},{text:"Credit",width:100,dataIndex:'credi',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,field:{type:'numberfield',decimalPrecision:2}},{text:"Remarks",width:250,dataIndex:'txz01',sortable:true,field:{type:'textfield'}}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='saknr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.saknr);rModel.set('sgtxt',r.data.sgtxt);if(r.data.glcre=='-1'){rModel.set('debit','1.00');}else if(record.data.glcre=='1'){rModel.set('credi','1.00');}}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.glDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('saknr',record.data.saknr);rModel.set('sgtxt',record.data.sgtxt);if(r.data.glcre=='-1'){rModel.set('debit','1.00');}else if(record.data.glcre=='1'){rModel.set('credi','1.00');}}
grid.getSelectionModel().deselectAll();_this.glDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addDefaultRecord:function(){this.store.removeAll();var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;for(var i=0;i<5;i++){rec={id:i};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();}},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('trpr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.Journaltemp.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Journal Template',closeAction:'hide',height:450,width:910,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Journaltemp.Item.Form',{region:'center'});this.items=[this.form];this.buttons=[{text:'Save',disabled:!(UMS.CAN.CREATE('JT')||UMS.CAN.EDIT('JT')),handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({tranr:id});}else{this.dialogId=null;this.form.reset();this.show(false);}}});;Ext.define('Account.Journaltemp.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Journal Template',closeAction:'hide',height:580,minHeight:380,width:500,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('JT')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('JT')||UMS.CAN.CREATE('JT')||UMS.CAN.EDIT('JT'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('JT')});this.itemDialog=Ext.create('Account.Journaltemp.Item.Window');this.grid=Ext.create('Account.Journaltemp.Grid',{region:'center',border:false});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.Journaltemp.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.tbar=[this.addAct,this.editAct,this.deleteAct];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form){_this.itemDialog.hide();_this.grid.load();});this.itemDialog.form.on('afterDelete',function(form){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();opts.params=Ext.apply(opts.params,formValues);}});if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Journaltype.Grid',{extend:'Ext.grid.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'journaltype/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'journaltype/loads',reader:{type:'json',root:'rows',idProperty:''}},fields:['typtx'],remoteSort:true,sorters:['bcode ASC']});this.columns=[{xtype:'actioncolumn',text:"Journal Code",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Invoice Item',scope:this,handler:this.removeRecord}]},{text:"Journal Type",width:150,dataIndex:'typtx',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('ttype',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnIvItem.setValue(Ext.encode(rsItem));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'invoice/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},});;Ext.define('Account.Journaltype.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Bank Name',closeAction:'hide',height:380,minHeight:380,width:500,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true,defaultFocus:'code'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.Journaltype.Grid',{region:'center',border:false});this.items=[this.grid];this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Login.MainWindow',{extend:'Ext.window.Window',constructor:function(config){var _this=this;var store_company=Ext.create('Ext.data.ArrayStore',{fields:[{name:'comid',type:'string'},{name:'name1',type:'string'}],sortInfo:{field:'name1',direction:'ASC'}});var lblCompany=Ext.create('Ext.form.Label',{layout:'absolute',x:20,y:20,text:'Company :'});var lblUserName=Ext.create('Ext.form.Label',{layout:'absolute',x:20,y:55,text:'User   :'});var lblPassword=Ext.create('Ext.form.Label',{layout:'absolute',x:20,y:90,text:'Password :'});var cbCompany=Ext.create('Ext.form.ComboBox',{rtl:false,x:80,y:15,width:200,emptyText:'Company',triggerAction:'all',lazyRender:true,selectOnFocus:true,queryMode:'local',displayField:'name1',valueField:'comid',store:store_company});var txtUserName=Ext.create('Ext.form.Text',{layout:'absolute',width:200,x:80,y:50});var txtPassword=Ext.create('Ext.form.Text',{layout:'absolute',inputType:'password',x:80,y:85,width:200});var lblLoginError=Ext.create('Ext.form.Label',{layout:'absolute',style:{color:'red'},x:20,y:145,hidden:true,text:'*Invalid UserName/Password*'});var btnLogin=Ext.create('Ext.Button',{text:'Login',x:110,y:120,width:80,handler:function(){CheckLogin();}});var btnReset=Ext.create('Ext.Button',{text:'Reset',x:200,y:120,width:80,handler:function(){GetReset();}});var form_login=Ext.create('Ext.form.Panel',{layout:'absolute',frame:true,width:320,height:200,items:[lblCompany,cbCompany,lblUserName,txtUserName,lblPassword,txtPassword,lblLoginError,btnLogin,btnReset]});function GetReset()
{cbCompany.reset();txtUserName.setValue('');txtPassword.setValue('');lblLoginError.setVisible(false);}
function GetCompany()
{Ext.Ajax.request({url:__site_url+'login/GetCompany',disableCaching:false,success:function(res){var arrCompany=res.responseText.split('|');var detail=arrCompany;var data;var myData=new Array();var i;var strTemp;if(detail!=''){for(i=0;i<arrCompany.length;i++){data=new Array();strTemp=arrCompany[i].split('+')
data[0]=strTemp[0];data[1]=strTemp[1];myData[i]=data;}}
else{data=new Array();myData=data;}
store_company.loadData(myData);}});}
function CheckLogin()
{var comid=cbCompany.getValue();var uname=txtUserName.getRawValue();var passw=txtPassword.getRawValue();Ext.Ajax.request({url:__site_url+'login/CheckLogin?uname='+uname+'&passw='+passw+'&comid='+comid,disableCaching:false,success:function(res){GetResultLogin(res.responseText);}});}
function GetResultLogin(strData)
{if(strData!="")
{arrPermit=new Array();var arrData=strData.split("|");var strTemp;for(i=0;i<arrData.length;i++)
{strTemp=arrData[i].split('+')
arrPermit[strTemp[3]]=new Array(5);arrPermit[strTemp[3]]['display']=strTemp[4];arrPermit[strTemp[3]]['create']=strTemp[5];arrPermit[strTemp[3]]['edit']=strTemp[6];arrPermit[strTemp[3]]['delete']=strTemp[7];arrPermit[strTemp[3]]['export']=strTemp[8];arrPermit[strTemp[3]]['approve']=strTemp[9];}
Ext.getCmp('lblUserName-default').setText('User Name : '+strTemp[1]);lblLoginError.setVisible(false);_this.hide();}
else{lblLoginError.setVisible(true);}}
GetCompany();Ext.apply(this,{title:'Login',closeAction:'hide',width:320,height:220,resizable:false,modal:true,layout:'fit',maximizable:false,items:[form_login],buttons:[]});return this.callParent(arguments);}});;Ext.define('Account.Material.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Material No., Mat Type or Group',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Material.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"material/loads",reader:{type:'json',root:'rows',idProperty:'matnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['matnr','maktx','mtart','mtype','matkl','mgrpp','saknr','meins','sgtxt','erdat','statx','cost1','unit1','cost2','unit2','cost3','unit3'],remoteSort:true,sorters:[{property:'matnr',direction:'ASC'}]});this.columns=[{text:"Material No",width:80,dataIndex:'matnr',sortable:true},{text:"Material Name",width:130,dataIndex:'maktx',sortable:true},{text:"Type",width:50,dataIndex:'mtart',sortable:true},{text:"Type Desc",width:100,dataIndex:'mtype',sortable:true},{text:"Group",width:50,dataIndex:'matkl',sortable:true},{text:"Group Dese",width:100,dataIndex:'mgrpp',sortable:true},{text:"GL No",width:80,dataIndex:'saknr',sortable:true},{text:"GL Description",width:130,dataIndex:'sgtxt',sortable:true},{text:"Unit",width:60,dataIndex:'meins',sortable:true},{text:"Create Date",width:100,dataIndex:'erdat',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Unit 1",width:50,dataIndex:'unit1',sortable:true},{text:"Cost 1",width:80,dataIndex:'cost1',sortable:true},{text:"Unit 2",width:50,dataIndex:'unit2',sortable:true},{text:"Cost 2",width:80,dataIndex:'cost2',sortable:true},{text:"Unit 3",width:50,dataIndex:'unit3',sortable:true},{text:"Cost 3",width:80,dataIndex:'cost3',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Material.Import.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center',border:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.uploadAct=new Ext.Action({text:'Upload',iconCls:'b-small-save'});this.items=[{xtype:'filefield',name:'userfile',fieldLabel:'Excel file',labelAlign:'right',msgTarget:'side',allowBlank:false,anchor:'70%',buttonText:'Select Excel file...',allowBlank:false}];this.buttons=[this.uploadAct];this.uploadAct.setHandler(function(){_this.save();});return this.callParent(arguments);},save:function(){var _this=this,form=this.getForm();if(form.isValid()){_this.fireEvent('upload_click');form.submit({url:__site_url+'import/upload/do_upload',waitMsg:'Uploading excel file...',success:function(form,action){_this.fireEvent('upload_success',action.result.file);},failure:function(form,action){Ext.Msg.show({title:'An error occured.',msg:action.result.msg.error,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});}},reset:function(){this.getForm().reset();}});;Ext.define('Account.Material.Import.Grid',{extend:'Ext.grid.Panel',constructor:function(config){Ext.apply(this,{viewConfig:{getRowClass:function(r,rowIndex,rowParams,store){var s=r.get('error');if(s&&s.length>0)
return'red-bg-row';}},buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.importAct=new Ext.Action({text:'Import',iconCls:'b-small-save'});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"import/material/read",reader:{type:'json',root:'rows',idProperty:'row_id'},simpleSortMode:true},fields:['row_id','matnr','maktx','matkl','mtart','meins','saknr','beqty','beval','cosav','enqty','enval','unit1','cost1','unit2','cost2','unit3','cost3','statu','error'],remoteSort:false});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{text:"Material Code",width:100,align:'center',dataIndex:'matnr',sortable:false},{text:"Material Name",width:150,align:'center',dataIndex:'maktx',sortable:false},{text:"Material Group",width:100,align:'center',dataIndex:'matkl',sortable:false},{text:"Material Type",width:80,align:'center',dataIndex:'mtart',sortable:false},{text:"Unit",width:80,align:'center',dataIndex:'unit1',sortable:false},{text:"Cost",width:80,align:'center',dataIndex:'cost1',sortable:false},{text:"Error",width:250,dataIndex:'error',sortable:false,renderer:function(v,p,r){return(v&&v.length>0)?v:'-';}}];this.buttons=[this.importAct];this.importAct.setHandler(function(){_this.importData();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},showMask:function(msg,msgClass){msg=msg||'Please select excel file for upload.';msgClass=msgClass||'grid-disable';this.importAct.setDisabled(true);this.getEl().mask(msg,msgClass);},hideMask:function(){this.importAct.setDisabled(false);this.getEl().unmask();},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();grid.getSelectionModel().deselectAll();},importData:function(){var _this=this;var rs=[];this.store.each(function(r){rs.push(r.getData());});if(rs.length>0){this.showMask('Importing please wait','');var data_json=Ext.encode(rs);Ext.Ajax.request({url:__site_url+'import/material/import',params:{data:data_json},success:function(response){var text=response.responseText;var data=Ext.decode(text);if(data.success){Ext.Msg.show({title:'Import success.',msg:'Import '+data.rows.length+' rows success.',buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO});_this.fireEvent('import_success',data);}else{_this.hideMask();Ext.Msg.show({title:'An error occured.',msg:response,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}},failure:function(response){Ext.Msg.show({title:'An error occured.',msg:response.responseText,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});}else{Ext.Msg.alert('Status','No datas to import.');}}});;Ext.define('Account.Material.Import.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Material Import',closeAction:'hide',height:600,minHeight:480,width:900,minWidth:600,resizable:true,modal:true,layout:'border',maximizable:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Material.Import.Form',{region:'north',height:80});this.grid=Ext.create('Account.Material.Import.Grid',{region:'center',disbled:true});this.items=[this.form,this.grid];this.form.on('upload_success',function(file_name){_this.grid.hideMask();_this.grid.load({file:file_name});});return this.callParent(arguments);},openDialog:function(){this.form.reset();this.grid.store.removeAll();this.show(false,function(){this.grid.showMask();});}});;Ext.define('Account.Material.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'material/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'right',msgTarget:'qtip',labelWidth:105,}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.typeDialog=Ext.create('Account.Materialtype.Window');this.trigType=Ext.create('Ext.form.field.Trigger',{name:'mtart',fieldLabel:'Material Type',triggerCls:'x-form-search-trigger',allowBlank:false,enableKeyEvents:true});this.grpDialog=Ext.create('Account.Materialgrp.Window');this.trigGrp=Ext.create('Ext.form.field.Trigger',{name:'matkl',fieldLabel:'Material Group',triggerCls:'x-form-search-trigger',allowBlank:false,enableKeyEvents:true});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('MM'),fieldLabel:'Material Status',name:'statu',labelAlign:'right',editable:false,allowBlank:false,triggerAction:'all',margin:'0 0 0 10',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.glnoDialog=Ext.create('Account.GL.MainWindow');this.trigGlno=Ext.create('Ext.form.field.Trigger',{name:'saknr',fieldLabel:'GL Account',triggerCls:'x-form-search-trigger',allowBlank:false,enableKeyEvents:true,});this.unitDialog=Ext.create('Account.Unit.Window');this.trigUnit=Ext.create('Ext.form.field.Trigger',{name:'meins',fieldLabel:'Unit',triggerCls:'x-form-search-trigger',editable:false,enableKeyEvents:true});this.unit1Dialog=Ext.create('Account.Unit.Window');this.trigUnit1=Ext.create('Ext.form.field.Trigger',{name:'unit1',fieldLabel:'Unit 1',triggerCls:'x-form-search-trigger',editable:false,enableKeyEvents:true});this.unit2Dialog=Ext.create('Account.Unit.Window');this.trigUnit2=Ext.create('Ext.form.field.Trigger',{name:'unit2',fieldLabel:'Unit 2',triggerCls:'x-form-search-trigger',editable:false,enableKeyEvents:true});this.unit3Dialog=Ext.create('Account.Unit.Window');this.trigUnit3=Ext.create('Ext.form.field.Trigger',{name:'unit3',fieldLabel:'Unit 3',triggerCls:'x-form-search-trigger',editable:false,enableKeyEvents:true});this.numberBudget=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Budgeted Price',name:'buget'});this.items=[{xtype:'hidden',name:'id'},{xtype:'fieldset',title:'Material Data',collapsible:true,defaultType:'textfield',layout:'anchor',items:[{xtype:'displayfield',fieldLabel:'Material Code',name:'matnr',readOnly:true,value:'XXXXX'},{xtype:'textfield',fieldLabel:'Material Name',name:'maktx',width:400,allowBlank:false},{xtype:'container',layout:'hbox',items:[this.trigType,{xtype:'displayfield',name:'mtype',margins:'4 0 0 6',width:286}]},{xtype:'container',layout:'hbox',items:[this.trigGrp,{xtype:'displayfield',name:'mgrpp',margins:'4 0 0 6',width:286}]},{xtype:'textarea',fieldLabel:'Description',name:'descr',width:400,rows:3,},{xtype:'textfield',fieldLabel:'Brand',name:'brand',width:400},this.numberBudget,this.trigUnit,{xtype:'container',layout:'hbox',items:[this.trigGlno,{xtype:'displayfield',name:'sgtxt',margins:'4 0 0 6',width:286}]}]},{xtype:'fieldset',title:'Balance Data',collapsible:true,defaultType:'textfield',layout:'anchor',items:[{xtype:'numberfield',fieldLabel:'Beginning Qty',name:'beqty',allowBlank:true},{xtype:'numberfield',fieldLabel:'Beginning Value',name:'beval',allowBlank:true},{xtype:'numberfield',fieldLabel:'Average Cost',name:'cosav',disabled:true,allowBlank:true},{xtype:'numberfield',fieldLabel:'Ending Qty',name:'enqty',disabled:true,allowBlank:true},{xtype:'numberfield',fieldLabel:'Ending Value',name:'enval',disabled:true,allowBlank:true}]},{xtype:'fieldset',title:'Costing Data',collapsible:true,defaultType:'textfield',layout:'anchor',items:[{xtype:'container',layout:'hbox',items:[{xtype:'container',flex:1,layout:'anchor',items:[this.trigUnit1,this.trigUnit2,this.trigUnit3]},{xtype:'container',flex:1,layout:'anchor',items:[{xtype:'numberfield',fieldLabel:'Cost 1',name:'cost1',labelWidth:90,allowBlank:true},{xtype:'numberfield',fieldLabel:'Cost 2',minValue:0,name:'cost2',labelWidth:90,allowBlank:true},{xtype:'numberfield',fieldLabel:'Cost 3',minValue:0,name:'cost3',labelWidth:90,allowBlank:true}]}]}]},this.comboQStatus];this.trigType.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'material/load_type',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.trigType.setValue(r.data.mtart);_this.getForm().findField('mtype').setValue(r.data.matxt);}else{o.markInvalid('Could not find material type : '+o.getValue());}}});}},this);_this.typeDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigType.setValue(record.data.mtart);_this.getForm().findField('mtype').setValue(record.data.matxt);grid.getSelectionModel().deselectAll();_this.typeDialog.hide();});this.trigType.onTriggerClick=function(){_this.typeDialog.show();};this.trigGrp.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'material/load_grp',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.trigGrp.setValue(r.data.matkl);_this.getForm().findField('mgrpp').setValue(r.data.matxt);_this.getForm().findField('saknr').setValue(r.data.saknr);_this.getForm().findField('sgtxt').setValue(r.data.sgtxt);}else{o.markInvalid('Could not find material group : '+o.getValue());}}});}},this);_this.grpDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigGrp.setValue(record.data.matkl);_this.getForm().findField('mgrpp').setValue(record.data.matxt);_this.getForm().findField('saknr').setValue(record.data.saknr);_this.getForm().findField('sgtxt').setValue(record.data.sgtxt);grid.getSelectionModel().deselectAll();_this.grpDialog.hide();});this.trigGrp.onTriggerClick=function(){_this.grpDialog.show();};this.trigUnit.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'unit/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.meins);}else{o.markInvalid('Could not find Unit : '+o.getValue());}}});}},this);_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigUnit.setValue(record.data.meins);grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});this.trigUnit.onTriggerClick=function(){_this.unitDialog.show();};this.trigUnit1.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'unit/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.meins);}else{o.markInvalid('Could not find Unit : '+o.getValue());}}});}},this);_this.unit1Dialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigUnit1.setValue(record.data.meins);grid.getSelectionModel().deselectAll();_this.unit1Dialog.hide();});this.trigUnit1.onTriggerClick=function(){_this.unit1Dialog.show();};this.trigUnit2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'unit/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.meins);}else{o.markInvalid('Could not find Unit : '+o.getValue());}}});}},this);_this.unit2Dialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigUnit2.setValue(record.data.meins);grid.getSelectionModel().deselectAll();_this.unit2Dialog.hide();});this.trigUnit2.onTriggerClick=function(){_this.unit2Dialog.show();};this.trigUnit3.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'unit/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.meins);}else{o.markInvalid('Could not find Unit : '+o.getValue());}}});}},this);_this.unit3Dialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigUnit3.setValue(record.data.meins);grid.getSelectionModel().deselectAll();_this.unit3Dialog.hide();});this.trigUnit3.onTriggerClick=function(){_this.unit3Dialog.show();};this.trigGlno.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.saknr);_this.getForm().findField('sgtxt').setValue(record.data.sgtxt);}else{o.markInvalid('Could not find GL Account : '+o.getValue());}}});}},this);_this.glnoDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigGlno.setValue(record.data.saknr);_this.getForm().findField('sgtxt').setValue(record.data.sgtxt);grid.getSelectionModel().deselectAll();_this.glnoDialog.hide();});this.trigGlno.onTriggerClick=function(){_this.glnoDialog.show();};return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'material/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},reset:function(){this.getForm().reset();this.comboQStatus.setValue('01');},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'material/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});}});;Ext.define('Account.Material.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Material',closeAction:'hide',height:700,width:550,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Material.Item.Form');this.items=this.form;this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);}else{this.dialogId=null;this.form.reset();this.show(false);}}});;Ext.define('Account.Material.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Material Management',closeAction:'hide',height:600,minHeight:380,width:1200,minWidth:100,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('MM')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('MM')||UMS.CAN.CREATE('MM')||UMS.CAN.EDIT('MM'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('MM')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('MM')});this.importAct=new Ext.Action({text:'Import',iconCls:'b-small-import',disabled:!UMS.CAN.CREATE('MM')});this.itemDialog=Ext.create('Account.Material.Item.Window');this.importDialog=Ext.create('Account.Material.Import.Window');this.grid=Ext.create('Account.Material.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});this.searchForm=Ext.create('Account.Material.FormSearch',{region:'north',height:100});this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/material/index?'+query;});this.importAct.setHandler(function(){_this.importDialog.openDialog();});this.itemDialog.form.on('afterSave',function(){_this.itemDialog.hide();_this.grid.load();});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();opts.params=Ext.apply(opts.params,formValues);}});if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.importDialog.grid.on('import_success',function(){_this.importDialog.hide();_this.grid.load();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Materialgrp.GridItem',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.glnoDialog=Ext.create('Account.GL.MainWindow');this.tbar=[this.addAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'material/loads_grp',reader:{type:'json',root:'rows',idProperty:'id_mgrp',totalProperty:'totalCount'}},fields:[{name:'id_mgrp',type:'int'},'matkl','matxt','saknr','sgtxt'],remoteSort:false,sorters:['id_mgrp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{id:'PMiRowNumber002',header:"Type ID",dataIndex:'id_mgrp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Group Code",width:80,dataIndex:'matkl',sortable:true,field:{type:'textfield'},},{text:"Group Description",width:150,dataIndex:'matxt',sortable:true,field:{type:'textfield'},},{text:"GL no",width:100,dataIndex:'saknr',sortable:true,field:{xtype:'triggerfield',enableKeyEvents:true,allowBlank:false,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.glnoDialog.show();}},sortable:false},{text:"GL Description",width:170,dataIndex:'sgtxt',sortable:true}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='saknr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.saknr);rModel.set('sgtxt',r.data.sgtxt);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.glnoDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('saknr',record.data.saknr);rModel.set('sgtxt',record.data.sgtxt);}
grid.getSelectionModel().deselectAll();_this.glnoDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options,proxy:{type:'ajax',url:__site_url+'material/loads_grp',reader:{type:'json',root:'rows',idProperty:'id_mgrp'}},fields:[{name:'id_mgrp',type:'int'},'mtart','matxt','saknr','sgtxt'],remoteSort:false,sorters:['id_mgrp ASC']});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},save:function(){var _this=this;var r_data=this.getData();Ext.Ajax.request({url:__site_url+'material/save_grp',method:'POST',params:{mgrp:Ext.encode(r_data)},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){Ext.Msg.alert('SUCCESS');}else{Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}}});},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},reset:function(){this.grid.load({matkl:0});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('id_mgrp',row_num++);});}});;Ext.define('Account.Materialgrp.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Material Group',closeAction:'hide',height:420,width:600,layout:'border',resizable:true,modal:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.Materialgrp.GridItem',{region:'center'});this.items=[this.grid];this.buttons=[{text:'Save',handler:function(){_this.grid.save();}},{text:'Cancel',handler:function(){_this.hide();}}];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Materialtype.GridItem',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.tbar=[this.addAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'material/loads_type',reader:{type:'json',root:'rows',idProperty:'id_mtype',totalProperty:'totalCount'}},fields:[{name:'id_mtype',type:'int'},'mtart','matxt'],remoteSort:false,sorters:['id_mtype ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{id:'PMiRowNumber001',header:"Type ID",dataIndex:'id_mtype',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Type Code",width:100,dataIndex:'mtart',sortable:true,field:{type:'textfield'},},{text:"Type Description",width:250,dataIndex:'matxt',sortable:true,field:{type:'textfield'},}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});return this.callParent(arguments);},load:function(options){this.store.load({params:options,proxy:{type:'ajax',url:__site_url+'material/loads_type',reader:{type:'json',root:'rows',idProperty:'id_mtype'}},fields:[{name:'id_mtype',type:'int'},'mtart','matxt'],remoteSort:false,sorters:['id_mtype ASC']});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},save:function(){var _this=this;var r_data=this.getData();Ext.Ajax.request({url:__site_url+'material/save_type',method:'POST',params:{mtyp:Ext.encode(r_data)},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){Ext.Msg.alert('SUCCESS');}else{Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}}});},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},reset:function(){this.grid.load({mtart:0});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('id_mtype',row_num++);});}});;Ext.define('Account.Materialtype.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Material Type',closeAction:'hide',height:420,width:450,layout:'border',resizable:true,modal:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.Materialtype.GridItem',{region:'center'});this.items=[this.grid];this.buttons=[{text:'Save',handler:function(){_this.grid.save();}},{text:'Cancel',handler:function(){_this.hide();}}];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.OtherExpense.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from AP No., Vendor or GR No.',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.OtherExpense.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"otexpense/loads",reader:{type:'json',root:'rows',idProperty:'invnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['invnr','bldat','mbeln','lifnr','name1','netwr','statx'],remoteSort:true,sorters:[{property:'invnr',direction:'ASC'}]});this.columns=[{text:"AP Doc",flex:true,dataIndex:'invnr',align:'center',sortable:true},{text:"AP Date",width:125,xtype:'datecolumn',align:'center',format:'d/m/Y',dataIndex:'bldat',sortable:true},{text:"GR Doc",flex:true,dataIndex:'mbeln',align:'center',sortable:true},{text:"Vendor Code",flex:true,dataIndex:'lifnr',align:'center',sortable:true},{text:"Vendor Name",flex:true,dataIndex:'name1',sortable:true},{text:"Net Amount",flex:true,xtype:'numbercolumn',align:'right',dataIndex:'netwr',sortable:true},{text:"AP Status",flex:true,dataIndex:'statx',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.OtherExpense.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'ap/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.vendorDialog=Ext.create('Account.Vendor.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.gridItem=Ext.create('Account.OtherExpense.Item.Grid_i',{height:320,region:'center'});this.gridGL=Ext.create('Account.OtherExpense.Item.Grid_gl',{border:true,region:'center',title:'GL Posting'});this.formTotal=Ext.create('Account.OtherExpense.Item.Form_t',{title:'AP Total',border:true,split:true,region:'south'});this.gridPrice=Ext.create('Account.OtherExpense.Item.Grid_pc',{border:true,split:true,title:'Item Pricing',region:'south'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('OE'),fieldLabel:'AP Status',name:'statu',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat Type',name:'taxnr',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select data --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payments',name:'ptype',width:280,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.hdnApItem=Ext.create('Ext.form.Hidden',{name:'ebrp',});this.hdnGlItem=Ext.create('Ext.form.Hidden',{name:'bven',});this.trigVendor=Ext.create('Ext.form.field.Trigger',{name:'lifnr',fieldLabel:'Vendor Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',labelAlign:'right',width:170,hideTrigger:false,align:'right'});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:240,labelAlign:'right',allowBlank:false});this.numberVat=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Vat Value',name:'taxpr',labelAlign:'right',width:170,align:'right'});this.numberWHT=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'WHT Value',name:'whtpr',labelAlign:'right',width:170,align:'right'});this.radioType=Ext.create('Ext.form.RadioGroup',{cls:'x-check-group-alt',items:[{boxLabel:'Account Payable',width:150,name:'docty',inputValue:1,checked:true},{boxLabel:'Pretty Cash',width:100,name:'docty',inputValue:2}]});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnApItem,this.hdnGlItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},{xtype:'hidden',name:'loekz'},{xtype:'fieldset',title:'Payable Type',layout:'anchor',items:[this.radioType]},{xtype:'displayfield',width:240,allowBlank:true},{xtype:'displayfield',fieldLabel:'AP No',name:'invnr',value:'IPXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'container',flex:0,layout:'anchor',items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigVendor,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:160,allowBlank:true}]},{xtype:'textarea',fieldLabel:'Vendor Address',name:'adr01',width:450,rows:3,},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboPay,this.numberVat]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Reference No',width:280,name:'refnr',},this.numberWHT]}]},{xtype:'container',flex:0,layout:'anchor',margin:'0 0 0 70',items:[this.comboPtype,{xtype:'datefield',fieldLabel:'AP Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',},this.comboTax,this.trigCurrency,{xtype:'container',layout:'hbox',defaultType:'textfield',margin:'0 0 5 0',items:[this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:25,value:'Days'}]},{xtype:'datefield',fieldLabel:'Due Date',name:'duedt',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},this.comboQStatus]}]}]}]};this.items=[mainFormPanel,this.gridItem,{xtype:'tabpanel',region:'south',activeTab:0,height:195,items:[this.formTotal,this.gridPrice,this.gridGL]}];this.trigVendor.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.vendorDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor.setValue(record.data.lifnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.lifnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}}});grid.getSelectionModel().deselectAll();_this.vendorDialog.hide();});this.trigVendor.onTriggerClick=function(){_this.vendorDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);_this.formTotal.getForm().findField('curr').setValue(r.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',r.data.ctype);});_this.gridItem.curValue=r.data.ctype;}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);_this.formTotal.getForm().findField('curr1').setValue(record.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',record.data.ctype);});_this.gridItem.curValue=record.data.ctype;grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.gridItem.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.gridItem.getSelectionModel().on('viewready',this.onViewReady,this);this.numberCredit.on('keyup',this.getDuedate,this);this.numberCredit.on('change',this.getDuedate,this);this.comboTax.on('change',this.calculateTotal,this);return this.callParent(arguments);},onSelectChange:function(selModel,selections){var _this=this;var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:this.comboTax.getValue()});}},onViewReady:function(grid){grid.getSelectionModel().select(0);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'otexpense/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnApItem.setValue(Ext.encode(rsItem));var rsGL=_this.gridGL.getData();this.hdnGlItem.setValue(Ext.encode(rsGL));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{invnr:invnr},url:__site_url+'otexpense/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({invnr:0});this.gridGL.load({netpr:0});this.comboQStatus.setValue('01');this.comboTax.setValue('01');this.trigCurrency.setValue('THB');this.numberVat.setValue(7);this.numberWHT.setValue(3);this.getForm().findField('bldat').setValue(new Date());this.getForm().findField('duedt').setValue(new Date());this.formTotal.getForm().findField('exchg').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=this.gridItem.store;var sum=0;var vats=0;sum2=0;var whts=0;var discounts=0;var saknr_list=[];var vattype=this.comboTax.getValue();store.each(function(r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']),discount=parseFloat(r.data['disit']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;discount=isNaN(discount)?0:discount;var amt=qty*price;if(vattype=='02'){amt=amt*100;amt=amt/107;}
sum+=amt;discounts+=discount;amt=amt-discount;sum2+=amt;if(r.data['chk01']==true){var vat=_this.numberVat.getValue();vat=(amt*vat)/100;vats+=vat;}
var item=r.data['saknr']+'|'+amt;saknr_list.push(item);if(r.data['chk02']==true){var wht=_this.numberWHT.getValue();wht=(amt*wht)/100;whts+=wht;}});this.formTotal.getForm().findField('beamt').setValue(sum);this.formTotal.getForm().findField('vat01').setValue(vats);this.formTotal.getForm().findField('wht01').setValue(whts);this.formTotal.getForm().findField('dismt').setValue(discounts);var net=this.formTotal.calculate();this.formTotal.taxType=this.comboTax.getValue();this.gridItem.vatValue=this.numberVat.getValue();var currency=this.trigCurrency.getValue();this.gridItem.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);this.gridItem.vendorValue=this.trigVendor.getValue();if(currency!='THB'){var rate=this.formTotal.getForm().findField('exchg').getValue();sum=sum*rate;sum2=sum2*rate;vats=vats*rate;whts=whts*rate;}
if(sum>0&&this.trigVendor.getValue()!=''){_this.gridGL.load({netpr:sum2,vvat:vats,lifnr:this.trigVendor.getValue(),items:saknr_list.join(',')});}
var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:this.comboTax.getValue()});}},getDuedate:function(){var bForm=this.getForm(),credit=this.numberCredit.getValue(),startDate=bForm.findField('bldat').getValue();if(!Ext.isEmpty(credit)&&credit>0){var result=Ext.Date.add(startDate,Ext.Date.DAY,credit),dueDateField=bForm.findField('duedt');if(!Ext.isEmpty(credit)&&!Ext.isEmpty(dueDateField))
dueDateField.setValue(result);}}});;Ext.define('Account.OtherExpense.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'otexpense/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',}});return this.callParent(arguments);},initComponent:function(){var _this=this;var myStorecomboWHTno=Ext.create('Ext.data.Store',{fields:['idWHT','name'],data:[{"idWHT":"01","name":"นิติบุคคล"},{"idWHT":"02","name":"บุคคลธรรมดา"}]});this.whtDialog=Ext.create('Account.WHT.Window');this.trigWHT=Ext.create('Ext.form.field.Trigger',{name:'whtnr',labelAlign:'letf',width:50,triggerCls:'x-form-search-trigger',enableKeyEvents:true,margin:'3 0 0 10'});this.comboWHType=Ext.create('Ext.form.ComboBox',{fieldLabel:'Witholding Tax',name:'whtyp',width:240,triggerAction:'all',clearFilterOnReset:true,emptyText:'--Select WHT Typ--',margin:'3 0 0 0',store:myStorecomboWHTno,labelAlign:'left',queryMode:'local',displayField:'name',valueField:'idWHT'});this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',xtype:'textfield',fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:150,width:270,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt',align:'right',width:270,labelWidth:150,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',name:'vat01',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,margin:'4 0 0 0',readOnly:true});this.txtWHTValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'WHT Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,name:'wht01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:270,hideTrigger:true,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',alwaysDisplayDecimals:true,style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'},{xtype:'container',layout:'hbox',anchor:'100%',items:[this.comboWHType,this.trigWHT,{xtype:'textfield',name:'whtxt',margin:'3 0 0 7',emptyText:'อื่นๆ ระบุประเภทการหักภาษี ณ ที่จ่าย',width:250}]}]},{xtype:'container',layout:'anchor',margins:'0 0 0 20',items:[this.txtTotal,this.txtDiscountValue,this.txtDiscountSum,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];this.trigWHT.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/loads_wht',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.whtnr);if(r.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(r.data.whtxt);}}else{o.markInvalid('Could not find wht code : '+o.getValue());}}});}},this);_this.whtDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigWHT.setValue(record.data.whtnr);if(record.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(record.data.whtxt);}
grid.getSelectionModel().deselectAll();_this.whtDialog.hide();});this.trigWHT.onTriggerClick=function(){_this.whtDialog.show();};var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtTaxValue.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtWHTValue.on('render',setAlignRight);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'ap/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},calculate:function(){var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discountValue=this.txtDiscountValue.getValue();if(discountValue>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var wht=this.txtWHTValue.getValue();var net=(total-discountValue)+(vat-wht);this.txtNet.setValue(net);}});;Ext.define('Account.OtherExpense.Item.Grid_gl',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',disabled:true,iconCls:'b-small-copy'});this.glDialog=Ext.create('Account.GL.MainWindow');this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"otexpense/loads_gl_item",reader:{type:'json',root:'rows',idProperty:'belnr,belpr'}},fields:['belnr','belpr','saknr','sgtxt','debit','credi','txz01'],remoteSort:true,sorters:['belpr ASC']});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete GL Item',scope:this,handler:this.removeRecord}]},{id:'RowNumber2',text:"No.",dataIndex:'belpr',width:50,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"GL No.",width:100,dataIndex:'saknr',align:'center',sortable:false,},{text:"GL Description",width:215,dataIndex:'sgtxt',sortable:true},{text:"Debit",width:100,dataIndex:'debit',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,},{text:"Credit",width:100,dataIndex:'credi',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,},{text:"Comment",width:250,dataIndex:'txz01',sortable:true,field:{type:'textfield'}}];this.plugins=[this.editing];this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='saknr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.saknr);rModel.set('sgtxt',r.data.sgtxt);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.glDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('saknr',record.data.saknr);rModel.set('sgtxt',record.data.sgtxt);}
grid.getSelectionModel().deselectAll();_this.glDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addDefaultRecord:function(){this.store.removeAll();var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;for(var i=0;i<5;i++){rec={id:i};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();}},addRecord2:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();},removeRecord2:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow2();},runNumRow2:function(){var row_num=0;this.store.each(function(r){r.set('belpr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.OtherExpense.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMaterial.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"otexpense/loads_ap_item",reader:{type:'json',root:'rows',idProperty:'invnr,vbelp'}},fields:['invnr','vbelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctype','chk01','chk02','saknr'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete AP Item',scope:this,handler:this.removeRecord}]},{id:'APiRowNumber2',header:"Items",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:80,dataIndex:'matnr',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.materialDialog.show();}},},{text:"Description",width:220,dataIndex:'maktx',sortable:false,field:{type:'textfield'},},{text:"Qty",xtype:'numbercolumn',width:70,dataIndex:'menge',sortable:false,align:'right',field:{type:'numberfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Unit",width:50,dataIndex:'meins',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.unitDialog.show();}},},{text:"Price/Unit",xtype:'numbercolumn',width:100,dataIndex:'unitp',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Discount",xtype:'numbercolumn',width:80,dataIndex:'disit',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{xtype:'checkcolumn',text:'Vat',dataIndex:'chk01',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{xtype:'checkcolumn',text:'WHT',dataIndex:'chk02',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Amount",width:90,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:65,dataIndex:'ctype',sortable:false,align:'center',field:{type:'textfield'},},{dataIndex:'saknr',hidden:true,sortable:false}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='matnr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.matnr);rModel.set('maktx',r.data.maktx);rModel.set('meins',r.data.meins);rModel.set('saknr',r.data.saknr);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.materialDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('matnr',record.data.matnr);rModel.set('maktx',record.data.maktx);rModel.set('meins',record.data.meins);rModel.set('saknr',record.data.saknr);}
grid.getSelectionModel().deselectAll();_this.materialDialog.hide();});_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('meins',record.data.meins);}
grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,ctype:'THB'};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('ebelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.OtherExpense.Item.Grid_pc',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"quotation/loads_conp_item",reader:{type:'json',root:'rows',idProperty:'conty'}},fields:['conty','contx','vtamt','ttamt'],remoteSort:true,sorters:['conty ASC']});this.columns=[{text:"Condition type",width:170,dataIndex:'contx',sortable:true},{text:"Amount",width:100,xtype:'numbercolumn',dataIndex:'vtamt',sortable:true,align:'right'},{text:"Condition Amount",xtype:'numbercolumn',width:120,dataIndex:'ttamt',align:'right'}];return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.OtherExpense.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'Other Expense preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/ap/index/'+id+'/'+copies;},});;Ext.define('Account.OtherExpense.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Other Expense',closeAction:'hide',height:670,width:940,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.OtherExpense.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.OtherExpense.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({invnr:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}}});;Ext.define('Account.OtherExpense.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Other Expense',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('OE')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('OE')||UMS.CAN.CREATE('OE')||UMS.CAN.EDIT('OE'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('OE')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('OE')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.OtherExpense.Item.Window');this.grid=Ext.create('Account.OtherExpense.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.OtherExpense.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save AP number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/ap/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.OtherIncome.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Other Income, Customer',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.OtherIncome.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"otincome/loads",reader:{type:'json',root:'rows',idProperty:'invnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['invnr','bldat','kunnr','name1','ordnr','sname','statx','paytx','netwr','ctype'],remoteSort:true,sorters:[{property:'invnr',direction:'ASC'}]});this.columns=[{text:"Invoice No.",width:80,align:'center',dataIndex:'invnr',sortable:true},{text:"Invoice Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Customer No",width:80,align:'center',dataIndex:'kunnr',sortable:true},{text:"Customer Name",width:150,dataIndex:'name1',sortable:true},{text:"Sale Order No.",width:80,align:'center',dataIndex:'ordnr',sortable:true},{text:"Sale Person",width:120,dataIndex:'sname',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Payment Method",width:100,dataIndex:'paytx',sortable:true},{text:"Amount",xtype:'numbercolumn',width:80,align:'right',dataIndex:'netwr',sortable:true},{text:"Currency",width:60,align:'center',dataIndex:'ctype',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.OtherIncome.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'otincome/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.customerDialog=Ext.create('Account.Customer.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.saleDialog=Ext.create('Account.Saleperson.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.trigSale=Ext.create('Ext.form.field.Trigger',{name:'salnr',fieldLabel:'Sale Person',triggerCls:'x-form-search-trigger',labelAlign:'left',width:170,enableKeyEvents:true});this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.gridItem=Ext.create('Account.OtherIncome.Item.Grid_i',{height:320,region:'center'});this.gridGL=Ext.create('Account.OtherIncome.Item.Grid_gl',{border:true,region:'center',title:'GL Posting'});this.formTotal=Ext.create('Account.OtherIncome.Item.Form_t',{border:true,split:true,title:'Total->Income',region:'south'});this.gridPrice=Ext.create('Account.OtherIncome.Item.Grid_pc',{border:true,split:true,title:'Item Pricing',region:'south'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('OI'),fieldLabel:'INV Status',name:'statu',labelAlign:'right',width:240,margin:'0 0 0 6',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payments',name:'ptype',width:350,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.comboCond=Ext.create('Ext.form.ComboBox',{fieldLabel:'Condition',name:'condi',width:240,margin:'0 0 0 20',editable:false,labelAlign:'right',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Condition --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'invoice/loads_condcombo',reader:{type:'json',root:'rows',idProperty:'condi'}},fields:['condi','contx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'contx',valueField:'condi'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat type',name:'taxnr',width:240,margin:'0 0 0 5',labelAlign:'right',editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Vat --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.numberWHT=Ext.create('Ext.form.field.Number',{fieldLabel:'WHT Value',name:'whtpr',labelAlign:'right',width:200,align:'right',margin:'0 0 0 25'});this.numberVat=Ext.create('Ext.form.field.Number',{fieldLabel:'Vat Value',name:'taxpr',labelAlign:'right',width:200,align:'right',margin:'0 0 0 25'});this.trigCustomer=Ext.create('Ext.form.field.Trigger',{name:'kunnr',labelAlign:'letf',width:240,fieldLabel:'Customer Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:240,margin:'0 0 0 6',labelAlign:'right',allowBlank:false});this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',labelAlign:'right',width:200,hideTrigger:false,align:'right',margin:'0 0 0 25',allowDecimals:false,minValue:0});this.hdnIvItem=Ext.create('Ext.form.Hidden',{name:'vbrp'});this.hdnGlItem=Ext.create('Ext.form.Hidden',{name:'bcus',});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnIvItem,this.hdnGlItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,defaultType:'textfield',layout:'anchor',defaults:{anchor:'100%'},items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},{xtype:'hidden',name:'loekz'},{xtype:'displayfield',width:590,margins:'0 0 0 6',allowBlank:true},{xtype:'displayfield',fieldLabel:'Invoice No',name:'invnr',value:'IVXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigCustomer,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:350,allowBlank:true},{xtype:'datefield',fieldLabel:'Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false}]},{xtype:'container',layout:'hbox',defaultType:'textfield',margin:'0 0 5 0',items:[{xtype:'textarea',fieldLabel:'Bill To',name:'adr01',width:350,rows:3,editable:false,labelAlign:'top'},{xtype:'textarea',fieldLabel:'Ship To',name:'adr02',width:355,rows:3,labelAlign:'top',editable:false,margin:'0 0 0 130'}]},{xtype:'container',layout:'hbox',defaultType:'textfield',margin:'0 0 5 0',items:[this.trigSale,{xtype:'displayfield',name:'emnam',width:174,margins:'0 0 0 6'},this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:10,value:'Days'},this.trigCurrency]},{xtype:'container',layout:'hbox',defaultType:'textfield',margin:'0 0 5 0',items:[this.comboPay,{xtype:'datefield',fieldLabel:'Due Date',name:'duedt',labelAlign:'right',width:200,margin:'0 0 0 25',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},this.comboCond]},{xtype:'container',layout:'hbox',defaultType:'textfield',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Reference No',name:'refnr',width:350},this.numberVat,{xtype:'displayfield',align:'right',width:10,margin:'0 0 0 5',value:'%'},this.comboTax]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'displayfield',width:350},this.numberWHT,{xtype:'displayfield',align:'right',width:10,margin:'0 0 0 5',value:'%'},this.comboQStatus]}]}]};this.items=[mainFormPanel,this.gridItem,{xtype:'tabpanel',region:'south',activeTab:0,height:200,items:[this.formTotal,this.gridPrice,this.gridGL]}];this.trigCustomer.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('adr02').setValue(r.data.adr02);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer.setValue(record.data.kunnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.kunnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'customer/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('adr02').setValue(r.data.adr02);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}}});grid.getSelectionModel().deselectAll();_this.customerDialog.hide();});this.trigCustomer.onTriggerClick=function(){_this.customerDialog.show();};this.trigSale.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'saleperson/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.salnr);_this.getForm().findField('emnam').setValue(r.data.emnam);}else{o.markInvalid('Could not find project owner : '+o.getValue());}}});}},this);_this.saleDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigSale.setValue(record.data.salnr);_this.getForm().findField('emnam').setValue(record.data.emnam);grid.getSelectionModel().deselectAll();_this.saleDialog.hide();});this.trigSale.onTriggerClick=function(){_this.saleDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);_this.formTotal.getForm().findField('curr').setValue(r.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',r.data.ctype);});_this.gridItem.curValue=r.data.ctype;}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);_this.formTotal.getForm().findField('curr1').setValue(record.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',record.data.ctype);});_this.gridItem.curValue=record.data.ctype;grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.gridItem.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.gridItem.getSelectionModel().on('viewready',this.onViewReady,this);this.numberCredit.on('keyup',this.getDuedate,this);this.numberCredit.on('change',this.getDuedate,this);this.comboTax.on('change',this.calculateTotal,this);return this.callParent(arguments);},onSelectChange:function(selModel,selections){var _this=this;var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:this.comboTax.getValue()});}},onViewReady:function(grid){grid.getSelectionModel().select(0);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'otincome/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnIvItem.setValue(Ext.encode(rsItem));var rsGL=_this.gridGL.getData();this.hdnGlItem.setValue(Ext.encode(rsGL));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){_this.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{invnr:invnr},url:__site_url+'otincome/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({invnr:0});this.gridGL.load({netpr:0});this.gridPrice.load({belnr:0});this.comboQStatus.setValue('01');this.comboTax.setValue('01');this.trigCurrency.setValue('THB');this.numberVat.setValue(7);this.numberWHT.setValue(3);this.getForm().findField('bldat').setValue(new Date());this.formTotal.getForm().findField('exchg').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=this.gridItem.store;var sum=0;var vats=0;sum2=0;var whts=0;var discounts=0;var saknr_list=[];var vattype=this.comboTax.getValue();store.each(function(r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']),discount=parseFloat(r.data['disit']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;discount=isNaN(discount)?0:discount;var amt=qty*price;if(vattype=='02'){amt=amt*100;amt=amt/107;}
sum+=amt;discounts+=discount;amt=amt-discount;sum2+=amt;if(r.data['chk01']==true){var vat=_this.numberVat.getValue();vat=(amt*vat)/100;vats+=vat;}
var item=r.data['saknr']+'|'+amt;saknr_list.push(item);if(r.data['chk02']==true){var wht=_this.numberWHT.getValue();wht=(amt*wht)/100;whts+=wht;}});this.formTotal.getForm().findField('beamt').setValue(sum);this.formTotal.getForm().findField('vat01').setValue(vats);this.formTotal.getForm().findField('wht01').setValue(whts);this.formTotal.getForm().findField('dismt').setValue(discounts);var net=this.formTotal.calculate();this.formTotal.taxType=this.comboTax.getValue();this.gridItem.vatValue=this.numberVat.getValue();var currency=this.trigCurrency.getValue();this.gridItem.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);this.gridItem.customerValue=this.trigCustomer.getValue();if(currency!='THB'){var rate=this.formTotal.getForm().findField('exchg').getValue();sum=sum*rate;sum2=sum2*rate;vats=vats*rate;whts=whts*rate;}
if(sum>0&&this.trigCustomer.getValue()!=''){_this.gridGL.load({netpr:sum2,vvat:vats,kunnr:this.trigCustomer.getValue(),items:saknr_list.join(',')});}
var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:this.comboTax.getValue()});}},getDuedate:function(){var bForm=this.getForm(),credit=this.numberCredit.getValue(),startDate=bForm.findField('bldat').getValue();if(!Ext.isEmpty(credit)&&credit>0){var result=Ext.Date.add(startDate,Ext.Date.DAY,credit),dueDateField=bForm.findField('duedt');if(!Ext.isEmpty(credit)&&!Ext.isEmpty(dueDateField))
dueDateField.setValue(result);}}});;Ext.define('Account.OtherIncome.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'otincome/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip'}});return this.callParent(arguments);},initComponent:function(){var _this=this;var myStorecomboWHTno=Ext.create('Ext.data.Store',{fields:['idWHT','name'],data:[{"idWHT":"01","name":"นิติบุคคล"},{"idWHT":"02","name":"บุคคลธรรมดา"}]});this.whtDialog=Ext.create('Account.WHT.Window');this.trigWHT=Ext.create('Ext.form.field.Trigger',{name:'whtnr',labelAlign:'letf',width:50,triggerCls:'x-form-search-trigger',enableKeyEvents:true,margin:'4 0 0 10'});this.comboWHType=Ext.create('Ext.form.ComboBox',{fieldLabel:'Witholding Tax',name:'whtyp',width:240,triggerAction:'all',clearFilterOnReset:true,emptyText:'--Select WHT Typ--',margin:'4 0 0 0',store:myStorecomboWHTno,labelAlign:'left',queryMode:'local',displayField:'name',valueField:'idWHT'});this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',labelWidth:155,alwaysDisplayDecimals:true,width:270,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:155,name:'vat01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtWHTValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'WHT Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:155,name:'wht01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:240,hideTrigger:true,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',width:270,labelWidth:155,alwaysDisplayDecimals:true,margin:'4 0 0 0',style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'},{xtype:'container',layout:'hbox',anchor:'100%',items:[this.comboWHType,this.trigWHT,{xtype:'textfield',name:'whtxt',margin:'4 0 0 7',width:250}]}]},{xtype:'container',layout:'anchor',margins:'0 0 0 20',items:[this.txtTotal,this.txtDiscountValue,this.txtDiscountSum,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];this.trigWHT.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/loads_wht',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.whtnr);if(r.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(r.data.whtxt);}}else{o.markInvalid('Could not find wht code : '+o.getValue());}}});}},this);_this.whtDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigWHT.setValue(record.data.whtnr);if(record.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(record.data.whtxt);}
grid.getSelectionModel().deselectAll();_this.whtDialog.hide();});this.trigWHT.onTriggerClick=function(){_this.whtDialog.show();};var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtTaxValue.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtWHTValue.on('render',setAlignRight);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'otincome/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},ex_rate:function(id){var _this=this;_this.getForm().calculateTotal();},calculate:function(){var _this=this;var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discountValue=this.txtDiscountValue.getValue();if(discountValue>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscountSum.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var wht=this.txtWHTValue.getValue();var net=(total-discountValue)+(vat-wht);this.txtNet.setValue(net);return net;}});;Ext.define('Account.OtherIncome.Item.Grid_gl',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',disabled:true,iconCls:'b-small-copy'});this.glDialog=Ext.create('Account.GL.MainWindow');this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"otincome/loads_gl_item",reader:{type:'json',root:'rows',idProperty:'belnr,belpr'}},fields:['belnr','belpr','saknr','sgtxt','debit','credi','txz01'],remoteSort:true,sorters:['belpr ASC']});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete GL Item',scope:this,handler:this.removeRecord}]},{id:'RowNumber2',text:"No.",dataIndex:'belpr',width:50,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"GL No.",width:100,dataIndex:'saknr',align:'center',sortable:false,},{text:"GL Description",width:215,dataIndex:'sgtxt',sortable:true},{text:"Debit",width:100,dataIndex:'debit',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,},{text:"Credit",width:100,dataIndex:'credi',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,},{text:"Comment",width:250,dataIndex:'txz01',sortable:true,field:{type:'textfield'}}];this.plugins=[this.editing];this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='saknr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.saknr);rModel.set('sgtxt',r.data.sgtxt);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.glDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('saknr',record.data.saknr);rModel.set('sgtxt',record.data.sgtxt);}
grid.getSelectionModel().deselectAll();_this.glDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addDefaultRecord:function(){this.store.removeAll();var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;for(var i=0;i<5;i++){rec={id:i};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();}},addRecord2:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();},removeRecord2:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow2();},runNumRow2:function(){var row_num=0;this.store.each(function(r){r.set('belpr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.OtherIncome.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMaterial.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"otincome/loads_iv_item",reader:{type:'json',root:'rows',idProperty:'invnr,vbelp'}},fields:['invnr','vbelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctype','chk01','chk02','saknr'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Invoice Item',scope:this,handler:this.removeRecord}]},{id:'RowNumber',text:"No.",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:110,dataIndex:'matnr',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.materialDialog.show();}},},{text:"Description",width:220,dataIndex:'maktx',sortable:false,field:{type:'textfield'},},{text:"Qty",xtype:'numbercolumn',width:60,dataIndex:'menge',sortable:false,align:'right',field:{type:'numberfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Unit",width:50,dataIndex:'meins',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.unitDialog.show();}},},{text:"Price/Unit",xtype:'numbercolumn',width:80,dataIndex:'unitp',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Discount",xtype:'numbercolumn',width:70,dataIndex:'disit',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{xtype:'checkcolumn',text:'Vat',dataIndex:'chk01',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{xtype:'checkcolumn',text:'WHT',dataIndex:'chk02',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Amount",width:120,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge'].replace(/[^0-9.]/g,'')),price=parseFloat(r.data['unitp'].replace(/[^0-9.]/g,'')),qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:55,dataIndex:'ctype',sortable:false,align:'center',field:{type:'textfield'},},{dataIndex:'saknr',width:55,sortable:false}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='matnr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.matnr);rModel.set('maktx',r.data.maktx);rModel.set('meins',r.data.meins);rModel.set('unitp',r.data.cost);rModel.set('saknr',r.data.saknr);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.materialDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('matnr',record.data.matnr);rModel.set('maktx',record.data.maktx);rModel.set('meins',record.data.meins);rModel.set('saknr',r.data.saknr);var v=record.data.matnr;var cusno=_this.customerValue;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v,kunnr:cusno},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success&&r.data.cost){rModel.set('unitp',r.data.cost);}}});}
grid.getSelectionModel().deselectAll();_this.materialDialog.hide();});_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('meins',record.data.meins);}
grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,ctype:'THB'};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();this.getSelectionModel().deselectAll();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.OtherIncome.Item.Grid_pc',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"quotation/loads_conp_item",reader:{type:'json',root:'rows',idProperty:'conty'}},fields:['conty','contx','vtamt','ttamt'],remoteSort:true,sorters:['conty ASC']});this.columns=[{text:"Condition type",width:180,dataIndex:'contx',sortable:true},{text:"Amount",xtype:'numbercolumn',width:100,xtype:'numbercolumn',dataIndex:'vtamt',sortable:true,align:'right'},{text:"Condition Amount",xtype:'numbercolumn',width:120,dataIndex:'ttamt',align:'right'}];return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.OtherIncome.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'Other Income preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/invoice/index/'+id+'/'+copies;}});;Ext.define('Account.OtherIncome.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Other Income',closeAction:'hide',height:700,width:950,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.OtherIncome.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.OtherIncome.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({invnr:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}}});;Ext.define('Account.OtherIncome.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Other Income',closeAction:'hide',height:600,minHeight:380,width:950,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;var fibasic=Ext.create('Ext.form.field.File',{width:200,x:50,y:50,hideLabel:true});this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('OI')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('OI')||UMS.CAN.CREATE('OI')||UMS.CAN.EDIT('OI'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('OI')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('OI')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.OtherIncome.Item.Window');this.grid=Ext.create('Account.OtherIncome.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.OtherIncome.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save Other Income number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/invoice/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Payment.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Payment No., Vendor or AP No.',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Payment.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"payment/loads",reader:{type:'json',root:'rows',idProperty:'payno',totalProperty:'totalCount'},simpleSortMode:true},fields:['payno','bldat','duedt','lifnr','name1','txz01','statx','netwr','ctype'],remoteSort:true,sorters:[{property:'payno',direction:'ASC'}]});this.columns=[{text:"Payment No",width:120,align:'center',dataIndex:'payno',sortable:true},{text:"Doc Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Payment Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'duedt',sortable:true},{text:"Vendor No",width:80,align:'center',dataIndex:'lifnr',sortable:true},{text:"Vendor Name",width:200,dataIndex:'name1',sortable:true},{text:"Text Note",width:250,dataIndex:'txz01',sortable:true},{text:"Payment Status",flex:true,dataIndex:'statx',sortable:true},{text:"Amount",xtype:'numbercolumn',width:80,align:'right',dataIndex:'netwr',sortable:true},{text:"Currency",dataIndex:'ctype',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Payment.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'payment/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.vendorDialog=Ext.create('Account.SVendor.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.gridItem=Ext.create('Account.Payment.Item.Grid_i',{height:320,region:'center'});this.gridGL=Ext.create('Account.Payment.Item.Grid_gl',{border:true,region:'center',title:'GL Posting'});this.gridPayment=Ext.create('Account.Payment.Item.Grid_pm',{border:true,region:'center',title:'Payment'});this.formTotal=Ext.create('Account.Payment.Item.Form_t',{border:true,split:true,title:'Total->Payment',region:'south'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('PY'),fieldLabel:'Payment Status',name:'statu',labelAlign:'right',width:245,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:200,editable:false,labelAlign:'right',allowBlank:false});this.hdnPyItem=Ext.create('Ext.form.Hidden',{name:'ebbp'});this.hdnPpItem=Ext.create('Ext.form.Hidden',{name:'paym',});this.hdnGlItem=Ext.create('Ext.form.Hidden',{name:'bven',});this.trigVendor=Ext.create('Ext.form.field.Trigger',{name:'lifnr',labelAlign:'letf',width:240,fieldLabel:'Vendor Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnPyItem,this.hdnPpItem,this.hdnGlItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,defaultType:'textfield',layout:'anchor',items:[{xtype:'container',layout:'hbox',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',items:[{xtype:'hidden',name:'id'},this.trigVendor,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:350,allowBlank:true}]},{xtype:'textarea',fieldLabel:'Address',name:'adr01',width:350,rows:3,labelAlign:'top'}]},{xtype:'container',layout:'anchor',items:[{xtype:'displayfield',fieldLabel:'Payment No',name:'payno',value:'PYXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'},{xtype:'datefield',fieldLabel:'Document Date',name:'bldat',labelAlign:'right',width:245,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false},{xtype:'datefield',fieldLabel:'Payment Date',name:'duedt',labelAlign:'right',width:245,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false},{xtype:'container',layout:'hbox',margin:'0 0 5 -200',items:[this.trigCurrency,this.comboQStatus]}]}]}]}]};this.items=[mainFormPanel,this.gridItem,{xtype:'tabpanel',region:'south',activeTab:0,height:170,items:[this.formTotal,this.gridPayment,this.gridGL]}];this.trigVendor.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.lifnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);}else{o.markInvalid('Could not find vendor code : '+o.getValue());}}});}},this);_this.vendorDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor.setValue(record.data.lifnr);_this.getForm().findField('name1').setValue(record.data.name1);var _addr=record.data.adr01;if(!Ext.isEmpty(record.data.distx))
_addr+=' '+record.data.distx;if(!Ext.isEmpty(record.data.pstlz))
_addr+=' '+record.data.pstlz;if(!Ext.isEmpty(record.data.telf1))
_addr+='\n'+'Tel: '+record.data.telf1;if(!Ext.isEmpty(record.data.telfx))
_addr+=' '+'Fax: '+record.data.telfx;if(!Ext.isEmpty(record.data.email))
_addr+='\n'+'Email: '+record.data.email;_this.getForm().findField('adr01').setValue(_addr);grid.getSelectionModel().deselectAll();_this.vendorDialog.hide();_this.gridItem.setVendorCode(record.data.lifnr);});this.trigVendor.onTriggerClick=function(){_this.vendorDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);_this.formTotal.getForm().findField('curr').setValue(r.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',r.data.ctype);});_this.gridItem.curValue=r.data.ctype;}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);_this.formTotal.getForm().findField('curr1').setValue(record.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',record.data.ctype);});_this.gridItem.curValue=record.data.ctype;grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.gridPayment.store.on('update',this.loadGL,this);this.gridPayment.store.on('load',this.loadGL,this);this.on('afterLoad',this.loadGL,this);_this.formTotal.getForm().findField('exchg').on('change',this.loadGL,this);return this.callParent(arguments);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'payment/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);_this.gridItem.setVendorCode(act.result.data.lifnr);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnPyItem.setValue(Ext.encode(rsItem));var rsPayment=_this.gridPayment.getData();this.hdnPpItem.setValue(Ext.encode(rsPayment));var rsGL=_this.gridGL.getData();this.hdnGlItem.setValue(Ext.encode(rsGL));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'payment/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({payno:0});this.gridPayment.load({recnr:0});this.gridGL.load({netpr:0});this.comboQStatus.setValue('01');this.trigCurrency.setValue('THB');this.getForm().findField('bldat').setValue(new Date());this.getForm().findField('duedt').setValue(new Date());this.formTotal.getForm().findField('exchg').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=_this.gridItem.store;var sum=0;store.each(function(r){var itamt=parseFloat(r.data['itamt'].replace(/[^0-9.]/g,''));itamt=isNaN(itamt)?0:itamt;var amt=itamt;sum+=amt;});this.formTotal.getForm().findField('beamt').setValue(sum);var currency=this.trigCurrency.getValue();this.gridItem.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);var net=this.formTotal.calculate();this.gridPayment.netValue=net;},loadGL:function(id){var _this=this;var store=_this.gridItem.store;var sum=0;var dtype='';var itamt=0;sum2=0;var saknr_list=[];var whts=0;var vats=0;store.each(function(r){itamt=parseFloat(r.data['itamt'].replace(/[^0-9.]/g,''));itamt=isNaN(itamt)?0:itamt;var amt=itamt;sum+=amt;if(r.data['wht01']>0&&r.data['wht01']!=null){var wht=parseFloat(r.data['wht01'].replace(/[^0-9.]/g,''));whts+=wht;}
if(r.data['vat01']>0&&r.data['vat01']!=null){var vat=parseFloat(r.data['vat01'].replace(/[^0-9.]/g,''));vats+=vat;}
dtype=r.data['dtype'];});var discount=this.formTotal.getForm().findField('dismt').getValue();sum2=sum-discount;var currency=this.trigCurrency.getValue();if(currency!='THB'){var rate=this.formTotal.getForm().findField('exchg').getValue();sum=sum*rate;sum2=sum2*rate;}
if(sum>0&&this.trigVendor.getValue()!=''){var r_data=_this.gridPayment.getData();var pay_list=[];for(var i=0;i<r_data.length;i++){if(r_data[i].ptype=='03'||r_data[i].ptype=='04'){var item=r_data[i].saknr+'|'+r_data[i].payam;}else{var item=r_data[i].ptype+'|'+r_data[i].payam;}
saknr_list.push(item);}
_this.gridGL.load({netpr:sum2,vwht:whts,vvat:vats,dtype:dtype,lifnr:this.trigVendor.getValue(),items:saknr_list.join(',')});}}});;Ext.define('Account.Payment.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'payment/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip'}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:155,width:270,readOnly:true});this.txtDiscount=Ext.create('Ext.form.field.Text',{fieldLabel:'Discount',name:'dispc',disabled:true,align:'right',labelWidth:80,width:150,enableKeyEvents:true,validator:function(v){if(!Ext.isEmpty(v)){var regEx=/^([0-9]*)(\.[1-9]*)?$|^([0-9]|[1-9][0-9]|100)(\.[1-9]*)?(%)$/gi;if(regEx.test(v))
return true;else
return'Value can be only numbers or percent';}else
return true;}});this.txtDiscountValue=Ext.create('Ext.form.field.Text',{name:'dismt',disabled:true,align:'right',width:110,margin:'0 0 0 10',readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',disabled:true,align:'right',width:270,labelWidth:155,margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:240,editable:false,hideTrigger:true,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',width:270,labelWidth:155,alwaysDisplayDecimals:true,margin:'4 0 0 0',style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr1'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'}]},{xtype:'container',layout:'anchor',margins:'0 0 0 200',items:[this.txtTotal,{xtype:'container',layout:'hbox',items:[this.txtDiscount,this.txtDiscountValue]},this.txtDiscountSum,{xtype:'container',layout:'hbox',defaultType:'textfield',items:[this.txtInterest]},this.txtNet]}]}];var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtDiscount.on('keyup',this.calculate,this);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'depositin/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'invoice/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},calculate:function(){var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discount=this.txtDiscount.getValue(),discountValue=0;if(this.txtDiscount.isValid()&&!Ext.isEmpty(discount)){if(discount.match(/%$/gi)){discount=discount.replace('%','');var discountPercent=parseFloat(discount);discountValue=total*discountPercent/100;}else{discountValue=parseFloat(discount);}
discountValue=isNaN(discountValue)?0:discountValue;this.txtDiscountValue.setValue(Ext.util.Format.usMoney(discountValue).replace(/\$/,''));if(discountValue>0)
this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscount.setValue('');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var net=total;this.txtNet.setValue(net);return net;}});;Ext.define('Account.Payment.Item.Grid_gl',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',disabled:true,iconCls:'b-small-copy'});this.glDialog=Ext.create('Account.GL.MainWindow');this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"payment/loads_gl_item",reader:{type:'json',root:'rows',idProperty:'belnr,belpr'}},fields:['belnr','belpr','saknr','sgtxt','debit','credi','txz01','statu'],remoteSort:true,sorters:['belpr ASC']});this.columns=[{id:'RowNumber61',text:"No.",dataIndex:'belpr',width:50,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"GL No.",width:100,dataIndex:'saknr',align:'center',sortable:false,},{text:"GL Description",width:215,dataIndex:'sgtxt',sortable:true},{text:"Debit",width:100,dataIndex:'debit',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,},{text:"Credit",width:100,dataIndex:'credi',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,},{text:"Comment",width:250,dataIndex:'txz01',sortable:true,field:{type:'textfield'}}];this.plugins=[this.editing];this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='saknr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.saknr);rModel.set('sgtxt',r.data.sgtxt);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.glDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('saknr',record.data.saknr);rModel.set('sgtxt',record.data.sgtxt);}
grid.getSelectionModel().deselectAll();_this.glDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addDefaultRecord:function(){this.store.removeAll();var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;for(var i=0;i<5;i++){rec={id:i};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();}},addRecord2:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();},removeRecord2:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow2();},runNumRow2:function(){var row_num=0;this.store.each(function(r){r.set('belpr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.Payment.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.apDialog=Ext.create('Account.SAp.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"payment/loads_py_item",reader:{type:'json',root:'rows',idProperty:'payno,vbelp'}},fields:['payno','vbelp','invnr','refnr','invdt','texts',{name:'itamt',type:'string'},'belnr','ctype','wht01','vat01','dtype','loekz','ebeln'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Payment Item',scope:this,handler:this.removeRecord}]},{xtype:'hidden',name:'loekz'},{id:'PMiRowNumber022',header:"No.",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Acc-Payable No",width:110,dataIndex:'invnr',align:'center',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.apDialog.show();}},},{text:"PO/GR No",width:110,dataIndex:'ebeln',align:'center',sortable:false,field:{type:'textfield'}},{text:"Ref.No",width:150,dataIndex:'refnr',sortable:false,field:{type:'textfield'},},{text:"Payment Date",width:80,xtype:'datecolumn',align:'center',dataIndex:'invdt',sortable:false,renderer:Ext.util.Format.dateRenderer('m/d/Y')},{text:"Text Note",width:180,dataIndex:'texts',sortable:false,field:{type:'textfield'},},{text:"Acc-Payable Amt",xtype:'numbercolumn',width:100,dataIndex:'itamt',sortable:false,align:'right',readOnly:true},{text:"Currency",width:55,dataIndex:'ctype',sortable:false,align:'center',field:{type:'textfield'},},{dataIndex:'wht01',hidden:true,sortable:false},{dataIndex:'vat01',hidden:true,sortable:false},{dataIndex:'dtype',hidden:true,sortable:false}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='invnr'){var v=e.value;var v_url='ap/load';var v_str=v.substring(0,1);if(v_str=='D'){v_url='depositout/load';}
if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+v_url,method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.invnr);rModel.set('refnr',r.data.refnr);rModel.set('invdt',r.data.bldat);rModel.set('texts',r.data.sgtxt);rModel.set('ebeln',r.data.ebeln);rModel.set('itamt',r.data.netwr);rModel.set('ctype',r.data.ctype);rModel.set('wht01',r.data.wht01);rModel.set('vat01',r.data.vat01);var dtype=r.data.invnr.substring(0,2);rModel.set('dtype',dtype[0]);rModel.set('loekz',r.data.loekz);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.apDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('invnr',record.data.invnr);rModel.set('refnr',record.data.refnr);rModel.set('invdt',record.data.bldat);rModel.set('texts',record.data.sgtxt);rModel.set('ebeln',record.data.ebeln);rModel.set('itamt',record.data.netwr);rModel.set('ctype',record.data.ctype);rModel.set('wht01',record.data.wht01);rModel.set('vat01',record.data.vat01);var dtype=record.data.invnr.substring(0,2);rModel.set('dtype',dtype[0]);rModel.set('loekz',record.data.loekz);}
grid.getSelectionModel().deselectAll();_this.apDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,invnr:''};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},setVendorCode:function(lifnr){this.vendorCode=lifnr;var field=this.apDialog.searchForm.form.findField('lifnr');field.setValue(lifnr);this.apDialog.grid.load();}});;Ext.define('Account.Payment.Item.Grid_pm',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.bankDialog=Ext.create('Account.Bankname.MainWindow');this.tbar=[this.addAct,this.copyAct];this.ptypeStore=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'receipt/loads_pcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'});this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"payment/loads_pm_item",reader:{type:'json',root:'rows',idProperty:'recnr,paypr'}},fields:['recnr','paypr','ptype','bcode','bname','sgtxt','chqid','chqdt',{name:'pramt',type:'string'},'payam','reman','saknr','wht01'],remoteSort:true,sorters:['paypr ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Payment',scope:this,handler:this.removeRecord2}]},{id:'RowNumber60',header:"No.",dataIndex:'paypr',width:50,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Payment",width:100,dataIndex:'ptype',sortable:false,editor:new Ext.form.field.ComboBox({store:this.ptypeStore,queryMode:'remote',displayField:'paytx',valueField:'ptype'}),renderer:function(value){if(!isNaN(value)){if(_this.ptypeStore.findRecord('ptype',value)!=null)
return _this.ptypeStore.findRecord('ptype',value).get('paytx');else
return value;}else if(typeof value!='undefined'){if(value.paytx!=null)
return value.paytx;else
return"";}else
return"";}},{text:"Bank Code",align:'center',width:80,dataIndex:'bcode',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.bankDialog.show();}},},{text:"Bank Name",width:120,dataIndex:'bname',sortable:false,field:{type:'textfield'},},{text:"Branch",width:100,dataIndex:'sgtxt',sortable:false,field:{type:'textfield'},},{text:"Cheque No",align:'center',width:80,dataIndex:'chqid',sortable:false,field:{type:'textfield'},},{text:"Cheque Dat",align:'center',xtype:'datecolumn',width:80,dataIndex:'chqdt',sortable:false,format:'d/m/Y',editor:{xtype:'datefield',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},renderer:function(value){if(!isNaN(value)){return Ext.Date.format(value,'d/m/Y')}else{return"";}}},{text:"Amount",xtype:'numbercolumn',align:'right',width:100,dataIndex:'pramt',sortable:false},{text:"Pay Amount",xtype:'numbercolumn',align:'right',width:100,dataIndex:'payam',sortable:false,field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Remain Amt",xtype:'numbercolumn',align:'right',width:100,dataIndex:'reman',sortable:false,readOnly:true,renderer:function(v,p,r){var pamt=parseFloat(r.data['pramt'].replace(/[^0-9.]/g,''));var pay=parseFloat(r.data['payam'].replace(/[^0-9.]/g,''));pamt=isNaN(pamt)?0:pamt;pay=isNaN(pay)?0:pay;var amt=pamt-pay;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{dataIndex:'saknr',hidden:true,sortable:false},{dataIndex:'wht01',hidden:true,sortable:false},{dataIndex:'vat01',hidden:true,sortable:false},{dataIndex:'dtype',hidden:true,sortable:false}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord2();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='bcode'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'bankname/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.bcode);rModel.set('bname',r.data.bname);rModel.set('saknr',r.data.saknr);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.bankDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('bcode',record.data.bcode);rModel.set('bname',record.data.bname);rModel.set('saknr',record.data.saknr)}
grid.getSelectionModel().deselectAll();_this.bankDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord2:function(){var _this=this;var net=_this.netValue;var newId=-1;var i=0;var wht01=0;var vat01=0;var dtype='';this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){i=parseFloat(sel.get('payam').replace(/[^0-9.]/g,''));net=net-i;wht01=parseFloat(sel.get('wht01'));vat01=parseFloat(sel.get('vat01'));dtype=parseFloat(sel.get('dtype'));}
rec={id:newId,pramt:net,vat01:vat01,wht01:wht01,dtype:dtype};edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();},removeRecord2:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow2();},runNumRow2:function(){var row_num=0;this.store.each(function(r){r.set('paypr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},});;Ext.define('Account.Payment.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'Payment preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/payment/index/'+id+'/'+copies;}});;Ext.define('Account.Payment.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Payment',closeAction:'hide',height:650,width:950,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Payment.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.Payment.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({payno:id});this.form.gridPayment.load({recnr:id});this.form.gridGL.load({belnr:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}}});;Ext.define('Account.Payment.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Payment',closeAction:'hide',height:500,minHeight:380,width:950,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('PY')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('PY')||UMS.CAN.CREATE('PY')||UMS.CAN.EDIT('PY'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('PY')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('PY')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.Payment.Item.Window');this.grid=Ext.create('Account.Payment.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.Payment.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save Payment number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/payment/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.PO.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from PO No., Vendor or PR No.',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.PO.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"po/loads",reader:{type:'json',root:'rows',idProperty:'ebeln',totalProperty:'totalCount'},simpleSortMode:true},fields:['ebeln','bldat','lifnr','name1','purnr','netwr','statx','adr01','distx','pstlz','telf1','telfx','email'],remoteSort:true,sorters:[{property:'ebeln',direction:'ASC'}]});this.columns=[{text:"PO No",flex:true,dataIndex:'ebeln',sortable:true},{text:"PO Date",width:125,xtype:'datecolumn',align:'center',format:'d/m/Y',dataIndex:'bldat',sortable:true},{text:"Vendor Code",flex:true,dataIndex:'lifnr',sortable:true},{text:"Vendor Name",flex:true,dataIndex:'name1',sortable:true},{text:"PR No",flex:true,dataIndex:'purnr',sortable:true},{text:"Net Amount",flex:true,xtype:'numbercolumn',dataIndex:'netwr',sortable:true},{text:"PO Status",flex:true,dataIndex:'statx',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.PO.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'po/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.prDialog=Ext.create('Account.PR.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.vendorDialog=Ext.create('Account.SVendor.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.gridItem=Ext.create('Account.PO.Item.Grid_i',{height:320,region:'center'});this.formTotal=Ext.create('Account.PO.Item.Form_t',{title:'PO Total',border:true,split:true,region:'south'});this.gridPrice=Ext.create('Account.PO.Item.Grid_pc',{border:true,split:true,title:'Item Pricing',region:'south'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat Type',name:'taxnr',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select data --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('PO'),fieldLabel:'PO Status',name:'statu',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payments',name:'ptype',width:280,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.hdnPoItem=Ext.create('Ext.form.Hidden',{name:'ekpo',});this.trigPR=Ext.create('Ext.form.field.Trigger',{name:'purnr',fieldLabel:'PR No',labelAlign:'letf',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigVender=Ext.create('Ext.form.field.Trigger',{name:'lifnr',fieldLabel:'Vendor Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',labelAlign:'right',width:170,hideTrigger:false,align:'right'});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:240,labelAlign:'right',allowBlank:false});this.numberVat=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Vat Value',name:'taxpr',labelAlign:'right',width:170,align:'right'});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnPoItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},{xtype:'hidden',name:'loekz'},this.trigPR,{xtype:'displayfield',fieldLabel:'Purchase Order',name:'ebeln',value:'POXXXX-XXXX',width:232,readOnly:true,labelStyle:'font-weight:bold',margin:'0 0 0 292',}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'container',flex:0,layout:'anchor',items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigVender,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:160,allowBlank:true}]},{xtype:'textarea',fieldLabel:'Vendor Address',name:'adr01',width:450,rows:3,},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboPay,this.numberVat]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Reference No',width:280,name:'refnr',},this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:25,value:'Days'}]}]},{xtype:'container',flex:0,layout:'anchor',margin:'0 0 0 70',items:[this.comboPtype,{xtype:'datefield',fieldLabel:'PO Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',},{xtype:'datefield',fieldLabel:'Delivery Date',name:'lfdat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',},this.comboTax,this.trigCurrency,this.comboQStatus]}]}]}]};this.items=[mainFormPanel,this.gridItem,{xtype:'tabpanel',region:'south',activeTab:0,height:170,items:[this.formTotal,this.gridPrice]}];this.trigVender.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.lifnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}else{o.markInvalid('Could not find Vendor code : '+o.getValue());}}});}},this);_this.vendorDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVender.setValue(record.data.lifnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.lifnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}}});grid.getSelectionModel().deselectAll();_this.vendorDialog.hide();});this.trigVender.onTriggerClick=function(){_this.vendorDialog.show();};this.trigPR.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'pr/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.purnr);_this.getForm().findField('lifnr').setValue(r.data.lifnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('loekz').setValue(r.data.loekz);}else{o.markInvalid('Could not find Purchase no : '+o.getValue());}}});}},this);_this.prDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigPR.setValue(record.data.purnr);_this.getForm().findField('lifnr').setValue(record.data.lifnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.purnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'pr/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('loekz').setValue(r.data.loekz);}}});grid.getSelectionModel().deselectAll();var grdpurnr=_this.trigPR.value;_this.gridItem.load({grdpurnr:grdpurnr});_this.prDialog.hide();});this.trigPR.onTriggerClick=function(){_this.prDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.gridItem.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.gridItem.getSelectionModel().on('viewready',this.onViewReady,this);this.comboTax.on('change',this.calculateTotal,this);return this.callParent(arguments);},onSelectChange:function(selModel,selections){var _this=this;var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vat:sel.get('chk01')});}},onViewReady:function(grid){grid.getSelectionModel().select(0);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'po/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnPoItem.setValue(Ext.encode(rsItem));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(ebeln){var _this=this;this.getForm().load({params:{ebeln:ebeln},url:__site_url+'po/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({ebeln:0});this.comboQStatus.setValue('01');this.comboTax.setValue('01');this.trigCurrency.setValue('THB');this.numberVat.setValue(7);this.getForm().findField('bldat').setValue(new Date());this.formTotal.getForm().findField('exchg').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=this.gridItem.store;var sum=0;var vats=0;var i=0;discounts=0;var vattype=this.comboTax.getValue();store.each(function(r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']),discount=parseFloat(r.data['disit']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;discount=isNaN(discount)?0:discount;var amt=qty*price;if(vattype=='02'){amt=amt*100;amt=amt/107;}
sum+=amt;discounts+=discount;amt=amt-discount;if(r.data['chk01']==true){var vat=_this.numberVat.getValue();vat=(amt*vat)/100;vats+=vat;}});this.formTotal.getForm().findField('beamt').setValue(sum);this.formTotal.getForm().findField('vat01').setValue(vats);this.formTotal.getForm().findField('dismt').setValue(discounts);this.formTotal.calculate();this.gridItem.vattValue=this.comboTax.getValue();this.gridItem.vatValue=this.numberVat.getValue();var currency=this.trigCurrency.getValue();this.gridItem.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);this.formTotal.getForm().findField('vat01').setValue(vats);var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vat:sel.get('chk01'),vattype:vattype});}}});;Ext.define('Account.PO.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'quotation/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',xtype:'textfield',fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:150,width:270,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt',align:'right',width:270,labelWidth:150,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',name:'vat01',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:270,hideTrigger:true,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',alwaysDisplayDecimals:true,style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'}]},{xtype:'container',layout:'anchor',margins:'0 0 0 145',items:[this.txtTotal,this.txtDiscountValue,this.txtDiscountSum,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtTaxValue.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'pr2/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},calculate:function(){var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discountValue=this.txtDiscountValue.getValue();if(discountValue>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var net=(total-discountValue)+vat;this.txtNet.setValue(net);}});;Ext.define('Account.PO.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMatAsset.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"po/loads_po_item",reader:{type:'json',root:'rows',idProperty:'ebeln,ebelp'}},fields:['ebeln','ebelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctype','chk01'],remoteSort:true,sorters:['ebelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete PO Item',scope:this,handler:this.removeRecord}]},{id:'POiRowNumber',header:"Items",dataIndex:'ebelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:80,dataIndex:'matnr',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.materialDialog.show();}},},{text:"Description",width:220,dataIndex:'maktx',sortable:false,field:{type:'textfield'},},{text:"Qty",xtype:'numbercolumn',width:70,dataIndex:'menge',sortable:false,align:'right',field:{type:'numberfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Unit",width:50,dataIndex:'meins',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.unitDialog.show();}},},{text:"Price/Unit",xtype:'numbercolumn',width:100,dataIndex:'unitp',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Discount",xtype:'numbercolumn',width:80,dataIndex:'disit',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{xtype:'checkcolumn',text:'Vat',dataIndex:'chk01',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Amount",width:90,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:65,dataIndex:'ctype',sortable:false,align:'center',field:{type:'textfield'}}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='matnr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.matnr);rModel.set('maktx',r.data.maktx);rModel.set('meins',r.data.meins);rModel.set('saknr',r.data.saknr);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.materialDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('matnr',record.data.matnr);rModel.set('maktx',record.data.maktx);rModel.set('meins',record.data.meins);rModel.set('saknr',record.data.saknr);}
grid.getSelectionModel().deselectAll();_this.materialDialog.hide();});_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('meins',record.data.meins);}
grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,ctype:'THB'};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('ebelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.PO.Item.Grid_pc',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"pr/loads_conp_item",reader:{type:'json',root:'rows',idProperty:'conty'}},fields:['conty','contx','vtamt','ttamt'],remoteSort:true,sorters:['conty ASC']});this.columns=[{text:"Condition type",width:170,dataIndex:'contx',sortable:true},{text:"Amount",width:100,xtype:'numbercolumn',dataIndex:'vtamt',sortable:true,align:'right'},{text:"Condition Amount",xtype:'numbercolumn',width:120,dataIndex:'ttamt',align:'right'}];return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.PO.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'Purchase order preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/po/index/'+id+'/'+copies;}});;Ext.define('Account.PO.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Purchase Order',closeAction:'hide',height:650,width:880,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.PO.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.PO.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.buttons=[{text:'Save',disable:!UMS.CAN.APPROVE('PO'),handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.form.gridItem.load({ebeln:0});_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({ebeln:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}}});;Ext.define('Account.PO.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Purchase Orders',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;var fibasic=Ext.create('Ext.form.field.File',{width:200,x:50,y:50,hideLabel:true});this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('PO')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('PO')||UMS.CAN.CREATE('PO')||UMS.CAN.EDIT('PO'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('PO')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('PO')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.PO.Item.Window');this.grid=Ext.create('Account.PO.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.PO.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save PO number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/po/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.PR.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from PR No., Vendor or Reference No.',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.PR.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"pr/loads",reader:{type:'json',root:'rows',idProperty:'purnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['purnr','bldat','lifnr','name1','netwr','statx','adr01','distx','pstlz','telf1','telfx','email','ctype'],remoteSort:true,sorters:[{property:'purnr',direction:'ASC'}]});this.columns=[{text:"PR No",flex:true,dataIndex:'purnr',align:'center',sortable:true},{text:"PR Date",width:125,xtype:'datecolumn',align:'center',format:'d/m/Y',dataIndex:'bldat',sortable:true},{text:"Vendor Code",flex:true,dataIndex:'lifnr',align:'center',sortable:true},{text:"Vendor Name",flex:true,dataIndex:'name1',sortable:true},{text:"PR Status",flex:true,dataIndex:'statx',align:'center',sortable:true},{text:"Net Amount",xtype:'numbercolumn',align:'right',flex:true,dataIndex:'netwr',sortable:true},{text:"Currency",dataIndex:'ctype',sortable:true},{text:"1",hidden:true,width:0,dataIndex:'adr01',sortable:false},{text:"2",hidden:true,width:0,dataIndex:'distx',sortable:false},{text:"3",hidden:true,width:0,dataIndex:'pstlz',sortable:false},{text:"4",hidden:true,width:0,dataIndex:'telf1',sortable:false},{text:"5",hidden:true,width:0,dataIndex:'telfx',sortable:false},{text:"6",hidden:true,width:0,dataIndex:'email',sortable:false}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.PR.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'pr/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.vendorDialog=Ext.create('Account.SVendor.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.gridItem=Ext.create('Account.PR.Item.Grid_i',{region:'center'});this.formTotal=Ext.create('Account.PR.Item.Form_t',{border:true,split:true,title:'PR Total',region:'south'});this.gridPrice=Ext.create('Account.PR.Item.Grid_pc',{border:true,split:true,title:'Item Pricing',region:'south'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('PR'),fieldLabel:'PR Status',name:'statu',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat Type',name:'taxnr',width:240,editable:false,allowBlank:false,labelAlign:'right',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Vat --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payments',name:'ptype',width:280,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.hdnPrItem=Ext.create('Ext.form.Hidden',{name:'ebpo',});this.trigVender=Ext.create('Ext.form.field.Trigger',{name:'lifnr',fieldLabel:'Vendor Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',labelAlign:'right',width:170,hideTrigger:false,align:'right'});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:240,labelAlign:'right',allowBlank:false});this.numberVat=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Vat Value',name:'taxpr',labelAlign:'right',width:170,align:'right'});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnPrItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},this.trigVender,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:307,allowBlank:true},{xtype:'displayfield',fieldLabel:'Purchase No',name:'purnr',fieldLabel:'Purchase No',name:'purnr',value:'PRXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'container',flex:0,items:[this.comboLifnr,{xtype:'textarea',fieldLabel:'Vendor Address',name:'adr01',width:450,rows:3,},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboPay,this.numberVat]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Reference No',width:280,name:'refnr',},this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:25,value:'Days'}]}]},{xtype:'container',margin:'0 0 0 70',items:[{xtype:'datefield',fieldLabel:'PR Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',},{xtype:'datefield',fieldLabel:'Delivery Date',name:'lfdat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',},this.comboTax,this.trigCurrency,this.comboQStatus]}]}]}]};this.items=[mainFormPanel,this.gridItem,{xtype:'tabpanel',region:'south',activeTab:0,height:170,items:[this.formTotal,this.gridPrice]}];this.trigVender.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.vendorDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVender.setValue(record.data.lifnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.lifnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}}});grid.getSelectionModel().deselectAll();_this.vendorDialog.hide();});this.trigVender.onTriggerClick=function(){_this.vendorDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);_this.formTotal.getForm().findField('curr').setValue(r.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',r.data.ctype);});_this.gridItem.curValue=r.data.ctype;}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);_this.formTotal.getForm().findField('curr1').setValue(record.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',record.data.ctype);});_this.gridItem.curValue=record.data.ctype;grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.gridItem.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.gridItem.getSelectionModel().on('viewready',this.onViewReady,this);this.comboTax.on('change',this.calculateTotal,this);return this.callParent(arguments);},onSelectChange:function(selModel,selections){var _this=this;var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vat:sel.get('chk01')});}},onViewReady:function(grid){grid.getSelectionModel().select(0);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'pr/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnPrItem.setValue(Ext.encode(rsItem));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(purnr){var _this=this;this.getForm().load({params:{purnr:purnr},url:__site_url+'pr/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({purnr:0});this.comboQStatus.setValue('01');this.comboTax.setValue('01');this.trigCurrency.setValue('THB');this.numberVat.setValue(7);this.getForm().findField('bldat').setValue(new Date());this.formTotal.getForm().findField('exchg').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=this.gridItem.store;var sum=0;var vats=0;var i=0;discounts=0;var vattype=this.comboTax.getValue();store.each(function(r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']),discount=parseFloat(r.data['disit']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;discount=isNaN(discount)?0:discount;var amt=qty*price;if(vattype=='02'){amt=amt*100;amt=amt/107;}
sum+=amt;discounts+=discount;amt=amt-discount;if(r.data['chk01']==true){var vat=_this.numberVat.getValue();vat=(amt*vat)/100;vats+=vat;}});this.formTotal.getForm().findField('beamt').setValue(sum);this.formTotal.getForm().findField('vat01').setValue(vats);this.formTotal.getForm().findField('dismt').setValue(discounts);this.formTotal.calculate();this.gridItem.vattValue=this.comboTax.getValue();this.gridItem.vatValue=this.numberVat.getValue();var currency=this.trigCurrency.getValue();this.gridItem.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);this.formTotal.getForm().findField('vat01').setValue(vats);var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vat:sel.get('chk01'),vattype:vattype});}}});;Ext.define('Account.PR.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'pr/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',xtype:'textfield',fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:150,width:270,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt',align:'right',width:270,labelWidth:150,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',name:'vat01',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:270,hideTrigger:true,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',alwaysDisplayDecimals:true,style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'}]},{xtype:'container',layout:'anchor',margins:'0 0 0 145',items:[this.txtTotal,this.txtDiscountValue,this.txtDiscountSum,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtTaxValue.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'pr2/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},calculate:function(){var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discountValue=this.txtDiscountValue.getValue();if(discountValue>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var net=(total-discountValue)+vat;this.txtNet.setValue(net);}});;Ext.define('Account.PR.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMatAsset.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"pr/loads_pr_item",reader:{type:'json',root:'rows',idProperty:'purnr,purpr'}},fields:['purnr','purpr','matnr','maktx','menge','meins','unitp','disit','itamt','ctype','chk01'],remoteSort:true,sorters:['purpr ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete PR Item',scope:this,handler:this.removeRecord}]},{id:'PRiRowNumber',header:"Items",dataIndex:'purpr',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:80,dataIndex:'matnr',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.materialDialog.show();}},},{text:"Description",width:220,dataIndex:'maktx',sortable:false,field:{type:'textfield'},},{text:"Qty",xtype:'numbercolumn',width:70,dataIndex:'menge',sortable:false,align:'right',field:{type:'numberfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Unit",width:50,dataIndex:'meins',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.unitDialog.show();}},},{text:"Price/Unit",xtype:'numbercolumn',width:100,dataIndex:'unitp',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Discount",xtype:'numbercolumn',width:80,dataIndex:'disit',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{xtype:'checkcolumn',text:'Vat',dataIndex:'chk01',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Amount",width:90,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']),qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:65,dataIndex:'ctype',sortable:false,align:'center',field:{type:'textfield'},}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='matnr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.matnr);rModel.set('maktx',r.data.maktx);rModel.set('meins',r.data.meins);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.materialDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('matnr',record.data.matnr);rModel.set('maktx',record.data.maktx);rModel.set('meins',record.data.meins);}
grid.getSelectionModel().deselectAll();_this.materialDialog.hide();});_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('meins',record.data.meins);}
grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options,});},addRecord:function(){var _this=this;var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec={id:newId,ctype:cur};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();this.getSelectionModel().deselectAll();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('purpr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.PR.Item.Grid_pc',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"pr/loads_conp_item",reader:{type:'json',root:'rows',idProperty:'conty'}},fields:['conty','contx','vtamt','ttamt'],remoteSort:true,sorters:['conty ASC']});this.columns=[{text:"Condition type",width:170,dataIndex:'contx',sortable:true},{text:"Amount",width:100,xtype:'numbercolumn',dataIndex:'vtamt',sortable:true,align:'right'},{text:"Condition Amount",xtype:'numbercolumn',width:120,dataIndex:'ttamt',align:'right'}];return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.PR.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'Purchase requisitions preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/pr/index/'+id+'/'+copies;}});;Ext.define('Account.PR.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Purchase Requisition',closeAction:'hide',height:600,width:880,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.PR.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.PR.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.form.gridItem.load({purnr:0});_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.form.load(id);this.form.gridItem.load({purnr:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}}});;Ext.define('Account.PR.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Purchase Requisitions',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;var fibasic=Ext.create('Ext.form.field.File',{width:200,x:50,y:50,hideLabel:true});this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('PR')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('PR')||UMS.CAN.CREATE('PR')||UMS.CAN.EDIT('PR'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('PR')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('PR')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.PR.Item.Window');this.grid=Ext.create('Account.PR.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.PR.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save PR number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/pr/index?'+query;});this.searchForm.on('search_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();opts.params=Ext.apply(opts.params,formValues);}});if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Project.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Project, Customer or Salesperson',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Project.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"project/loads",reader:{type:'json',root:'rows',idProperty:'jobnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['jobnr','jobtx','kunnr','name1','bldat','statx','salnr','emnam','stdat','endat','pramt'],remoteSort:true,sorters:[{property:'jobnr',direction:'ASC'}]});this.columns=[{text:"Project No",width:80,align:'center',dataIndex:'jobnr',sortable:true},{text:"Project Name",width:150,dataIndex:'jobtx',sortable:true},{text:"Customer No",width:80,align:'center',dataIndex:'kunnr',sortable:true},{text:"Customer Name",width:150,dataIndex:'name1',sortable:true},{text:"Project Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"1",hidden:true,width:0,dataIndex:'salnr',sortable:true},{text:"Salesperson",width:100,dataIndex:'emnam',sortable:true},{text:"Status",width:120,dataIndex:'statx',sortable:true},{text:"Start Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'stdat',sortable:true},{text:"End Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'endat',sortable:true},{text:"Project Amount",xtype:'numbercolumn',width:90,align:'right',dataIndex:'pramt',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.Project.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'project/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'right',msgTarget:'qtip',labelWidth:105,}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.customerDialog=Ext.create('Account.SCustomer.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.saleDialog=Ext.create('Account.Saleperson.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.typeDialog=Ext.create('Account.Projecttype.Window');this.trigType=Ext.create('Ext.form.field.Trigger',{name:'jtype',fieldLabel:'Project Type',triggerCls:'x-form-search-trigger',enableKeyEvents:true,labelWidth:100,labelAlign:'left',width:250});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('PJ'),fieldLabel:'Project Status',name:'statu',labelWidth:100,labelAlign:'left',editable:false,allowBlank:false,triggerAction:'all',width:250,clearFilterOnReset:true,emptyText:'-- Please Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.trigCustomer=Ext.create('Ext.form.field.Trigger',{name:'kunnr',fieldLabel:'Customer Code',triggerCls:'x-form-search-trigger',labelAlign:'left',enableKeyEvents:true,allowBlank:false});this.trigSale=Ext.create('Ext.form.field.Trigger',{name:'salnr',fieldLabel:'Project Owner',triggerCls:'x-form-search-trigger',labelWidth:100,labelAlign:'left',width:250,enableKeyEvents:true,allowBlank:false});this.txtAmt=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Project Amount',name:'pramt',labelAlign:'left',width:250,minValue:0,allowBlank:false,labelWidth:100});this.txtCost=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Estimate Cost',name:'esamt',align:'right',width:250,minValue:0,labelWidth:100});this.items=[{xtype:'fieldset',title:'Customer Data',items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},this.trigCustomer,{xtype:'displayfield',fieldLabel:'',name:'name1',margins:'0 0 0 6',width:400,allowBlank:true}]},{xtype:'textarea',fieldLabel:'Address',labelAlign:'left',name:'adr01',width:500,allowBlank:true}]},{xtype:'fieldset',title:'Project Detail',defaultType:'textfield',items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'displayfield',fieldLabel:'Project No',name:'jobnr',labelAlign:'left',width:248,labelWidth:100,value:'PJXXXX-XXXX',readOnly:true,labelStyle:'font-weight:bold'},this.comboJStatus]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'container',layout:'hbox',items:[this.trigType,{xtype:'displayfield',name:'typtx',margins:'4 0 0 6',width:286}]},{xtype:'datefield',fieldLabel:'Project Date',name:'bldat',labelWidth:100,width:250,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false}]},{xtype:'textfield',fieldLabel:'Project Name',name:'jobtx',labelAlign:'left',width:500,labelWidth:100,allowBlank:false},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigSale,{xtype:'displayfield',fieldLabel:'',name:'emnam',margins:'0 0 0 6',},{xtype:'hidden',name:'ctype',value:'THB'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.txtAmt,this.txtCost]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Start Date',name:'stdat',labelAlign:'left',labelWidth:100,width:250,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},{xtype:'datefield',fieldLabel:'Finish Date',name:'endat',labelWidth:100,width:250,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},this.comboQStatus]}];this.trigType.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'project/load_type',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.trigType.setValue(r.data.jtype);_this.getForm().findField('typtx').setValue(r.data.typtx);}else{o.markInvalid('Could not find Project type : '+o.getValue());}}});}},this);_this.typeDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigType.setValue(record.data.jtype);_this.getForm().findField('typtx').setValue(record.data.typtx);grid.getSelectionModel().deselectAll();_this.typeDialog.hide();});this.trigType.onTriggerClick=function(){_this.typeDialog.grid.load();_this.typeDialog.show();};this.trigCustomer.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);var _addr=r.data.adr01;if(!Ext.isEmpty(r.data.distx))
_addr+=' '+r.data.distx;if(!Ext.isEmpty(r.data.pstlz))
_addr+=' '+r.data.pstlz;if(!Ext.isEmpty(r.data.telf1))
_addr+='\n'+'Tel: '+r.data.telf1;if(!Ext.isEmpty(r.data.telfx))
_addr+='\n'+'Fax: '+r.data.telfx;if(!Ext.isEmpty(r.data.email))
_addr+='\n'+'Email: '+r.data.email;_this.getForm().findField('adr01').setValue(_addr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer.setValue(record.data.kunnr);_this.getForm().findField('name1').setValue(record.data.name1);var _addr=record.data.adr01;if(!Ext.isEmpty(record.data.distx))
_addr+=' '+record.data.distx;if(!Ext.isEmpty(record.data.pstlz))
_addr+=' '+record.data.pstlz;if(!Ext.isEmpty(record.data.telf1))
_addr+='\n'+'Tel: '+record.data.telf1;if(!Ext.isEmpty(record.data.telfx))
_addr+='\n'+'Fax: '+record.data.telfx;if(!Ext.isEmpty(record.data.email))
_addr+='\n'+'Email: '+record.data.email;_this.getForm().findField('adr01').setValue(_addr);grid.getSelectionModel().deselectAll();_this.customerDialog.hide();});this.trigCustomer.onTriggerClick=function(){_this.customerDialog.show();};this.trigSale.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'saleperson/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.salnr);_this.getForm().findField('emnam').setValue(r.data.emnam);}else{o.markInvalid('Could not find project owner : '+o.getValue());}}});}},this);_this.saleDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigSale.setValue(record.data.salnr);_this.getForm().findField('emnam').setValue(record.data.emnam);grid.getSelectionModel().deselectAll();_this.saleDialog.hide();});this.trigSale.onTriggerClick=function(){_this.saleDialog.show();};return this.callParent(arguments);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'project/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'project/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.comboQStatus.setValue('01');this.getForm().findField('bldat').setValue(new Date());}});;Ext.define('Account.Project.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Project',closeAction:'hide',height:450,width:600,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Project.Item.Form');this.items=[this.form];this.btnSave=Ext.create('Ext.Button',{text:'Save',disabled:!(UMS.CAN.CREATE('PJ')||UMS.CAN.EDIT('PJ')||UMS.CAN.APPROVE('PJ')),handler:function(){_this.form.save();}});this.buttons=[this.btnSave,{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);}else{this.dialogId=null;this.form.reset();this.show(false);}},setReadOnly:function(readOnly){var children=this.items?this.items.items:[];for(var i=0;i<children.length;i++){var child=children[i];child.query('.field').forEach(function(c){c.setReadOnly(readOnly);});child.query('.button').forEach(function(c){if(c.xtype!='tab')
c.setDisabled(readOnly);});}
if(!this.btnSave.initialConfig.disabled)
this.btnSave.setDisabled(readOnly);}});;Ext.define('Account.Project.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Project Management',closeAction:'hide',height:600,minHeight:380,width:1020,minWidth:600,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;var fibasic=Ext.create('Ext.form.field.File',{width:200,x:50,y:50,hideLabel:true});this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('PJ')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('PJ')||UMS.CAN.CREATE('PJ')||UMS.CAN.EDIT('PJ'))});this.displayAct=new Ext.Action({text:'Display',iconCls:'b-small-search',disabled:!UMS.CAN.DISPLAY('PJ')});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('PJ')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('PJ')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.Project.Item.Window');this.grid=Ext.create('Account.Project.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.displayAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.Project.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(false);}});this.displayAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(true);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(){_this.itemDialog.hide();_this.grid.load();});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.itemDialog.form.on('afterSave',function(){_this.itemDialog.hide();_this.grid.load();});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/project/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Projecttype.GridItem',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',enabled:!UMS.CAN.CREATE('PJ'),iconCls:'b-small-plus'});this.tbar=[this.addAct,this.deleteAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'project/loads_type',reader:{type:'json',root:'rows',idProperty:'id_jtype',totalProperty:'totalCount'}},fields:[{name:'id_jtype',type:'int'},'jtype','typtx'],remoteSort:false,sorters:['id_jtype ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{id:'PMiRowNumber003',header:"Type ID",dataIndex:'id_jtype',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Type Code",width:100,dataIndex:'jtype',sortable:true,field:{type:'textfield'},},{text:"Type Description",width:250,dataIndex:'typtx',sortable:true,field:{type:'textfield'},}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});return this.callParent(arguments);},load:function(options){this.store.load({params:options,proxy:{type:'ajax',url:__site_url+'project/loads_type',reader:{type:'json',root:'rows',idProperty:'id_jtype'}},fields:[{name:'id_jtype',type:'int'},'ptype','protx'],remoteSort:false,sorters:['id_jtype ASC']});},addRecord:function(){var newId=-1;var i=0;this.store.each(function(r){i++;if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(i,rec);edit.startEditByPosition({row:i,column:0});this.runNumRow();},save:function(){var _this=this;var r_data=this.getData();Ext.Ajax.request({url:__site_url+'project/save_type',method:'POST',params:{jtyp:Ext.encode(r_data)},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){}else{Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}}});},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},reset:function(){this.grid.load({jtype:0});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('id_jtype',row_num++);});}});;Ext.define('Account.Projecttype.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Project Type',closeAction:'hide',height:420,width:450,layout:'border',resizable:true,modal:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.Projecttype.GridItem',{region:'center'});this.items=[this.grid];this.buttons=[{text:'Save',enabled:!(UMS.CAN.CREATE('PJ')||UMS.CAN.EDIT('PJ')),handler:function(){Ext.Msg.show({title:"Warning",msg:"Are you sure you want to update item(s) ?",icon:Ext.Msg.WARNING,buttons:Ext.Msg.YESNO,fn:function(bt){if(bt=="yes"){_this.grid.save();}}});}},{text:'Cancel',handler:function(){_this.hide();}}];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.PurchaseCreditNote.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Credit Note No, Vender or AP No.',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.PurchaseCreditNote.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"creditnote/loads_cnp",reader:{type:'json',root:'rows',idProperty:'crenr',totalProperty:'totalCount'},simpleSortMode:true},fields:['crenr','bldat','invnr','lifnr','name1','txz01','statx','netwr','ctype'],remoteSort:true,sorters:[{property:'crenr',direction:'ASC'}]});this.columns=[{text:"Credit Note No",width:100,align:'center',dataIndex:'crenr',sortable:true},{text:"Doc Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Invoice No",width:80,align:'center',dataIndex:'invnr',sortable:true},{text:"Vendor No",width:80,align:'center',dataIndex:'lifnr',sortable:true},{text:"Vendor Name",width:150,dataIndex:'name1',sortable:true},{text:"Text Note",width:200,dataIndex:'txz01',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Amount",xtype:'numbercolumn',width:80,align:'right',dataIndex:'netwr',sortable:true},{text:"Currency",width:60,align:'center',dataIndex:'ctype',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.PurchaseCreditNote.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'creditnote/save_cnp',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.apDialog=Ext.create('Account.AP.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.vendorDialog=Ext.create('Account.Vendor.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.gridItem=Ext.create('Account.PurchaseCreditNote.Item.Grid_i',{title:'Credit Items',height:320,region:'center'});this.gridItemIT=Ext.create('Account.PurchaseCreditNote.Item.Grid_it',{height:320,region:'center'});this.gridGL=Ext.create('Account.PurchaseCreditNote.Item.Grid_gl',{border:true,region:'center',title:'GL Posting'});this.formTotal=Ext.create('Account.PurchaseCreditNote.Item.Form_t',{border:true,split:true,title:'GR Total',region:'south'});this.gridPrice=Ext.create('Account.PurchaseCreditNote.Item.Grid_pc',{border:true,split:true,title:'Item Pricing',region:'south'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('PN'),fieldLabel:'Credit Note Status',name:'statu',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat Type',name:'taxnr',width:240,labelAlign:'right',editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select data --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payments',name:'ptype',width:280,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.hdnCnItem=Ext.create('Ext.form.Hidden',{name:'ebcp'});this.hdnGlItem=Ext.create('Ext.form.Hidden',{name:'bven',});this.trigAP=Ext.create('Ext.form.field.Trigger',{name:'invnr',fieldLabel:'AP No',labelAlign:'letf',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigVendor=Ext.create('Ext.form.field.Trigger',{name:'lifnr',fieldLabel:'Vendor Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',labelAlign:'right',width:170,hideTrigger:false,align:'right'});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:240,labelAlign:'right',allowBlank:false});this.numberVat=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Vat Value',name:'taxpr',labelAlign:'right',width:170,align:'right'});this.numberWHT=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'WHT Value',name:'whtpr',labelAlign:'right',width:170,align:'right'});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnCnItem,this.hdnGlItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'loekz'},{xtype:'hidden',name:'id'},this.trigAP,{xtype:'displayfield',width:290,allowBlank:true},{xtype:'displayfield',fieldLabel:'Credit Note No',name:'crenr',value:'CNXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'container',flex:0,layout:'anchor',items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigVendor,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:160,allowBlank:true}]},{xtype:'textarea',fieldLabel:'Vendor Address',name:'adr01',width:450,rows:3,},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboPay,this.numberVat]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Reference No',width:280,name:'refnr',},this.numberWHT]}]},{xtype:'container',flex:0,layout:'anchor',margin:'0 0 0 70',items:[this.comboPtype,{xtype:'datefield',fieldLabel:'Credit Note Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',},this.comboTax,this.trigCurrency,{xtype:'container',layout:'hbox',defaultType:'textfield',margin:'0 0 5 0',items:[this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:25,value:'Days'}]},{xtype:'datefield',fieldLabel:'Due Date',name:'duedt',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},this.comboQStatus]}]}]}]};this.items=[mainFormPanel,{xtype:'tabpanel',region:'center',activeTab:0,border:false,items:[this.gridItem,{xtype:'panel',border:false,title:'Invoice Items',layout:'border',items:[this.gridItemIT]}]},{xtype:'tabpanel',region:'south',activeTab:0,height:200,items:[this.formTotal,this.gridPrice,this.gridGL]}];this.trigAP.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'ap/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.invnr);_this.getForm().findField('lifnr').setValue(r.data.lifnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('loekz').setValue(r.data.loekz);}else{o.markInvalid('Could not find AP no : '+o.getValue());}}});}},this);_this.apDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigAP.setValue(record.data.invnr);_this.getForm().findField('lifnr').setValue(record.data.lifnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.invnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'ap/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('loekz').setValue(r.data.loekz);}}});grid.getSelectionModel().deselectAll();var grdinvnr=_this.trigAP.value;_this.gridItemIT.load({invnr:grdinvnr});_this.apDialog.hide();});this.trigAP.onTriggerClick=function(){_this.apDialog.show();};this.trigVendor.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}else{o.markInvalid('Could not find vendor code : '+o.getValue());}}});}},this);_this.vendorDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor.setValue(record.data.lifnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.lifnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}}});grid.getSelectionModel().deselectAll();_this.vendorDialog.hide();});this.trigVendor.onTriggerClick=function(){_this.vendorDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);_this.formTotal.getForm().findField('curr').setValue(r.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctyp1',r.data.ctype);});_this.gridItem.curValue=r.data.ctype;}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);_this.formTotal.getForm().findField('curr1').setValue(record.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctyp1',record.data.ctype);});_this.gridItem.curValue=record.data.ctype;grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.gridItem.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.gridItem.getSelectionModel().on('viewready',this.onViewReady,this);this.numberCredit.on('keyup',this.getDuedate,this);this.numberCredit.on('change',this.getDuedate,this);this.comboTax.on('change',this.calculateTotal,this);return this.callParent(arguments);},onSelectChange:function(selModel,selections){var _this=this;var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vat:sel.get('chk01')});}},onViewReady:function(grid){grid.getSelectionModel().select(0);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'creditnote/load_cnp',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnCnItem.setValue(Ext.encode(rsItem));var rsGL=_this.gridGL.getData();this.hdnGlItem.setValue(Ext.encode(rsGL));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(mbeln){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'creditnote/remove_cnp',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({crenr:0});this.gridItemIT.load({invnr:0});this.gridGL.load({netpr:0});this.comboQStatus.setValue('01');this.comboTax.setValue('01');this.trigCurrency.setValue('THB');this.numberVat.setValue(7);this.numberWHT.setValue(3);this.getForm().findField('bldat').setValue(new Date());this.formTotal.getForm().findField('exchg').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=this.gridItem.store;var sum2=0;var sum=0;var vats=0;var whts=0;var discounts=0;var saknr_list=[];var vattype=this.comboTax.getValue();store.each(function(r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']),discount=parseFloat(r.data['disit']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;discount=isNaN(discount)?0:discount;var amt=qty*price;if(vattype=='02'){amt=amt*100;amt=amt/107;}
sum+=amt;discounts+=discount;amt=amt-discount;sum2+=amt;if(r.data['chk01']==true){var vat=_this.numberVat.getValue();vat=(amt*vat)/100;vats+=vat;}
if(r.data['chk02']==true){var wht=_this.numberWHT.getValue();wht=(amt*wht)/100;whts+=wht;}
var item=r.data['saknr']+'|'+amt;saknr_list.push(item);});this.formTotal.getForm().findField('beamt').setValue(sum);this.formTotal.getForm().findField('vat01').setValue(vats);this.formTotal.getForm().findField('wht01').setValue(whts);this.formTotal.getForm().findField('dismt').setValue(discounts);this.formTotal.calculate();this.gridItem.vattValue=this.comboTax.getValue();this.gridItem.vatValue=this.numberVat.getValue();var currency=this.trigCurrency.getValue();this.gridItem.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);this.formTotal.getForm().findField('vat01').setValue(vats);var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:vattype});}
if(currency!='THB'){var rate=this.formTotal.getForm().findField('exchg').getValue();sum=sum*rate;sum2=sum2*rate;vats=vats*rate;}
if(sum>0&&this.trigVendor.getValue()!=''){_this.gridGL.load({netpr:sum2,vvat:vats,lifnr:this.trigVendor.getValue(),items:saknr_list.join(',')});}},getDuedate:function(){var bForm=this.getForm(),credit=this.numberCredit.getValue(),startDate=bForm.findField('bldat').getValue();if(!Ext.isEmpty(credit)&&credit>0){var result=Ext.Date.add(startDate,Ext.Date.DAY,credit),dueDateField=bForm.findField('duedt');if(!Ext.isEmpty(credit)&&!Ext.isEmpty(dueDateField))
dueDateField.setValue(result);}}});;Ext.define('Account.PurchaseCreditNote.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'creditnote/save_cnp',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',}});return this.callParent(arguments);},initComponent:function(){var _this=this;var myStorecomboWHTno=Ext.create('Ext.data.Store',{fields:['idWHT','name'],data:[{"idWHT":"01","name":"นิติบุคคล"},{"idWHT":"02","name":"บุคคลธรรมดา"}]});this.whtDialog=Ext.create('Account.WHT.Window');this.trigWHT=Ext.create('Ext.form.field.Trigger',{name:'whtnr',labelAlign:'letf',width:50,triggerCls:'x-form-search-trigger',enableKeyEvents:true,margin:'4 0 0 10'});this.comboWHType=Ext.create('Ext.form.ComboBox',{fieldLabel:'Witholding Tax',name:'whtyp',width:240,triggerAction:'all',clearFilterOnReset:true,emptyText:'--Select WHT Typ--',margin:'4 0 0 0',store:myStorecomboWHTno,labelAlign:'left',queryMode:'local',displayField:'name',valueField:'idWHT'});this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',xtype:'textfield',fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:150,width:270,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt',align:'right',width:270,labelWidth:150,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',name:'vat01',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,margin:'4 0 0 0',readOnly:true});this.txtWHTValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'WHT Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,name:'wht01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:270,hideTrigger:true,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',alwaysDisplayDecimals:true,style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'},{xtype:'container',layout:'hbox',anchor:'100%',items:[this.comboWHType,this.trigWHT,{xtype:'textfield',name:'whtxt',margin:'4 0 0 7',width:250}]}]},{xtype:'container',layout:'anchor',margins:'0 0 0 15',items:[this.txtTotal,this.txtDiscountValue,this.txtDiscountSum,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];this.trigWHT.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/loads_wht',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.whtnr);if(r.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(r.data.whtxt);}}else{o.markInvalid('Could not find wht code : '+o.getValue());}}});}},this);_this.whtDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigWHT.setValue(record.data.whtnr);if(record.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(record.data.whtxt);}
grid.getSelectionModel().deselectAll();_this.whtDialog.hide();});this.trigWHT.onTriggerClick=function(){_this.whtDialog.show();};var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtTaxValue.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtWHTValue.on('render',setAlignRight);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'creditnote/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},calculate:function(){var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discountValue=this.txtDiscountValue.getValue();if(discountValue>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var wht=this.txtWHTValue.getValue();var net=(total-discountValue)+(vat-wht);this.txtNet.setValue(net);}});;Ext.define('Account.PurchaseCreditNote.Item.Grid_gl',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"creditnote/loads_gl_itemp",reader:{type:'json',root:'rows',idProperty:'belnr,belpr'}},fields:['belnr','belpr','saknr','sgtxt','debit','credi','txz01','statu'],remoteSort:true,sorters:['belpr ASC']});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete GL Item',scope:this,handler:this.removeRecord}]},{id:'RowNumber27',text:"No.",dataIndex:'belpr',width:50,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"GL No.",width:100,dataIndex:'saknr',align:'center',sortable:false,},{text:"GL Description",width:215,dataIndex:'sgtxt',sortable:true},{text:"Debit",width:100,dataIndex:'debit',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2},{text:"Credit",width:100,dataIndex:'credi',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2},{text:"Comment",width:250,dataIndex:'txz01',sortable:true,field:{type:'textfield'}}];this.plugins=[this.editing];return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addDefaultRecord:function(){this.store.removeAll();var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;for(var i=0;i<5;i++){rec={id:i};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();}},addRecord2:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();},removeRecord2:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow2();},runNumRow2:function(){var row_num=0;this.store.each(function(r){r.set('belpr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.PurchaseCreditNote.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMaterial.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"creditnote/loads_cn_itemp",reader:{type:'json',root:'rows',idProperty:function(o){return o.crenr+o.vbelp;}}},fields:['vbelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctyp1','chk01','chk02','saknr'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Credit Note Item',scope:this,handler:this.removeRecord}]},{id:'CNiRowNumber2',header:"Items",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:80,dataIndex:'matnr',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.materialDialog.show();}},},{text:"Description",width:220,dataIndex:'maktx',sortable:false,field:{type:'textfield'},},{text:"Qty",xtype:'numbercolumn',width:70,dataIndex:'menge',sortable:false,align:'right',field:{type:'numberfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Unit",width:50,dataIndex:'meins',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.unitDialog.show();}},},{text:"Price/Unit",xtype:'numbercolumn',width:100,dataIndex:'unitp',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Discount",xtype:'numbercolumn',width:80,dataIndex:'disit',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{xtype:'checkcolumn',text:'Vat',dataIndex:'chk01',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{xtype:'checkcolumn',text:'WHT',dataIndex:'chk02',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Amount",width:90,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:65,dataIndex:'ctyp1',sortable:false,align:'center',field:{type:'textfield'},},{dataIndex:'saknr',width:55,sortable:false}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='matnr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.matnr);rModel.set('maktx',r.data.maktx);rModel.set('meins',r.data.meins);rModel.set('saknr',r.data.saknr);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.materialDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('matnr',record.data.matnr);rModel.set('maktx',record.data.maktx);rModel.set('meins',record.data.meins);rModel.set('saknr',record.data.saknr);}
grid.getSelectionModel().deselectAll();_this.materialDialog.hide();});_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('meins',record.data.meins);}
grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,ctyp1:'THB'};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.PurchaseCreditNote.Item.Grid_it',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMaterial.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"creditnote/loads_itemp",reader:{type:'json',root:'rows',idProperty:function(o){return o.crenr+o.vbelp;}}},fields:['vbelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctype','chk01','chk02','saknr'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,},{id:'CNiRowNumber12',header:"Items",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:80,dataIndex:'matnr',sortable:false,},{text:"Description",width:220,dataIndex:'maktx',sortable:false,},{text:"Qty",xtype:'numbercolumn',width:70,dataIndex:'menge',sortable:false,align:'right',},{text:"Unit",width:50,dataIndex:'meins',sortable:false,},{text:"Price/Unit",xtype:'numbercolumn',width:100,dataIndex:'unitp',sortable:false,align:'right',},{text:"Discount",xtype:'numbercolumn',width:80,dataIndex:'disit',sortable:false,align:'right',},{xtype:'checkcolumn',text:'Vat',disabled:true,dataIndex:'chk01',width:30,},{xtype:'checkcolumn',text:'WHT',disabled:true,dataIndex:'chk02',width:30,},{text:"Amount",width:90,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:65,dataIndex:'ctype',sortable:false,align:'center',},{dataIndex:'saknr',hidden:true,sortable:false}];this.plugins=[this.editing];return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,ctype:'THB'};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.PurchaseCreditNote.Item.Grid_pc',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"invoice/loads_conp_item",reader:{type:'json',root:'rows',idProperty:'conty'}},fields:['conty','contx','vtamt','ttamt'],remoteSort:true,sorters:['conty ASC']});this.columns=[{text:"Condition type",width:170,dataIndex:'contx',sortable:true},{text:"Amount",width:100,xtype:'numbercolumn',dataIndex:'vtamt',sortable:true,align:'right'},{text:"Condition Amount",xtype:'numbercolumn',width:120,dataIndex:'ttamt',align:'right'}];return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.PurchaseCreditNote.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'Credit Note preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/purchasecreditnote/index/'+id+'/'+copies;}});;Ext.define('Account.PurchaseCreditNote.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Credit Note',closeAction:'hide',height:650,width:900,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.PurchaseCreditNote.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.PurchaseCreditNote.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({crenr:id});this.form.gridItemIT.load({crenr:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}}});;Ext.define('Account.PurchaseCreditNote.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Credit Note',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;var fibasic=Ext.create('Ext.form.field.File',{width:200,x:50,y:50,hideLabel:true});this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('PN')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('PN')||UMS.CAN.CREATE('PN')||UMS.CAN.EDIT('PN'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('PN')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('PN')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.PurchaseCreditNote.Item.Window');this.grid=Ext.create('Account.PurchaseCreditNote.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.PurchaseCreditNote.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save Credit Note number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/purchasecreditnote/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.PurchaseDebitNote.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Debit Note No, Vendor or Invoice No.',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.PurchaseDebitNote.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"debitnote/loads_dnp",reader:{type:'json',root:'rows',idProperty:'debnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['debnr','bldat','invnr','lifnr','name1','txz01','statx','netwr','ctype'],remoteSort:true,sorters:[{property:'debnr',direction:'ASC'}]});this.columns=[{text:"Debit Note No",width:100,align:'center',dataIndex:'debnr',sortable:true},{text:"Doc Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Invoice No",width:80,align:'center',dataIndex:'invnr',sortable:true},{text:"Vendor No",width:80,align:'center',dataIndex:'lifnr',sortable:true},{text:"Vendor Name",width:150,dataIndex:'name1',sortable:true},{text:"Text Note",width:200,dataIndex:'txz01',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Amount",xtype:'numbercolumn',width:80,align:'right',dataIndex:'netwr',sortable:true},{text:"Currency",width:60,align:'center',dataIndex:'ctype',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.PurchaseDebitNote.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'debitnote/save_dnp',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.apDialog=Ext.create('Account.AP.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.vendorDialog=Ext.create('Account.Vendor.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.gridItem=Ext.create('Account.PurchaseDebitNote.Item.Grid_i',{title:'Debit Items',height:320,region:'center'});this.gridItemIT=Ext.create('Account.PurchaseDebitNote.Item.Grid_it',{height:320,region:'center'});this.gridGL=Ext.create('Account.PurchaseDebitNote.Item.Grid_gl',{border:true,region:'center',title:'GL Posting'});this.formTotal=Ext.create('Account.PurchaseDebitNote.Item.Form_t',{border:true,split:true,title:'GR Total',region:'south'});this.gridPrice=Ext.create('Account.PurchaseDebitNote.Item.Grid_pc',{border:true,split:true,title:'Item Pricing',region:'south'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('PN'),fieldLabel:'Debit Note Status',name:'statu',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat Type',name:'taxnr',width:240,labelAlign:'right',editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select data --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payments',name:'ptype',width:280,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.hdnDnItem=Ext.create('Ext.form.Hidden',{name:'ebde'});this.hdnGlItem=Ext.create('Ext.form.Hidden',{name:'bven',});this.trigAP=Ext.create('Ext.form.field.Trigger',{name:'invnr',fieldLabel:'AP No',labelAlign:'letf',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigVendor=Ext.create('Ext.form.field.Trigger',{name:'lifnr',fieldLabel:'Vendor Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',labelAlign:'right',width:170,hideTrigger:false,align:'right'});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:240,labelAlign:'right',allowBlank:false});this.numberVat=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Vat Value',name:'taxpr',labelAlign:'right',width:170,align:'right'});this.numberWHT=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'WHT Value',name:'whtpr',labelAlign:'right',width:170,align:'right'});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnDnItem,this.hdnGlItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'loekz'},{xtype:'hidden',name:'id'},this.trigAP,{xtype:'displayfield',width:290,allowBlank:true},{xtype:'displayfield',fieldLabel:'Debit Note No',name:'debnr',value:'DNXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'container',flex:0,layout:'anchor',items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigVendor,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:160,allowBlank:true}]},{xtype:'textarea',fieldLabel:'Vendor Address',name:'adr01',width:450,rows:3,},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboPay,this.numberVat]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Reference No',width:280,name:'refnr',},this.numberWHT]}]},{xtype:'container',flex:0,layout:'anchor',margin:'0 0 0 70',items:[this.comboPtype,{xtype:'datefield',fieldLabel:'Debit Note Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',},this.comboTax,this.trigCurrency,{xtype:'container',layout:'hbox',defaultType:'textfield',margin:'0 0 5 0',items:[this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:25,value:'Days'}]},{xtype:'datefield',fieldLabel:'Due Date',name:'duedt',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},this.comboQStatus]}]}]}]};this.items=[mainFormPanel,{xtype:'tabpanel',region:'center',activeTab:0,border:false,items:[this.gridItem,{xtype:'panel',border:false,title:'Invoice Items',layout:'border',items:[this.gridItemIT]}]},{xtype:'tabpanel',region:'south',activeTab:0,height:200,items:[this.formTotal,this.gridPrice,this.gridGL]}];this.trigAP.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'ap/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.invnr);_this.getForm().findField('lifnr').setValue(r.data.lifnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('loekz').setValue(r.data.loekz);}else{o.markInvalid('Could not find Purchase no : '+o.getValue());}}});}},this);_this.apDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigAP.setValue(record.data.invnr);_this.getForm().findField('lifnr').setValue(record.data.lifnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.invnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'ap/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('loekz').setValue(r.data.loekz);}}});grid.getSelectionModel().deselectAll();var grdinvnr=_this.trigAP.value;_this.gridItemIT.load({invnr:grdinvnr});_this.apDialog.hide();});this.trigAP.onTriggerClick=function(){_this.apDialog.show();};this.trigVendor.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}else{o.markInvalid('Could not find vendor code : '+o.getValue());}}});}},this);_this.vendorDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor.setValue(record.data.lifnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.lifnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'vendor/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}}});grid.getSelectionModel().deselectAll();_this.vendorDialog.hide();});this.trigVendor.onTriggerClick=function(){_this.vendorDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);_this.formTotal.getForm().findField('curr').setValue(r.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctyp1',r.data.ctype);});_this.gridItem.curValue=r.data.ctype;}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);_this.formTotal.getForm().findField('curr1').setValue(record.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctyp1',record.data.ctype);});_this.gridItem.curValue=record.data.ctype;grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.gridItem.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.gridItem.getSelectionModel().on('viewready',this.onViewReady,this);this.numberCredit.on('keyup',this.getDuedate,this);this.numberCredit.on('change',this.getDuedate,this);this.comboTax.on('change',this.calculateTotal,this);return this.callParent(arguments);},onSelectChange:function(selModel,selections){var _this=this;var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vat:sel.get('chk01')});}},onViewReady:function(grid){grid.getSelectionModel().select(0);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'debitnote/load_dnp',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnDnItem.setValue(Ext.encode(rsItem));var rsGL=_this.gridGL.getData();this.hdnGlItem.setValue(Ext.encode(rsGL));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(mbeln){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'debitnote/remove_dnp',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({debnr:0});this.gridItemIT.load({invnr:0});this.gridGL.load({netpr:0});this.comboQStatus.setValue('01');this.comboTax.setValue('01');this.trigCurrency.setValue('THB');this.numberVat.setValue(7);this.numberWHT.setValue(3);this.getForm().findField('bldat').setValue(new Date());this.formTotal.getForm().findField('exchg').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=this.gridItem.store;var sum2=0;var sum=0;var vats=0;var whts=0;var discounts=0;var saknr_list=[];var vattype=this.comboTax.getValue();store.each(function(r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']),discount=parseFloat(r.data['disit']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;discount=isNaN(discount)?0:discount;var amt=qty*price;if(vattype=='02'){amt=amt*100;amt=amt/107;}
sum+=amt;discounts+=discount;amt=amt-discount;sum2+=amt;if(r.data['chk01']==true){var vat=_this.numberVat.getValue();vat=(amt*vat)/100;vats+=vat;}
if(r.data['chk02']==true){var wht=_this.numberWHT.getValue();wht=(amt*wht)/100;whts+=wht;}
var item=r.data['saknr']+'|'+amt;saknr_list.push(item);});this.formTotal.getForm().findField('beamt').setValue(sum);this.formTotal.getForm().findField('vat01').setValue(vats);this.formTotal.getForm().findField('wht01').setValue(whts);this.formTotal.getForm().findField('dismt').setValue(discounts);this.formTotal.calculate();this.gridItem.vattValue=this.comboTax.getValue();this.gridItem.vatValue=this.numberVat.getValue();var currency=this.trigCurrency.getValue();this.gridItem.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);this.formTotal.getForm().findField('vat01').setValue(vats);var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:vattype});}
if(currency!='THB'){var rate=this.formTotal.getForm().findField('exchg').getValue();sum=sum*rate;sum2=sum2*rate;vats=vats*rate;}
if(sum>0&&this.trigVendor.getValue()!=''){_this.gridGL.load({netpr:sum2,vvat:vats,lifnr:this.trigVendor.getValue(),items:saknr_list.join(',')});}},getDuedate:function(){var bForm=this.getForm(),credit=this.numberCredit.getValue(),startDate=bForm.findField('bldat').getValue();if(!Ext.isEmpty(credit)&&credit>0){var result=Ext.Date.add(startDate,Ext.Date.DAY,credit),dueDateField=bForm.findField('duedt');if(!Ext.isEmpty(credit)&&!Ext.isEmpty(dueDateField))
dueDateField.setValue(result);}}});;Ext.define('Account.PurchaseDebitNote.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'debitnote/save_dnp',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',}});return this.callParent(arguments);},initComponent:function(){var _this=this;var myStorecomboWHTno=Ext.create('Ext.data.Store',{fields:['idWHT','name'],data:[{"idWHT":"01","name":"นิติบุคคล"},{"idWHT":"02","name":"บุคคลธรรมดา"}]});this.whtDialog=Ext.create('Account.WHT.Window');this.trigWHT=Ext.create('Ext.form.field.Trigger',{name:'whtnr',labelAlign:'letf',width:50,triggerCls:'x-form-search-trigger',enableKeyEvents:true,margin:'4 0 0 10'});this.comboWHType=Ext.create('Ext.form.ComboBox',{fieldLabel:'Witholding Tax',name:'whtyp',width:240,triggerAction:'all',clearFilterOnReset:true,emptyText:'--Select WHT Typ--',margin:'4 0 0 0',store:myStorecomboWHTno,labelAlign:'left',queryMode:'local',displayField:'name',valueField:'idWHT'});this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',xtype:'textfield',fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:150,width:270,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt',align:'right',width:270,labelWidth:150,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',name:'vat01',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,margin:'4 0 0 0',readOnly:true});this.txtWHTValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'WHT Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,name:'wht01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:270,hideTrigger:true,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',alwaysDisplayDecimals:true,style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'},{xtype:'container',layout:'hbox',anchor:'100%',items:[this.comboWHType,this.trigWHT,{xtype:'textfield',name:'whtxt',margin:'4 0 0 7',width:250}]}]},{xtype:'container',layout:'anchor',margins:'0 0 0 15',items:[this.txtTotal,this.txtDiscountValue,this.txtDiscountSum,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];this.trigWHT.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/loads_wht',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.whtnr);if(r.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(r.data.whtxt);}}else{o.markInvalid('Could not find wht code : '+o.getValue());}}});}},this);_this.whtDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigWHT.setValue(record.data.whtnr);if(record.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(record.data.whtxt);}
grid.getSelectionModel().deselectAll();_this.whtDialog.hide();});this.trigWHT.onTriggerClick=function(){_this.whtDialog.show();};var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtTaxValue.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtWHTValue.on('render',setAlignRight);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'debitnote/load_dn'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},calculate:function(){var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discountValue=this.txtDiscountValue.getValue();if(discountValue>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var wht=this.txtWHTValue.getValue();var net=(total-discountValue)+(vat-wht);this.txtNet.setValue(net);}});;Ext.define('Account.PurchaseDebitNote.Item.Grid_gl',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"debitnote/loads_gl_itemp",reader:{type:'json',root:'rows',idProperty:'belnr,belpr'}},fields:['belnr','belpr','saknr','sgtxt','debit','credi','txz01','statu'],remoteSort:true,sorters:['belpr ASC']});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete GL Item',scope:this,handler:this.removeRecord}]},{id:'RowNumber28',text:"No.",dataIndex:'belpr',width:50,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"GL No.",width:100,dataIndex:'saknr',align:'center',sortable:false,},{text:"GL Description",width:215,dataIndex:'sgtxt',sortable:true},{text:"Debit",width:100,dataIndex:'debit',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2},{text:"Credit",width:100,dataIndex:'credi',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2},{text:"Comment",width:250,dataIndex:'txz01',sortable:true,field:{type:'textfield'}}];this.plugins=[this.editing];return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addDefaultRecord:function(){this.store.removeAll();var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;for(var i=0;i<5;i++){rec={id:i};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();}},addRecord2:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();},removeRecord2:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow2();},runNumRow2:function(){var row_num=0;this.store.each(function(r){r.set('belpr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.PurchaseDebitNote.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMaterial.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"debitnote/loads_dn_itemp",reader:{type:'json',root:'rows',idProperty:function(o){return o.debnr+o.vbelp;}}},fields:['vbelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctyp1','chk01','chk02','saknr'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Debit Note Item',scope:this,handler:this.removeRecord}]},{id:'DNiRowNumber2',header:"Items",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:80,dataIndex:'matnr',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.materialDialog.show();}},},{text:"Description",width:220,dataIndex:'maktx',sortable:false,field:{type:'textfield'},},{text:"Qty",xtype:'numbercolumn',width:70,dataIndex:'menge',sortable:false,align:'right',field:{type:'numberfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Unit",width:50,dataIndex:'meins',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.unitDialog.show();}},},{text:"Price/Unit",xtype:'numbercolumn',width:100,dataIndex:'unitp',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Discount",xtype:'numbercolumn',width:80,dataIndex:'disit',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{xtype:'checkcolumn',text:'Vat',dataIndex:'chk01',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{xtype:'checkcolumn',text:'WHT',dataIndex:'chk02',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Amount",width:90,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:65,dataIndex:'ctyp1',sortable:false,align:'center',field:{type:'textfield'},},{dataIndex:'saknr',width:55,sortable:false}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='matnr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.matnr);rModel.set('maktx',r.data.maktx);rModel.set('meins',r.data.meins);rModel.set('saknr',r.data.saknr);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.materialDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('matnr',record.data.matnr);rModel.set('maktx',record.data.maktx);rModel.set('meins',record.data.meins);rModel.set('saknr',record.data.saknr);}
grid.getSelectionModel().deselectAll();_this.materialDialog.hide();});_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('meins',record.data.meins);}
grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,ctyp1:'THB'};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.PurchaseDebitNote.Item.Grid_it',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMaterial.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"debitnote/loads_itemp",reader:{type:'json',root:'rows',idProperty:function(o){return o.debnr+o.vbelp;}}},fields:['vbelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctype','chk01','chk02','saknr'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,},{id:'DNiRowNumber12',header:"Items",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:80,dataIndex:'matnr',sortable:false,},{text:"Description",width:220,dataIndex:'maktx',sortable:false,},{text:"Qty",xtype:'numbercolumn',width:70,dataIndex:'menge',sortable:false,align:'right',},{text:"Unit",width:50,dataIndex:'meins',sortable:false,},{text:"Price/Unit",xtype:'numbercolumn',width:100,dataIndex:'unitp',sortable:false,align:'right',},{text:"Discount",xtype:'numbercolumn',width:80,dataIndex:'disit',sortable:false,align:'right',},{xtype:'checkcolumn',text:'Vat',disabled:true,dataIndex:'chk01',width:30,},{xtype:'checkcolumn',text:'WHT',disabled:true,dataIndex:'chk02',width:30,},{text:"Amount",width:90,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:65,dataIndex:'ctype',sortable:false,align:'center',},{dataIndex:'saknr',hidden:true,sortable:false}];this.plugins=[this.editing];return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,ctype:'THB'};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.PurchaseDebitNote.Item.Grid_pc',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"invoice/loads_conp_item",reader:{type:'json',root:'rows',idProperty:'conty'}},fields:['conty','contx','vtamt','ttamt'],remoteSort:true,sorters:['conty ASC']});this.columns=[{text:"Condition type",width:170,dataIndex:'contx',sortable:true},{text:"Amount",width:100,xtype:'numbercolumn',dataIndex:'vtamt',sortable:true,align:'right'},{text:"Condition Amount",xtype:'numbercolumn',width:120,dataIndex:'ttamt',align:'right'}];return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.PurchaseDebitNote.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'Debit Note preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/purchasedebitnote/index/'+id+'/'+copies;}});;Ext.define('Account.PurchaseDebitNote.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Debit Note',closeAction:'hide',height:650,width:900,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.PurchaseDebitNote.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.PurchaseDebitNote.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({debnr:id});this.form.gridItemIT.load({debnr:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}}});;Ext.define('Account.PurchaseDebitNote.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Debit Note',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;var fibasic=Ext.create('Ext.form.field.File',{width:200,x:50,y:50,hideLabel:true});this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('PN')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('PN')||UMS.CAN.CREATE('PN')||UMS.CAN.EDIT('PN'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('PN')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('PN')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.PurchaseDebitNote.Item.Window');this.grid=Ext.create('Account.PurchaseDebitNote.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.PurchaseDebitNote.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save Debit Note number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/purchasedebitnote/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Quotation.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Quotation, Customer, Project or Sale',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Quotation.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"quotation/loads",reader:{type:'json',root:'rows',idProperty:'vbeln',totalProperty:'totalCount'},simpleSortMode:true},fields:['vbeln','bldat','kunnr','name1','jobnr','jobtx','statx','salnr','sname','netwr','ctype','ptype','taxnr','terms'],remoteSort:true,sorters:[{property:'vbeln',direction:'ASC'}]});this.columns=[{text:"Quotation No",width:100,align:'center',dataIndex:'vbeln',sortable:true},{text:"Quotation Date",xtype:'datecolumn',width:85,align:'center',format:'d/m/Y',dataIndex:'bldat',sortable:true},{text:"Customer No",width:100,align:'center',dataIndex:'kunnr',sortable:true},{text:"Customer Name",width:100,dataIndex:'name1',sortable:true},{text:"Project No",width:100,align:'center',dataIndex:'jobnr',sortable:true},{text:"Project Name",width:150,dataIndex:'jobtx',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"",hidden:true,width:0,dataIndex:'salnr'},{text:"Salesperson",width:120,dataIndex:'sname',sortable:true},{text:"Amount",xtype:'numbercolumn',width:100,align:'right',dataIndex:'netwr',sortable:true},{text:"Currency",width:60,align:'center',dataIndex:'ctype',sortable:true},{text:"1",hidden:true,width:0,sortable:false,dataIndex:'ptype'},{text:"2",hidden:true,width:0,sortable:false,dataIndex:'taxnr'},{text:"3",hidden:true,width:0,sortable:false,dataIndex:'terms'}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Quotation.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'quotation/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.projectDialog=Ext.create('Account.Project.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.customerDialog=Ext.create('Account.SCustomer.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.saleDialog=Ext.create('Account.Saleperson.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.trigSale=Ext.create('Ext.form.field.Trigger',{name:'salnr',fieldLabel:'Salesperson',triggerCls:'x-form-search-trigger',labelAlign:'left',width:170,enableKeyEvents:true});this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.gridItem=Ext.create('Account.Quotation.Item.Grid_i',{title:'Quotation Items'});this.gridPayment=Ext.create('Account.Quotation.Item.Grid_p',{border:true,region:'center'});this.formTotal=Ext.create('Account.Quotation.Item.Form_t',{border:true,split:true,title:'Total->Quotation',region:'south'});this.formTotalthb=Ext.create('Account.Quotation.Item.Form_thb',{border:true,split:true,title:'Exchange Rate->THB',region:'south'});this.gridPrice=Ext.create('Account.Quotation.Item.Grid_pc',{border:true,split:true,title:'Item Pricing',region:'south'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('QT'),fieldLabel:'QT Status',name:'statu',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',margin:'0 0 0 30',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payments',name:'ptype',width:350,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat Type',name:'taxnr',width:240,margin:'0 0 0 6',labelAlign:'right',editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Vat --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',labelAlign:'right',width:200,hideTrigger:false,align:'right',margin:'0 0 0 35'});this.whtDialog=Ext.create('Account.WHT.Window');this.trigWHT=Ext.create('Ext.form.field.Trigger',{fieldLabel:'WHT Value',name:'whtnr',labelAlign:'right',width:150,hideTrigger:false,align:'right',margin:'0 0 0 35'});this.numberWHT=Ext.create('Ext.form.field.Display',{name:'whtpr',width:15,align:'right',margin:'0 0 0 5'});this.numberVat=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Vat Value',name:'taxpr',labelAlign:'right',width:200,align:'right',margin:'0 0 0 35'});this.hdnQtItem=Ext.create('Ext.form.Hidden',{name:'vbap',});this.hdnPpItem=Ext.create('Ext.form.Hidden',{name:'payp',});this.trigProject=Ext.create('Ext.form.field.Trigger',{name:'jobnr',fieldLabel:'Project No.',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigCustomer=Ext.create('Ext.form.field.Trigger',{name:'kunnr',fieldLabel:'Customer Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:240,margin:'0 0 0 6',labelAlign:'right',allowBlank:false});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnQtItem,this.hdnPpItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,defaultType:'textfield',layout:'anchor',defaults:{anchor:'100%'},items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},this.trigProject,{xtype:'displayfield',name:'jobtx',width:350,margins:'0 0 0 6',allowBlank:true},{xtype:'displayfield',fieldLabel:'Quotation No',name:'vbeln',value:'QTXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigCustomer,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:350,allowBlank:true},{xtype:'datefield',fieldLabel:'Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textarea',fieldLabel:'Bill To',name:'adr01',width:350,rows:3,editable:false,labelAlign:'top'},{xtype:'textarea',fieldLabel:'Ship To',name:'adr02',width:355,rows:3,labelAlign:'top',editable:false,margin:'0 0 0 140'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigSale,{xtype:'displayfield',name:'sname',width:174,margins:'0 0 0 6'},this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:10,value:'Days'},this.trigCurrency]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboPay,this.numberVat,{xtype:'displayfield',align:'right',width:10,margin:'0 0 0 5',value:'%'},this.comboTax]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Reference No',name:'refnr',width:350},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigWHT,this.numberWHT,{xtype:'displayfield',align:'right',width:15,margin:'0 0 0 5',value:'%'}]},this.comboQStatus]}]}]};this.items=[mainFormPanel,{xtype:'tabpanel',region:'center',activeTab:0,border:false,items:[this.gridItem,{xtype:'panel',border:false,title:'Partial Payment',layout:'border',items:[this.gridPayment]}]},{xtype:'tabpanel',region:'south',activeTab:0,height:200,items:[this.formTotal,this.formTotalthb,this.gridPrice]}];this.trigCustomer.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('adr02').setValue(r.data.adr02);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer.setValue(record.data.kunnr);var v=record.data.kunnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'customer/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('adr02').setValue(r.data.adr02);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}}});grid.getSelectionModel().deselectAll();_this.customerDialog.hide();});this.trigCustomer.onTriggerClick=function(){_this.customerDialog.grid.load();_this.customerDialog.show();};this.trigSale.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'saleperson/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.salnr);_this.getForm().findField('sname').setValue(r.data.sname);}else{o.markInvalid('Could not find project owner : '+o.getValue());}}});}},this);_this.saleDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigSale.setValue(record.data.salnr);_this.getForm().findField('sname').setValue(record.data.sname);grid.getSelectionModel().deselectAll();_this.saleDialog.hide();});this.trigSale.onTriggerClick=function(){_this.saleDialog.grid.load();_this.saleDialog.show();};this.trigProject.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'project/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.jobnr);_this.getForm().findField('jobtx').setValue(r.data.jobtx);_this.getForm().findField('kunnr').setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('salnr').setValue(r.data.salnr);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('adr02').setValue(r.data.adr02);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('vat01').setValue(r.data.vat01);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('sname').setValue(r.data.sname);}else{o.markInvalid('Could not find project code : '+o.getValue());}}});}},this);_this.projectDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigProject.setValue(record.data.jobnr);_this.getForm().findField('jobtx').setValue(record.data.jobtx);_this.getForm().findField('kunnr').setValue(record.data.kunnr);_this.getForm().findField('name1').setValue(record.data.name1);_this.getForm().findField('salnr').setValue(record.data.salnr);Ext.Ajax.request({url:__site_url+'project/load',method:'POST',params:{id:record.data.jobnr},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('adr02').setValue(r.data.adr02);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('vat01').setValue(r.data.vat01);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('sname').setValue(r.data.sname);}}});grid.getSelectionModel().deselectAll();_this.projectDialog.hide();});this.trigProject.onTriggerClick=function(){_this.projectDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);_this.formTotal.getForm().findField('curr').setValue(r.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',r.data.ctype);});_this.gridItem.curValue=r.data.ctype;}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);_this.formTotal.getForm().findField('curr1').setValue(record.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',record.data.ctype);});_this.gridItem.curValue=record.data.ctype;grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};this.trigWHT.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/loads_wht',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.whtnr);_this.getForm().findField('whtpr').setValue(r.data.whtpr);}else{o.markInvalid('Could not find wht code : '+o.getValue());}}});}},this);_this.whtDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigWHT.setValue(record.data.whtnr);_this.getForm().findField('whtpr').setValue(record.data.whtpr);grid.getSelectionModel().deselectAll();_this.whtDialog.hide();});this.trigWHT.onTriggerClick=function(){_this.whtDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.gridItem.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.gridItem.getSelectionModel().on('viewready',this.onViewReady,this);this.comboTax.on('change',this.calculateTotal,this);this.trigCurrency.on('change',this.changeCurrency,this);this.formTotal.txtRate.on('keyup',this.calculateTotal,this);this.formTotal.txtRate.on('change',this.calculateTotal,this);this.numberWHT.on('change',this.calculateTotal,this);return this.callParent(arguments);},onSelectChange:function(selModel,selections){var _this=this;var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:this.comboTax.getValue()});}},onViewReady:function(grid){grid.getSelectionModel().select(0);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'quotation/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnQtItem.setValue(Ext.encode(rsItem));var rsPayment=_this.gridPayment.getData();this.hdnPpItem.setValue(Ext.encode(rsPayment));if(_form_basic.isValid()){_form_basic.submit({waitMsg:'Save data...',success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'quotation/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({vbeln:0});this.gridPayment.load({vbeln:0});this.comboQStatus.setValue('01');this.comboTax.setValue('01');this.trigCurrency.setValue('THB');this.numberVat.setValue(7);this.numberWHT.setValue(3);this.getForm().findField('bldat').setValue(new Date());this.formTotal.txtRate.setValue('1.0000');this.formTotalthb.getForm().findField('exchg2').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=this.gridItem.store;var sum=0;var vats=0;var whts=0;var discounts=0;var vattype=this.comboTax.getValue();store.each(function(r){var qty=parseFloat(r.data['menge'].replace(/[^0-9.]/g,'')),price=parseFloat(r.data['unitp'].replace(/[^0-9.]/g,'')),discountValue=0,discount=r.data['disit'];qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;if(vattype=='02'){amt=amt*100;amt=amt/107;}
if(discount.match(/%$/gi)){discount=discount.replace('%','');var discountPercent=parseFloat(discount);discountValue=amt*discountPercent/100;}else{discountValue=parseFloat(discount);}
discountValue=isNaN(discountValue)?0:discountValue;sum+=amt;discounts+=discountValue;amt=amt-discountValue;if(r.data['chk01']==true){var vat=_this.numberVat.getValue();vat=(amt*vat)/100;vats+=vat;}
if(r.data['chk02']==true){var wht=_this.numberWHT.getValue();wht=(amt*wht)/100;whts+=wht;}});this.formTotal.getForm().findField('beamt').setValue(sum);this.formTotal.getForm().findField('vat01').setValue(vats);this.formTotal.getForm().findField('wht01').setValue(whts);this.formTotal.getForm().findField('dismt').setValue(discounts);var net=this.formTotal.calculate();var currency=this.trigCurrency.getValue();var rate=this.formTotal.txtRate.getValue();if(currency!='THB'){sum=sum*rate;vats=vats*rate;discounts=discounts*rate;}
this.formTotalthb.getForm().findField('beamt2').setValue(sum);this.formTotalthb.getForm().findField('vat02').setValue(vats);this.formTotalthb.getForm().findField('wht02').setValue(whts);this.formTotalthb.getForm().findField('dismt2').setValue(discounts);this.formTotalthb.getForm().findField('exchg2').setValue(rate);var net2=this.formTotalthb.calculate();this.gridPayment.netValue=net;this.gridItem.vattValue=this.comboTax.getValue();this.gridItem.vatValue=this.numberVat.getValue();this.gridItem.whtValue=this.numberWHT.getValue();this.gridItem.curValue=currency;this.gridPayment.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);this.formTotalthb.getForm().findField('curr2').setValue(currency);this.gridItem.customerValue=this.trigCustomer.getValue();var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit'),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:vattype});}},changeCurrency:function(){var _this=this;var store=this.gridItem.store;var currency=this.trigCurrency.getValue();store.each(function(r){r.set('ctyp1',currency);});var store2=this.gridPayment.store;store2.each(function(r){r.set('ctyp1',currency);});}});;Ext.define('Account.Quotation.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'quotation/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:155,width:270,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:155,name:'vat01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtWHTValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'WHT Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:155,name:'wht01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:240,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',width:270,labelWidth:155,alwaysDisplayDecimals:true,margin:'4 0 0 0',style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'}]},{xtype:'container',layout:'anchor',margins:'0 0 0 200',items:[this.txtTotal,this.txtDiscountValue,this.txtDiscountSum,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtTaxValue.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtWHTValue.on('render',setAlignRight);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'quotation/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'quotation/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},calculate:function(){var _this=this;var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discount=this.txtDiscountValue.getValue();if(discount>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discount).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var wht=this.txtWHTValue.getValue();var net=(total-discount)+(vat-wht);this.txtNet.setValue(net);var net=total-discount;return net;}});;Ext.define('Account.Quotation.Item.Form_thb',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'quotation/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt2',alwaysDisplayDecimals:true,labelWidth:155,width:270,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt2',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb2',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:155,name:'vat02',align:'right',margin:'4 0 0 0',readOnly:true});this.txtWHTValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'WHT Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:155,name:'wht02',align:'right',margin:'4 0 0 0',readOnly:true});this.txtRate2=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Exchange Rate',align:'right',readOnly:true,width:240,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg2',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr2',align:'right',width:270,labelWidth:155,alwaysDisplayDecimals:true,margin:'4 0 0 0',style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate2,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr2',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',disabled:true,margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,disabled:true,width:380,name:'txz01'}]},{xtype:'container',layout:'anchor',margins:'0 0 0 200',items:[this.txtTotal,this.txtDiscountValue,this.txtDiscountSum,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtTaxValue.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtWHTValue.on('render',setAlignRight);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'quotation/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'quotation/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},calculate:function(){var _this=this;var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discount=this.txtDiscountValue.getValue();if(discount>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discount).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var wht=this.txtWHTValue.getValue();var net=(total-discount)+(vat-wht);this.txtNet.setValue(net);return net;}});;Ext.define('Account.Quotation.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMaterial.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"quotation/loads_qt_item",reader:{type:'json',root:'rows',idProperty:function(o){return o.vbeln+o.vbelp;},totalProperty:'totalCount'}},fields:['vbeln','vbelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctype','chk01','chk02'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete QT Item',scope:this,handler:this.removeRecord}]},{id:'RowNumber3',text:"Items",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:110,dataIndex:'matnr',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.materialDialog.show();}},},{text:"Description",width:220,dataIndex:'maktx',sortable:false,field:{type:'textfield'},},{text:"Qty",xtype:'numbercolumn',width:60,dataIndex:'menge',sortable:false,align:'right',field:{type:'numberfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Unit",width:50,dataIndex:'meins',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:false,editable:false,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.unitDialog.show();}},},{text:"Price/Unit",xtype:'numbercolumn',width:80,dataIndex:'unitp',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Discount",width:70,dataIndex:'disit',sortable:false,align:'right',field:Ext.create('BASE.form.field.PercentOrNumber'),renderer:function(v,p,r){var regEx=/%$/gi;if(regEx.test(v))
return v;else
return Ext.util.Format.usMoney(v).replace(/\$/,'');}},{xtype:'checkcolumn',text:'Vat',dataIndex:'chk01',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{xtype:'checkcolumn',text:'WHT',dataIndex:'chk02',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Amount",width:120,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge'].replace(/[^0-9.]/g,'')),price=parseFloat(r.data['unitp'].replace(/[^0-9.]/g,'')),chk01=r.data['chk01'],chk02=r.data['chk02'];qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:70,dataIndex:'ctype',sortable:false,align:'center',field:{type:'textfield'},}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='matnr'){var v=e.value;var cusno=_this.customerValue;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v,kunnr:cusno},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.getId());console.log(e.record);if(rModel){rModel.beginEdit();var result=rModel.set({'maktx':r.data.maktx,'meins':r.data.meins,'unitp':r.data.cost});rModel.endEdit();}}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.materialDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('matnr',record.data.matnr);rModel.set('maktx',record.data.maktx);rModel.set('meins',record.data.meins);var v=record.data.matnr;var cusno=_this.customerValue;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v,kunnr:cusno},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success&&r.data.cost){var cost=r.data.cost;rModel.set('unitp',cost);}}});}
grid.getSelectionModel().deselectAll();_this.materialDialog.hide();});_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('meins',record.data.meins);}
grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});this.store.on('load',function(store,rs){if(_this.readOnly){var view=_this.getView();var t=_this.getView().getEl().down('table');t.addCls('mask-grid-readonly');_this.readOnlyMask=new Ext.LoadMask(t,{msg:"..."});_this.readOnlyMask.show();}else{if(_this.readOnlyMask)
_this.readOnlyMask.hide();}});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var _this=this;var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec={id:newId,ctype:cur};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();grid.getSelectionModel().deselectAll();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.Quotation.Item.Grid_p',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"quotation/loads_pay_item",reader:{type:'json',root:'rows',idProperty:'vbeln,paypr'}},fields:['vbeln','paypr','sgtxt','duedt','perct','pramt','ctyp1','payty'],remoteSort:true,sorters:['paypr ASC']});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete QT Payment',scope:this,handler:this.removeRecord2}]},{id:'RowNumber41',text:"Periods No.",dataIndex:'paypr',width:90,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Period Desc.",width:340,dataIndex:'sgtxt',sortable:true,field:{type:'textfield'}},{text:"Due Date",width:100,xtype:'datecolumn',dataIndex:'duedt',format:'d/m/Y',sortable:true,editor:{xtype:'datefield',allowBlank:false,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}},{xtype:'checkcolumn',text:'Deposit',dataIndex:'payty',width:70,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Amt/ %",width:70,dataIndex:'perct',sortable:true,align:'right',field:Ext.create('BASE.form.field.PercentOrNumber'),renderer:function(v,p,r){var regEx=/%$/gi;if(regEx.test(v))
return v;else
return Ext.util.Format.usMoney(v).replace(/\$/,'');}},{text:"Amount",width:150,dataIndex:'pramt',xtype:'numbercolumn',align:'right',renderer:function(v,p,r){var net=_this.netValue,percRaw=r.data['perct'],regEx=/%$/gi;if(regEx.test(percRaw)){var perc=parseFloat(percRaw.replace(regEx,'')),amt=(perc*net)/100;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}else
return Ext.util.Format.usMoney(percRaw).replace(/\$/,'');}},{text:"Currency",width:70,dataIndex:'ctyp1',sortable:true,align:'center',editor:{xtype:'textfield'},}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord2();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord2:function(){var _this=this;var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec={id:newId,pramt:'0.00',ctyp1:cur};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();},removeRecord2:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow2();},runNumRow2:function(){var row_num=0;this.store.each(function(r){r.set('paypr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},netValue:0});;Ext.define('Account.Quotation.Item.Grid_pc',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"quotation/loads_conp_item",reader:{type:'json',root:'rows',idProperty:'conty'}},fields:['conty','contx','vtamt','ttamt'],remoteSort:true,sorters:['conty ASC']});this.columns=[{text:"Condition type",width:170,dataIndex:'contx',sortable:true},{text:"Amount",width:100,xtype:'numbercolumn',dataIndex:'vtamt',sortable:true,align:'right'},{text:"Condition Amount",xtype:'numbercolumn',width:120,dataIndex:'ttamt',align:'right'}];return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.Quotation.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){var _this=this;Ext.apply(this,{title:'Quotation preview',enableCopies:true});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/quotation/index/'+id+'/'+copies;}});;Ext.define('Account.Quotation.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Quotation',closeAction:'hide',height:700,width:950,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Quotation.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.Quotation.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.btnSave=Ext.create('Ext.Button',{text:'Save',disabled:!(UMS.CAN.CREATE('QT')||UMS.CAN.EDIT('QT')||UMS.CAN.APPROVE('QT')),handler:function(){_this.form.save();}});this.buttons=[this.btnSave,{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({vbeln:id});this.form.gridPayment.load({vbeln:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}},setReadOnly:function(readOnly){var children=this.items?this.items.items:[];for(var i=0;i<children.length;i++){var child=children[i];child.query('.field').forEach(function(c){if(!c.initialConfig.readOnly){c.setReadOnly(readOnly);}});child.query('.button').forEach(function(c){if(c.xtype!='tab'){if(!c.initialConfig.disabled)
c.setDisabled(readOnly);}});}
this.form.gridItem.readOnly=readOnly;this.form.gridPayment.readOnly=readOnly;if(!this.btnSave.initialConfig.disabled)
this.btnSave.setDisabled(readOnly);}});;Ext.define('Account.Quotation.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Quotation',closeAction:'hide',height:600,minHeight:380,width:1020,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('QT')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.CREATE('QT')||UMS.CAN.EDIT('QT')||UMS.CAN.APPROVE('QT'))});this.displayAct=new Ext.Action({text:'Display',iconCls:'b-small-search',disabled:!UMS.CAN.DISPLAY('QT')});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('QT')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('QT')});this.importAct=new Ext.Action({text:'Import',iconCls:'b-small-import',disabled:true});this.itemDialog=Ext.create('Account.Quotation.Item.Window');this.grid=Ext.create('Account.Quotation.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.displayAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.Quotation.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();_this.itemDialog.setReadOnly(false);});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(false);}});this.displayAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(true);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/quotation/index?'+query;});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save quotation number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();opts.params=Ext.apply(opts.params,formValues);}});if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){if(!_this.editAct.isDisabled())
_this.editAct.execute();else if(UMS.CAN.DISPLAY('QT'))
_this.displayAct.execute();});}
if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
this.grid.load();return this.callParent(arguments);},disableGridDoubleClick:false});;Ext.define('Account.RAP.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.comboAPStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'AP Status',name:'statu',editable:false,triggerAction:'all',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.apDialog=Ext.create('Account.AP.MainWindow');this.apDialog2=Ext.create('Account.AP.MainWindow');this.grDialog=Ext.create('Account.GR.MainWindow');this.grDialog2=Ext.create('Account.GR.MainWindow');this.vendorDialog=Ext.create('Account.Vendor.MainWindow');this.vendorDialog2=Ext.create('Account.Vendor.MainWindow');this.trigAP=Ext.create('Ext.form.field.Trigger',{name:'invnr',fieldLabel:'AP Doc',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigAP2=Ext.create('Ext.form.field.Trigger',{name:'invnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigGR=Ext.create('Ext.form.field.Trigger',{name:'mbeln',fieldLabel:'GR Doc',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigGR2=Ext.create('Ext.form.field.Trigger',{name:'mbeln2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigVendor=Ext.create('Ext.form.field.Trigger',{name:'lifnr',fieldLabel:'Vendor Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigVendor2=Ext.create('Ext.form.field.Trigger',{name:'lifnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigAP.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'ap/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.invnr);}else{o.markInvalid('Could not find Account Payable : '+o.getValue());}}});}},this);_this.apDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigAP.setValue(record.data.invnr);grid.getSelectionModel().deselectAll();_this.apDialog.hide();});this.trigAP.onTriggerClick=function(){_this.apDialog.show();};this.trigAP2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'ap/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.invnr);}else{o.markInvalid('Could not find Account Payable : '+o.getValue());}}});}},this);_this.apDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigAP2.setValue(record.data.invnr);grid.getSelectionModel().deselectAll();_this.apDialog2.hide();});this.trigAP2.onTriggerClick=function(){_this.apDialog2.show();};this.trigGR.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'gr/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.mbeln);}else{o.markInvalid('Could not find Goods Receipts Doc : '+o.getValue());}}});}},this);_this.grDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigGR.setValue(record.data.mbeln);grid.getSelectionModel().deselectAll();_this.grDialog.hide();});this.trigGR.onTriggerClick=function(){_this.grDialog.show();};this.trigGR2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'gr/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.mbeln);}else{o.markInvalid('Could not find Goods Receipts Doc : '+o.getValue());}}});}},this);_this.grDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigGR2.setValue(record.data.mbeln);grid.getSelectionModel().deselectAll();_this.grDialog2.hide();});this.trigGR2.onTriggerClick=function(){_this.grDialog2.show();};this.trigVendor.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.lifnr);}else{o.markInvalid('Could not find vendor code : '+o.getValue());}}});}},this);_this.vendorDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor.setValue(record.data.lifnr);grid.getSelectionModel().deselectAll();_this.vendorDialog.hide();});this.trigVendor.onTriggerClick=function(){_this.vendorDialog.show();};this.trigVendor2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.lifnr);}else{o.markInvalid('Could not find vendor code : '+o.getValue());}}});}},this);_this.vendorDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor2.setValue(record.data.lifnr);grid.getSelectionModel().deselectAll();_this.vendorDialog2.hide();});this.trigVendor2.onTriggerClick=function(){_this.vendorDialog2.show();};this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Document Date',name:'bldat',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},{xtype:'datefield',name:'bldat2',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigAP,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigAP2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigGR,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigGR2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},this.trigVendor,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigVendor2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboAPStatus,{}]}];return this.callParent(arguments);},});;Ext.define('Account.RAP.Item.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"ap/loads_report",reader:{type:'json',root:'rows',idProperty:function(o){return o.invnr+o.vbelp;}},simpleSortMode:true},fields:['invnr','bldat','ebeln','lifnr','name1','terms','duedt','overd','statx','matnr','maktx','menge','unitp','beamt','vat01','netwr'],remoteSort:true,sorters:[{property:'invnr',direction:'ASC'}]});this.columns=[{text:"AP No.",width:80,align:'center',dataIndex:'invnr',sortable:true},{text:"AP Date",xtype:'datecolumn',format:'d/m/Y',width:70,align:'center',dataIndex:'bldat',sortable:true},{text:"Ref. PO No.",width:80,align:'center',dataIndex:'ebeln',sortable:true},{text:"Vendor Code",width:80,dataIndex:'lifnr',align:'center',sortable:true},{text:"Vendor Name",width:120,dataIndex:'name1',sortable:true},{text:"Credit Term",width:80,align:'center',dataIndex:'terms',sortable:true},{text:"Due Date",width:80,dataIndex:'duedt',format:'d/m/Y',sortable:true},{text:"Over Due",width:60,dataIndex:'overd',sortable:true},{text:"Status",width:80,dataIndex:'statx',align:'center',align:'center',sortable:true},{text:"Material Code",width:80,align:'center',dataIndex:'matnr',sortable:true},{text:"Item Description",width:60,align:'center',dataIndex:'maktx',sortable:true},{text:"Quantity",width:60,align:'right',xtype:'numbercolumn',dataIndex:'menge',sortable:true},{text:"Unit Price",width:60,align:'right',xtype:'numbercolumn',dataIndex:'unitp',sortable:true},{text:"Amount (Before Vat)",width:80,align:'right',xtype:'numbercolumn',dataIndex:'beamt',sortable:true},{text:"Vat Amount",width:80,align:'right',xtype:'numbercolumn',dataIndex:'vat01',sortable:true},{text:"Amount Including Vat",width:80,align:'center',xtype:'numbercolumn',dataIndex:'netwr',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.RAP.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Account Payable Report',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.txtParam=Ext.create('Ext.form.Text',{width:300});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',handler:function(){var param=_this.txtParam.getValue();window.location=__site_url+'export/rap/Index?'+param;}});this.grid=Ext.create('Account.RAP.Item.Grid',{region:'center',border:false});this.items=[this.grid];this.tbar=[this.excelAct];return this.callParent(arguments);}});;Ext.define('Account.RAP.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Account Payable Selection',closeAction:'hide',height:250,width:500,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.itemDialog=Ext.create('Account.RAP.Item.Window');this.form=Ext.create('Account.RAP.Form',{region:'center'});this.items=[this.form];this.buttons=[{text:'Report',handler:function(){_this.itemDialog.show();_this.itemDialog.grid.load();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];this.itemDialog.grid.store.on('beforeload',function(store){var formValues=_this.form.getForm().getValues();store.getProxy().extraParams=formValues;});return this.callParent(arguments);}});;Ext.define('Account.RProject.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.projectDialog=Ext.create('Account.Project.MainWindow');this.customerDialog=Ext.create('Account.Customer.MainWindow');this.projectDialog2=Ext.create('Account.Project.MainWindow');this.customerDialog2=Ext.create('Account.Customer.MainWindow');this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'Quotation Status',name:'statu',editable:false,triggerAction:'all',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboQStatus2=Ext.create('Ext.form.ComboBox',{name:'statu2',editable:false,triggerAction:'all',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboPSale=Ext.create('Ext.form.ComboBox',{fieldLabel:'Saleperson',name:'salnr',editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select Saleperson --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_scombo',reader:{type:'json',root:'rows',idProperty:'salnr'}},fields:['salnr','name1'],remoteSort:true,sorters:'salnr ASC'}),queryMode:'remote',displayField:'name1',valueField:'salnr'});this.comboPSale2=Ext.create('Ext.form.ComboBox',{name:'salnr2',editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select Saleperson --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_scombo',reader:{type:'json',root:'rows',idProperty:'salnr'}},fields:['salnr','name1'],remoteSort:true,sorters:'salnr ASC'}),queryMode:'remote',displayField:'name1',valueField:'salnr'});this.trigProject=Ext.create('Ext.form.field.Trigger',{name:'jobnr',fieldLabel:'Project Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigProject2=Ext.create('Ext.form.field.Trigger',{name:'jobnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigCustomer=Ext.create('Ext.form.field.Trigger',{name:'kunnr',fieldLabel:'Customer Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigCustomer2=Ext.create('Ext.form.field.Trigger',{name:'kunnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Date',name:'bldat1',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},{xtype:'datefield',name:'bldat2',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigProject,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigProject2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},this.trigCustomer,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigCustomer2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboPSale,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.comboPSale2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboQStatus,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.comboQStatus2]}];this.trigCustomer2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer2.setValue(record.data.kunnr);grid.getSelectionModel().deselectAll();_this.customerDialog2.hide();});this.trigCustomer2.onTriggerClick=function(){_this.customerDialog2.show();};this.trigProject2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'project/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.jobnr);}else{o.markInvalid('Could not find project code : '+o.getValue());}}});}},this);_this.projectDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigProject2.setValue(record.data.jobnr);grid.getSelectionModel().deselectAll();_this.projectDialog2.hide();});this.trigProject2.onTriggerClick=function(){_this.projectDialog2.show();};this.trigCustomer.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer.setValue(record.data.kunnr);grid.getSelectionModel().deselectAll();_this.customerDialog.hide();});this.trigCustomer.onTriggerClick=function(){_this.customerDialog.show();};this.trigProject.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'project/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.jobnr);}else{o.markInvalid('Could not find project code : '+o.getValue());}}});}},this);_this.projectDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigProject.setValue(record.data.jobnr);grid.getSelectionModel().deselectAll();_this.projectDialog.hide();});this.trigProject.onTriggerClick=function(){_this.projectDialog.show();};return this.callParent(arguments);},});;Ext.define('Account.RProject.Item.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"project/loads",reader:{type:'json',root:'rows',idProperty:'vbeln'}},fields:['jobnr','jobtx','bldat','kunnr','name1','statx','sname','pramt','ctype'],remoteSort:true,sorters:['vbeln ASC']});this.columns=[{text:"Project No",width:100,align:'center',dataIndex:'jobnr',sortable:true},{text:"Project Name",width:150,dataIndex:'jobtx',sortable:true},{text:"Project Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Customer No",width:100,align:'center',dataIndex:'kunnr',sortable:true},{text:"Customer Name",width:100,dataIndex:'name1',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Sale Name",width:120,dataIndex:'sname',sortable:true},{text:"Project Amount",width:100,align:'right',dataIndex:'pramt',sortable:true},{text:"Currency",width:80,align:'center',dataIndex:'ctype',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.RProject.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Project Report',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.RProject.Item.Grid',{region:'center',border:false});this.items=[this.grid];return this.callParent(arguments);}});;Ext.define('Account.RProject.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Project Selection',closeAction:'hide',height:250,width:500,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.itemDialog=Ext.create('Account.RProject.Item.Window');this.form=Ext.create('Account.RProject.Form',{region:'center'});this.items=[this.form];this.buttons=[{text:'Report',handler:function(){_this.itemDialog.show();_this.itemDialog.grid.load();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];this.itemDialog.grid.store.on('beforeload',function(store){var formValues=_this.form.getForm().getValues();store.getProxy().extraParams=formValues;});return this.callParent(arguments);}});;Ext.define('Account.RBalanceSheet.MainWindow',{extend:'Ext.window.Window',title:'Report Balance Sheet',closeAction:'hide',width:320,height:220,resizable:false,modal:true,layout:'fit',maximizable:false,initComponent:function(config){var form=Ext.create('Ext.form.Panel',{layout:'form',bodyPadding:'15 15 15 15',fieldDefaults:{labelWidth:50},frame:true,items:[{xtype:'datefield',fieldLabel:'เริ่มต้น',name:'start_date',format:'Y-m-d',allowBlank:false},{xtype:'datefield',fieldLabel:'สิ้นสุด',name:'end_date',format:'Y-m-d',allowBlank:false}],buttons:[{text:'ยืนยัน',handler:function(){form=this.up('form').getForm();if(form.isValid()){rs=form.getValues();start_date=rs.start_date;end_date=rs.end_date;comid=1000;params="start_date="+start_date+"&end_date="+end_date+"&comid="+comid;url=__base_url+'index.php/rbalancesheet/pdf?'+params;Ext.create("Ext.window.Window",{title:"PDF",width:830,height:600,html:"<iframe src='"+url+"' style='width:100%;height:100%'></iframe>"}).show();}}},{text:'ยกเลิก',handler:function(){form=this.up('form').getForm();form.reset();}}]});this.items=[form];this.callParent(arguments);}});;Ext.define('Account.Receipt.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Receipt No, Customer No or Name',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Receipt.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"receipt/loads",reader:{type:'json',root:'rows',idProperty:'recnr'},simpleSortMode:true},fields:['recnr','bldat','duedt','kunnr','name1','txz01','statx','netwr','ctype'],remoteSort:true,sorters:[{property:'recnr',direction:'ASC'}]});this.columns=[{text:"Receipt No",width:100,align:'center',dataIndex:'recnr',sortable:true},{text:"Doc Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Receipt Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'duedt',sortable:true},{text:"Customer No",width:80,align:'center',dataIndex:'kunnr',sortable:true},{text:"Customer Name",width:150,dataIndex:'name1',sortable:true},{text:"Text Note",width:200,dataIndex:'txz01',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Amount",xtype:'numbercolumn',width:80,align:'right',dataIndex:'netwr',sortable:true},{text:"Currency",width:60,align:'center',dataIndex:'ctype',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Receipt.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'receipt/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.customerDialog=Ext.create('Account.SCustomer.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.gridItem=Ext.create('Account.Receipt.Item.Grid_i',{height:320,region:'center'});this.gridGL=Ext.create('Account.Receipt.Item.Grid_gl',{border:true,region:'center',title:'GL Posting'});this.gridPayment=Ext.create('Account.Receipt.Item.Grid_pm',{border:true,region:'center',title:'Receipt'});this.formTotal=Ext.create('Account.Receipt.Item.Form_t',{border:true,split:true,title:'Total->Receipt',region:'south'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('RD'),fieldLabel:'Receipt Status',name:'statu',labelAlign:'right',width:245,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.hdnRcItem=Ext.create('Ext.form.Hidden',{name:'vbbp'});this.hdnPpItem=Ext.create('Ext.form.Hidden',{name:'paym',});this.hdnGlItem=Ext.create('Ext.form.Hidden',{name:'bcus',});this.trigCustomer=Ext.create('Ext.form.field.Trigger',{name:'kunnr',labelAlign:'letf',width:240,fieldLabel:'Customer Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:200,editable:false,labelAlign:'right',allowBlank:false});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnRcItem,this.hdnPpItem,this.hdnGlItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,defaultType:'textfield',layout:'anchor',defaults:{anchor:'100%'},items:[{xtype:'container',layout:'hbox',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',items:[{xtype:'hidden',name:'id'},this.trigCustomer,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:350,allowBlank:true}]},{xtype:'textarea',fieldLabel:'Bill To',name:'adr01',width:400,rows:3,labelAlign:'top'}]},{xtype:'container',layout:'anchor',items:[{xtype:'displayfield',fieldLabel:'Receipt No',name:'recnr',value:'RDXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'},{xtype:'datefield',fieldLabel:'Document Date',name:'bldat',labelAlign:'right',width:245,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false},{xtype:'datefield',fieldLabel:'Receipt Date',name:'duedt',labelAlign:'right',width:245,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false},{xtype:'container',layout:'hbox',margin:'0 0 5 -200',items:[this.trigCurrency,this.comboQStatus]}]}]}]}]};this.items=[mainFormPanel,this.gridItem,{xtype:'tabpanel',region:'south',activeTab:0,height:170,items:[this.formTotal,this.gridPayment,this.gridGL]}];this.trigCustomer.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer.setValue(record.data.kunnr);_this.getForm().findField('name1').setValue(record.data.name1);var _addr=record.data.adr01;if(!Ext.isEmpty(record.data.distx))
_addr+=' '+record.data.distx;if(!Ext.isEmpty(record.data.pstlz))
_addr+=' '+record.data.pstlz;if(!Ext.isEmpty(record.data.telf1))
_addr+='\n'+'Tel: '+record.data.telf1;if(!Ext.isEmpty(record.data.telfx))
_addr+=' '+'Fax: '+record.data.telfx;if(!Ext.isEmpty(record.data.email))
_addr+='\n'+'Email: '+record.data.email;_this.getForm().findField('adr01').setValue(_addr);grid.getSelectionModel().deselectAll();_this.customerDialog.hide();_this.gridItem.setCustomerCode(record.data.kunnr);});this.trigCustomer.onTriggerClick=function(){_this.customerDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);_this.formTotal.getForm().findField('curr').setValue(r.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',r.data.ctype);});_this.gridItem.curValue=r.data.ctype;}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);_this.formTotal.getForm().findField('curr1').setValue(record.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',record.data.ctype);});_this.gridItem.curValue=record.data.ctype;grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.gridPayment.store.on('update',this.loadGL,this);this.gridPayment.store.on('load',this.loadGL,this);this.on('afterLoad',this.loadGL,this);_this.formTotal.getForm().findField('exchg').on('change',this.loadGL,this);return this.callParent(arguments);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'receipt/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);_this.gridItem.setCustomerCode(act.result.data.kunnr);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnRcItem.setValue(Ext.encode(rsItem));var rsPayment=_this.gridPayment.getData();this.hdnPpItem.setValue(Ext.encode(rsPayment));var rsGL=_this.gridGL.getData();this.hdnGlItem.setValue(Ext.encode(rsGL));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'receipt/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({recnr:0});this.gridPayment.load({recnr:0});this.gridGL.load({belnr:0});this.comboQStatus.setValue('01');this.trigCurrency.setValue('THB');this.getForm().findField('bldat').setValue(new Date());this.getForm().findField('duedt').setValue(new Date());this.formTotal.getForm().findField('exchg').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=this.gridItem.store;var sum=0;store.each(function(r){var itamt=parseFloat(r.data['itamt'].replace(/[^0-9.]/g,''));itamt=isNaN(itamt)?0:itamt;var amt=itamt;sum+=amt;});this.formTotal.getForm().findField('beamt').setValue(sum);var currency=this.trigCurrency.getValue();this.gridItem.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);var net=this.formTotal.calculate();this.gridPayment.netValue=net;var storePay=this.gridPayment.store;storePay.each(function(r){r.set('pramt',net);});},loadGL:function(id){var _this=this;var store=this.gridItem.store;var sum=0;var dtype='';var sum2=0;var saknr_list=[];var whts=0;var vats=0;store.each(function(r){var itamt=parseFloat(r.data['itamt'].replace(/[^0-9.]/g,''));itamt=isNaN(itamt)?0:itamt;var amt=itamt;sum+=amt;if(r.data['wht01']>0&&r.data['wht01']!=null){var wht=parseFloat(r.data['wht01'].replace(/[^0-9.]/g,''));whts+=wht;}
if(r.data['vat01']>0&&r.data['vat01']!=null){var vat=parseFloat(r.data['vat01'].replace(/[^0-9.]/g,''));vats+=vat;}
dtype=r.data['dtype'];});var currency=this.trigCurrency.getValue();if(currency!='THB'){var rate=this.formTotal.getForm().findField('exchg').getValue();sum=sum*rate;whts=whts*rate;vats=vats*rate;}
if(sum>0&&this.trigCustomer.getValue()!=''){var payam=0;var r_data=_this.gridPayment.getData();var pay_list=[];for(var i=0;i<r_data.length;i++){payam=r_data[i].payam-r_data[i].wht01;if(r_data[i].ptype=='03'||r_data[i].ptype=='04'){var item=r_data[i].saknr+'|'+payam;}else{var item=r_data[i].ptype+'|'+payam;}
saknr_list.push(item);}
_this.gridGL.load({netpr:sum,vwht:whts,vvat:vats,dtype:dtype,kunnr:this.trigCustomer.getValue(),items:saknr_list.join(',')});}}});;Ext.define('Account.Receipt.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'receipt/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip'}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:155,width:270,readOnly:true});this.txtDiscount=Ext.create('Ext.form.field.Text',{fieldLabel:'Discount',name:'dispc',disabled:true,align:'right',labelWidth:80,width:150,enableKeyEvents:true,validator:function(v){if(!Ext.isEmpty(v)){var regEx=/^([0-9]*)(\.[1-9]*)?$|^([0-9]|[1-9][0-9]|100)(\.[1-9]*)?(%)$/gi;if(regEx.test(v))
return true;else
return'Value can be only numbers or percent';}else
return true;}});this.txtDiscountValue=Ext.create('Ext.form.field.Text',{name:'dismt',disabled:true,align:'right',width:110,margin:'0 0 0 10',readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',disabled:true,align:'right',width:270,labelWidth:155,margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:240,editable:false,hideTrigger:true,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',width:270,labelWidth:155,alwaysDisplayDecimals:true,margin:'4 0 0 0',style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr1'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'}]},{xtype:'container',layout:'anchor',margins:'0 0 0 200',items:[this.txtTotal,{xtype:'container',layout:'hbox',items:[this.txtDiscount,this.txtDiscountValue]},this.txtDiscountSum,{xtype:'container',layout:'hbox',defaultType:'textfield',items:[this.txtInterest]},this.txtNet]}]}];var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtDiscount.on('keyup',this.calculate,this);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'depositin/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'invoice/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},calculate:function(){var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discount=this.txtDiscount.getValue(),discountValue=0;if(this.txtDiscount.isValid()&&!Ext.isEmpty(discount)){if(discount.match(/%$/gi)){discount=discount.replace('%','');var discountPercent=parseFloat(discount);discountValue=total*discountPercent/100;}else{discountValue=parseFloat(discount);}
discountValue=isNaN(discountValue)?0:discountValue;this.txtDiscountValue.setValue(Ext.util.Format.usMoney(discountValue).replace(/\$/,''));if(discountValue>0)
this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscount.setValue('');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var net=total;this.txtNet.setValue(net);return net;}});;Ext.define('Account.Receipt.Item.Grid_gl',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.glDialog=Ext.create('Account.GL.MainWindow');this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"receipt/loads_gl_item",reader:{type:'json',root:'rows',idProperty:'belnr,belpr'}},fields:['belnr','belpr','saknr','sgtxt','debit','credi','txz01','statu'],remoteSort:true,sorters:['belpr ASC']});this.columns=[{id:'RowNumber20',text:"No.",dataIndex:'belpr',width:50,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"GL No.",width:100,dataIndex:'saknr',align:'center',sortable:false,},{text:"GL Description",width:215,dataIndex:'sgtxt',sortable:true},{text:"Debit",width:100,dataIndex:'debit',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,},{text:"Credit",width:100,dataIndex:'credi',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2,},{text:"Comment",width:250,dataIndex:'txz01',sortable:true,field:{type:'textfield'}}];this.plugins=[this.editing];this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='saknr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.saknr);rModel.set('sgtxt',r.data.sgtxt);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.glDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('saknr',record.data.saknr);rModel.set('sgtxt',record.data.sgtxt);}
grid.getSelectionModel().deselectAll();_this.glDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addDefaultRecord:function(){this.store.removeAll();var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;for(var i=0;i<5;i++){rec={id:i};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();}},addRecord2:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();},removeRecord2:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow2();},runNumRow2:function(){var row_num=0;this.store.each(function(r){r.set('belpr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.Receipt.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.invoiceDialog=Ext.create('Account.SInvoice.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"receipt/loads_rc_item",reader:{type:'json',root:'rows',idProperty:'recnr,vbelp'}},fields:['recnr','vbelp','invnr','refnr','invdt','texts',{name:'itamt',type:'string'},'jobtx','belnr','ctype','wht01','vat01','dtype','loekz'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Receipt Item',scope:this,handler:this.removeRecord}]},{xtype:'hidden',name:'loekz'},{id:'RowNumber5',header:"No.",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Invoice No",width:100,dataIndex:'invnr',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.invoiceDialog.show();}}},{text:"Project Description",width:150,dataIndex:'jobtx',sortable:false,field:{type:'textfield'}},{text:"Ref.No",width:120,dataIndex:'refnr',sortable:false,field:{type:'textfield'}},{text:"Invoice Date",width:80,xtype:'datecolumn',dataIndex:'invdt',sortable:false,renderer:Ext.util.Format.dateRenderer('m/d/Y')},{text:"Text Note",width:180,dataIndex:'texts',sortable:false,field:{type:'textfield'},},{text:"Invoice Amt",xtype:'numbercolumn',width:120,dataIndex:'itamt',sortable:false,align:'right',readOnly:true},{text:"Currency",width:55,dataIndex:'ctype',sortable:false,align:'center',field:{type:'textfield'},},{dataIndex:'wht01',hidden:true,sortable:false},{dataIndex:'vat01',hidden:true,sortable:false},{dataIndex:'dtype',hidden:true,sortable:false}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='invnr'){var v=e.value;var v_url='invoice/load';var v_str=v.substring(0,1);if(v_str=='D'){v_url='depositin/load';}
if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+v_url,method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.invnr);rModel.set('refnr',r.data.refnr);rModel.set('invdt',r.data.bldat);rModel.set('jobtx',r.data.jobtx);rModel.set('texts',r.data.txz01);rModel.set('itamt',r.data.netwr);rModel.set('ctype',r.data.ctype);rModel.set('wht01',r.data.wht01);rModel.set('vat01',r.data.vat01);rModel.set('loekz',r.data.loekz);var dtype=r.data.invnr.substring(0,2);rModel.set('dtype',dtype[0]);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.invoiceDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('invnr',record.data.invnr);rModel.set('refnr',record.data.refnr);rModel.set('invdt',record.data.bldat);rModel.set('texts',record.data.txz01);rModel.set('jobtx',record.data.jobtx);rModel.set('itamt',record.data.netwr);rModel.set('wht01',record.data.wht01);rModel.set('vat01',record.data.vat01);rModel.set('loekz',record.data.loekz);var dtype=record.data.invnr.substring(0,2);rModel.set('dtype',dtype[0]);}
grid.getSelectionModel().deselectAll();_this.invoiceDialog.hide();});this.store.on('load',function(store,rs){if(_this.readOnly){var view=_this.getView();var t=_this.getView().getEl().down('table');t.addCls('mask-grid-readonly');_this.readOnlyMask=new Ext.LoadMask(t,{msg:"..."});_this.readOnlyMask.show();}else{if(_this.readOnlyMask)
_this.readOnlyMask.hide();}});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var _this=this;var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec={id:newId,invnr:'',ctype:cur};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},setCustomerCode:function(kunnr){this.customerCode=kunnr;var field=this.invoiceDialog.searchForm.form.findField('kunnr');field.setValue(kunnr);this.invoiceDialog.grid.load();}});;Ext.define('Account.Receipt.Item.Grid_pm',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.bankDialog=Ext.create('Account.Bankname.MainWindow');this.tbar=[this.addAct,this.copyAct];this.ptypeStore=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'receipt/loads_pcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'});this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"receipt/loads_pm_item",reader:{type:'json',root:'rows',idProperty:'recnr,paypr'}},fields:['recnr','paypr','ptype','bcode','bname','sgtxt','chqid','chqdt',{name:'pramt',type:'string'},'payam','reman','saknr','wht01'],remoteSort:true,sorters:['paypr ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Payment',scope:this,handler:this.removeRecord2}]},{id:'RowNumber6',header:"No.",dataIndex:'paypr',width:50,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Payment",width:100,dataIndex:'ptype',sortable:false,editor:new Ext.form.field.ComboBox({store:this.ptypeStore,queryMode:'remote',displayField:'paytx',valueField:'ptype'}),renderer:function(value){if(!isNaN(value)){if(_this.ptypeStore.findRecord('ptype',value)!=null)
return _this.ptypeStore.findRecord('ptype',value).get('paytx');else
return value;}else if(typeof value!='undefined'){if(value.paytx!=null)
return value.paytx;else
return"";}else
return"";}},{text:"Bank Code",align:'center',width:80,dataIndex:'bcode',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.bankDialog.show();}},},{text:"Bank Name",width:120,dataIndex:'bname',sortable:false,field:{type:'textfield'},},{text:"Branch",width:100,dataIndex:'sgtxt',sortable:false,field:{type:'textfield'},},{text:"Cheque No",align:'center',width:80,dataIndex:'chqid',sortable:false,field:{type:'textfield'},},{text:"Cheque Dat",align:'center',xtype:'datecolumn',width:80,dataIndex:'chqdt',sortable:false,format:'d/m/Y',editor:{xtype:'datefield',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},renderer:function(value){if(!isNaN(value)){return Ext.Date.format(value,'d/m/Y');}else{return"";}}},{text:"Amount",xtype:'numbercolumn',align:'right',width:100,dataIndex:'pramt',sortable:false},{text:"Pay Amt",xtype:'numbercolumn',align:'right',width:100,dataIndex:'payam',sortable:false,field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Remain Amt",xtype:'numbercolumn',align:'right',width:100,dataIndex:'reman',sortable:false,readOnly:true,renderer:function(v,p,r){var pamt=parseFloat(r.data['pramt'].replace(/[^0-9.]/g,''));var pay=parseFloat(r.data['payam'].replace(/[^0-9.]/g,''));pamt=isNaN(pamt)?0:pamt;pay=isNaN(pay)?0:pay;var amt=pamt-pay;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{dataIndex:'saknr',hidden:true,sortable:false},{dataIndex:'wht01',hidden:true,sortable:false},{dataIndex:'vat01',hidden:true,sortable:false},{dataIndex:'dtype',hidden:true,sortable:false}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord2();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='bcode'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'bankname/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.bcode);rModel.set('bname',r.data.bname);rModel.set('saknr',r.data.saknr);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.bankDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('bcode',record.data.bcode);rModel.set('bname',record.data.bname);rModel.set('saknr',record.data.saknr);}
grid.getSelectionModel().deselectAll();_this.bankDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord2:function(){var _this=this;var net=_this.netValue;var newId=-1;var wht=0;var vat=0;var dtype='';this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var i=parseFloat(sel.get('payam'));net=net-i;wht=parseFloat(sel.get('wht01'));vat=parseFloat(sel.get('vat01'));dtype=parseFloat(sel.get('dtype'));}
rec={id:newId,pramt:net,wht01:wht,vat01:vat,dtype:dtype};edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();},removeRecord2:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow2();},runNumRow2:function(){var row_num=0;this.store.each(function(r){r.set('paypr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},});;Ext.define('Account.Receipt.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'Receipt preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/receipt/index/'+id+'/'+copies;}});;Ext.define('Account.Receipt.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Receipt',closeAction:'hide',height:650,width:950,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Receipt.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.Receipt.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.btnSave=Ext.create('Ext.Button',{text:'Save',disabled:!(UMS.CAN.CREATE('RD')||UMS.CAN.EDIT('RD')||UMS.CAN.APPROVE('RD')),handler:function(){_this.form.save();}});this.buttons=[this.btnSave,{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({recnr:id});this.form.gridPayment.load({recnr:id});this.form.gridGL.load({belnr:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}},setReadOnly:function(readOnly){var children=this.items?this.items.items:[];for(var i=0;i<children.length;i++){var child=children[i];child.query('.field').forEach(function(c){if(!c.initialConfig.readOnly){c.setReadOnly(readOnly);}});child.query('.button').forEach(function(c){if(c.xtype!='tab'){if(!c.initialConfig.disabled)
c.setDisabled(readOnly);}});}
this.form.gridItem.readOnly=readOnly;if(!this.btnSave.initialConfig.disabled)
this.btnSave.setDisabled(readOnly);}});;Ext.define('Account.Receipt.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Receipt',closeAction:'hide',height:600,minHeight:380,width:950,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;var fibasic=Ext.create('Ext.form.field.File',{width:200,x:50,y:50,hideLabel:true});this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('RD')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('RD')||UMS.CAN.CREATE('RD')||UMS.CAN.EDIT('RD'))});this.displayAct=new Ext.Action({text:'Display',iconCls:'b-small-search',disabled:!UMS.CAN.DISPLAY('RD')});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('RD')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('RD')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.Receipt.Item.Window');this.grid=Ext.create('Account.Receipt.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.displayAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.Receipt.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(false);}});this.displayAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(true);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save Receipt number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/receipt/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.RGeneralJournal.MainWindow',{extend:'Ext.window.Window',title:'Report General Journal',closeAction:'hide',width:420,height:220,resizable:false,modal:true,layout:'fit',maximizable:false,initComponent:function(config){var form=Ext.create('Ext.form.Panel',{layout:'form',bodyPadding:'15 15 15 15',fieldDefaults:{labelWidth:150},frame:true,items:[{xtype:'datefield',fieldLabel:'เริ่มต้น',name:'start_date',format:'Y-m-d',allowBlank:false},{xtype:'datefield',fieldLabel:'สิ้นสุด',name:'end_date',format:'Y-m-d',allowBlank:false},{xtype:'textfield',name:'kunnr',fieldLabel:'Customer / Supplier Code',}],buttons:[{text:'ยืนยัน',handler:function(){form=this.up('form').getForm();if(form.isValid()){var result=Ext.create("Account.RGeneralJournal.Result.Grid");result.loadMask.show();Ext.Ajax.request({url:__base_url+"index.php/rgeneraljournal/result",params:form.getValues(),success:function(response){var rs=response.responseText;rs=Ext.JSON.decode(rs);if(rs.success){result.params=form.getValues();result.storeGrid.loadData(rs.datas);result.show();result.loadMask.hide();}}});}}},{text:'ยกเลิก',handler:function(){form=this.up('form').getForm();form.reset();}}]});this.items=[form];return this.callParent(arguments);}});;Ext.define('Account.RGeneralJournal.Result.Grid',{extend:'Ext.window.Window',requires:['Ext.ux.grid.FiltersFeature','Ext.ux.DataTip'],title:'Report General Journal',closeAction:'hide',width:780,height:500,resizable:false,modal:true,layout:'fit',maximizable:true,maximized:true,params:{},loadMask:null,initComponent:function(config){this.loadMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."});var me=this;var filters={ftype:'filters',encode:false,local:true,filters:[{type:'boolean',dataIndex:'visible'}]};this.storeGrid=Ext.create('Ext.data.ArrayStore',{model:'RGeneralJournal',fields:[{name:'bldat',type:'date',dateFormat:'Y-m-d'},{name:'belnr'},{name:'invnr'},{name:'name1'},{name:'saknr'},{name:'sgtxt'},{name:'debit',type:'float'},{name:'credi',type:'float'},{name:'statu'},{name:'kunnr'}],data:[],groupers:['bldat','belnr']});this.columnsGrid=[{text:'SV Date',sortable:false,dataIndex:'bldat',renderer:Ext.util.Format.dateRenderer('d/m/Y')},{text:'SV Number',sortable:false,dataIndex:'belnr',filterable:true,filter:{type:'string'}},{text:'Ref. Doc. No.',sortable:false,dataIndex:'invnr'},{text:'Customer',sortable:false,dataIndex:'name1'},{text:'Account Code',sortable:false,dataIndex:'saknr'},{text:'Account Name',sortable:false,dataIndex:'sgtxt'},{text:'Debit',sortable:false,dataIndex:'debit',renderer:Ext.util.Format.numberRenderer('0,000.00'),summaryType:function(records){var i=0,length=records.length,total=0,record;for(i=0;i<length;++i){record=records[i];total+=Number(record.get('debit'));}
return total;},summaryRenderer:function(value,summaryData,index){return'<b>'+Ext.util.Format.number(value,'0,000.00')+'</b>';}},{text:'Credit',sortable:false,dataIndex:'credi',renderer:Ext.util.Format.numberRenderer('0,000.00'),summaryType:function(records){var i=0,length=records.length,total=0,record;for(i=0;i<length;++i){record=records[i];total+=Number(record.get('credi'));}
return total;},summaryRenderer:function(value,summaryData,index){return'<b>'+Ext.util.Format.number(value,'0,000.00')+'</b>';}},{text:'Status',sortable:false,dataIndex:'statu'}];this.grid=Ext.create('Ext.grid.Panel',{store:this.storeGrid,columns:this.columnsGrid,forceFit:true,features:[Ext.create('Ext.ux.grid.feature.MultiGroupingSummary',{id:'group',hideGroupedHeader:false,enableGroupingMenu:true,startCollapsed:true}),{ftype:'summary',dock:'bottom'},filters]});this.items=[this.grid];this.tbar=[{text:"Print",handler:function(){start_date=me.params.start_date;end_date=me.params.end_date;kunnr=me.params.kunnr;comid=1000;params="start_date="+start_date+"&end_date="+end_date+"&kunnr="+kunnr+"&comid="+comid;url=__base_url+'index.php/rgeneraljournal/pdf?'+params;Ext.create("Ext.window.Window",{title:"PDF",width:830,height:600,html:"<iframe src='"+url+"' style='width:100%;height:100%'></iframe>"}).show();}}];return this.callParent(arguments);}});;Ext.define('Account.RGeneralLedger.MainWindow',{extend:'Ext.window.Window',title:'Report General Ledger',closeAction:'hide',width:320,height:220,resizable:false,modal:true,layout:'fit',maximizable:false,loadMask:null,initComponent:function(config){var _this=this;this.loadMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."}),this.glnoDialog1=Ext.create('Account.GL.MainWindow');this.trigGlno1=Ext.create('Ext.form.field.Trigger',{name:'start_saknr',fieldLabel:'Start GL',triggerCls:'x-form-search-trigger',enableKeyEvents:true,});this.trigGlno1.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.saknr);_this.getForm().findField('sgtxt').setValue(record.data.sgtxt);}else{o.markInvalid('Could not find GL Account : '+o.getValue());}}});}},this);_this.glnoDialog1.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigGlno1.setValue(record.data.saknr);grid.getSelectionModel().deselectAll();_this.glnoDialog1.hide();});this.trigGlno1.onTriggerClick=function(){_this.glnoDialog1.show();};this.glnoDialog2=Ext.create('Account.GL.MainWindow');this.trigGlno2=Ext.create('Ext.form.field.Trigger',{name:'end_saknr',fieldLabel:'End GL',triggerCls:'x-form-search-trigger',enableKeyEvents:true,});this.trigGlno2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.saknr);_this.getForm().findField('sgtxt').setValue(record.data.sgtxt);}else{o.markInvalid('Could not find GL Account : '+o.getValue());}}});}},this);_this.glnoDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigGlno2.setValue(record.data.saknr);grid.getSelectionModel().deselectAll();_this.glnoDialog2.hide();});this.trigGlno2.onTriggerClick=function(){_this.glnoDialog2.show();};var form=Ext.create('Ext.form.Panel',{layout:'form',bodyPadding:'15 15 15 15',fieldDefaults:{labelWidth:50},frame:true,items:[{xtype:'datefield',fieldLabel:'เริ่มต้น',name:'start_date',format:'Y-m-d',allowBlank:false},{xtype:'datefield',fieldLabel:'สิ้นสุด',name:'end_date',format:'Y-m-d',allowBlank:false},this.trigGlno1,this.trigGlno2],buttons:[{text:'ยืนยัน',handler:function(){form=this.up('form').getForm();_this.loadMask.show();if(form.isValid()){Ext.Ajax.request({url:__base_url+"index.php/rgeneralledger/result",params:form.getValues(),success:function(response){var rs=response.responseText;rs=Ext.JSON.decode(rs);if(rs.success){var result=Ext.create("Account.RGeneralLedger.Result.Grid");result.params=form.getValues();result.storeGrid.loadData(rs.datas);result.show();}
_this.loadMask.hide();}});}}},{text:'ยกเลิก',handler:function(){form=this.up('form').getForm();form.reset();}}]});this.items=[form];return this.callParent(arguments);}});;Ext.define('RGeneralLedger',{extend:'Ext.data.Model',fields:['bldat','belnr','kunnr','name1','txz01','debit','credi','statu','saknr','sgtxt','balance']});Ext.define('Account.RGeneralLedger.Result.Grid',{extend:'Ext.window.Window',requires:['Ext.ux.grid.FiltersFeature','Ext.ux.DataTip'],title:'Report General Ledger',closeAction:'hide',width:780,height:500,resizable:false,modal:true,layout:'fit',maximizable:true,maximized:true,params:{},initComponent:function(config){me=this;var filters={ftype:'filters',encode:false,local:true,filters:[{type:'string',dataIndex:'saknr'}]};this.storeGrid=Ext.create('Ext.data.ArrayStore',{model:'RGeneralLedger',fields:[{name:'bldat',type:'date',dateFormat:'Y-m-d'},{name:'belnr'},{name:'invnr'},{name:'name1'},{name:'saknr'},{name:'sgtxt'},{name:'debit',type:'float'},{name:'credi',type:'float'},{name:'statu'},{name:'kunnr'},{name:'txz01'},{name:'balance',type:'float'}],data:[],groupers:['saknr']});this.columnsGrid=[{text:'Account Code',sortable:false,dataIndex:'saknr'},{text:'Account Name',sortable:false,dataIndex:'sgtxt'},{text:'Date',sortable:false,dataIndex:'bldat',renderer:Ext.util.Format.dateRenderer('d/m/Y')},{text:'Document Number',sortable:false,dataIndex:'belnr'},{text:'Customer/ Supplier Code',sortable:false,dataIndex:'kunnr'},{text:'Customer/ Supplier Name',sortable:false,dataIndex:'name1'},{text:'Description',sortable:false,dataIndex:'txz01'},{text:'Debit',sortable:false,dataIndex:'debit',renderer:Ext.util.Format.numberRenderer('0,000.00'),summaryType:function(records){var i=0,length=records.length,total=0,record;for(i=0;i<length;++i){record=records[i];total+=Number(record.get('debit'));}
return total;},summaryRenderer:function(value,summaryData,index){return'<b>'+Ext.util.Format.number(value,'0,000.00')+'</b>';}},{text:'Credit',sortable:false,dataIndex:'credi',renderer:Ext.util.Format.numberRenderer('0,000.00'),summaryType:function(records){var i=0,length=records.length,total=0,record;for(i=0;i<length;++i){record=records[i];total+=Number(record.get('credi'));}
return total;},summaryRenderer:function(value,summaryData,index){return'<b>'+Ext.util.Format.number(value,'0,000.00')+'</b>';}},{text:'Balance',sortable:false,dataIndex:'balance',renderer:Ext.util.Format.numberRenderer('0,000.00'),summaryType:function(records){var i=0,length=records.length,total=0,record;for(i=0;i<length;++i){record=records[i];total+=Number(record.get('balance'));}
return total;},summaryRenderer:function(value,summaryData,index){return'<b>'+Ext.util.Format.number(value,'0,000.00')+'</b>';}},{text:'Status',sortable:false,dataIndex:'statu'},];this.grid=Ext.create('Ext.grid.Panel',{store:this.storeGrid,columns:this.columnsGrid,forceFit:true,features:[Ext.create('Ext.ux.grid.feature.MultiGroupingSummary',{id:'group',hideGroupedHeader:false,enableGroupingMenu:true,startCollapsed:true}),{ftype:'summary',dock:'bottom'},filters]});this.items=[this.grid];this.tbar=[{text:"Excel",iconCls:'b-small-excel',handler:function(){start_date=me.params.start_date;end_date=me.params.end_date;start_saknr=me.params.start_saknr;end_saknr=me.params.end_saknr;params="start_date="+start_date+"&end_date="+end_date;params=params+"&start_saknr="+start_saknr+"&end_saknr="+end_saknr;window.location=__base_url+'index.php/rgeneralledger/excel?'+params;}}];return this.callParent(arguments);}});;Ext.define('Account.RGL.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.glDialog=Ext.create('Account.GL.MainWindow');this.glDialog2=Ext.create('Account.GL.MainWindow');this.trigGL=Ext.create('Ext.form.field.Trigger',{name:'saknr',labelWidth:100,fieldLabel:'GL No',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigGL2=Ext.create('Ext.form.field.Trigger',{name:'saknr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.comboType=Ext.create('Ext.form.ComboBox',{fieldLabel:'Journal Type',name:'ttype',labelAlign:'letf',labelWidth:100,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Type --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'journal/loads_jtypecombo',reader:{type:'json',root:'rows',idProperty:'ttype'}},fields:['ttype','typtx'],remoteSort:true,sorters:'ttype ASC'}),listeners:{select:function(combo,record,index){var value=combo.getValue();}},queryMode:'remote',displayField:'typtx',valueField:'ttype'});this.comboType2=Ext.create('Ext.form.ComboBox',{name:'ttype2',labelAlign:'letf',labelWidth:100,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Type --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'journal/loads_jtypecombo',reader:{type:'json',root:'rows',idProperty:'ttype'}},fields:['ttype','typtx'],remoteSort:true,sorters:'ttype ASC'}),listeners:{select:function(combo,record,index){var value=combo.getValue();}},queryMode:'remote',displayField:'typtx',valueField:'ttype'});this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Doc Date',labelWidth:100,name:'bldat1',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},{xtype:'datefield',name:'bldat2',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboType,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.comboType2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigGL,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigGL2]}];this.trigGL.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.saknr);}else{o.markInvalid('Could not find gl code : '+o.getValue());}}});}},this);_this.glDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigGL.setValue(record.data.saknr);grid.getSelectionModel().deselectAll();_this.glDialog.hide();});this.trigGL.onTriggerClick=function(){_this.glDialog.show();};this.trigGL2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.saknr);}else{o.markInvalid('Could not find gl code : '+o.getValue());}}});}},this);_this.glDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigGL2.setValue(record.data.saknr);grid.getSelectionModel().deselectAll();_this.glDialog2.hide();});this.trigGL2.onTriggerClick=function(){_this.glDialog2.show();};return this.callParent(arguments);},});;Ext.define('Account.RGL.Item.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"gl/rloads",reader:{type:'json',root:'rows',idProperty:'saknr'}},fields:['saknr','sgtxt','deb1','cre1'],remoteSort:true,sorters:['saknr ASC']});this.columns=[{text:"GL No",width:100,align:'center',dataIndex:'saknr',sortable:true},{text:"GL Name",width:180,dataIndex:'sgtxt',sortable:true},{text:"Debit",width:80,align:'right',dataIndex:'deb1',sortable:true},{text:"Credit",width:100,align:'right',dataIndex:'cre1',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options});},reset:function(){this.load({saknr:0});}});;Ext.define('Account.RGL.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'General Ledger Report',closeAction:'hide',height:700,minHeight:380,width:500,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.RGL.Item.Grid',{region:'center',border:false});this.items=[this.grid];return this.callParent(arguments);}});;Ext.define('Account.RGL.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'General Ledger Selection',closeAction:'hide',height:180,width:500,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.itemDialog=Ext.create('Account.RGL.Item.Window');this.form=Ext.create('Account.RGL.Form',{region:'center'});this.items=[this.form];this.buttons=[{text:'Report',handler:function(){_this.itemDialog.grid.reset();_this.itemDialog.show();_this.itemDialog.grid.load();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];this.itemDialog.grid.store.on('beforeload',function(store){var formValues=_this.form.getForm().getValues();store.getProxy().extraParams=formValues;});return this.callParent(arguments);}});;Ext.define('Account.RGR.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.comboGRStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'GR Status',name:'statu',editable:false,triggerAction:'all',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'gr/loads_combo/apov/statu/statx',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboGRStatus2=Ext.create('Ext.form.ComboBox',{name:'statu2',editable:false,triggerAction:'all',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'gr/loads_combo/apov/statu/statx',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.poDialog=Ext.create('Account.PO.MainWindow');this.poDialog2=Ext.create('Account.PO.MainWindow');this.grDialog=Ext.create('Account.GR.MainWindow');this.grDialog2=Ext.create('Account.GR.MainWindow');this.vendorDialog=Ext.create('Account.Vendor.MainWindow');this.vendorDialog2=Ext.create('Account.Vendor.MainWindow');this.trigPO=Ext.create('Ext.form.field.Trigger',{name:'ebeln',fieldLabel:'PO Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigPO2=Ext.create('Ext.form.field.Trigger',{name:'ebeln2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigGR=Ext.create('Ext.form.field.Trigger',{name:'mbeln',fieldLabel:'GR Doc',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigGR2=Ext.create('Ext.form.field.Trigger',{name:'mbeln2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigVendor=Ext.create('Ext.form.field.Trigger',{name:'lifnr',fieldLabel:'Vendor Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigVendor2=Ext.create('Ext.form.field.Trigger',{name:'lifnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigPO.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'po/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ebeln);}else{o.markInvalid('Could not find purchase order code : '+o.getValue());}}});}},this);_this.poDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigPO.setValue(record.data.ebeln);grid.getSelectionModel().deselectAll();_this.poDialog.hide();});this.trigPO.onTriggerClick=function(){_this.poDialog.show();};this.trigPO2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'po/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ebeln);}else{o.markInvalid('Could not find purchase order code : '+o.getValue());}}});}},this);_this.poDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigPO2.setValue(record.data.ebeln);grid.getSelectionModel().deselectAll();_this.poDialog2.hide();});this.trigPO2.onTriggerClick=function(){_this.poDialog2.show();};this.trigGR.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'gr/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.mbeln);}else{o.markInvalid('Could not find Goods Receipts Doc : '+o.getValue());}}});}},this);_this.grDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigGR.setValue(record.data.mbeln);grid.getSelectionModel().deselectAll();_this.grDialog.hide();});this.trigGR.onTriggerClick=function(){_this.grDialog.show();};this.trigGR2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'gr/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.mbeln);}else{o.markInvalid('Could not find Goods Receipts Doc : '+o.getValue());}}});}},this);_this.grDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigGR2.setValue(record.data.mbeln);grid.getSelectionModel().deselectAll();_this.grDialog2.hide();});this.trigGR2.onTriggerClick=function(){_this.grDialog2.show();};this.trigVendor.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.lifnr);}else{o.markInvalid('Could not find vendor code : '+o.getValue());}}});}},this);_this.vendorDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor.setValue(record.data.lifnr);grid.getSelectionModel().deselectAll();_this.vendorDialog.hide();});this.trigVendor.onTriggerClick=function(){_this.vendorDialog.show();};this.trigVendor2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.lifnr);}else{o.markInvalid('Could not find vendor code : '+o.getValue());}}});}},this);_this.vendorDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor2.setValue(record.data.lifnr);grid.getSelectionModel().deselectAll();_this.vendorDialog2.hide();});this.trigVendor2.onTriggerClick=function(){_this.vendorDialog2.show();};this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Date',name:'bldat1',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},{xtype:'datefield',name:'bldat2',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigGR,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigGR2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigPO,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigPO2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},this.trigVendor,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigVendor2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboGRStatus,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.comboGRStatus2]}];return this.callParent(arguments);},});;Ext.define('Account.RGR.Item.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"gr/loads",reader:{type:'json',root:'rows',idProperty:'mbeln'}},fields:['mbeln','bldat','lifnr','name1','netwr','statx'],remoteSort:true,sorters:['mbeln ASC']});this.columns=[{text:"GR No",flex:true,dataIndex:'mbeln',sortable:true},{text:"GR Date",width:125,dataIndex:'bldat',sortable:true},{text:"Vendor Code",flex:true,dataIndex:'lifnr',sortable:true},{text:"Vendor Name",flex:true,dataIndex:'name1',sortable:true},{text:"Net Amount",flex:true,dataIndex:'netwr',sortable:true},{text:"GR Status",flex:true,dataIndex:'statx',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.RGR.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Goods Receipts Report',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.RGR.Item.Grid',{region:'center',border:false});this.items=[this.grid];return this.callParent(arguments);}});;Ext.define('Account.RGR.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Goods Receipts Selection',closeAction:'hide',height:250,width:500,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.itemDialog=Ext.create('Account.RGR.Item.Window');this.form=Ext.create('Account.RGR.Form',{region:'center'});this.items=[this.form];this.buttons=[{text:'Report',handler:function(){_this.itemDialog.show();_this.itemDialog.grid.load();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];this.itemDialog.grid.store.on('beforeload',function(store){var formValues=_this.form.getForm().getValues();store.getProxy().extraParams=formValues;});return this.callParent(arguments);}});;Ext.define('Account.RIncome.Item.PreviewWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Income Statement preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.items=[new Ext.Panel({region:'center',border:true,items:[{xtype:'component',id:'preview_frame',autoEl:{tag:'iframe',src:'about:blank',frameBorder:0,width:'100%',height:'100%',style:{overflow:'auto'}}}]})];this.on('hide',function(){Ext.get('preview_frame').set({src:'about:blank'});});return this.callParent(arguments);},dialogId:null,openDialog:function(url){var _this=this;if(url){this.show(false,function(){Ext.get('preview_frame').set({src:url});_this.showFrameLoad();_this.checkFrameReady(function(){_this.hideFrameLoad();});});}},checkFrameReady:function(cb){document.getElementById('preview_frame').onload=cb;},showFrameLoad:function(){Ext.MessageBox.show({msg:'Populating preview...',progressText:'Loading...',width:300,wait:true,waitConfig:{interval:200},animateTarget:this});},hideFrameLoad:function(){Ext.MessageBox.hide();}});;Ext.define('Account.RIncome.MainWindow',{extend:'Ext.window.Window',title:'Report Income Statement',closeAction:'hide',width:320,height:150,resizable:false,modal:true,layout:'fit',maximizable:false,initComponent:function(config){var _this=this;this.previewDialog=Ext.create('Account.RIncome.Item.PreviewWindow');var years=[],nowYear=parseInt(Ext.Date.format(new Date(),'Y'));for(var i=nowYear;i>=nowYear-2;i--){years.push([i,i]);}
var form=Ext.create('Ext.form.Panel',{layout:'form',bodyPadding:'15 15 15 15',fieldDefaults:{labelWidth:50},frame:true,items:[{xtype:'combo',fieldLabel:'Period',name:'year',editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'Please select',field:['value','year'],store:years,valueField:'value',displayField:'text'}],buttons:[{text:'ยืนยัน',handler:function(){start_date1=form.form.findField('year').getValue()+"-01-01";end_date1=form.form.findField('year').getValue()+"-12-31";start_date2=parseInt(form.form.findField('year').getValue())-1+"-01-01";end_date2=parseInt(form.form.findField('year').getValue())-1+"-12-31";params="start_date1="+start_date1+"&end_date1="+end_date1+"&start_date2="+start_date2+"&end_date2="+end_date2;_this.previewDialog.openDialog(__base_url+'index.php/rincome/pdf?'+params,'_blank');}},{text:'ยกเลิก',handler:function(){form=this.up('form').getForm();form.reset();}}]});this.items=[form];this.callParent(arguments);}});;Ext.define('Account.RInvoice.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.invoiceDialog=Ext.create('Account.Invoice.MainWindow');this.saleorderDialog=Ext.create('Account.Saleorder.MainWindow');this.customerDialog=Ext.create('Account.Customer.MainWindow');this.invoiceDialog2=Ext.create('Account.Invoice.MainWindow');this.saleorderDialog2=Ext.create('Account.Saleorder.MainWindow');this.customerDialog2=Ext.create('Account.Customer.MainWindow');this.dateDoc1=Ext.create('Ext.form.field.Date',{fieldLabel:'Document Date',name:'bldat',labelWidth:100,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'});this.dateDoc2=Ext.create('Ext.form.field.Date',{name:'bldat2',labelWidth:100,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'Invoice Status',name:'statu',labelWidth:100,editable:false,triggerAction:'all',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'invoice/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.trigInvoice=Ext.create('Ext.form.field.Trigger',{name:'invnr',labelWidth:100,fieldLabel:'Invoice No',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigInvoice2=Ext.create('Ext.form.field.Trigger',{name:'invnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigSaleorder=Ext.create('Ext.form.field.Trigger',{name:'ordnr',labelWidth:100,fieldLabel:'So No',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigSaleorder2=Ext.create('Ext.form.field.Trigger',{name:'ordnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigCustomer=Ext.create('Ext.form.field.Trigger',{name:'kunnr',fieldLabel:'Customer Code',triggerCls:'x-form-search-trigger',labelWidth:100,enableKeyEvents:true});this.trigCustomer2=Ext.create('Ext.form.field.Trigger',{name:'kunnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.dateDoc1,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.dateDoc2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigInvoice,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigInvoice2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigSaleorder,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigSaleorder2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},this.trigCustomer,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigCustomer2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboQStatus,{}]}];this.trigInvoice.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.invnr);}else{o.markInvalid('Could not find invoice code : '+o.getValue());}}});}},this);this.trigInvoice2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.invnr);}else{o.markInvalid('Could not find invoice code : '+o.getValue());}}});}},this);_this.invoiceDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigInvoice.setValue(record.data.invnr);grid.getSelectionModel().deselectAll();_this.invoiceDialog.hide();});_this.invoiceDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigInvoice2.setValue(record.data.invnr);grid.getSelectionModel().deselectAll();_this.invoiceDialog2.hide();});this.trigInvoice.onTriggerClick=function(){_this.invoiceDialog.show();};this.trigInvoice2.onTriggerClick=function(){_this.invoiceDialog2.show();};this.trigSaleorder.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'saleorder/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.vbeln);}else{o.markInvalid('Could not find Saleorder code : '+o.getValue());}}});}},this);this.trigSaleorder2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'saleorder/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.vbeln);}else{o.markInvalid('Could not find Saleorder code : '+o.getValue());}}});}},this);_this.saleorderDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigSaleorder.setValue(record.data.vbeln);grid.getSelectionModel().deselectAll();_this.saleorderDialog.hide();});_this.saleorderDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigSaleorder2.setValue(record.data.vbeln);grid.getSelectionModel().deselectAll();_this.saleorderDialog2.hide();});this.trigSaleorder.onTriggerClick=function(){_this.saleorderDialog.show();};this.trigSaleorder2.onTriggerClick=function(){_this.saleorderDialog2.show();};this.trigCustomer.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer.setValue(record.data.kunnr);grid.getSelectionModel().deselectAll();_this.customerDialog.hide();});this.trigCustomer.onTriggerClick=function(){_this.customerDialog.show();};this.trigCustomer2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer2.setValue(record.data.kunnr);grid.getSelectionModel().deselectAll();_this.customerDialog2.hide();});this.trigCustomer2.onTriggerClick=function(){_this.customerDialog2.show();};return this.callParent(arguments);},});;Ext.define('Account.RInvoice.Item.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},requires:['Ext.grid.feature.Grouping'],features:[{id:'group',ftype:'groupingsummary',groupHeaderTpl:'{name}',hideGroupedHeader:true,enableGroupingMenu:false,startCollapsed:true}],initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"invoice/loads_report",reader:{type:'json',root:'rows',idProperty:function(o){return o.invnr+o.vbelp;}},simpleSortMode:true},fields:['invnr','bldat','jobnr','ordnr','vbeln','kunnr','name1','terms','duedt','overd','statx','matnr','maktx','menge','unitp','beamt','vat01','netwr'],remoteSort:true,sorters:[{property:'invnr',direction:'ASC'}],groupField:'invnr'});this.columns=[{text:"Invoice No.",width:80,align:'center',dataIndex:'invnr',sortable:true},{text:"Invoice Date",xtype:'datecolumn',format:'d/m/Y',width:70,align:'center',dataIndex:'bldat',sortable:true},{text:"Ref. Project No.",width:80,align:'center',dataIndex:'jobnr',sortable:true},{text:"Ref. Quotation No.",width:80,align:'center',dataIndex:'vbeln',sortable:true},{text:"Ref. Sale Order No.",width:80,align:'center',dataIndex:'ordnr',sortable:true},{text:"Customer Code",width:80,dataIndex:'kunnr',sortable:true},{text:"Customer Name",width:120,dataIndex:'name1',sortable:true},{text:"Credit Term",width:80,align:'center',dataIndex:'terms',sortable:true},{text:"Due Date",width:80,dataIndex:'duedt',sortable:true},{text:"Over Due",width:60,dataIndex:'overd',sortable:true},{text:"Status",width:80,dataIndex:'statx',align:'center',sortable:true},{text:"Material Code",width:80,align:'center',dataIndex:'matnr',sortable:true},{text:"Item Description",width:60,align:'center',dataIndex:'maktx',sortable:true},{text:"Quantity",width:60,align:'right',xtype:'numbercolumn',dataIndex:'menge',sortable:true},{text:"Unit Price",width:60,align:'right',xtype:'numbercolumn',dataIndex:'unitp',sortable:true},{text:"Amount (Before Vat)",width:80,align:'right',xtype:'numbercolumn',dataIndex:'beamt',sortable:true},{text:"Vat Amount",width:80,align:'right',xtype:'numbercolumn',dataIndex:'vat01',sortable:true},{text:"Amount Including Vat",width:80,align:'center',xtype:'numbercolumn',dataIndex:'netwr',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options,});}});;Ext.define('Account.RInvoice.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Invoice Report',closeAction:'hide',height:600,minHeight:380,width:1100,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.txtParam=Ext.create('Ext.form.Text',{width:300});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',handler:function(){var param=_this.txtParam.getValue();window.location=__site_url+'export/rinvoice/Index?'+param;}});this.grid=Ext.create('Account.RInvoice.Item.Grid',{region:'center',border:false});this.items=[this.grid];this.tbar=[this.excelAct];return this.callParent(arguments);}});;Ext.define('Account.RInvoice.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Invoice Selection',closeAction:'hide',height:240,width:500,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.itemDialog=Ext.create('Account.RInvoice.Item.Window');this.form=Ext.create('Account.RInvoice.Form',{region:'center'});this.items=[this.form];this.buttons=[{text:'Report',handler:function(){_this.itemDialog.show();_this.itemDialog.grid.load();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];this.itemDialog.grid.store.on('beforeload',function(store){var formValues=_this.form.getForm().getValues();store.getProxy().extraParams=formValues;});return this.callParent(arguments);}});;Ext.define('Account.RJournal.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.journalDialog=Ext.create('Account.Journal.MainWindow');this.templateDialog=Ext.create('Account.Journaltemp.MainWindow');this.journalDialog2=Ext.create('Account.Journal.MainWindow');this.templateDialog2=Ext.create('Account.Journaltemp.MainWindow');this.trigJournal=Ext.create('Ext.form.field.Trigger',{name:'belnr',labelWidth:100,fieldLabel:'Journal Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigJournal2=Ext.create('Ext.form.field.Trigger',{name:'belnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigTemplate=Ext.create('Ext.form.field.Trigger',{name:'tranr',labelWidth:100,fieldLabel:'Template Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigTemplate2=Ext.create('Ext.form.field.Trigger',{name:'tranr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.comboType=Ext.create('Ext.form.ComboBox',{fieldLabel:'Journal Type',name:'ttype',labelAlign:'letf',labelWidth:100,allowBlank:false,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Type --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'journal/loads_jtypecombo',reader:{type:'json',root:'rows',idProperty:'ttype'}},fields:['ttype','typtx'],remoteSort:true,sorters:'ttype ASC'}),listeners:{select:function(combo,record,index){var value=combo.getValue();}},queryMode:'remote',displayField:'typtx',valueField:'ttype'});this.comboType2=Ext.create('Ext.form.ComboBox',{name:'ttype2',labelAlign:'letf',labelWidth:100,allowBlank:false,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Type --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'journal/loads_jtypecombo',reader:{type:'json',root:'rows',idProperty:'ttype'}},fields:['ttype','typtx'],remoteSort:true,sorters:'ttype ASC'}),listeners:{select:function(combo,record,index){var value=combo.getValue();}},queryMode:'remote',displayField:'typtx',valueField:'ttype'});this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Document Date',name:'bldat1',labelWidth:100,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},{xtype:'datefield',name:'bldat2',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboType,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.comboType2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigJournal,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigJournal2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigTemplate,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigTemplate2]}];this.trigJournal.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'journal/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.belnr);}else{o.markInvalid('Could not find journal code : '+o.getValue());}}});}},this);this.trigJournal2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'journal/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.belnr);}else{o.markInvalid('Could not find journal code : '+o.getValue());}}});}},this);_this.journalDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigJournal.setValue(record.data.belnr);grid.getSelectionModel().deselectAll();_this.journalDialog.hide();});_this.journalDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigJournal2.setValue(record.data.belnr);grid.getSelectionModel().deselectAll();_this.journalDialog2.hide();});this.trigJournal.onTriggerClick=function(){_this.journalDialog.show();};this.trigJournal2.onTriggerClick=function(){_this.journalDialog2.show();};this.trigTemplate.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'journaltemp/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.tranr);}else{o.markInvalid('Could not find template code : '+o.getValue());}}});}},this);this.trigTemplate2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'journaltemp/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.tranr);}else{o.markInvalid('Could not find template code : '+o.getValue());}}});}},this);_this.templateDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigTemplate.setValue(record.data.tranr);grid.getSelectionModel().deselectAll();_this.templateDialog.hide();});_this.templateDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigTemplate2.setValue(record.data.tranr);grid.getSelectionModel().deselectAll();_this.templateDialog2.hide();});this.trigTemplate.onTriggerClick=function(){_this.templateDialog.show();};this.trigTemplate2.onTriggerClick=function(){_this.templateDialog2.show();};return this.callParent(arguments);},});;Ext.define('Account.RJournal.GL.GLGrid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"journal/loads_jv_item",reader:{type:'json',root:'rows',idProperty:'belnr,belpr'}},fields:['belnr','belpr','saknr','sgtxt','debit','credi'],remoteSort:true,sorters:['belnr ASC']});this.columns=[{text:"Journal No",width:100,align:'center',dataIndex:'belnr',sortable:true},{text:"Journal Items",width:100,align:'center',dataIndex:'belpr',sortable:true},{text:"GL No.",width:80,align:'center',dataIndex:'saknr',sortable:true},{text:"GL Name",width:200,dataIndex:'sgtxt',sortable:true},{text:"Debit",width:90,align:'right',dataIndex:'debit',sortable:true},{text:"Credit",width:90,align:'right',dataIndex:'credi',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.RJournal.GL.GLWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Journal Detail',closeAction:'hide',height:300,minHeight:450,width:680,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.RJournal.GL.GLGrid',{region:'center',border:false});this.items=[this.grid];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.RJournal.Item.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"journal/loads",reader:{type:'json',root:'rows',idProperty:'belnr'}},fields:['belnr','typtx','bldat','tranr','txz02','txz01','netwr'],remoteSort:true,sorters:['belnr ASC']});this.columns=[{text:"Journal No",width:100,align:'center',dataIndex:'belnr',sortable:true},{text:"Journal Type",width:80,align:'center',dataIndex:'typtx',sortable:true},{text:"Document Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Template Code",width:80,align:'center',dataIndex:'tranr',sortable:true},{text:"Template Name",width:160,dataIndex:'txz02',sortable:true},{text:"Description",width:200,dataIndex:'txz01',sortable:true},{text:"Amount",width:70,align:'right',dataIndex:'netwr',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.RJournal.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Journal Report',closeAction:'hide',height:600,minHeight:380,width:800,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.detailAct=new Ext.Action({text:'Journal Details',iconCls:'b-small-detail'});this.glDialog=Ext.create('Account.RJournal.GL.GLWindow');this.grid=Ext.create('Account.RJournal.Item.Grid',{region:'center',border:false});this.items=[this.grid];this.tbar=[this.detailAct];this.detailAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.glDialog.grid.load({belnr:id});_this.glDialog.show();}});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.RJournal.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Journal Selection',closeAction:'hide',height:200,width:500,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.itemDialog=Ext.create('Account.RJournal.Item.Window');this.form=Ext.create('Account.RJournal.Form',{region:'center'});this.items=[this.form];this.buttons=[{text:'Report',handler:function(){_this.itemDialog.show();_this.itemDialog.grid.load();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];this.itemDialog.grid.store.on('beforeload',function(store){var formValues=_this.form.getForm().getValues();store.getProxy().extraParams=formValues;});return this.callParent(arguments);}});;Ext.define('Account.RPayment.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.paymentDialog=Ext.create('Account.Payment.MainWindow');this.paymentDialog2=Ext.create('Account.Payment.MainWindow');this.vendorDialog=Ext.create('Account.Vendor.MainWindow');this.vendorDialog2=Ext.create('Account.Vendor.MainWindow');this.trigPayment=Ext.create('Ext.form.field.Trigger',{name:'payno',fieldLabel:'Payment no',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigPayment2=Ext.create('Ext.form.field.Trigger',{name:'payno2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigVendor=Ext.create('Ext.form.field.Trigger',{name:'lifnr',fieldLabel:'Vendor Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigVendor2=Ext.create('Ext.form.field.Trigger',{name:'lifnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigPayment.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'payment/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.payno);}else{o.markInvalid('Could not find Payment : '+o.getValue());}}});}},this);_this.paymentDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigPayment.setValue(record.data.payno);grid.getSelectionModel().deselectAll();_this.paymentDialog.hide();});this.trigPayment.onTriggerClick=function(){_this.paymentDialog.show();};this.trigPayment2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'payment/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.payno);}else{o.markInvalid('Could not find Payment : '+o.getValue());}}});}},this);_this.paymentDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigPayment2.setValue(record.data.payno);grid.getSelectionModel().deselectAll();_this.paymentDialog2.hide();});this.trigPayment2.onTriggerClick=function(){_this.paymentDialog2.show();};this.trigVendor.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.lifnr);}else{o.markInvalid('Could not find vendor code : '+o.getValue());}}});}},this);_this.vendorDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor.setValue(record.data.lifnr);grid.getSelectionModel().deselectAll();_this.vendorDialog.hide();});this.trigVendor.onTriggerClick=function(){_this.vendorDialog.show();};this.trigVendor2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.lifnr);}else{o.markInvalid('Could not find vendor code : '+o.getValue());}}});}},this);_this.vendorDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor2.setValue(record.data.lifnr);grid.getSelectionModel().deselectAll();_this.vendorDialog2.hide();});this.trigVendor2.onTriggerClick=function(){_this.vendorDialog2.show();};this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payment Status',name:'statu',editable:false,triggerAction:'all',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Document Date',name:'bldat',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},{xtype:'datefield',name:'bldat2',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigPayment,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigPayment2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},this.trigVendor,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigVendor2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboQStatus,{}]}];return this.callParent(arguments);},});;Ext.define('Account.RPayment.Item.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"payment/loads_report",reader:{type:'json',root:'rows',idProperty:function(o){return o.payno+o.vbelp;}},simpleSortMode:true},fields:['payno','bldat','lifnr','name1','netwr','invnr','invdt','itamt','netwr','paytx'],remoteSort:true,sorters:[{property:'payno',direction:'ASC'}],});this.columns=[{text:"Payment No",width:100,align:'center',dataIndex:'payno',sortable:true},{text:"Doc Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Vendor No",width:80,align:'center',dataIndex:'lifnr',sortable:true},{text:"Vendor Name",width:200,dataIndex:'name1',sortable:true},{text:"Net Amount",xtype:'numbercolumn',width:100,align:'right',dataIndex:'netwr',sortable:true},{text:"AP No",width:100,align:'center',dataIndex:'invnr',sortable:true},{text:"AP Date",width:80,dataIndex:'invdt',align:'center',sortable:true},{text:"Amount",xtype:'numbercolumn',width:100,dataIndex:'itamt',align:'right',sortable:true},{text:"Paymented by",width:170,dataIndex:'paytx',align:'left',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.RPayment.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Payment Report',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.txtParam=Ext.create('Ext.form.Text',{width:300});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',handler:function(){var param=_this.txtParam.getValue();window.location=__site_url+'export/rpayment/Index?'+param;}});this.grid=Ext.create('Account.RPayment.Item.Grid',{region:'center',border:false});this.items=[this.grid];this.tbar=[this.excelAct];return this.callParent(arguments);}});;Ext.define('Account.RPayment.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Payment Selection',closeAction:'hide',height:250,width:550,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.itemDialog=Ext.create('Account.RPayment.Item.Window');this.form=Ext.create('Account.RPayment.Form',{region:'center'});this.items=[this.form];this.buttons=[{text:'Report',handler:function(){_this.itemDialog.show();_this.itemDialog.grid.load();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];this.itemDialog.grid.store.on('beforeload',function(store){var formValues=_this.form.getForm().getValues();store.getProxy().extraParams=formValues;});return this.callParent(arguments);}});;Ext.define('Account.RPaymentJournal.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){var _this=this;Ext.apply(this,{title:'Payment Journal preview',enableCopies:false});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);}});;Ext.define('Account.RPaymentJournal.MainWindow',{extend:'Ext.window.Window',title:'Report Payment Journal',closeAction:'hide',width:420,height:220,resizable:false,modal:true,layout:'fit',maximizable:false,initComponent:function(config){var result=Ext.create("Account.RPaymentJournal.Result.Grid");var form=Ext.create('Ext.form.Panel',{layout:'form',bodyPadding:'15 15 15 15',fieldDefaults:{labelWidth:150},frame:true,items:[{xtype:'datefield',fieldLabel:'เริ่มต้น',name:'start_date',format:'Y-m-d',allowBlank:false},{xtype:'datefield',fieldLabel:'สิ้นสุด',name:'end_date',format:'Y-m-d',allowBlank:false},{xtype:'textfield',name:'kunnr',fieldLabel:'Customer / Supplier Code',}],buttons:[{text:'ยืนยัน',handler:function(){form=this.up('form').getForm();if(form.isValid()){result.loadMask.show();Ext.Ajax.request({url:__base_url+"index.php/rpaymenthjournal/result",params:form.getValues(),success:function(response){var rs=response.responseText;rs=Ext.JSON.decode(rs);if(rs.success){result.params=form.getValues();result.storeGrid.loadData(rs.datas);result.show();result.loadMask.hide();}}});}}},{text:'ยกเลิก',handler:function(){form=this.up('form').getForm();form.reset();}}]});this.items=[form];return this.callParent(arguments);}});;Ext.define('Account.RPaymentJournal.Result.Grid',{extend:'Ext.window.Window',requires:['Ext.ux.grid.FiltersFeature','Ext.ux.DataTip'],title:'Report Payment Journal',closeAction:'hide',width:780,height:500,resizable:false,modal:true,layout:'fit',maximizable:true,maximized:true,params:{},loadMask:null,initComponent:function(config){this.loadMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."});this.preview=Ext.create('Account.RPaymentJournal.Item.PreviewWindow');var me=this;var filters={ftype:'filters',encode:false,local:true,filters:[{type:'boolean',dataIndex:'visible'}]};this.storeGrid=Ext.create('Ext.data.ArrayStore',{model:'RPaymentJournal',fields:[{name:'bldat',type:'date',dateFormat:'Y-m-d'},{name:'belnr'},{name:'invnr'},{name:'name1'},{name:'saknr'},{name:'sgtxt'},{name:'debit',type:'float'},{name:'credi',type:'float'},{name:'statu'},{name:'kunnr'}],data:[],groupers:['bldat','belnr']});this.columnsGrid=[{text:'SV Date',sortable:false,dataIndex:'bldat',renderer:Ext.util.Format.dateRenderer('d/m/Y')},{text:'SV Number',sortable:false,dataIndex:'belnr',filterable:true,filter:{type:'string'}},{text:'Ref. Doc. No.',sortable:false,dataIndex:'invnr'},{text:'Vendor',sortable:false,dataIndex:'name2'},{text:'Account Code',sortable:false,dataIndex:'saknr'},{text:'Account Name',sortable:false,dataIndex:'sgtxt'},{text:'Debit',sortable:false,dataIndex:'debit',renderer:Ext.util.Format.numberRenderer('0,000.00'),summaryType:function(records){var i=0,length=records.length,total=0,record;for(i=0;i<length;++i){record=records[i];total+=Number(record.get('debit'));}
return total;},summaryRenderer:function(value,summaryData,index){return'<b>'+Ext.util.Format.number(value,'0,000.00')+'</b>';}},{text:'Credit',sortable:false,dataIndex:'credi',renderer:Ext.util.Format.numberRenderer('0,000.00'),summaryType:function(records){var i=0,length=records.length,total=0,record;for(i=0;i<length;++i){record=records[i];total+=Number(record.get('credi'));}
return total;},summaryRenderer:function(value,summaryData,index){return'<b>'+Ext.util.Format.number(value,'0,000.00')+'</b>';}},{text:'Status',sortable:false,dataIndex:'statu'}];this.grid=Ext.create('Ext.grid.Panel',{store:this.storeGrid,columns:this.columnsGrid,forceFit:true,features:[Ext.create('Ext.ux.grid.feature.MultiGroupingSummary',{id:'group',hideGroupedHeader:false,enableGroupingMenu:true,startCollapsed:true}),{ftype:'summary',dock:'bottom'},filters]});this.items=[this.grid];this.tbar=[{text:"Print",handler:function(){start_date=me.params.start_date;end_date=me.params.end_date;kunnr=me.params.kunnr;comid=1000;params="start_date="+start_date+"&end_date="+end_date+"&kunnr="+kunnr+"&comid="+comid;url=__base_url+'index.php/rpaymentjournal/pdf?'+params;me.preview.openDialog(__base_url+'index.php/rpaymentjournal/pdf?'+params,'_blank');}}];return this.callParent(arguments);}});;Ext.define('Account.RPettyCashJournal.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){var _this=this;Ext.apply(this,{title:'Petty Cash Journal preview',enableCopies:false});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);}});;Ext.define('Account.RPettyCashJournal.MainWindow',{extend:'Ext.window.Window',title:'Report Petty Cash Journal',closeAction:'hide',width:420,height:220,resizable:false,modal:true,layout:'fit',maximizable:false,initComponent:function(config){var result=Ext.create("Account.RPettyCashJournal.Result.Grid");var form=Ext.create('Ext.form.Panel',{layout:'form',bodyPadding:'15 15 15 15',fieldDefaults:{labelWidth:150},frame:true,items:[{xtype:'datefield',fieldLabel:'เริ่มต้น',name:'start_date',format:'Y-m-d',allowBlank:false},{xtype:'datefield',fieldLabel:'สิ้นสุด',name:'end_date',format:'Y-m-d',allowBlank:false},{xtype:'textfield',name:'kunnr',fieldLabel:'Customer / Supplier Code',}],buttons:[{text:'ยืนยัน',handler:function(){form=this.up('form').getForm();if(form.isValid()){result.loadMask.show();Ext.Ajax.request({url:__base_url+"index.php/rpettycashjournal/result",params:form.getValues(),success:function(response){var rs=response.responseText;rs=Ext.JSON.decode(rs);if(rs.success){result.params=form.getValues();result.storeGrid.loadData(rs.datas);result.show();result.loadMask.hide();}}});}}},{text:'ยกเลิก',handler:function(){form=this.up('form').getForm();form.reset();}}]});this.items=[form];return this.callParent(arguments);}});;Ext.define('Account.RPettyCashJournal.Result.Grid',{extend:'Ext.window.Window',requires:['Ext.ux.grid.FiltersFeature','Ext.ux.DataTip'],title:'Report Petty Cash Journal',closeAction:'hide',width:780,height:500,resizable:false,modal:true,layout:'fit',maximizable:true,maximized:true,params:{},loadMask:null,initComponent:function(config){this.loadMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."});this.preview=Ext.create('Account.RPettyCashJournal.Item.PreviewWindow');var me=this;var filters={ftype:'filters',encode:false,local:true,filters:[{type:'boolean',dataIndex:'visible'}]};this.storeGrid=Ext.create('Ext.data.ArrayStore',{model:'RPettyCashJournal',fields:[{name:'bldat',type:'date',dateFormat:'Y-m-d'},{name:'belnr'},{name:'invnr'},{name:'name1'},{name:'saknr'},{name:'sgtxt'},{name:'debit',type:'float'},{name:'credi',type:'float'},{name:'statu'},{name:'kunnr'}],data:[],groupers:['bldat','belnr']});this.columnsGrid=[{text:'SV Date',sortable:false,dataIndex:'bldat',renderer:Ext.util.Format.dateRenderer('d/m/Y')},{text:'SV Number',sortable:false,dataIndex:'belnr',filterable:true,filter:{type:'string'}},{text:'Ref. Doc. No.',sortable:false,dataIndex:'invnr'},{text:'Customer',sortable:false,dataIndex:'name1'},{text:'Account Code',sortable:false,dataIndex:'saknr'},{text:'Account Name',sortable:false,dataIndex:'sgtxt'},{text:'Debit',sortable:false,dataIndex:'debit',renderer:Ext.util.Format.numberRenderer('0,000.00'),summaryType:function(records){var i=0,length=records.length,total=0,record;for(i=0;i<length;++i){record=records[i];total+=Number(record.get('debit'));}
return total;},summaryRenderer:function(value,summaryData,index){return'<b>'+Ext.util.Format.number(value,'0,000.00')+'</b>';}},{text:'Credit',sortable:false,dataIndex:'credi',renderer:Ext.util.Format.numberRenderer('0,000.00'),summaryType:function(records){var i=0,length=records.length,total=0,record;for(i=0;i<length;++i){record=records[i];total+=Number(record.get('credi'));}
return total;},summaryRenderer:function(value,summaryData,index){return'<b>'+Ext.util.Format.number(value,'0,000.00')+'</b>';}},{text:'Status',sortable:false,dataIndex:'statu'}];this.grid=Ext.create('Ext.grid.Panel',{store:this.storeGrid,columns:this.columnsGrid,forceFit:true,features:[Ext.create('Ext.ux.grid.feature.MultiGroupingSummary',{id:'group',hideGroupedHeader:false,enableGroupingMenu:true,startCollapsed:true}),{ftype:'summary',dock:'bottom'},filters]});this.items=[this.grid];this.tbar=[{text:"Print",handler:function(){start_date=me.params.start_date;end_date=me.params.end_date;kunnr=me.params.kunnr;comid=1000;params="start_date="+start_date+"&end_date="+end_date+"&kunnr="+kunnr+"&comid="+comid;url=__base_url+'index.php/rpettycashjournal/pdf?'+params;me.preview.openDialog(__base_url+'index.php/rpettycashjournal/pdf?'+params,'_blank');}}];return this.callParent(arguments);}});;Ext.define('Account.Rpnd1WHT.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Period Date',name:'bldat',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',value:new Date,allowBlank:false}]}];return this.callParent(arguments);},});;Ext.define('Account.Rpnd1WHT.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'เลือกเดือนที่ต้องการดู รายงาน ภ.ง.ด. 1',closeAction:'hide',height:130,width:400,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Rpnd1WHT.Form',{region:'center'});this.previewDialog=Ext.create('Account.Rpnd1WHT.PreviewWindow');this.previewDialog2=Ext.create('Account.Rpnd1WHT.PreviewWindow2');this.previewDialog3=Ext.create('Account.Rpnd1WHT.PreviewWindow3');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'รายงานภาษีหัก ณ ที่จ่าย ภ.ง.ด.1',handler:function(){var form_basic=_this.form.getForm();if(form_basic.isValid()){_this.previewDialog.openDialog(form_basic.getValues());}}});this.btnPreview2=Ext.create('Ext.Button',{text:'ฟอร์มแบบนำส่ง ภ.ง.ด.1',handler:function(){var form_basic=_this.form.getForm();if(form_basic.isValid()){_this.previewDialog2.openDialog(form_basic.getValues());}}});this.btnPreview3=Ext.create('Ext.Button',{text:'ใบแนบ ภ.ง.ด.1',handler:function(){var form_basic=_this.form.getForm();if(form_basic.isValid()){_this.previewDialog3.openDialog(form_basic.getValues());}}});this.buttons=[this.btnPreview,this.btnPreview3,this.btnPreview2];return this.callParent(arguments);}});;Ext.define('Account.Rpnd1WHT.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'รายงานภาษีหัก ณ ที่จ่าย (ภ.ง.ด.1)',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(params,copies){copies=copies||1;var q_str='';params['copies']=copies;return __site_url+'form/rsalarywht/index?'+Ext.urlEncode(params);}});;Ext.define('Account.Rpnd1WHT.PreviewWindow2',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'แบบฟอร์มนำส่ง ภ.ง.ด.1',closeAction:'hide',height:700,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(params,copies){copies=copies||1;var q_str='';params['copies']=copies;return __site_url+'form/rsalarywht_docket/index?'+Ext.urlEncode(params);}});;Ext.define('Account.Rpnd1WHT.PreviewWindow3',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'ใบแนบ ภ.ง.ด.1',closeAction:'hide',height:600,width:1000,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(params,copies){copies=copies||1;var q_str='';params['copies']=copies;return __site_url+'form/rsalarywht_attach/index?'+Ext.urlEncode(params);}});;Ext.define('Account.Rpnd3WHT.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Period Date',name:'bldat',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',value:new Date,allowBlank:false}]}];return this.callParent(arguments);},});;Ext.define('Account.Rpnd3WHT.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'เลือกเดือนที่ต้องการดู รายงาน ภ.ง.ด. 3',closeAction:'hide',height:130,width:400,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Rpnd1WHT.Form',{region:'center'});this.previewDialog=Ext.create('Account.Rpnd3WHT.PreviewWindow');this.previewDialog2=Ext.create('Account.Rpnd3WHT.PreviewWindow2');this.previewDialog3=Ext.create('Account.Rpnd3WHT.PreviewWindow3');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'รายงานภาษีหัก ณ ที่จ่าย ภ.ง.ด.3',handler:function(){var form_basic=_this.form.getForm();if(form_basic.isValid()){_this.previewDialog.openDialog(form_basic.getValues());}}});this.btnPreview2=Ext.create('Ext.Button',{text:'ฟอร์มแบบนำส่ง ภ.ง.ด.3',handler:function(){var form_basic=_this.form.getForm();if(form_basic.isValid()){_this.previewDialog2.openDialog(form_basic.getValues());}}});this.btnPreview3=Ext.create('Ext.Button',{text:'ใบแนบ ภ.ง.ด.3',handler:function(){var form_basic=_this.form.getForm();if(form_basic.isValid()){_this.previewDialog3.openDialog(form_basic.getValues());}}});this.buttons=[this.btnPreview,this.btnPreview3,this.btnPreview2];return this.callParent(arguments);}});;Ext.define('Account.Rpnd3WHT.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'รายงานภาษีหัก ณ ที่จ่าย (ภ.ง.ด.3)',closeAction:'hide',height:600,width:1000,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(params,copies){copies=copies||1;var q_str='';params['copies']=copies;return __site_url+'form/rpnd3wht/index?'+Ext.urlEncode(params);}});;Ext.define('Account.Rpnd3WHT.PreviewWindow2',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'แบบฟอร์มนำส่ง ภ.ง.ด.3',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(params,copies){copies=copies||1;var q_str='';params['copies']=copies;return __site_url+'form/rpnd3wht_docket/index?'+Ext.urlEncode(params);}});;Ext.define('Account.Rpnd3WHT.PreviewWindow3',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'ใบแนบ ภ.ง.ด.3',closeAction:'hide',height:600,width:1000,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(params,copies){copies=copies||1;var q_str='';params['copies']=copies;return __site_url+'form/rpnd3wht_attach/index?'+Ext.urlEncode(params);}});;Ext.define('Account.Rpnd50WHT.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.paymentDialog=Ext.create('Account.AP.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.trigPayment=Ext.create('Ext.form.field.Trigger',{name:'invnr',labelWidth:130,fieldLabel:'Account Payable No',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigPayment.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'ap/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.invnr);}else{o.markInvalid('Could not find Payment : '+o.getValue());}}});}},this);_this.paymentDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigPayment.setValue(record.data.invnr);grid.getSelectionModel().deselectAll();_this.paymentDialog.hide();});this.trigPayment.onTriggerClick=function(){_this.paymentDialog.show();};this.items=[this.trigPayment];return this.callParent(arguments);},});;Ext.define('Account.Rpnd50WHT.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'หนังสือรับรองการหักภาษี ณ ที่จ่าย(50 ทวิ)',closeAction:'hide',height:150,width:350,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Rpnd50WHT.Form',{region:'center'});this.previewDialog=Ext.create('Account.Rpnd50WHT.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){var form_basic=_this.form.getForm();if(form_basic.isValid()){_this.previewDialog.openDialog(form_basic.getValues());}}});this.buttons=[this.btnPreview,{text:'Cancel',handler:function(){_this.hide();}}];return this.callParent(arguments);}});;Ext.define('Account.Rpnd50WHT.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'หนังสือรับรองการหักภาษี ณ ที่จ่าย(50 ทวิ)',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(params,copies){copies=copies||1;var q_str='';params['copies']=copies;return __site_url+'form/rwht_docket/index?'+Ext.urlEncode(params);}});;Ext.define('Account.Rpnd53WHT.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Period Date',name:'bldat',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',value:new Date,allowBlank:false}]}];return this.callParent(arguments);},});;Ext.define('Account.Rpnd53WHT.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'รายงานภาษีหัก ณ ที่จ่ายนิติบุคคล',closeAction:'hide',height:130,width:560,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Rpnd53WHT.Form',{region:'center'});this.previewDialog=Ext.create('Account.Rpnd53WHT.PreviewWindow');this.previewDialog2=Ext.create('Account.Rpnd53WHT.PreviewWindow2');this.previewDialog3=Ext.create('Account.Rpnd53WHT.PreviewWindow3');this.previewDialog4=Ext.create('Account.Rpnd53WHT.PreviewWindow4');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'รายงานภาษีหัก ณ ที่จ่าย(ฝั่งซื้อ)',handler:function(){var form_basic=_this.form.getForm();if(form_basic.isValid()){_this.previewDialog.openDialog(form_basic.getValues());}}});this.btnPreview2=Ext.create('Ext.Button',{text:'รายงานภาษีหัก ณ ที่จ่าย(ฝั่งขาย)',handler:function(){var form_basic=_this.form.getForm();if(form_basic.isValid()){_this.previewDialog2.openDialog(form_basic.getValues());}}});this.btnPreview3=Ext.create('Ext.Button',{text:'ใบแนบ ภ.ง.ด.53',handler:function(){var form_basic=_this.form.getForm();if(form_basic.isValid()){_this.previewDialog3.openDialog(form_basic.getValues());}}});this.btnPreview4=Ext.create('Ext.Button',{text:'ฟอร์มนำส่ง ภ.ง.ด.53',handler:function(){var form_basic=_this.form.getForm();if(form_basic.isValid()){_this.previewDialog4.openDialog(form_basic.getValues());}}});this.buttons=[this.btnPreview,this.btnPreview2,this.btnPreview3,this.btnPreview4];return this.callParent(arguments);}});;Ext.define('Account.Rpnd53WHT.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'รายงานภาษีหัก ณ ที่จ่าย(ฝั่งซื้อ)',closeAction:'hide',height:600,width:1000,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(params,copies){copies=copies||1;var q_str='';params['copies']=copies;return __site_url+'form/rpurchasewht/index?'+Ext.urlEncode(params);}});;Ext.define('Account.Rpnd53WHT.PreviewWindow2',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'รายงานภาษีหัก ณ ที่จ่าย(ฝั่งขาย)',closeAction:'hide',height:600,width:1000,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(params,copies){copies=copies||1;var q_str='';params['copies']=copies;return __site_url+'form/rsalewht/index?'+Ext.urlEncode(params);}});;Ext.define('Account.Rpnd53WHT.PreviewWindow3',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'ใบแนบ ภ.ง.ด.53',closeAction:'hide',height:600,width:1000,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(params,copies){copies=copies||1;var q_str='';params['copies']=copies;return __site_url+'form/rpnd53wht_attach/index?'+Ext.urlEncode(params);}});;Ext.define('Account.Rpnd53WHT.PreviewWindow4',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'แบบฟอร์มนำส่ง ภ.ง.ด. 53',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(params,copies){copies=copies||1;var q_str='';params['copies']=copies;return __site_url+'form/rsumwht_docket/index?'+Ext.urlEncode(params);}});;Ext.define('Account.RPO.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'PO Status',name:'statu',editable:false,triggerAction:'all',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'po/loads_combo/apov/statu/statx',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboQStatus2=Ext.create('Ext.form.ComboBox',{name:'statu2',editable:false,triggerAction:'all',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'po/loads_combo/apov/statu/statx',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.poDialog=Ext.create('Account.PO.MainWindow');this.poDialog2=Ext.create('Account.PO.MainWindow');this.prDialog=Ext.create('Account.PR2.MainWindow');this.prDialog2=Ext.create('Account.PR2.MainWindow');this.vendorDialog=Ext.create('Account.Vendor.MainWindow');this.vendorDialog2=Ext.create('Account.Vendor.MainWindow');this.trigPO=Ext.create('Ext.form.field.Trigger',{name:'ebeln',fieldLabel:'PO Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigPO2=Ext.create('Ext.form.field.Trigger',{name:'ebeln2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigPR=Ext.create('Ext.form.field.Trigger',{name:'purnr',fieldLabel:'PR Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigPR2=Ext.create('Ext.form.field.Trigger',{name:'purnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigVendor=Ext.create('Ext.form.field.Trigger',{name:'lifnr',fieldLabel:'Vendor Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigVendor2=Ext.create('Ext.form.field.Trigger',{name:'lifnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigPO.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'po/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ebeln);}else{o.markInvalid('Could not find purchase order code : '+o.getValue());}}});}},this);_this.poDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigPO.setValue(record.data.ebeln);grid.getSelectionModel().deselectAll();_this.poDialog.hide();});this.trigPO.onTriggerClick=function(){_this.poDialog.show();};this.trigPO2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'po/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ebeln);}else{o.markInvalid('Could not find purchase order code : '+o.getValue());}}});}},this);_this.poDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigPO2.setValue(record.data.ebeln);grid.getSelectionModel().deselectAll();_this.poDialog2.hide();});this.trigPO2.onTriggerClick=function(){_this.poDialog2.show();};this.trigPR.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'pr2/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.purnr);}else{o.markInvalid('Could not find purchase requisitions code : '+o.getValue());}}});}},this);_this.prDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigPR.setValue(record.data.purnr);grid.getSelectionModel().deselectAll();_this.prDialog.hide();});this.trigPR.onTriggerClick=function(){_this.prDialog.show();};this.trigPR2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'pr2/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.purnr);}else{o.markInvalid('Could not find purchase requisitions code : '+o.getValue());}}});}},this);_this.prDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigPR2.setValue(record.data.purnr);grid.getSelectionModel().deselectAll();_this.prDialog2.hide();});this.trigPR2.onTriggerClick=function(){_this.prDialog2.show();};this.trigVendor.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.lifnr);}else{o.markInvalid('Could not find vendor code : '+o.getValue());}}});}},this);_this.vendorDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor.setValue(record.data.lifnr);grid.getSelectionModel().deselectAll();_this.vendorDialog.hide();});this.trigVendor.onTriggerClick=function(){_this.vendorDialog.show();};this.trigVendor2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.lifnr);}else{o.markInvalid('Could not find vendor code : '+o.getValue());}}});}},this);_this.vendorDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor2.setValue(record.data.lifnr);grid.getSelectionModel().deselectAll();_this.vendorDialog2.hide();});this.trigVendor2.onTriggerClick=function(){_this.vendorDialog2.show();};this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Date',name:'bldat1',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},{xtype:'datefield',name:'bldat2',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigPO,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigPO2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigPR,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigPR2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},this.trigVendor,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigVendor2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboQStatus,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.comboQStatus2]}];return this.callParent(arguments);},});;Ext.define('Account.RPO.Item.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"po/loads",reader:{type:'json',root:'rows',idProperty:'ebeln'}},fields:['ebeln','bldat','lifnr','name1','netwr','statx'],remoteSort:true,sorters:['ebeln ASC']});this.columns=[{text:"PO No",flex:true,dataIndex:'ebeln',sortable:true},{text:"PO Date",width:125,dataIndex:'bldat',sortable:true},{text:"Vendor Code",flex:true,dataIndex:'lifnr',sortable:true},{text:"Vendor Name",flex:true,dataIndex:'name1',sortable:true},{text:"Net Amount",flex:true,dataIndex:'netwr',sortable:true},{text:"PO Status",flex:true,dataIndex:'statx',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.RPO.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Purchase Orders Report',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.RPO.Item.Grid',{region:'center',border:false});this.items=[this.grid];return this.callParent(arguments);}});;Ext.define('Account.RPO.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Purchase Orders Selection',closeAction:'hide',height:250,width:500,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.itemDialog=Ext.create('Account.RPO.Item.Window');this.form=Ext.create('Account.RPO.Form',{region:'center'});this.items=[this.form];this.buttons=[{text:'Report',handler:function(){_this.itemDialog.show();_this.itemDialog.grid.load();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];this.itemDialog.grid.store.on('beforeload',function(store){var formValues=_this.form.getForm().getValues();store.getProxy().extraParams=formValues;});return this.callParent(arguments);}});;Ext.define('Account.Rpp30Vat.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.numberBalance=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'ภาษีที่ชำระเกินยกมา',name:'balwr',width:250,align:'right'});this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Period Date',name:'bldat',format:'d/m/Y',value:new Date,altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',width:250,allowBlank:false}]},this.numberBalance];return this.callParent(arguments);},});;Ext.define('Account.Rpp30Vat.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'ภ.พ.30',closeAction:'hide',height:150,width:350,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Rpp30Vat.Form',{region:'center'});this.previewDialog=Ext.create('Account.Rpp30Vat.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){var form_basic=_this.form.getForm();if(form_basic.isValid()){_this.previewDialog.openDialog(form_basic.getValues());}}});this.buttons=[this.btnPreview,{text:'Cancel',handler:function(){_this.hide();}}];return this.callParent(arguments);}});;Ext.define('Account.Rpp30Vat.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'แบบฟอร์มนำส่ง ภ.พ.30',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(params,copies){copies=copies||1;var q_str='';params['copies']=copies;return __site_url+'form/rsumvat_docket/index?'+Ext.urlEncode(params);}});;Ext.define('Account.RPR.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'PR Status',name:'statu',editable:false,triggerAction:'all',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'po/loads_combo/apov/statu/statx',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboQStatus2=Ext.create('Ext.form.ComboBox',{name:'statu2',editable:false,triggerAction:'all',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'po/loads_combo/apov/statu/statx',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.prDialog=Ext.create('Account.PR2.MainWindow');this.prDialog2=Ext.create('Account.PR2.MainWindow');this.vendorDialog=Ext.create('Account.Vendor.MainWindow');this.vendorDialog2=Ext.create('Account.Vendor.MainWindow');this.trigPR=Ext.create('Ext.form.field.Trigger',{name:'purnr',fieldLabel:'PR Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigPR2=Ext.create('Ext.form.field.Trigger',{name:'purnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigVendor=Ext.create('Ext.form.field.Trigger',{name:'lifnr',fieldLabel:'Vendor Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigVendor2=Ext.create('Ext.form.field.Trigger',{name:'lifnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigPR.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'pr2/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.purnr);}else{o.markInvalid('Could not find purchase requisitions code : '+o.getValue());}}});}},this);_this.prDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigPR.setValue(record.data.purnr);grid.getSelectionModel().deselectAll();_this.prDialog.hide();});this.trigPR.onTriggerClick=function(){_this.prDialog.show();};this.trigPR2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'pr2/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.purnr);}else{o.markInvalid('Could not find purchase requisitions code : '+o.getValue());}}});}},this);_this.prDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigPR2.setValue(record.data.purnr);grid.getSelectionModel().deselectAll();_this.prDialog2.hide();});this.trigPR2.onTriggerClick=function(){_this.prDialog2.show();};this.trigVendor.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.lifnr);}else{o.markInvalid('Could not find vendor code : '+o.getValue());}}});}},this);_this.vendorDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor.setValue(record.data.lifnr);grid.getSelectionModel().deselectAll();_this.vendorDialog.hide();});this.trigVendor.onTriggerClick=function(){_this.vendorDialog.show();};this.trigVendor2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendor/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.lifnr);}else{o.markInvalid('Could not find vendor code : '+o.getValue());}}});}},this);_this.vendorDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVendor2.setValue(record.data.lifnr);grid.getSelectionModel().deselectAll();_this.vendorDialog2.hide();});this.trigVendor2.onTriggerClick=function(){_this.vendorDialog2.show();};this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Date',name:'bldat1',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},{xtype:'datefield',name:'bldat2',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigPR,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigPR2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},this.trigVendor,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigVendor2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboQStatus,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.comboQStatus2]}];return this.callParent(arguments);},});;Ext.define('Account.RPR.Item.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"pr2/loads",reader:{type:'json',root:'rows',idProperty:'purnr'}},fields:['purnr','bldat','lifnr','name1','netwr','statx','adr01','distx','pstlz','telf1','telfx','email'],remoteSort:true,sorters:['purnr ASC']});this.columns=[{text:"PR No",flex:true,dataIndex:'purnr',sortable:true},{text:"PR Date",width:125,dataIndex:'bldat',sortable:true},{text:"Vendor Code",flex:true,dataIndex:'lifnr',sortable:true},{text:"Vendor Name",flex:true,dataIndex:'name1',sortable:true},{text:"Net Amount",flex:true,dataIndex:'netwr',sortable:true},{text:"PR Status",flex:true,dataIndex:'statx',sortable:true},{text:"",width:0,dataIndex:'adr01',sortable:true},{text:"",width:0,dataIndex:'distx',sortable:true},{text:"",width:0,dataIndex:'pstlz',sortable:true},{text:"",width:0,dataIndex:'telf1',sortable:true},{text:"",width:0,dataIndex:'telfx',sortable:true},{text:"",width:0,dataIndex:'email',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.RPR.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Purchase Requisitions Report',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.RPR.Item.Grid',{region:'center',border:false});this.items=[this.grid];return this.callParent(arguments);}});;Ext.define('Account.RPR.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Purchase Requisitions Selection',closeAction:'hide',height:250,width:500,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.itemDialog=Ext.create('Account.RPR.Item.Window');this.form=Ext.create('Account.RPR.Form',{region:'center'});this.items=[this.form];this.buttons=[{text:'Report',handler:function(){_this.itemDialog.show();_this.itemDialog.grid.load();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];this.itemDialog.grid.store.on('beforeload',function(store){var formValues=_this.form.getForm().getValues();store.getProxy().extraParams=formValues;});return this.callParent(arguments);}});;Ext.define('Account.RProject.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.projectDialog=Ext.create('Account.Project.MainWindow');this.customerDialog=Ext.create('Account.Customer.MainWindow');this.projectDialog2=Ext.create('Account.Project.MainWindow');this.customerDialog2=Ext.create('Account.Customer.MainWindow');this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'Quotation Status',name:'statu',editable:false,triggerAction:'all',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboQStatus2=Ext.create('Ext.form.ComboBox',{name:'statu2',editable:false,triggerAction:'all',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboPSale=Ext.create('Ext.form.ComboBox',{fieldLabel:'Saleperson',name:'salnr',editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select Saleperson --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_scombo',reader:{type:'json',root:'rows',idProperty:'salnr'}},fields:['salnr','name1'],remoteSort:true,sorters:'salnr ASC'}),queryMode:'remote',displayField:'name1',valueField:'salnr'});this.comboPSale2=Ext.create('Ext.form.ComboBox',{name:'salnr2',editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select Saleperson --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_scombo',reader:{type:'json',root:'rows',idProperty:'salnr'}},fields:['salnr','name1'],remoteSort:true,sorters:'salnr ASC'}),queryMode:'remote',displayField:'name1',valueField:'salnr'});this.trigProject=Ext.create('Ext.form.field.Trigger',{name:'jobnr',fieldLabel:'Project Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigProject2=Ext.create('Ext.form.field.Trigger',{name:'jobnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigCustomer=Ext.create('Ext.form.field.Trigger',{name:'kunnr',fieldLabel:'Customer Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigCustomer2=Ext.create('Ext.form.field.Trigger',{name:'kunnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Date',name:'bldat1',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},{xtype:'datefield',name:'bldat2',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigProject,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigProject2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},this.trigCustomer,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigCustomer2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboPSale,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.comboPSale2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboQStatus,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.comboQStatus2]}];this.trigCustomer2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer2.setValue(record.data.kunnr);grid.getSelectionModel().deselectAll();_this.customerDialog2.hide();});this.trigCustomer2.onTriggerClick=function(){_this.customerDialog2.show();};this.trigProject2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'project/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.jobnr);}else{o.markInvalid('Could not find project code : '+o.getValue());}}});}},this);_this.projectDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigProject2.setValue(record.data.jobnr);grid.getSelectionModel().deselectAll();_this.projectDialog2.hide();});this.trigProject2.onTriggerClick=function(){_this.projectDialog2.show();};this.trigCustomer.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer.setValue(record.data.kunnr);grid.getSelectionModel().deselectAll();_this.customerDialog.hide();});this.trigCustomer.onTriggerClick=function(){_this.customerDialog.show();};this.trigProject.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'project/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.jobnr);}else{o.markInvalid('Could not find project code : '+o.getValue());}}});}},this);_this.projectDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigProject.setValue(record.data.jobnr);grid.getSelectionModel().deselectAll();_this.projectDialog.hide();});this.trigProject.onTriggerClick=function(){_this.projectDialog.show();};return this.callParent(arguments);},});;Ext.define('Account.RProject.Item.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"project/loads",reader:{type:'json',root:'rows',idProperty:'jobnr'}},fields:['jobnr','jobtx','bldat','kunnr','name1','statx','sname','pramt','ctype'],remoteSort:true,sorters:['jobnr ASC']});this.columns=[{text:"Project No",width:100,align:'center',dataIndex:'jobnr',sortable:true},{text:"Project Name",width:150,dataIndex:'jobtx',sortable:true},{text:"Project Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Customer No",width:100,align:'center',dataIndex:'kunnr',sortable:true},{text:"Customer Name",width:100,dataIndex:'name1',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Sale Name",width:120,dataIndex:'sname',sortable:true},{text:"Project Amount",width:100,align:'right',dataIndex:'pramt',sortable:true},{text:"Currency",width:80,align:'center',dataIndex:'ctype',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.RProject.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Project Report',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.RProject.Item.Grid',{region:'center',border:false});this.items=[this.grid];return this.callParent(arguments);}});;Ext.define('Account.RProject.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Project Selection',closeAction:'hide',height:250,width:500,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.itemDialog=Ext.create('Account.RProject.Item.Window');this.form=Ext.create('Account.RProject.Form',{region:'center'});this.items=[this.form];this.buttons=[{text:'Report',handler:function(){_this.itemDialog.show();_this.itemDialog.grid.load();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];this.itemDialog.grid.store.on('beforeload',function(store){var formValues=_this.form.getForm().getValues();store.getProxy().extraParams=formValues;});return this.callParent(arguments);}});;Ext.define('Account.RPurchaseJournal.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){var _this=this;Ext.apply(this,{title:'Purchase Journal preview',enableCopies:false});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);}});;Ext.define('Account.RPurchaseJournal.MainWindow',{extend:'Ext.window.Window',title:'Report Purchase Journal',closeAction:'hide',width:420,height:220,resizable:false,modal:true,layout:'fit',maximizable:false,initComponent:function(config){var form=Ext.create('Ext.form.Panel',{layout:'form',bodyPadding:'15 15 15 15',fieldDefaults:{labelWidth:150},frame:true,items:[{xtype:'datefield',fieldLabel:'เริ่มต้น',name:'start_date',format:'Y-m-d',allowBlank:false},{xtype:'datefield',fieldLabel:'สิ้นสุด',name:'end_date',format:'Y-m-d',allowBlank:false},{xtype:'textfield',name:'kunnr',fieldLabel:'Customer / Supplier Code',}],buttons:[{text:'ยืนยัน',handler:function(){form=this.up('form').getForm();if(form.isValid()){var result=Ext.create("Account.RPurchaseJournal.Result.Grid");result.loadMask.show();Ext.Ajax.request({url:__base_url+"index.php/rpurchasejournal/result",params:form.getValues(),success:function(response){var rs=response.responseText;rs=Ext.JSON.decode(rs);if(rs.success){result.params=form.getValues();result.storeGrid.loadData(rs.datas);result.show();result.loadMask.hide();}}});}}},{text:'ยกเลิก',handler:function(){form=this.up('form').getForm();form.reset();}}]});this.items=[form];return this.callParent(arguments);}});;Ext.define('Account.RPurchaseJournal.Result.Grid',{extend:'Ext.window.Window',requires:['Ext.ux.grid.FiltersFeature','Ext.ux.DataTip'],title:'Report Purchase Journal',closeAction:'hide',width:780,height:500,resizable:false,modal:true,layout:'fit',maximizable:true,maximized:true,params:{},loadMask:null,initComponent:function(config){this.loadMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."});this.preview=Ext.create('Account.RPurchaseJournal.Item.PreviewWindow');var me=this;var filters={ftype:'filters',encode:false,local:true,filters:[{type:'boolean',dataIndex:'visible'}]};this.storeGrid=Ext.create('Ext.data.ArrayStore',{model:'RPurchaseJournal',fields:[{name:'bldat',type:'date',dateFormat:'Y-m-d'},{name:'belnr'},{name:'invnr'},{name:'name2'},{name:'saknr'},{name:'sgtxt'},{name:'debit',type:'float'},{name:'credi',type:'float'},{name:'statu'},{name:'kunnr'}],data:[],groupers:['bldat','belnr']});this.columnsGrid=[{text:'SV Date',sortable:false,dataIndex:'bldat',renderer:Ext.util.Format.dateRenderer('d/m/Y')},{text:'SV Number',sortable:false,dataIndex:'belnr',filterable:true,filter:{type:'string'}},{text:'Ref. Doc. No.',sortable:false,dataIndex:'invnr'},{text:'Vendor Name',sortable:false,dataIndex:'name2'},{text:'Account Code',sortable:false,dataIndex:'saknr'},{text:'Account Name',sortable:false,dataIndex:'sgtxt'},{text:'Debit',sortable:false,dataIndex:'debit',renderer:Ext.util.Format.numberRenderer('0,000.00'),summaryType:function(records){var i=0,length=records.length,total=0,record;for(i=0;i<length;++i){record=records[i];total+=Number(record.get('debit'));}
return total;},summaryRenderer:function(value,summaryData,index){return'<b>'+Ext.util.Format.number(value,'0,000.00')+'</b>';}},{text:'Credit',sortable:false,dataIndex:'credi',renderer:Ext.util.Format.numberRenderer('0,000.00'),summaryType:function(records){var i=0,length=records.length,total=0,record;for(i=0;i<length;++i){record=records[i];total+=Number(record.get('credi'));}
return total;},summaryRenderer:function(value,summaryData,index){return'<b>'+Ext.util.Format.number(value,'0,000.00')+'</b>';}},{text:'Status',sortable:false,dataIndex:'statu'}];this.grid=Ext.create('Ext.grid.Panel',{store:this.storeGrid,columns:this.columnsGrid,forceFit:true,features:[Ext.create('Ext.ux.grid.feature.MultiGroupingSummary',{id:'group',hideGroupedHeader:false,enableGroupingMenu:true,startCollapsed:true}),{ftype:'summary',dock:'bottom'},filters]});this.items=[this.grid];this.tbar=[{text:"Print",handler:function(){start_date=me.params.start_date;end_date=me.params.end_date;kunnr=me.params.kunnr;comid=1000;params="start_date="+start_date+"&end_date="+end_date+"&kunnr="+kunnr+"&comid="+comid;url=__base_url+'index.php/rpurchasejournal/pdf?'+params;me.preview.openDialog(__base_url+'index.php/rpurchasejournal/pdf?'+params,'_blank');}}];return this.callParent(arguments);}});;Ext.define('Account.RPurchaseVat.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Period Date',name:'bldat',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false}]}];return this.callParent(arguments);},});;Ext.define('Account.RPurchaseVat.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Purchase Vat Report Selection',closeAction:'hide',height:150,width:350,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.RPurchaseVat.Form',{region:'center'});this.previewDialog=Ext.create('Account.RPurchaseVat.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){var form_basic=_this.form.getForm();if(form_basic.isValid()){_this.previewDialog.openDialog(form_basic.getValues());}}});this.buttons=[this.btnPreview,{text:'Cancel',handler:function(){_this.hide();}}];return this.callParent(arguments);}});;Ext.define('Account.RPurchaseVat.PreviewWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Purchase Vat Report',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.items=[new Ext.Panel({region:'center',border:true,items:[{xtype:'component',id:'preview_frame',autoEl:{tag:'iframe',src:'about:blank',frameBorder:0,width:'100%',height:'100%',style:{overflow:'auto'}}}]})];this.copies=new Ext.form.NumberField({name:'copies',allowBlank:false,allowDecimals:false,allowNegative:false,fieldLabel:'Copies',labelAlign:'right',labelWidth:60,value:1,minValue:1,maxValue:500,width:130});this.btnPrint=Ext.create('Ext.Button',{text:'Print',handler:function(){var id='preview_frame';var iframe=document.frames?document.frames[id]:document.getElementById(id);var ifWin=iframe.contentWindow||iframe;iframe.focus();ifWin.do_print();}});this.buttons=[this.copies,this.btnPrint];this.on('hide',function(){Ext.get('preview_frame').set({src:'about:blank'});this.copies.setValue(1);});this.copies.on('change',function(copies,newVal,oldVal){_this.showFrameLoad();Ext.get('preview_frame').set({src:_this.getFrameUrl(_this.dialogParams,newVal)});_this.checkFrameReady(function(){_this.hideFrameLoad();});});return this.callParent(arguments);},dialogParams:null,openDialog:function(form_values){var _this=this;if(form_values&&!Ext.isEmpty(form_values)){this.dialogParams=form_values;this.show(false,function(){Ext.get('preview_frame').set({src:_this.getFrameUrl(form_values,_this.copies.getValue())});_this.showFrameLoad();_this.checkFrameReady(function(){_this.hideFrameLoad();});});}},getFrameUrl:function(params,copies){copies=copies||1;var q_str='';params['copies']=copies;return __site_url+'form/rsumvat/index?'+Ext.urlEncode(params);},checkFrameReady:function(cb){document.getElementById('preview_frame').onload=cb;},showFrameLoad:function(){Ext.MessageBox.show({msg:'Populating preview...',progressText:'Loading...',width:300,wait:true,waitConfig:{interval:200},animateTarget:this});},hideFrameLoad:function(){Ext.MessageBox.hide();}});;Ext.define('Account.RQuotation.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.projectDialog=Ext.create('Account.Project.MainWindow');this.customerDialog=Ext.create('Account.Customer.MainWindow');this.quotationDialog=Ext.create('Account.Quotation.MainWindow');this.projectDialog2=Ext.create('Account.Project.MainWindow');this.customerDialog2=Ext.create('Account.Customer.MainWindow');this.quotationDialog2=Ext.create('Account.Quotation.MainWindow');this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'Project Status',name:'statu',editable:false,triggerAction:'all',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboQStatus2=Ext.create('Ext.form.ComboBox',{name:'statu2',editable:false,triggerAction:'all',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboPSale=Ext.create('Ext.form.ComboBox',{fieldLabel:'Saleperson',name:'salnr',editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select Saleperson --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_scombo',reader:{type:'json',root:'rows',idProperty:'salnr'}},fields:['salnr','name1'],remoteSort:true,sorters:'salnr ASC'}),queryMode:'remote',displayField:'name1',valueField:'salnr'});this.comboPSale2=Ext.create('Ext.form.ComboBox',{name:'salnr2',editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select Saleperson --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_scombo',reader:{type:'json',root:'rows',idProperty:'salnr'}},fields:['salnr','name1'],remoteSort:true,sorters:'salnr ASC'}),queryMode:'remote',displayField:'name1',valueField:'salnr'});this.trigQuotation=Ext.create('Ext.form.field.Trigger',{name:'vbeln',fieldLabel:'Quotation Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigQuotation2=Ext.create('Ext.form.field.Trigger',{name:'vbeln2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigProject=Ext.create('Ext.form.field.Trigger',{name:'jobnr',fieldLabel:'Project Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigProject2=Ext.create('Ext.form.field.Trigger',{name:'jobnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigCustomer=Ext.create('Ext.form.field.Trigger',{name:'kunnr',fieldLabel:'Customer Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigCustomer2=Ext.create('Ext.form.field.Trigger',{name:'kunnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Date',name:'bldat1',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},{xtype:'datefield',name:'bldat2',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigQuotation,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigQuotation2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigProject,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigProject2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},this.trigCustomer,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigCustomer2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboPSale,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.comboPSale2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboQStatus,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.comboQStatus2]}];this.trigQuotation2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'quotation/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.vbeln);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.quotationDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigQuotation2.setValue(record.data.vbeln);grid.getSelectionModel().deselectAll();_this.quotationDialog2.hide();});this.trigQuotation2.onTriggerClick=function(){_this.quotationDialog2.show();};this.trigCustomer2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer2.setValue(record.data.kunnr);grid.getSelectionModel().deselectAll();_this.customerDialog2.hide();});this.trigCustomer2.onTriggerClick=function(){_this.customerDialog2.show();};this.trigProject2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'project/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.jobnr);}else{o.markInvalid('Could not find project code : '+o.getValue());}}});}},this);_this.projectDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigProject2.setValue(record.data.jobnr);grid.getSelectionModel().deselectAll();_this.projectDialog2.hide();});this.trigProject2.onTriggerClick=function(){_this.projectDialog2.show();};this.trigQuotation.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'quotation/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.vbeln);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.quotationDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigQuotation.setValue(record.data.vbeln);grid.getSelectionModel().deselectAll();_this.quotationDialog.hide();});this.trigQuotation.onTriggerClick=function(){_this.quotationDialog.show();};this.trigCustomer.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer.setValue(record.data.kunnr);grid.getSelectionModel().deselectAll();_this.customerDialog.hide();});this.trigCustomer.onTriggerClick=function(){_this.customerDialog.show();};this.trigProject.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'project/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.jobnr);}else{o.markInvalid('Could not find project code : '+o.getValue());}}});}},this);_this.projectDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigProject.setValue(record.data.jobnr);grid.getSelectionModel().deselectAll();_this.projectDialog.hide();});this.trigProject.onTriggerClick=function(){_this.projectDialog.show();};return this.callParent(arguments);},});;Ext.define('Account.RQuotation.Item.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"quotation/loads",reader:{type:'json',root:'rows',idProperty:'vbeln'}},fields:['vbeln','bldat','kunnr','name1','jobnr','jobtx','statx','sname','netwr','ctype'],remoteSort:true,sorters:['vbeln ASC']});this.columns=[{text:"Quotation No",width:100,align:'center',dataIndex:'vbeln',sortable:true},{text:"Quotation Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Customer No",width:100,align:'center',dataIndex:'kunnr',sortable:true},{text:"Customer Name",width:100,dataIndex:'name1',sortable:true},{text:"Project No",width:100,align:'center',dataIndex:'jobnr',sortable:true},{text:"Project Name",width:150,dataIndex:'jobtx',sortable:true},{text:"Status",width:100,align:'center',dataIndex:'statx',sortable:true},{text:"Sale Name",width:120,dataIndex:'sname',sortable:true},{text:"Amount",width:100,align:'right',dataIndex:'netwr',sortable:true},{text:"Currency",width:80,align:'center',dataIndex:'ctype',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.RQuotation.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Quotation Report',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.RQuotation.Item.Grid',{region:'center',border:false});this.items=[this.grid];return this.callParent(arguments);}});;Ext.define('Account.RQuotation.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Quotation Selection',closeAction:'hide',height:250,width:500,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.itemDialog=Ext.create('Account.RQuotation.Item.Window');this.form=Ext.create('Account.RQuotation.Form',{region:'center'});this.items=[this.form];this.buttons=[{text:'Report',handler:function(){_this.itemDialog.show();_this.itemDialog.grid.load();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];this.itemDialog.grid.store.on('beforeload',function(store){var formValues=_this.form.getForm().getValues();store.getProxy().extraParams=formValues;});return this.callParent(arguments);}});;Ext.define('Account.RReceipt.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.receiptDialog=Ext.create('Account.Receipt.MainWindow');this.invoiceDialog=Ext.create('Account.Invoice.MainWindow');this.customerDialog=Ext.create('Account.Customer.MainWindow');this.receiptDialog2=Ext.create('Account.Receipt.MainWindow');this.invoiceDialog2=Ext.create('Account.Invoice.MainWindow');this.customerDialog2=Ext.create('Account.Customer.MainWindow');this.trigReceipt=Ext.create('Ext.form.field.Trigger',{name:'recnr',labelWidth:100,fieldLabel:'Receipt Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigReceipt2=Ext.create('Ext.form.field.Trigger',{name:'recnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigInvoice=Ext.create('Ext.form.field.Trigger',{name:'invnr',labelWidth:100,fieldLabel:'Invoice Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigInvoice2=Ext.create('Ext.form.field.Trigger',{name:'invnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.trigCustomer=Ext.create('Ext.form.field.Trigger',{name:'kunnr',fieldLabel:'Customer Code',triggerCls:'x-form-search-trigger',labelWidth:100,enableKeyEvents:true});this.trigCustomer2=Ext.create('Ext.form.field.Trigger',{name:'kunnr2',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'Receipt Status',name:'statu',labelWidth:100,editable:false,triggerAction:'all',triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'invoice/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Document Date',name:'bldat',labelWidth:100,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},{xtype:'datefield',name:'bldat2',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigReceipt,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigReceipt2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigInvoice,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigInvoice2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},this.trigCustomer,{xtype:'displayfield',value:'To',width:40,margins:'0 0 0 25'},this.trigCustomer2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboQStatus,{xtype:'displayfield',value:'To',hidden:true,width:40,margins:'0 0 0 25'},this.comboQStatus2]}];this.trigReceipt.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'receipt/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.recnr);}else{o.markInvalid('Could not find receipt code : '+o.getValue());}}});}},this);this.trigReceipt2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'receipt/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.recnr);}else{o.markInvalid('Could not find receipt code : '+o.getValue());}}});}},this);_this.receiptDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigReceipt.setValue(record.data.recnr);grid.getSelectionModel().deselectAll();_this.receiptDialog.hide();});_this.receiptDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigReceipt2.setValue(record.data.recnr);grid.getSelectionModel().deselectAll();_this.receiptDialog2.hide();});this.trigReceipt.onTriggerClick=function(){_this.receiptDialog.show();};this.trigReceipt2.onTriggerClick=function(){_this.receiptDialog2.show();};this.trigInvoice.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.invnr);}else{o.markInvalid('Could not find invoice code : '+o.getValue());}}});}},this);this.trigInvoice2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.invnr);}else{o.markInvalid('Could not find invoice code : '+o.getValue());}}});}},this);_this.invoiceDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigInvoice.setValue(record.data.invnr);grid.getSelectionModel().deselectAll();_this.invoiceDialog.hide();});_this.invoiceDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigInvoice2.setValue(record.data.invnr);grid.getSelectionModel().deselectAll();_this.invoiceDialog2.hide();});this.trigInvoice.onTriggerClick=function(){_this.invoiceDialog.show();};this.trigInvoice2.onTriggerClick=function(){_this.invoiceDialog2.show();};this.trigCustomer.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer.setValue(record.data.kunnr);grid.getSelectionModel().deselectAll();_this.customerDialog.hide();});this.trigCustomer.onTriggerClick=function(){_this.customerDialog.show();};this.trigCustomer2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog2.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer2.setValue(record.data.kunnr);grid.getSelectionModel().deselectAll();_this.customerDialog2.hide();});this.trigCustomer2.onTriggerClick=function(){_this.customerDialog2.show();};return this.callParent(arguments);},});;Ext.define('Account.RReceipt.Item.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"receipt/loads_report",reader:{type:'json',root:'rows',idProperty:function(o){return o.recnr+o.vbelp;}},simpleSortMode:true},fields:['recnr','vbelp','bldat','kunnr','name1','invnr','invdt','itamt','netwr','paytx'],remoteSort:true,sorters:[{property:'recnr',direction:'ASC'}],});this.columns=[{text:"Receipt No",width:90,align:'center',dataIndex:'recnr',sortable:true},{text:"Document Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Customer Code",width:90,align:'center',dataIndex:'invnr',sortable:true},{text:"Customer Name",width:160,dataIndex:'name1',sortable:true},{text:"Net Amount",width:90,align:'right',dataIndex:'netwr',xtype:'numbercolumn',sortable:true},{text:"Invoice No",width:90,align:'center',dataIndex:'invnr',sortable:true},{text:"Invoice Date",width:80,align:'center',dataIndex:'kunnr',sortable:true},{text:"Amount",width:90,align:'right',dataIndex:'itamt',xtype:'numbercolumn',sortable:true},{text:"Received by",width:150,dataIndex:'paytx',align:'left',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.RReceipt.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Receipt Report',closeAction:'hide',height:600,minHeight:380,width:900,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.txtParam=Ext.create('Ext.form.Text',{width:300});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',handler:function(){var param=_this.txtParam.getValue();window.location=__site_url+'export/rreceipt/Index?'+param;}});this.grid=Ext.create('Account.RReceipt.Item.Grid',{region:'center',border:false});this.items=[this.grid];this.tbar=[this.excelAct];return this.callParent(arguments);}});;Ext.define('Account.RReceipt.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Receipt Selection',closeAction:'hide',height:240,width:500,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.itemDialog=Ext.create('Account.RReceipt.Item.Window');this.form=Ext.create('Account.RReceipt.Form',{region:'center'});this.items=[this.form];this.buttons=[{text:'Report',handler:function(){_this.itemDialog.show();_this.itemDialog.grid.load();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];this.itemDialog.grid.store.on('beforeload',function(store){var formValues=_this.form.getForm().getValues();store.getProxy().extraParams=formValues;});return this.callParent(arguments);}});;Ext.define('Account.RSaleJournal.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){var _this=this;Ext.apply(this,{title:'Sale Journal preview',enableCopies:false});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);}});;Ext.define('Account.RSaleJournal.MainWindow',{extend:'Ext.window.Window',title:'Report Sale Journal',closeAction:'hide',width:420,height:220,resizable:false,modal:true,layout:'fit',maximizable:false,initComponent:function(config){var form=Ext.create('Ext.form.Panel',{layout:'form',bodyPadding:'15 15 15 15',fieldDefaults:{labelWidth:150},frame:true,items:[{xtype:'datefield',fieldLabel:'เริ่มต้น',name:'start_date',format:'Y-m-d',allowBlank:false},{xtype:'datefield',fieldLabel:'สิ้นสุด',name:'end_date',format:'Y-m-d',allowBlank:false},{xtype:'textfield',name:'kunnr',fieldLabel:'Customer / Supplier Code',}],buttons:[{text:'ยืนยัน',handler:function(){form=this.up('form').getForm();if(form.isValid()){var result=Ext.create("Account.RSaleJournal.Result.Grid");result.loadMask.show();Ext.Ajax.request({url:__base_url+"index.php/rsalejournal/result",params:form.getValues(),success:function(response){var rs=response.responseText;rs=Ext.JSON.decode(rs);if(rs.success){result.params=form.getValues();result.storeGrid.loadData(rs.datas);result.show();result.loadMask.hide();}}});}}},{text:'ยกเลิก',handler:function(){form=this.up('form').getForm();form.reset();}}]});this.items=[form];return this.callParent(arguments);}});;Ext.define('Account.RSaleJournal.Result.Grid',{extend:'Ext.window.Window',requires:['Ext.ux.grid.FiltersFeature','Ext.ux.DataTip'],title:'Report Sale Journal',closeAction:'hide',width:780,height:500,resizable:false,modal:true,layout:'fit',maximizable:true,maximized:true,params:{},loadMask:null,initComponent:function(config){this.loadMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."});this.preview=Ext.create('Account.RSaleJournal.Item.PreviewWindow');var me=this;var filters={ftype:'filters',encode:false,local:true,filters:[{type:'boolean',dataIndex:'visible'}]};this.storeGrid=Ext.create('Ext.data.ArrayStore',{model:'RSaleJournal',fields:[{name:'bldat',type:'date',dateFormat:'Y-m-d'},{name:'belnr'},{name:'invnr'},{name:'name1'},{name:'saknr'},{name:'sgtxt'},{name:'debit',type:'float'},{name:'credi',type:'float'},{name:'statu'},{name:'kunnr'}],data:[],groupers:['bldat','belnr']});this.columnsGrid=[{text:'SV Date',sortable:false,dataIndex:'bldat',renderer:Ext.util.Format.dateRenderer('d/m/Y')},{text:'SV Number',sortable:false,dataIndex:'belnr',filterable:true,filter:{type:'string'}},{text:'Ref. Doc. No.',sortable:false,dataIndex:'invnr'},{text:'Customer',sortable:false,dataIndex:'name1'},{text:'Account Code',sortable:false,dataIndex:'saknr'},{text:'Account Name',sortable:false,dataIndex:'sgtxt'},{text:'Debit',sortable:false,dataIndex:'debit',renderer:Ext.util.Format.numberRenderer('0,000.00'),summaryType:function(records){var i=0,length=records.length,total=0,record;for(i=0;i<length;++i){record=records[i];total+=Number(record.get('debit'));}
return total;},summaryRenderer:function(value,summaryData,index){return'<b>'+Ext.util.Format.number(value,'0,000.00')+'</b>';}},{text:'Credit',sortable:false,dataIndex:'credi',renderer:Ext.util.Format.numberRenderer('0,000.00'),summaryType:function(records){var i=0,length=records.length,total=0,record;for(i=0;i<length;++i){record=records[i];total+=Number(record.get('credi'));}
return total;},summaryRenderer:function(value,summaryData,index){return'<b>'+Ext.util.Format.number(value,'0,000.00')+'</b>';}},{text:'Status',sortable:false,dataIndex:'statu'}];this.grid=Ext.create('Ext.grid.Panel',{store:this.storeGrid,columns:this.columnsGrid,forceFit:true,features:[Ext.create('Ext.ux.grid.feature.MultiGroupingSummary',{id:'group',hideGroupedHeader:false,enableGroupingMenu:true,startCollapsed:true}),{ftype:'summary',dock:'bottom'},filters]});this.items=[this.grid];this.tbar=[{text:"Print",handler:function(){start_date=me.params.start_date;end_date=me.params.end_date;kunnr=me.params.kunnr;comid=1000;params="start_date="+start_date+"&end_date="+end_date+"&kunnr="+kunnr+"&comid="+comid;url=__base_url+'index.php/rsalejournal/pdf?'+params;me.preview.openDialog(__base_url+'index.php/rsalejournal/pdf?'+params,'_blank');}}];return this.callParent(arguments);}});;Ext.define('Account.RSumVat.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.items=[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'datefield',fieldLabel:'Period Date',name:'bldat',format:'d/m/Y',value:new Date,altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false}]}];return this.callParent(arguments);},});;Ext.define('Account.RSumVat.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Vat Report Selection',closeAction:'hide',height:130,width:450,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.RSumVat.Form',{region:'center'});this.previewDialog=Ext.create('Account.RSumVat.PreviewWindow');this.previewDialog2=Ext.create('Account.RSumVat.PreviewWindow2');this.previewDialog3=Ext.create('Account.RSumVat.PreviewWindow3');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'รายงานภาษีมูลค่าเพิ่ม',handler:function(){var form_basic=_this.form.getForm();if(form_basic.isValid()){_this.previewDialog.openDialog(form_basic.getValues());}}});this.btnPreview2=Ext.create('Ext.Button',{text:'รายงานภาษีขาย',handler:function(){var form_basic=_this.form.getForm();if(form_basic.isValid()){_this.previewDialog2.openDialog(form_basic.getValues());}}});this.btnPreview3=Ext.create('Ext.Button',{text:'รายงานภาษีซื้อ',handler:function(){var form_basic=_this.form.getForm();if(form_basic.isValid()){_this.previewDialog3.openDialog(form_basic.getValues());}}});this.buttons=[this.btnPreview2,this.btnPreview3,this.btnPreview];return this.callParent(arguments);}});;Ext.define('Account.RSumVat.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){var _this=this;Ext.apply(this,{title:'รายงานภาษีมูลค่าเพิ่ม',closeAction:'hide',height:600,width:1000,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center',enableCopies:true});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(params,copies){copies=copies||1;var q_str='';params['copies']=copies;return __site_url+'form/rsumvat/index?'+Ext.urlEncode(params);}});;Ext.define('Account.RSumVat.PreviewWindow2',{extend:'BASE.PreviewWindow',constructor:function(config){var _this=this;Ext.apply(this,{title:'รายงานภาษีขาย',enableCopies:true});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(params,copies){copies=copies||1;var q_str='';params['copies']=copies;return __site_url+'form/rsalevat/index?'+Ext.urlEncode(params);}});;Ext.define('Account.RSumVat.PreviewWindow3',{extend:'BASE.PreviewWindow',constructor:function(config){var _this=this;Ext.apply(this,{title:'รายงานภาษีซื้อ',enableCopies:true});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(params,copies){copies=copies||1;var q_str='';params['copies']=copies;return __site_url+'form/rpurchasevat/index?'+Ext.urlEncode(params);}});;Ext.define('Account.RTrialBalance.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){var _this=this;Ext.apply(this,{title:'Trial Balance preview',enableCopies:false});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);}});;Ext.define('Account.RTrialBalance.MainWindow',{extend:'Ext.window.Window',title:'Report Trial Balance',closeAction:'hide',width:320,height:220,resizable:false,modal:true,layout:'fit',maximizable:false,initComponent:function(config){var _this=this;this.previewDialog=Ext.create('Account.RTrialBalance.Item.PreviewWindow');var form=Ext.create('Ext.form.Panel',{layout:'form',bodyPadding:'15 15 15 15',fieldDefaults:{labelWidth:50},frame:true,items:[{xtype:'datefield',fieldLabel:'เริ่มต้น',name:'start_date',format:'Y-m-d',allowBlank:false},{xtype:'datefield',fieldLabel:'สิ้นสุด',name:'end_date',format:'Y-m-d',allowBlank:false}],buttons:[{text:'ยืนยัน',handler:function(){start_date=form.form.findField('start_date').getValue();start_date=Ext.Date.format(start_date,'Y-m-d');end_date=form.form.findField('end_date').getValue();end_date=Ext.Date.format(end_date,'Y-m-d');params="start_date="+start_date+"&end_date="+end_date;url=__base_url+'index.php/rtrialbalance/pdf?'+params;_this.previewDialog.openDialog(__base_url+'index.php/rtrialbalance/pdf?'+params,'_blank');}},{text:'ยกเลิก',handler:function(){form=this.up('form').getForm();form.reset();}}]});this.items=[form];this.callParent(arguments);}});;Ext.define('RTrialBalance',{extend:'Ext.data.Model',fields:['bldat','belnr','invnr','name1','saknr','sgtxt','debit','credi','statu']});Ext.define('Account.RTrialBalance.Result.Grid',{extend:'Ext.window.Window',requires:['Ext.ux.grid.FiltersFeature','Ext.ux.DataTip'],title:'Report Trial Balance',closeAction:'hide',width:780,height:500,resizable:false,modal:true,layout:'fit',maximizable:false,params:{},initComponent:function(config){var me=this;var filters={ftype:'filters',encode:false,local:true,filters:[{type:'boolean',dataIndex:'visible'}]};this.storeGrid=Ext.create('Ext.data.ArrayStore',{model:'RGeneralJournal',fields:[{name:'bldat',type:'date',dateFormat:'Y-m-d'},{name:'belnr'},{name:'invnr'},{name:'name1'},{name:'saknr'},{name:'sgtxt'},{name:'debit',type:'float'},{name:'credi',type:'float'},{name:'statu'}],data:[],groupers:['bldat','belnr']});this.columnsGrid=[{text:'SV Date',sortable:false,dataIndex:'bldat',renderer:Ext.util.Format.dateRenderer('d/m/Y')},{text:'SV Number',sortable:false,dataIndex:'belnr',filterable:true,filter:{type:'string'}},{text:'Ref. Doc. No.',sortable:false,dataIndex:'invnr'},{text:'Customer',sortable:false,dataIndex:'name1'},{text:'Account Code',sortable:false,dataIndex:'saknr'},{text:'Account Name',sortable:false,dataIndex:'sgtxt'},{text:'Debit',sortable:false,dataIndex:'debit',renderer:Ext.util.Format.numberRenderer('0,000.00'),summaryType:function(records){var i=0,length=records.length,total=0,record;for(i=0;i<length;++i){record=records[i];total+=Number(record.get('debit'));}
return total;},summaryRenderer:function(value,summaryData,index){return'<b>'+Ext.util.Format.number(value,'0,000.00')+'</b>';}},{text:'Credit',sortable:false,dataIndex:'credi',renderer:Ext.util.Format.numberRenderer('0,000.00'),summaryType:function(records){var i=0,length=records.length,total=0,record;for(i=0;i<length;++i){record=records[i];total+=Number(record.get('debit'));}
return total;},summaryRenderer:function(value,summaryData,index){return'<b>'+Ext.util.Format.number(value,'0,000.00')+'</b>';}},{text:'Status',sortable:false,dataIndex:'statu'}];this.grid=Ext.create('Ext.grid.Panel',{store:this.storeGrid,columns:this.columnsGrid,forceFit:true,features:[Ext.create('Ext.ux.grid.feature.MultiGroupingSummary',{id:'group',hideGroupedHeader:false,enableGroupingMenu:true,startCollapsed:true}),{ftype:'summary',dock:'bottom'},filters]});this.items=[this.grid];this.tbar=[{text:"Print",handler:function(){start_date=me.params.start_date;end_date=me.params.end_date;params="start_date="+start_date+"&end_date="+end_date;window.open(__base_url+'index.php/rgeneraljournal/pdf?'+params,'_blank');}}];this.callParent(arguments);}});;Ext.define('Account.SaleCreditNote.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Credit Note No, Customer or Invoice No.',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.SaleCreditNote.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"creditnote/loads_cns",reader:{type:'json',root:'rows',idProperty:'crenr',totalProperty:'totalCount'},simpleSortMode:true},fields:['crenr','bldat','invnr','kunnr','name1','txz01','statx','netwr','ctype'],remoteSort:true,sorters:[{property:'crenr',direction:'ASC'}]});this.columns=[{text:"Credit Note No",width:100,align:'center',dataIndex:'crenr',sortable:true},{text:"Doc Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Invoice No",width:80,align:'center',dataIndex:'invnr',sortable:true},{text:"Customer No",width:80,align:'center',dataIndex:'kunnr',sortable:true},{text:"Customer Name",width:150,dataIndex:'name1',sortable:true},{text:"Text Note",width:200,dataIndex:'txz01',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Amount",xtype:'numbercolumn',width:80,align:'right',dataIndex:'netwr',sortable:true},{text:"Currency",width:60,align:'center',dataIndex:'ctype',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.SaleCreditNote.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'creditnote/save_cns',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.invDialog=Ext.create('Account.Invoice.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.customerDialog=Ext.create('Account.Customer.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.gridItem=Ext.create('Account.SaleCreditNote.Item.Grid_i',{title:'Credit Items',height:320,region:'center'});this.gridItemIT=Ext.create('Account.SaleCreditNote.Item.Grid_it',{height:320,region:'center'});this.gridGL=Ext.create('Account.SaleCreditNote.Item.Grid_gl',{border:true,region:'center',title:'GL Posting'});this.formTotal=Ext.create('Account.SaleCreditNote.Item.Form_t',{border:true,split:true,title:'GR Total',region:'south'});this.gridPrice=Ext.create('Account.SaleCreditNote.Item.Grid_pc',{border:true,split:true,title:'Item Pricing',region:'south'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('SN'),fieldLabel:'Credit Note Status',name:'statu',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat Type',name:'taxnr',width:240,labelAlign:'right',editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select data --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payments',name:'ptype',width:280,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.hdnCnItem=Ext.create('Ext.form.Hidden',{name:'vbcp'});this.hdnGlItem=Ext.create('Ext.form.Hidden',{name:'bcus',});this.trigInv=Ext.create('Ext.form.field.Trigger',{name:'invnr',fieldLabel:'Invoice No',labelAlign:'letf',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigCustomer=Ext.create('Ext.form.field.Trigger',{name:'kunnr',fieldLabel:'Customer Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',labelAlign:'right',width:170,hideTrigger:false,align:'right'});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:240,labelAlign:'right',allowBlank:false});this.numberVat=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Vat Value',name:'taxpr',labelAlign:'right',width:170,align:'right'});this.numberWHT=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'WHT Value',name:'whtpr',labelAlign:'right',width:170,align:'right'});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnCnItem,this.hdnGlItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'loekz'},{xtype:'hidden',name:'id'},this.trigInv,{xtype:'displayfield',width:290,allowBlank:true},{xtype:'displayfield',fieldLabel:'Credit Note No',name:'crenr',value:'CNXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'container',flex:0,layout:'anchor',items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigCustomer,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:160,allowBlank:true}]},{xtype:'textarea',fieldLabel:'Customer Address',name:'adr01',width:450,rows:3,},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboPay,this.numberVat]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Reference No',width:280,name:'refnr',},this.numberWHT]}]},{xtype:'container',flex:0,layout:'anchor',margin:'0 0 0 70',items:[this.comboPtype,{xtype:'datefield',fieldLabel:'Credit Note Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',},this.comboTax,this.trigCurrency,{xtype:'container',layout:'hbox',defaultType:'textfield',margin:'0 0 5 0',items:[this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:25,value:'Days'}]},{xtype:'datefield',fieldLabel:'Due Date',name:'duedt',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},this.comboQStatus]}]}]}]};this.items=[mainFormPanel,{xtype:'tabpanel',region:'center',activeTab:0,border:false,items:[this.gridItem,{xtype:'panel',border:false,title:'Invoice Items',layout:'border',items:[this.gridItemIT]}]},{xtype:'tabpanel',region:'south',activeTab:0,height:200,items:[this.formTotal,this.gridPrice,this.gridGL]}];this.trigInv.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.invnr);_this.getForm().findField('kunnr').setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('loekz').setValue(r.data.loekz);}else{o.markInvalid('Could not find Purchase no : '+o.getValue());}}});}},this);_this.invDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigInv.setValue(record.data.invnr);_this.getForm().findField('kunnr').setValue(record.data.kunnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.invnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'invoice/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('loekz').setValue(r.data.loekz);}}});grid.getSelectionModel().deselectAll();var grdinvnr=_this.trigInv.value;_this.gridItemIT.load({invnr:grdinvnr});_this.invDialog.hide();});this.trigInv.onTriggerClick=function(){_this.invDialog.show();};this.trigCustomer.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer.setValue(record.data.kunnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.kunnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'customer/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}}});grid.getSelectionModel().deselectAll();_this.customerDialog.hide();});this.trigCustomer.onTriggerClick=function(){_this.customerDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);_this.formTotal.getForm().findField('curr').setValue(r.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctyp1',r.data.ctype);});_this.gridItem.curValue=r.data.ctype;}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);_this.formTotal.getForm().findField('curr1').setValue(record.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctyp1',record.data.ctype);});_this.gridItem.curValue=record.data.ctype;grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.gridItem.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.gridItem.getSelectionModel().on('viewready',this.onViewReady,this);this.numberCredit.on('keyup',this.getDuedate,this);this.numberCredit.on('change',this.getDuedate,this);this.comboTax.on('change',this.calculateTotal,this);return this.callParent(arguments);},onSelectChange:function(selModel,selections){var _this=this;var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vat:sel.get('chk01')});}},onViewReady:function(grid){grid.getSelectionModel().select(0);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'creditnote/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnCnItem.setValue(Ext.encode(rsItem));var rsGL=_this.gridGL.getData();this.hdnGlItem.setValue(Ext.encode(rsGL));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(mbeln){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'creditnote/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({crenr:0});this.gridItemIT.load({invnr:0});this.gridGL.load({netpr:0});this.comboQStatus.setValue('01');this.comboTax.setValue('01');this.trigCurrency.setValue('THB');this.numberVat.setValue(7);this.numberWHT.setValue(3);this.getForm().findField('bldat').setValue(new Date());this.formTotal.getForm().findField('exchg').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=this.gridItem.store;var sum2=0;var sum=0;var vats=0;var whts=0;var discounts=0;var saknr_list=[];var vattype=this.comboTax.getValue();store.each(function(r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']),discount=parseFloat(r.data['disit']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;discount=isNaN(discount)?0:discount;var amt=qty*price;if(vattype=='02'){amt=amt*100;amt=amt/107;}
sum+=amt;discounts+=discount;amt=amt-discount;sum2+=amt;if(r.data['chk01']==true){var vat=_this.numberVat.getValue();vat=(amt*vat)/100;vats+=vat;}
if(r.data['chk02']==true){var wht=_this.numberWHT.getValue();wht=(amt*wht)/100;whts+=wht;}
var item=r.data['saknr']+'|'+amt;saknr_list.push(item);});this.formTotal.getForm().findField('beamt').setValue(sum);this.formTotal.getForm().findField('vat01').setValue(vats);this.formTotal.getForm().findField('wht01').setValue(whts);this.formTotal.getForm().findField('dismt').setValue(discounts);this.formTotal.calculate();this.gridItem.vattValue=this.comboTax.getValue();this.gridItem.vatValue=this.numberVat.getValue();var currency=this.trigCurrency.getValue();this.gridItem.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);this.formTotal.getForm().findField('vat01').setValue(vats);var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:vattype});}
if(currency!='THB'){var rate=this.formTotal.getForm().findField('exchg').getValue();sum=sum*rate;sum2=sum2*rate;vats=vats*rate;}
if(sum>0&&this.trigCustomer.getValue()!=''){_this.gridGL.load({netpr:sum2,vvat:vats,kunnr:this.trigCustomer.getValue(),items:saknr_list.join(',')});}},getDuedate:function(){var bForm=this.getForm(),credit=this.numberCredit.getValue(),startDate=bForm.findField('bldat').getValue();if(!Ext.isEmpty(credit)&&credit>0){var result=Ext.Date.add(startDate,Ext.Date.DAY,credit),dueDateField=bForm.findField('duedt');if(!Ext.isEmpty(credit)&&!Ext.isEmpty(dueDateField))
dueDateField.setValue(result);}}});;Ext.define('Account.SaleCreditNote.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'creditnote/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',}});return this.callParent(arguments);},initComponent:function(){var _this=this;var myStorecomboWHTno=Ext.create('Ext.data.Store',{fields:['idWHT','name'],data:[{"idWHT":"01","name":"นิติบุคคล"},{"idWHT":"02","name":"บุคคลธรรมดา"}]});this.whtDialog=Ext.create('Account.WHT.Window');this.trigWHT=Ext.create('Ext.form.field.Trigger',{name:'whtnr',labelAlign:'letf',width:50,triggerCls:'x-form-search-trigger',enableKeyEvents:true,margin:'4 0 0 10'});this.comboWHType=Ext.create('Ext.form.ComboBox',{fieldLabel:'Witholding Tax',name:'whtyp',width:240,triggerAction:'all',clearFilterOnReset:true,emptyText:'--Select WHT Typ--',margin:'4 0 0 0',store:myStorecomboWHTno,labelAlign:'left',queryMode:'local',displayField:'name',valueField:'idWHT'});this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',xtype:'textfield',fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:150,width:270,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt',align:'right',width:270,labelWidth:150,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',name:'vat01',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,margin:'4 0 0 0',readOnly:true});this.txtWHTValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'WHT Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,name:'wht01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:270,hideTrigger:true,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',alwaysDisplayDecimals:true,style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'},{xtype:'container',layout:'hbox',anchor:'100%',items:[this.comboWHType,this.trigWHT,{xtype:'textfield',name:'whtxt',margin:'4 0 0 7',width:250}]}]},{xtype:'container',layout:'anchor',margins:'0 0 0 15',items:[this.txtTotal,this.txtDiscountValue,this.txtDiscountSum,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];this.trigWHT.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/loads_wht',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.whtnr);if(r.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(r.data.whtxt);}}else{o.markInvalid('Could not find wht code : '+o.getValue());}}});}},this);_this.whtDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigWHT.setValue(record.data.whtnr);if(record.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(record.data.whtxt);}
grid.getSelectionModel().deselectAll();_this.whtDialog.hide();});this.trigWHT.onTriggerClick=function(){_this.whtDialog.show();};var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtTaxValue.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtWHTValue.on('render',setAlignRight);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'creditnote/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},calculate:function(){var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discountValue=this.txtDiscountValue.getValue();if(discountValue>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var wht=this.txtWHTValue.getValue();var net=(total-discountValue)+(vat-wht);this.txtNet.setValue(net);}});;Ext.define('Account.SaleCreditNote.Item.Grid_gl',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"creditnote/loads_gl_items",reader:{type:'json',root:'rows',idProperty:function(o){return o.belnr+o.belpr;}}},fields:['belnr','belpr','saknr','sgtxt','debit','credi','txz01','statu'],remoteSort:true,sorters:['belpr ASC']});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete GL Item',scope:this,handler:this.removeRecord}]},{id:'RowNumber25',text:"No.",dataIndex:'belpr',width:50,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"GL No.",width:100,dataIndex:'saknr',align:'center',sortable:false,},{text:"GL Description",width:215,dataIndex:'sgtxt',sortable:true},{text:"Debit",width:100,dataIndex:'debit',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2},{text:"Credit",width:100,dataIndex:'credi',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2},{text:"Comment",width:250,dataIndex:'txz01',sortable:true,field:{type:'textfield'}}];this.plugins=[this.editing];return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addDefaultRecord:function(){this.store.removeAll();var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;for(var i=0;i<5;i++){rec={id:i};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();}},addRecord2:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();},removeRecord2:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow2();},runNumRow2:function(){var row_num=0;this.store.each(function(r){r.set('belpr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.SaleCreditNote.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMaterial.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"creditnote/loads_cn_items",reader:{type:'json',root:'rows',idProperty:function(o){return o.crenr+o.vbelp;}}},fields:['vbelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctyp1','chk01','chk02','saknr'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Credit Note Item',scope:this,handler:this.removeRecord}]},{id:'CNiRowNumber1',header:"Items",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:80,dataIndex:'matnr',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.materialDialog.show();}},},{text:"Description",width:220,dataIndex:'maktx',sortable:false,field:{type:'textfield'},},{text:"Qty",xtype:'numbercolumn',width:70,dataIndex:'menge',sortable:false,align:'right',field:{type:'numberfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Unit",width:50,dataIndex:'meins',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.unitDialog.show();}},},{text:"Price/Unit",xtype:'numbercolumn',width:100,dataIndex:'unitp',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Discount",xtype:'numbercolumn',width:80,dataIndex:'disit',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{xtype:'checkcolumn',text:'Vat',dataIndex:'chk01',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{xtype:'checkcolumn',text:'WHT',dataIndex:'chk02',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Amount",width:90,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:65,dataIndex:'ctyp1',sortable:false,align:'center',field:{type:'textfield'},},{dataIndex:'saknr',width:55,sortable:false}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='matnr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.matnr);rModel.set('maktx',r.data.maktx);rModel.set('meins',r.data.meins);rModel.set('saknr',r.data.saknr);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.materialDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('matnr',record.data.matnr);rModel.set('maktx',record.data.maktx);rModel.set('meins',record.data.meins);rModel.set('saknr',record.data.saknr);}
grid.getSelectionModel().deselectAll();_this.materialDialog.hide();});_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('meins',record.data.meins);}
grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});this.store.on('load',function(store,rs){if(_this.readOnly){var view=_this.getView();var t=_this.getView().getEl().down('table');t.addCls('mask-grid-readonly');_this.readOnlyMask=new Ext.LoadMask(t,{msg:"..."});_this.readOnlyMask.show();}else{if(_this.readOnlyMask)
_this.readOnlyMask.hide();}});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,ctyp1:'THB'};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.SaleCreditNote.Item.Grid_it',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMaterial.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"creditnote/loads_items",reader:{type:'json',root:'rows',idProperty:function(o){return o.crenr+o.vbelp;}}},fields:['vbelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctype','chk01','chk02','saknr'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,},{id:'CNiRowNumber11',header:"Items",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:80,dataIndex:'matnr',sortable:false,},{text:"Description",width:220,dataIndex:'maktx',sortable:false,},{text:"Qty",xtype:'numbercolumn',width:70,dataIndex:'menge',sortable:false,align:'right',},{text:"Unit",width:50,dataIndex:'meins',sortable:false,},{text:"Price/Unit",xtype:'numbercolumn',width:100,dataIndex:'unitp',sortable:false,align:'right',},{text:"Discount",xtype:'numbercolumn',width:80,dataIndex:'disit',sortable:false,align:'right',},{xtype:'checkcolumn',text:'Vat',disabled:true,dataIndex:'chk01',width:30,},{xtype:'checkcolumn',text:'WHT',disabled:true,dataIndex:'chk02',width:30,},{text:"Amount",width:90,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:65,dataIndex:'ctype',sortable:false,align:'center',},{dataIndex:'saknr',hidden:true,sortable:false}];this.plugins=[this.editing];return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,ctype:'THB'};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.SaleCreditNote.Item.Grid_pc',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"invoice/loads_conp_item",reader:{type:'json',root:'rows',idProperty:'conty'}},fields:['conty','contx','vtamt','ttamt'],remoteSort:true,sorters:['conty ASC']});this.columns=[{text:"Condition type",width:170,dataIndex:'contx',sortable:true},{text:"Amount",width:100,xtype:'numbercolumn',dataIndex:'vtamt',sortable:true,align:'right'},{text:"Condition Amount",xtype:'numbercolumn',width:120,dataIndex:'ttamt',align:'right'}];return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.SaleCreditNote.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'Credit Note preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/salecreditnote/index/'+id+'/'+copies;}});;Ext.define('Account.SaleCreditNote.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Credit Note',closeAction:'hide',height:650,width:900,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.SaleCreditNote.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.SaleCreditNote.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.btnSave=Ext.create('Ext.Button',{text:'Save',disabled:!(UMS.CAN.CREATE('SN')||UMS.CAN.EDIT('SN')||UMS.CAN.APPROVE('SN')),handler:function(){_this.form.save();}});this.buttons=[this.btnSave,{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({crenr:id});this.form.gridItemIT.load({crenr:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}},setReadOnly:function(readOnly){var children=this.items?this.items.items:[];for(var i=0;i<children.length;i++){var child=children[i];child.query('.field').forEach(function(c){if(!c.initialConfig.readOnly){c.setReadOnly(readOnly);}});child.query('.button').forEach(function(c){if(c.xtype!='tab'){if(!c.initialConfig.disabled)
c.setDisabled(readOnly);}});}
this.form.gridItem.readOnly=readOnly;if(!this.btnSave.initialConfig.disabled)
this.btnSave.setDisabled(readOnly);}});;Ext.define('Account.SaleCreditNote.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Credit Note',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;var fibasic=Ext.create('Ext.form.field.File',{width:200,x:50,y:50,hideLabel:true});this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('SN')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('SN')||UMS.CAN.CREATE('SN')||UMS.CAN.EDIT('SN'))});this.displayAct=new Ext.Action({text:'Display',iconCls:'b-small-search',disabled:!UMS.CAN.DISPLAY('SN')});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('SN')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('SN')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.SaleCreditNote.Item.Window');this.grid=Ext.create('Account.SaleCreditNote.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.displayAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.SaleCreditNote.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(false);}});this.displayAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(true);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save Credit Note number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/salecreditnote/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.SaleDebitNote.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Debit Note No, Customer or Invoice No.',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.SaleDebitNote.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"debitnote/loads_dns",reader:{type:'json',root:'rows',idProperty:'debnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['debnr','bldat','invnr','lifnr','name1','txz01','statx','netwr','ctype'],remoteSort:true,sorters:[{property:'debnr',direction:'ASC'}]});this.columns=[{text:"Debit Note No",width:100,align:'center',dataIndex:'debnr',sortable:true},{text:"Doc Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Invoice No",width:80,align:'center',dataIndex:'invnr',sortable:true},{text:"Customer No",width:80,align:'center',dataIndex:'kunnr',sortable:true},{text:"Customer Name",width:150,dataIndex:'name1',sortable:true},{text:"Text Note",width:200,dataIndex:'txz01',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Amount",xtype:'numbercolumn',width:80,align:'right',dataIndex:'netwr',sortable:true},{text:"Currency",width:60,align:'center',dataIndex:'ctype',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.SaleDebitNote.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'debitnote/save_dns',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.invDialog=Ext.create('Account.Invoice.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.customerDialog=Ext.create('Account.Customer.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.gridItem=Ext.create('Account.SaleDebitNote.Item.Grid_i',{title:'Debit Items',height:320,region:'center'});this.gridItemIT=Ext.create('Account.SaleDebitNote.Item.Grid_it',{height:320,region:'center'});this.gridGL=Ext.create('Account.SaleDebitNote.Item.Grid_gl',{border:true,region:'center',title:'GL Posting'});this.formTotal=Ext.create('Account.SaleDebitNote.Item.Form_t',{border:true,split:true,title:'GR Total',region:'south'});this.gridPrice=Ext.create('Account.SaleDebitNote.Item.Grid_pc',{border:true,split:true,title:'Item Pricing',region:'south'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('SN'),fieldLabel:'Debit Note Status',name:'statu',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat Type',name:'taxnr',width:240,labelAlign:'right',editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select data --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payments',name:'ptype',width:280,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.hdnDnItem=Ext.create('Ext.form.Hidden',{name:'vbde'});this.hdnGlItem=Ext.create('Ext.form.Hidden',{name:'bcus',});this.trigInv=Ext.create('Ext.form.field.Trigger',{name:'invnr',fieldLabel:'Invoice No',labelAlign:'letf',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigCustomer=Ext.create('Ext.form.field.Trigger',{name:'kunnr',fieldLabel:'Customer Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',labelAlign:'right',width:170,hideTrigger:false,align:'right'});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:240,labelAlign:'right',allowBlank:false});this.numberVat=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Vat Value',name:'taxpr',labelAlign:'right',width:170,align:'right'});this.numberWHT=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'WHT Value',name:'whtpr',labelAlign:'right',width:170,align:'right'});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnDnItem,this.hdnGlItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'loekz'},{xtype:'hidden',name:'id'},this.trigInv,{xtype:'displayfield',width:290,allowBlank:true},{xtype:'displayfield',fieldLabel:'Debit Note No',name:'debnr',value:'DNXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'container',flex:0,layout:'anchor',items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigCustomer,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:160,allowBlank:true}]},{xtype:'textarea',fieldLabel:'Customer Address',name:'adr01',width:450,rows:3,},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboPay,this.numberVat]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Reference No',width:280,name:'refnr',},this.numberWHT]}]},{xtype:'container',flex:0,layout:'anchor',margin:'0 0 0 70',items:[this.comboPtype,{xtype:'datefield',fieldLabel:'Debit Note Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',},this.comboTax,this.trigCurrency,{xtype:'container',layout:'hbox',defaultType:'textfield',margin:'0 0 5 0',items:[this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:25,value:'Days'}]},{xtype:'datefield',fieldLabel:'Due Date',name:'duedt',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},this.comboQStatus]}]}]}]};this.items=[mainFormPanel,{xtype:'tabpanel',region:'center',activeTab:0,border:false,items:[this.gridItem,{xtype:'panel',border:false,title:'Invoice Items',layout:'border',items:[this.gridItemIT]}]},{xtype:'tabpanel',region:'south',activeTab:0,height:200,items:[this.formTotal,this.gridPrice,this.gridGL]}];this.trigInv.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.invnr);_this.getForm().findField('kunnr').setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('loekz').setValue(r.data.loekz);}else{o.markInvalid('Could not find Purchase no : '+o.getValue());}}});}},this);_this.invDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigInv.setValue(record.data.invnr);_this.getForm().findField('kunnr').setValue(record.data.kunnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.invnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'invoice/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('loekz').setValue(r.data.loekz);}}});grid.getSelectionModel().deselectAll();var grdinvnr=_this.trigInv.value;_this.gridItemIT.load({invnr:grdinvnr});_this.invDialog.hide();});this.trigInv.onTriggerClick=function(){_this.invDialog.show();};this.trigCustomer.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer.setValue(record.data.kunnr);_this.getForm().findField('name1').setValue(record.data.name1);var v=record.data.kunnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'customer/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}}});grid.getSelectionModel().deselectAll();_this.customerDialog.hide();});this.trigCustomer.onTriggerClick=function(){_this.customerDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);_this.formTotal.getForm().findField('curr').setValue(r.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctyp1',r.data.ctype);});_this.gridItem.curValue=r.data.ctype;}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);_this.formTotal.getForm().findField('curr1').setValue(record.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctyp1',record.data.ctype);});_this.gridItem.curValue=record.data.ctype;grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.gridItem.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.gridItem.getSelectionModel().on('viewready',this.onViewReady,this);this.numberCredit.on('keyup',this.getDuedate,this);this.numberCredit.on('change',this.getDuedate,this);this.comboTax.on('change',this.calculateTotal,this);return this.callParent(arguments);},onSelectChange:function(selModel,selections){var _this=this;var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vat:sel.get('chk01')});}},onViewReady:function(grid){grid.getSelectionModel().select(0);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'debitnote/load_dn',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnDnItem.setValue(Ext.encode(rsItem));var rsGL=_this.gridGL.getData();this.hdnGlItem.setValue(Ext.encode(rsGL));if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(mbeln){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'debitnote/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({debnr:0});this.gridItemIT.load({invnr:0});this.gridGL.load({netpr:0});this.comboQStatus.setValue('01');this.comboTax.setValue('01');this.trigCurrency.setValue('THB');this.numberVat.setValue(7);this.numberWHT.setValue(3);this.getForm().findField('bldat').setValue(new Date());this.formTotal.getForm().findField('exchg').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=this.gridItem.store;var sum2=0;var sum=0;var vats=0;var whts=0;var discounts=0;var saknr_list=[];var vattype=this.comboTax.getValue();store.each(function(r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']),discount=parseFloat(r.data['disit']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;discount=isNaN(discount)?0:discount;var amt=qty*price;if(vattype=='02'){amt=amt*100;amt=amt/107;}
sum+=amt;discounts+=discount;amt=amt-discount;sum2+=amt;if(r.data['chk01']==true){var vat=_this.numberVat.getValue();vat=(amt*vat)/100;vats+=vat;}
if(r.data['chk02']==true){var wht=_this.numberWHT.getValue();wht=(amt*wht)/100;whts+=wht;}
var item=r.data['saknr']+'|'+amt;saknr_list.push(item);});this.formTotal.getForm().findField('beamt').setValue(sum);this.formTotal.getForm().findField('vat01').setValue(vats);this.formTotal.getForm().findField('wht01').setValue(whts);this.formTotal.getForm().findField('dismt').setValue(discounts);this.formTotal.calculate();this.gridItem.vattValue=this.comboTax.getValue();this.gridItem.vatValue=this.numberVat.getValue();var currency=this.trigCurrency.getValue();this.gridItem.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);this.formTotal.getForm().findField('vat01').setValue(vats);var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:vattype});}
if(currency!='THB'){var rate=this.formTotal.getForm().findField('exchg').getValue();sum=sum*rate;sum2=sum2*rate;vats=vats*rate;}
if(sum>0&&this.trigCustomer.getValue()!=''){_this.gridGL.load({netpr:sum2,vvat:vats,kunnr:this.trigCustomer.getValue(),items:saknr_list.join(',')});}},getDuedate:function(){var bForm=this.getForm(),credit=this.numberCredit.getValue(),startDate=bForm.findField('bldat').getValue();if(!Ext.isEmpty(credit)&&credit>0){var result=Ext.Date.add(startDate,Ext.Date.DAY,credit),dueDateField=bForm.findField('duedt');if(!Ext.isEmpty(credit)&&!Ext.isEmpty(dueDateField))
dueDateField.setValue(result);}}});;Ext.define('Account.SaleDebitNote.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'debitnote/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',}});return this.callParent(arguments);},initComponent:function(){var _this=this;var myStorecomboWHTno=Ext.create('Ext.data.Store',{fields:['idWHT','name'],data:[{"idWHT":"01","name":"นิติบุคคล"},{"idWHT":"02","name":"บุคคลธรรมดา"}]});this.whtDialog=Ext.create('Account.WHT.Window');this.trigWHT=Ext.create('Ext.form.field.Trigger',{name:'whtnr',labelAlign:'letf',width:50,triggerCls:'x-form-search-trigger',enableKeyEvents:true,margin:'4 0 0 10'});this.comboWHType=Ext.create('Ext.form.ComboBox',{fieldLabel:'Witholding Tax',name:'whtyp',width:240,triggerAction:'all',clearFilterOnReset:true,emptyText:'--Select WHT Typ--',margin:'4 0 0 0',store:myStorecomboWHTno,labelAlign:'left',queryMode:'local',displayField:'name',valueField:'idWHT'});this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',xtype:'textfield',fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:150,width:270,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt',align:'right',width:270,labelWidth:150,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',name:'vat01',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,margin:'4 0 0 0',readOnly:true});this.txtWHTValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'WHT Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:150,name:'wht01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:270,hideTrigger:true,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',labelWidth:150,width:270,margin:'4 0 0 0',alwaysDisplayDecimals:true,style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'},{xtype:'container',layout:'hbox',anchor:'100%',items:[this.comboWHType,this.trigWHT,{xtype:'textfield',name:'whtxt',margin:'4 0 0 7',width:250}]}]},{xtype:'container',layout:'anchor',margins:'0 0 0 15',items:[this.txtTotal,this.txtDiscountValue,this.txtDiscountSum,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];this.trigWHT.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/loads_wht',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.whtnr);if(r.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(r.data.whtxt);}}else{o.markInvalid('Could not find wht code : '+o.getValue());}}});}},this);_this.whtDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigWHT.setValue(record.data.whtnr);if(record.data.whtnr!='6'){_this.getForm().findField('whtxt').setValue(record.data.whtxt);}
grid.getSelectionModel().deselectAll();_this.whtDialog.hide();});this.trigWHT.onTriggerClick=function(){_this.whtDialog.show();};var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtTaxValue.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtWHTValue.on('render',setAlignRight);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'debitnote/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},calculate:function(){var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discountValue=this.txtDiscountValue.getValue();if(discountValue>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var wht=this.txtWHTValue.getValue();var net=(total-discountValue)+(vat-wht);this.txtNet.setValue(net);}});;Ext.define('Account.SaleDebitNote.Item.Grid_gl',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"debitnote/loads_gl_items",reader:{type:'json',root:'rows',idProperty:'belnr,belpr'}},fields:['belnr','belpr','saknr','sgtxt','debit','credi','txz01','statu'],remoteSort:true,sorters:['belpr ASC']});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete GL Item',scope:this,handler:this.removeRecord}]},{id:'RowNumber25',text:"No.",dataIndex:'belpr',width:50,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"GL No.",width:100,dataIndex:'saknr',align:'center',sortable:false,},{text:"GL Description",width:215,dataIndex:'sgtxt',sortable:true},{text:"Debit",width:100,dataIndex:'debit',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2},{text:"Credit",width:100,dataIndex:'credi',sortable:true,align:'right',xtype:'numbercolumn',decimalPrecision:2},{text:"Comment",width:250,dataIndex:'txz01',sortable:true,field:{type:'textfield'}}];this.plugins=[this.editing];return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addDefaultRecord:function(){this.store.removeAll();var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;for(var i=0;i<5;i++){rec={id:i};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();}},addRecord2:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow2();},removeRecord2:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow2();},runNumRow2:function(){var row_num=0;this.store.each(function(r){r.set('belpr',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.SaleDebitNote.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMaterial.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"debitnote/loads_dn_items",reader:{type:'json',root:'rows',idProperty:function(o){return o.debnr+o.vbelp;}}},fields:['vbelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctyp1','chk01','chk02','saknr'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Debit Note Item',scope:this,handler:this.removeRecord}]},{id:'DNiRowNumber1',header:"Items",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:80,dataIndex:'matnr',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.materialDialog.show();}},},{text:"Description",width:220,dataIndex:'maktx',sortable:false,field:{type:'textfield'},},{text:"Qty",xtype:'numbercolumn',width:70,dataIndex:'menge',sortable:false,align:'right',field:{type:'numberfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Unit",width:50,dataIndex:'meins',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.unitDialog.show();}},},{text:"Price/Unit",xtype:'numbercolumn',width:100,dataIndex:'unitp',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Discount",xtype:'numbercolumn',width:80,dataIndex:'disit',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{xtype:'checkcolumn',text:'Vat',dataIndex:'chk01',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{xtype:'checkcolumn',text:'WHT',dataIndex:'chk02',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Amount",width:90,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:65,dataIndex:'ctyp1',sortable:false,align:'center',field:{type:'textfield'},},{dataIndex:'saknr',width:55,sortable:false}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='matnr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.matnr);rModel.set('maktx',r.data.maktx);rModel.set('meins',r.data.meins);rModel.set('saknr',r.data.saknr);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.materialDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('matnr',record.data.matnr);rModel.set('maktx',record.data.maktx);rModel.set('meins',record.data.meins);rModel.set('saknr',record.data.saknr);}
grid.getSelectionModel().deselectAll();_this.materialDialog.hide();});_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('meins',record.data.meins);}
grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});this.store.on('load',function(store,rs){if(_this.readOnly){var view=_this.getView();var t=_this.getView().getEl().down('table');t.addCls('mask-grid-readonly');_this.readOnlyMask=new Ext.LoadMask(t,{msg:"..."});_this.readOnlyMask.show();}else{if(_this.readOnlyMask)
_this.readOnlyMask.hide();}});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,ctyp1:'THB'};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.SaleDebitNote.Item.Grid_it',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMaterial.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"debitnote/loads_items",reader:{type:'json',root:'rows',idProperty:function(o){return o.crenr+o.vbelp;}}},fields:['vbelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctype','chk01','chk02','saknr'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,},{id:'CNiRowNumber11',header:"Items",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:80,dataIndex:'matnr',sortable:false,},{text:"Description",width:220,dataIndex:'maktx',sortable:false,},{text:"Qty",xtype:'numbercolumn',width:70,dataIndex:'menge',sortable:false,align:'right',},{text:"Unit",width:50,dataIndex:'meins',sortable:false,},{text:"Price/Unit",xtype:'numbercolumn',width:100,dataIndex:'unitp',sortable:false,align:'right',},{text:"Discount",xtype:'numbercolumn',width:80,dataIndex:'disit',sortable:false,align:'right',},{xtype:'checkcolumn',text:'Vat',disabled:true,dataIndex:'chk01',width:30,},{xtype:'checkcolumn',text:'WHT',disabled:true,dataIndex:'chk02',width:30,},{text:"Amount",width:90,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge']),price=parseFloat(r.data['unitp']);qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:65,dataIndex:'ctype',sortable:false,align:'center',},{dataIndex:'saknr',hidden:true,sortable:false}];this.plugins=[this.editing];return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId,ctype:'THB'};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.SaleDebitNote.Item.Grid_pc',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"invoice/loads_conp_item",reader:{type:'json',root:'rows',idProperty:'conty'}},fields:['conty','contx','vtamt','ttamt'],remoteSort:true,sorters:['conty ASC']});this.columns=[{text:"Condition type",width:170,dataIndex:'contx',sortable:true},{text:"Amount",width:100,xtype:'numbercolumn',dataIndex:'vtamt',sortable:true,align:'right'},{text:"Condition Amount",xtype:'numbercolumn',width:120,dataIndex:'ttamt',align:'right'}];return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.SaleDebitNote.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'Debit Note preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/saledebitnote/index/'+id+'/'+copies;}});;Ext.define('Account.SaleDebitNote.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Debit Note',closeAction:'hide',height:650,width:900,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.SaleDebitNote.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.SaleDebitNote.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.btnSave=Ext.create('Ext.Button',{text:'Save',disabled:!(UMS.CAN.CREATE('SN')||UMS.CAN.EDIT('SN')||UMS.CAN.APPROVE('SN')),handler:function(){_this.form.save();}});this.buttons=[this.btnSave,{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({debnr:id});this.form.gridItemIT.load({debnr:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}},setReadOnly:function(readOnly){var children=this.items?this.items.items:[];for(var i=0;i<children.length;i++){var child=children[i];child.query('.field').forEach(function(c){if(!c.initialConfig.readOnly){c.setReadOnly(readOnly);}});child.query('.button').forEach(function(c){if(c.xtype!='tab'){if(!c.initialConfig.disabled)
c.setDisabled(readOnly);}});}
this.form.gridItem.readOnly=readOnly;if(!this.btnSave.initialConfig.disabled)
this.btnSave.setDisabled(readOnly);}});;Ext.define('Account.SaleDebitNote.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Debit Note',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;var fibasic=Ext.create('Ext.form.field.File',{width:200,x:50,y:50,hideLabel:true});this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('SN')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('SN')||UMS.CAN.CREATE('SN')||UMS.CAN.EDIT('SN'))});this.displayAct=new Ext.Action({text:'Display',iconCls:'b-small-search',disabled:!UMS.CAN.DISPLAY('SN')});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('SN')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('SN')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.SaleDebitNote.Item.Window');this.grid=Ext.create('Account.SaleDebitNote.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.displayAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.SaleDebitNote.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(false);}});this.displayAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(true);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save Debit Note number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/saledebitnote/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Saleorder.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Sale Order, Customer, Quotation no. or Sale',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Saleorder.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"saleorder/loads",reader:{type:'json',root:'rows',idProperty:'ordnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['ordnr','bldat','kunnr','name1','vbeln','statx','salnr','sname','netwr','ctype','ptype','taxnr','terms'],remoteSort:true,sorters:[{property:'ordnr',direction:'ASC'}]});this.columns=[{text:"Sale Order No.",width:100,align:'center',dataIndex:'ordnr',sortable:true},{text:"SO Date",xtype:'datecolumn',width:100,align:'center',format:'d/m/Y',dataIndex:'bldat',sortable:true},{text:"Customer No",width:100,align:'center',dataIndex:'kunnr',sortable:true},{text:"Customer Name",width:150,dataIndex:'name1',sortable:true},{text:"Quotation No.",width:100,align:'center',dataIndex:'vbeln',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"1",hidden:true,width:0,dataIndex:'salnr',sortable:false},{text:"Salesperson",width:120,dataIndex:'sname',sortable:true},{text:"Amount",xtype:'numbercolumn',width:100,align:'right',dataIndex:'netwr',sortable:true},{text:"Currency",width:60,align:'center',dataIndex:'ctype',sortable:true},{text:"2",hidden:true,width:0,dataIndex:'ptype',sortable:false},{text:"3",hidden:true,width:0,dataIndex:'taxnr',sortable:false},{text:"4",hidden:true,width:0,dataIndex:'terms',sortable:false}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Saleorder.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'saleorder/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.quotationDialog=Ext.create('Account.Quotation.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.customerDialog=Ext.create('Account.SCustomer.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.saleDialog=Ext.create('Account.Saleperson.MainWindow',{disableGridDoubleClick:true,isApproveOnly:true});this.trigSale=Ext.create('Ext.form.field.Trigger',{name:'salnr',fieldLabel:'Salesperson',triggerCls:'x-form-search-trigger',labelAlign:'left',width:170,enableKeyEvents:true});this.currencyDialog=Ext.create('Account.SCurrency.MainWindow');this.gridItem=Ext.create('Account.Saleorder.Item.Grid_i',{height:320,region:'center'});this.formTotal=Ext.create('Account.Saleorder.Item.Form_t',{border:true,split:true,title:'Total->SO',region:'south'});this.formTotalthb=Ext.create('Account.Saleorder.Item.Form_thb',{border:true,split:true,title:'Exchange Rate->THB',region:'south'});this.gridPrice=Ext.create('Account.Saleorder.Item.Grid_pc',{border:true,split:true,title:'Item Pricing',region:'south'});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('SO'),fieldLabel:'SO Status',name:'statu',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',margin:'0 0 0 27',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payments',name:'ptype',width:350,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat Type',name:'taxnr',width:240,margin:'0 0 0 6',labelAlign:'right',editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Vat --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_taxcombo',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',labelAlign:'right',width:200,hideTrigger:false,align:'right',margin:'0 0 0 35'});this.whtDialog=Ext.create('Account.WHT.Window');this.trigWHT=Ext.create('Ext.form.field.Trigger',{fieldLabel:'WHT Value',name:'whtnr',labelAlign:'right',width:150,triggerCls:'x-form-search-trigger',enableKeyEvents:true,margin:'0 0 0 35'});this.numberWHT=Ext.create('Ext.form.field.Display',{name:'whtpr',width:15,align:'right',margin:'0 0 0 8'});this.numberVat=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Vat Value',name:'taxpr',labelAlign:'right',width:200,align:'right',margin:'0 0 0 35'});this.hdnSOItem=Ext.create('Ext.form.Hidden',{name:'vbop',});this.trigQuotation=Ext.create('Ext.form.field.Trigger',{name:'vbeln',fieldLabel:'Quotation No.',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigCustomer=Ext.create('Ext.form.field.Trigger',{name:'kunnr',fieldLabel:'Customer Code',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.trigCurrency=Ext.create('Ext.form.field.Trigger',{name:'ctype',fieldLabel:'Currency',triggerCls:'x-form-search-trigger',enableKeyEvents:true,width:240,margin:'0 0 0 6',labelAlign:'right',allowBlank:false});var mainFormPanel={xtype:'panel',border:true,region:'north',bodyPadding:'5 10 0 10',fieldDefaults:{labelAlign:'left',msgTarget:'qtip',labelWidth:105},items:[this.hdnSOItem,{xtype:'fieldset',title:'Heading Data',collapsible:true,defaultType:'textfield',layout:'anchor',items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'hidden',name:'id'},{xtype:'hidden',name:'loekz'},this.trigQuotation,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:350,allowBlank:true},{xtype:'displayfield',fieldLabel:'SO No',name:'ordnr',value:'SOXXXX-XXXX',labelAlign:'right',width:240,readOnly:true,labelStyle:'font-weight:bold'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigCustomer,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:350,allowBlank:true},{xtype:'datefield',fieldLabel:'Date',name:'bldat',labelAlign:'right',width:240,format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d',allowBlank:false}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textarea',fieldLabel:'Bill To',name:'adr01',width:350,rows:3,editable:false,labelAlign:'top'},{xtype:'textarea',fieldLabel:'Ship To',name:'adr02',width:355,rows:3,labelAlign:'top',editable:false,margin:'0 0 0 140'}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigSale,{xtype:'displayfield',name:'emnam',width:174,margins:'0 0 0 6'},this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:10,value:'Days'},this.trigCurrency]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.comboPay,this.numberVat,{xtype:'displayfield',align:'right',width:10,margin:'0 0 0 5',value:'%'},this.comboTax]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'textfield',fieldLabel:'Reference No',name:'refnr',width:350},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigWHT,this.numberWHT,{xtype:'displayfield',align:'right',width:15,margin:'0 0 0 5',value:'%'}]},this.comboQStatus]}]}]};this.items=[mainFormPanel,this.gridItem,{xtype:'tabpanel',region:'south',activeTab:0,height:220,items:[this.formTotal,this.formTotalthb,this.gridPrice]}];this.trigCustomer.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'customer/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('adr02').setValue(r.data.adr02);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}else{o.markInvalid('Could not find customer code : '+o.getValue());}}});}},this);_this.customerDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCustomer.setValue(record.data.kunnr);var v=record.data.kunnr;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'customer/load2',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('adr02').setValue(r.data.adr02);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);}}});grid.getSelectionModel().deselectAll();_this.customerDialog.hide();});this.trigCustomer.onTriggerClick=function(){_this.customerDialog.grid.load();_this.customerDialog.show();};this.trigSale.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'saleperson/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.salnr);_this.getForm().findField('emnam').setValue(r.data.emnam);}else{o.markInvalid('Could not find project owner : '+o.getValue());}}});}},this);_this.saleDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigSale.setValue(record.data.salnr);_this.getForm().findField('emnam').setValue(record.data.emnam);grid.getSelectionModel().deselectAll();_this.saleDialog.hide();});this.trigSale.onTriggerClick=function(){_this.saleDialog.grid.load();_this.saleDialog.show();};this.trigQuotation.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'quotation/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.vbeln);_this.getForm().findField('kunnr').setValue(r.data.kunnr);_this.getForm().findField('name1').setValue(r.data.name1);_this.getForm().findField('salnr').setValue(r.data.salnr);_this.getForm().findField('ptype').setValue(r.data.ptype);_this.getForm().findField('taxnr').setValue(r.data.taxnr);_this.getForm().findField('terms').setValue(r.data.terms);_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('adr02').setValue(r.data.adr02);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('whtpr').setValue(r.data.whtpr);_this.getForm().findField('loekz').setValue(r.data.loekz);_this.formTotal.txtDepositValue.setValue(r.data.deamt);var qtnr=_this.trigQuotation.value;_this.gridItem.load({qtnr:qtnr});}else{o.markInvalid('Could not find quotation no : '+o.getValue());}}});}},this);_this.quotationDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigQuotation.setValue(record.data.vbeln);_this.getForm().findField('kunnr').setValue(record.data.kunnr);_this.getForm().findField('name1').setValue(record.data.name1);_this.getForm().findField('salnr').setValue(record.data.salnr);_this.getForm().findField('ptype').setValue(record.data.ptype);_this.getForm().findField('taxnr').setValue(record.data.taxnr);_this.getForm().findField('terms').setValue(record.data.terms);Ext.Ajax.request({url:__site_url+'quotation/load',method:'POST',params:{id:record.data.vbeln},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.getForm().findField('adr01').setValue(r.data.adr01);_this.getForm().findField('adr02').setValue(r.data.adr02);_this.getForm().findField('ctype').setValue(r.data.ctype);_this.getForm().findField('taxpr').setValue(r.data.taxpr);_this.getForm().findField('whtpr').setValue(r.data.whtpr);_this.getForm().findField('loekz').setValue(r.data.loekz);_this.formTotal.txtDepositValue.setValue(r.data.deamt);}}});grid.getSelectionModel().deselectAll();var qtnr=_this.trigQuotation.value;_this.gridItem.load({qtnr:qtnr});_this.quotationDialog.hide();});this.trigQuotation.onTriggerClick=function(){_this.quotationDialog.grid.load();_this.quotationDialog.show();};this.trigCurrency.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'currency/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.ctype);_this.formTotal.getForm().findField('curr').setValue(r.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',r.data.ctype);});_this.gridItem.curValue=r.data.ctype;}else{o.markInvalid('Could not find currency code : '+o.getValue());}}});}},this);_this.currencyDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigCurrency.setValue(record.data.ctype);_this.formTotal.getForm().findField('curr1').setValue(record.data.ctype);var store=_this.gridItem.store;store.each(function(rc){rc.set('ctype',record.data.ctype);});_this.gridItem.curValue=record.data.ctype;grid.getSelectionModel().deselectAll();_this.currencyDialog.hide();});this.trigCurrency.onTriggerClick=function(){_this.currencyDialog.show();};this.trigWHT.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'invoice/loads_wht',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.whtnr);_this.getForm().findField('whtpr').setValue(r.data.whtpr);}else{o.markInvalid('Could not find wht code : '+o.getValue());}}});}},this);_this.whtDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigWHT.setValue(record.data.whtnr);_this.getForm().findField('whtpr').setValue(record.data.whtpr);grid.getSelectionModel().deselectAll();_this.whtDialog.hide();});this.trigWHT.onTriggerClick=function(){_this.whtDialog.show();};this.gridItem.store.on('update',this.calculateTotal,this);this.gridItem.store.on('load',this.calculateTotal,this);this.on('afterLoad',this.calculateTotal,this);this.gridItem.getSelectionModel().on('selectionchange',this.onSelectChange,this);this.gridItem.getSelectionModel().on('viewready',this.onViewReady,this);this.comboTax.on('change',this.calculateTotal,this);this.trigCurrency.on('change',this.changeCurrency,this);this.formTotal.txtRate.on('keyup',this.calculateTotal,this);this.formTotal.txtRate.on('change',this.calculateTotal,this);this.numberWHT.on('change',this.calculateTotal,this);return this.callParent(arguments);},onSelectChange:function(selModel,selections){var _this=this;var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:this.comboTax.getValue()});}},onViewReady:function(grid){grid.getSelectionModel().select(0);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'saleorder/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.gridItem.getData();this.hdnSOItem.setValue(Ext.encode(rsItem));if(_form_basic.isValid()){_form_basic.submit({waitMsg:'Save data...',success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'saleorder/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.gridItem.load({ordnr:0});this.comboQStatus.setValue('01');this.comboTax.setValue('01');this.trigCurrency.setValue('THB');this.numberVat.setValue(7);this.numberWHT.setValue(3);this.getForm().findField('bldat').setValue(new Date());this.formTotal.getForm().findField('exchg').setValue('1.0000');this.formTotalthb.getForm().findField('exchg2').setValue('1.0000');this.formTotal.getForm().findField('bbb').setValue('0.00');this.formTotal.getForm().findField('netwr').setValue('0.00');},calculateTotal:function(){var _this=this;var store=this.gridItem.store;var sum=0;var vats=0;var whts=0;var discounts=0;var vattype=this.comboTax.getValue();store.each(function(r){var qty=parseFloat(r.data['menge'].replace(/[^0-9.]/g,'')),price=parseFloat(r.data['unitp'].replace(/[^0-9.]/g,'')),discount=parseFloat(r.data['disit'].replace(/[^0-9.]/g,''));qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;discount=isNaN(discount)?0:discount;var amt=qty*price;if(vattype=='02'){amt=amt*100;amt=amt/107;}
sum+=amt;discounts+=discount;amt=amt-discount;if(r.data['chk01']==true){var vat=_this.numberVat.getValue();vat=(amt*vat)/100;vats+=vat;}
if(r.data['chk02']==true){var wht=_this.numberWHT.getValue();wht=(amt*wht)/100;whts+=wht;}});this.formTotal.getForm().findField('beamt').setValue(sum);this.formTotal.getForm().findField('vat01').setValue(vats);this.formTotal.getForm().findField('wht01').setValue(whts);this.formTotal.getForm().findField('dismt').setValue(discounts);var net=this.formTotal.calculate();this.gridItem.vattValue=this.comboTax.getValue();this.gridItem.vatValue=this.numberVat.getValue();this.gridItem.whtValue=this.numberWHT.getValue();var currency=this.trigCurrency.getValue();this.gridItem.curValue=currency;this.formTotal.getForm().findField('curr1').setValue(currency);this.formTotalthb.getForm().findField('curr2').setValue(currency);this.gridItem.customerValue=this.trigCustomer.getValue();var rate=this.formTotal.txtRate.getValue();var deamt=this.formTotal.getForm().findField('deamt').getValue();if(currency!='THB'){sum=sum*rate;vats=vats*rate;discounts=discounts*rate;deamt=deamt*rate;}
this.formTotalthb.getForm().findField('beamt2').setValue(sum);this.formTotalthb.getForm().findField('vat02').setValue(vats);this.formTotalthb.getForm().findField('wht02').setValue(whts);this.formTotalthb.getForm().findField('dismt2').setValue(discounts);this.formTotalthb.getForm().findField('exchg2').setValue(rate);this.formTotalthb.getForm().findField('deamt2').setValue(deamt);var net2=this.formTotalthb.calculate();var sel=this.gridItem.getView().getSelectionModel().getSelection()[0];if(sel){_this.gridPrice.load({menge:sel.get('menge').replace(/[^0-9.]/g,''),unitp:sel.get('unitp').replace(/[^0-9.]/g,''),disit:sel.get('disit').replace(/[^0-9.]/g,''),vvat:this.numberVat.getValue(),vwht:this.numberWHT.getValue(),vat:sel.get('chk01'),wht:sel.get('chk02'),vattype:vattype});}},changeCurrency:function(){var _this=this;var store=this.gridItem.store;var currency=this.trigCurrency.getValue();store.each(function(r){r.set('ctyp1',currency);});}});;Ext.define('Account.Saleorder.Item.Form_t',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'saleorder/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt',alwaysDisplayDecimals:true,labelWidth:155,width:270,readOnly:true});this.txtDepositValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Deposit Receipt',name:'deamt',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:155,name:'vat01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtWHTValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'WHT Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:155,name:'wht01',align:'right',margin:'4 0 0 0',readOnly:true});this.txtRate=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Exchange Rate',align:'right',width:240,hideTrigger:true,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr',align:'right',width:270,labelWidth:155,alwaysDisplayDecimals:true,margin:'4 0 0 0',style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr1',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,width:380,name:'txz01'}]},{xtype:'container',layout:'anchor',margins:'0 0 0 200',items:[this.txtTotal,this.txtDiscountValue,this.txtDiscountSum,this.txtDepositValue,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtTaxValue.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtWHTValue.on('render',setAlignRight);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'saleorder/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'saleorder/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},calculate:function(){var _this=this;var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discountValue=this.txtDiscountValue.getValue();var depositValue=this.txtDepositValue.getValue();if(discountValue>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var wht=this.txtWHTValue.getValue();var net=(total-discountValue)+(vat-wht);net=net-depositValue;this.txtNet.setValue(net);return net;}});;Ext.define('Account.Saleorder.Item.Form_thb',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'quotation/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'left',msgTarget:'qtip',}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.txtTotal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Total',name:'beamt2',alwaysDisplayDecimals:true,labelWidth:155,width:270,readOnly:true});this.txtDepositValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Deposit Receipt',name:'deamt2',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Discount',name:'dismt2',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',alwaysDisplayDecimals:true,readOnly:true});this.txtDiscountSum=Ext.create('Ext.form.field.Text',{fieldLabel:'After Discount',name:'bbb2',align:'right',width:270,labelWidth:155,margin:'4 0 0 0',readOnly:true});this.txtTaxValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Vat Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:155,name:'vat02',align:'right',margin:'4 0 0 0',readOnly:true});this.txtWHTValue=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'WHT Total',align:'right',alwaysDisplayDecimals:true,width:270,labelWidth:155,name:'wht02',align:'right',margin:'4 0 0 0',readOnly:true});this.txtRate2=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Exchange Rate',align:'right',readOnly:true,width:240,alwaysDisplayDecimals:true,decimalPrecision:4,name:'exchg2',align:'right'});this.txtNet=Ext.create('Ext.ux.form.NumericField',{xtype:'textfield',fieldLabel:'Net Amount',name:'netwr2',align:'right',width:270,labelWidth:155,alwaysDisplayDecimals:true,margin:'4 0 0 0',style:'font-weight:bold',labelStyle:'font-weight:bold',readOnly:true});this.items=[{xtype:'container',layout:'hbox',anchor:'100%',defaultType:'textfield',items:[{xtype:'container',layout:'anchor',items:[{xtype:'container',layout:'hbox',anchor:'100%',items:[this.txtRate2,{xtype:'displayfield',align:'right',margin:'0 0 0 5',width:20,value:'THB/'},{xtype:'displayfield',name:'curr2',margin:'0 0 0 7',width:30}]},{xtype:'textfield',fieldLabel:'Rejected Reason',align:'right',disabled:true,margin:'3 0 0 0',width:380,name:'reanr'},{xtype:'textarea',fieldLabel:'Text Note',margin:'3 0 0 0',rows:2,disabled:true,width:380,name:'txz01'}]},{xtype:'container',layout:'anchor',margins:'0 0 0 200',items:[this.txtTotal,this.txtDiscountValue,this.txtDiscountSum,this.txtDepositValue,this.txtTaxValue,this.txtWHTValue,this.txtNet]}]}];var setAlignRight=function(o){o.inputEl.setStyle('text-align','right');};var setBold=function(o){o.inputEl.setStyle('font-weight','bold');};this.txtTotal.on('render',setAlignRight);this.txtDiscountValue.on('render',setAlignRight);this.txtDiscountSum.on('render',setAlignRight);this.txtTaxValue.on('render',setAlignRight);this.txtNet.on('render',setAlignRight);this.txtNet.on('render',setBold);this.txtWHTValue.on('render',setAlignRight);return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'quotation/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'quotation/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},calculate:function(){var _this=this;var total=this.txtTotal.getValue();total=parseFloat(total);total=isNaN(total)?0:total;if(total<=0)return;var discountValue=this.txtDiscountValue.getValue();var depositValue=this.txtDepositValue.getValue();if(discountValue>0){this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total-discountValue).replace(/\$/,''));}else{this.txtDiscountValue.setValue('0.00');this.txtDepositValue.setValue('0.00');this.txtDiscountSum.setValue(Ext.util.Format.usMoney(total).replace(/\$/,''));}
var vat=this.txtTaxValue.getValue();var wht=this.txtWHTValue.getValue();var net=(total-discountValue)+(vat-wht);net=net-depositValue;this.txtNet.setValue(net);return net;}});;Ext.define('Account.Saleorder.Item.Grid_i',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.copyAct=new Ext.Action({text:'Copy',iconCls:'b-small-copy'});this.materialDialog=Ext.create('Account.SMaterial.MainWindow');this.unitDialog=Ext.create('Account.Unit.Window');this.tbar=[this.addAct,this.copyAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"saleorder/loads_so_item",reader:{type:'json',root:'rows',idProperty:'ordnr,vbelp'}},fields:['ordnr','vbelp','matnr','maktx','menge','meins','unitp','disit','itamt','ctype','chk01','chk02'],remoteSort:true,sorters:['vbelp ASC']});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete SO Item',scope:this,handler:this.removeRecord}]},{id:'RowNumber32',text:"Items",dataIndex:'vbelp',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Material Code",width:110,dataIndex:'matnr',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.materialDialog.show();}},},{text:"Description",width:220,dataIndex:'maktx',sortable:false,field:{type:'textfield'},},{text:"Qty",xtype:'numbercolumn',width:60,dataIndex:'menge',sortable:false,align:'right',field:{type:'numberfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Unit",width:50,dataIndex:'meins',sortable:false,field:{xtype:'triggerfield',enableKeyEvents:true,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.unitDialog.show();}},},{text:"Price/Unit",xtype:'numbercolumn',width:80,dataIndex:'unitp',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{text:"Discount",xtype:'numbercolumn',width:70,dataIndex:'disit',sortable:false,align:'right',field:{type:'numberfield',decimalPrecision:2,listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}},},{xtype:'checkcolumn',text:'Vat',dataIndex:'chk01',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{xtype:'checkcolumn',text:'WHT',dataIndex:'chk02',width:30,field:{xtype:'checkboxfield',listeners:{focus:function(field,e){var v=field.getValue();if(Ext.isEmpty(v)||v==0)
field.selectText();}}}},{text:"Amount",xtype:'numbercolumn',width:120,dataIndex:'itamt',sortable:false,align:'right',renderer:function(v,p,r){var qty=parseFloat(r.data['menge'].replace(/[^0-9.]/g,'')),price=parseFloat(r.data['unitp'].replace(/[^0-9.]/g,'')),chk01=r.data['chk01'],chk02=r.data['chk02'];qty=isNaN(qty)?0:qty;price=isNaN(price)?0:price;var amt=qty*price;return Ext.util.Format.usMoney(amt).replace(/\$/,'');}},{text:"Currency",width:70,dataIndex:'ctype',sortable:false,align:'center',field:{type:'textfield'},}];this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.copyAct.setHandler(function(){_this.copyRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='matnr'){var v=e.value;var cusno=_this.customerValue;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v,kunnr:cusno},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.matnr);rModel.set('maktx',r.data.maktx);rModel.set('meins',r.data.meins);var cost=r.data.cost;rModel.set('unitp',cost);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.materialDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('matnr',record.data.matnr);rModel.set('maktx',record.data.maktx);rModel.set('meins',record.data.meins);var v=record.data.matnr;var cusno=_this.customerValue;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'material/load',method:'POST',params:{id:v,kunnr:cusno},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success&&r.data.cost){var cost=r.data.cost;rModel.set('unitp',cost);}}});}
grid.getSelectionModel().deselectAll();_this.materialDialog.hide();});_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('meins',record.data.meins);}
grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});this.store.on('load',function(store,rs){if(_this.readOnly){var view=_this.getView();var t=_this.getView().getEl().down('table');t.addCls('mask-grid-readonly');_this.readOnlyMask=new Ext.LoadMask(t,{msg:"..."});_this.readOnlyMask.show();}else{if(_this.readOnlyMask)
_this.readOnlyMask.hide();}});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},addRecord:function(){var _this=this;var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec={id:newId,ctype:cur};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();},copyRecord:function(){var _this=this;var sel=_this.getView().getSelectionModel().getSelection()[0];if(sel){var newId=-1;this.store.each(function(r){if(r.get('id')<newId)
newId=r.get('id');});newId--;var cur=_this.curValue;rec=sel.getData();rec.id=newId;edit=this.editing;edit.cancelEdit();var selIndex=this.store.indexOf(sel);this.store.insert(selIndex+1,rec);edit.startEditByPosition({row:selIndex+1,column:0});this.runNumRow();this.getSelectionModel().deselectAll();}else{Ext.Msg.alert('Warning','Please select record to copy.');}},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();this.getSelectionModel().deselectAll();},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('vbelp',row_num++);});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;}});;Ext.define('Account.Saleorder.Item.Grid_pc',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"saleorder/loads_conp_item",reader:{type:'json',root:'rows',idProperty:'conty'}},fields:['conty','contx','vtamt','ttamt'],remoteSort:true,sorters:['conty ASC']});this.columns=[{text:"Condition type",width:170,dataIndex:'contx',sortable:true},{text:"Amount",width:100,xtype:'numbercolumn',dataIndex:'vtamt',sortable:true,align:'right'},{text:"Condition Amount",xtype:'numbercolumn',width:120,dataIndex:'ttamt',align:'right'}];return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.Saleorder.Item.PreviewWindow',{extend:'BASE.PreviewWindow',constructor:function(config){Ext.apply(this,{title:'Sale Order preview',closeAction:'hide',height:600,width:830,minHeight:600,minWidth:830,layout:'border',border:false,resizable:true,modal:true,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){return this.callParent(arguments);},getFrameUrl:function(id,copies){copies=copies||1;return __site_url+'form/saleorder/index/'+id+'/'+copies;}});;Ext.define('Account.Saleorder.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Sale Order',closeAction:'hide',height:700,width:950,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Saleorder.Item.Form',{region:'center'});this.previewDialog=Ext.create('Account.Saleorder.Item.PreviewWindow');this.items=[this.form];this.btnPreview=Ext.create('Ext.Button',{text:'Preview',handler:function(){_this.previewDialog.openDialog(_this.dialogId);}});this.btnSave=Ext.create('Ext.Button',{text:'Save',disabled:!(UMS.CAN.CREATE('QT')||UMS.CAN.EDIT('QT')||UMS.CAN.APPROVE('QT')),handler:function(){_this.form.save();}});this.buttons=[this.btnSave,{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},this.btnPreview];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);this.form.gridItem.load({ordnr:id});this.btnPreview.setDisabled(false);}else{this.dialogId=null;this.form.reset();this.show(false);this.btnPreview.setDisabled(true);}},setReadOnly:function(readOnly){var children=this.items?this.items.items:[];for(var i=0;i<children.length;i++){var child=children[i];child.query('.field').forEach(function(c){if(!c.initialConfig.readOnly){c.setReadOnly(readOnly);}});child.query('.button').forEach(function(c){if(c.xtype!='tab'){if(!c.initialConfig.disabled)
c.setDisabled(readOnly);}});}
this.form.gridItem.readOnly=readOnly;if(!this.btnSave.initialConfig.disabled)
this.btnSave.setDisabled(readOnly);}});;Ext.define('Account.Saleorder.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Sale Order',closeAction:'hide',height:600,minHeight:380,width:950,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;var fibasic=Ext.create('Ext.form.field.File',{width:200,x:50,y:50,hideLabel:true});this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('SO')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('SO')||UMS.CAN.CREATE('SO')||UMS.CAN.EDIT('SO'))});this.displayAct=new Ext.Action({text:'Display',iconCls:'b-small-search',disabled:!UMS.CAN.DISPLAY('SO')});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('SO')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('SO')});this.importAct=new Ext.Action({text:'Import',disabled:true,iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.Saleorder.Item.Window');this.grid=Ext.create('Account.Saleorder.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.displayAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.Saleorder.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(false);}});this.displayAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);_this.itemDialog.setReadOnly(true);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form,action){_this.itemDialog.hide();_this.grid.load();var resultId=action.result.data.id;_this.itemDialog.openDialog(resultId);Ext.Msg.alert('Status','Save SO number: '+resultId+' successfully.');});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/saleorder/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Saleperson.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Sale Code, Sale Name',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'textfield',name:'salnr',hideLabel:false,fieldLabel:'Sale Code',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'textfield',name:'salnr2',hideLabel:false,fieldLabel:'To',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Saleperson.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'saleperson/loads',reader:{type:'json',root:'rows',idProperty:'salnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['salnr','empnr','emnam','ctype','statx'],remoteSort:true,sorters:[{property:'salnr',direction:'ASC'}]});this.columns=[{text:"Sale Person No",width:100,dataIndex:'salnr',sortable:true},{text:"Name",width:180,dataIndex:'emnam',sortable:true},{text:"Employee No",flex:true,dataIndex:'empnr',sortable:true},{text:"Commission Type",flex:true,dataIndex:'ctype',sortable:true},{text:"Status",flex:true,dataIndex:'statx',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Saleperson.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'saleperson/save',border:false,fieldDefaults:{msgTarget:'qtip',labelWidth:130,}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.employeeDialog=Ext.create('Account.SEmployee.MainWindow');this.trigEmployee=Ext.create('Ext.form.field.Trigger',{name:'empnr',labelAlign:'letf',width:240,fieldLabel:'Employee No',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'Sale Person Status',name:'statu',editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.numberLevf1=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Level 1',name:'levf1',hideTrigger:false,emptyText:'0',width:250});this.numberLevf2=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Level 2',name:'levf2',hideTrigger:false,emptyText:'0',width:250});this.numberLevf3=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Level 3',name:'levf3',hideTrigger:false,emptyText:'0',width:250});this.numberLevt1=Ext.create('Ext.ux.form.NumericField',{name:'levt1',hideTrigger:false,width:120,margin:'0 0 0 5',emptyText:'0'});this.numberLevt2=Ext.create('Ext.ux.form.NumericField',{name:'levt2',hideTrigger:false,width:120,margin:'0 0 0 5',emptyText:'0'});this.numberLevt3=Ext.create('Ext.ux.form.NumericField',{name:'levt3',hideTrigger:false,width:120,margin:'0 0 0 5',emptyText:'0'});this.numberPerc1=Ext.create('Ext.ux.form.NumericField',{name:'perc1',hideTrigger:false,width:50,margin:'0 0 0 145',emptyText:'0'});this.numberPerc2=Ext.create('Ext.ux.form.NumericField',{name:'perc2',hideTrigger:false,width:50,margin:'0 0 0 145',emptyText:'0'});this.numberPerc3=Ext.create('Ext.ux.form.NumericField',{name:'perc3',width:50,margin:'0 0 0 145',hideTrigger:false,emptyText:'0'});this.numberPerc4=Ext.create('Ext.ux.form.NumericField',{name:'percs',hideTrigger:false,width:50,margin:'0 0 5 20',emptyText:'0'});this.numberGoal=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Special rate',name:'goals',width:250,emptyText:'0'});this.radioType=Ext.create('Ext.form.RadioGroup',{fieldLabel:'Comission type',cls:'x-check-group-alt',items:[{boxLabel:'Levels',width:70,name:'ctype',inputValue:1},{boxLabel:'Step',width:50,name:'ctype',inputValue:2,checked:true}]});this.items=[{xtype:'hidden',name:'id'},{xtype:'fieldset',title:'Sale Person Head',defaultType:'textfield',layout:'anchor',items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'displayfield',fieldLabel:'Sale Person Code',labelWidth:130,name:'salnr',width:200,value:'XXXXX',labelStyle:'font-weight:bold',readOnly:true},{}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.trigEmployee,{xtype:'displayfield',name:'name1',margins:'0 0 0 6',width:350,allowBlank:true}]}]},{xtype:'fieldset',title:'Commission',layout:'anchor',collapsible:true,items:[this.radioType]},{xtype:'fieldset',title:'Sale Person Data',defaultType:'textfield',layout:'anchor',defaults:{anchor:'100%'},items:[{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'displayfield',name:'qqq',width:250,value:'<span style="color:green; padding-left:180px">From</span>'},{xtype:'displayfield',name:'www',width:250,value:'<span style="color:green; padding-left:60px">To</span>'},{xtype:'displayfield',name:'eee',width:50,value:'<span style="color:green; padding-left:35px">%</span>',}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.numberLevf1,this.numberLevt1,this.numberPerc1]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.numberLevf2,this.numberLevt2,this.numberPerc2]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.numberLevf3,this.numberLevt3,this.numberPerc3]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[{xtype:'displayfield',name:'aaa',width:250,value:'<span style="color:green; padding-left:145px">Sale Goal (Baht)</span>'},{xtype:'displayfield',name:'sss',width:100,value:'<span style="color:green; padding-left:30px">Start Date</span>'},{xtype:'displayfield',name:'ddd',width:120,value:'<span style="color:green; padding-left:65px">End Date</span>'},{xtype:'displayfield',name:'fff',fieldLabel:'',width:100,value:'<span style="color:green; padding-left:70px">%</span>',}]},{xtype:'container',layout:'hbox',margin:'0 0 5 0',items:[this.numberGoal,{xtype:'datefield',name:'stdat',width:120,margin:'0 0 5 5',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},{xtype:'datefield',name:'endat',width:120,margin:'0 0 5 5',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'},this.numberPerc4]}]},this.comboQStatus];this.trigEmployee.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'employee/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.empnr);_this.getForm().findField('name1').setValue(r.data.name1);}else{o.markInvalid('Could not find Employee code : '+o.getValue());}}});}},this);_this.employeeDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigEmployee.setValue(record.data.empnr);_this.getForm().findField('name1').setValue(record.data.name1);grid.getSelectionModel().deselectAll();_this.employeeDialog.hide();});this.trigEmployee.onTriggerClick=function(){_this.employeeDialog.show();};this.buttons=[{text:'Save',handler:function(){var _form_basic=this.up('form').getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}}},{text:'Cancel',handler:function(){this.up('form').getForm().reset();this.up('window').hide();}}];this.radioType.on('change',this.selectType,this);return this.callParent(arguments);},load:function(salnr){this.getForm().load({params:{salnr:salnr},url:__site_url+'saleperson/load'});this.numberLevf1.setValue(0);this.numberLevf1.disable();},reset:function(){this.getForm().reset();this.comboQStatus.setValue('01');},remove:function(salnr){var _this=this;this.getForm().load({params:{salnr:salnr},url:__site_url+'saleperson/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},selectType:function(radio,record){var _this=this;var selection=record['ctype'];if(selection==1){this.numberLevf2.setValue(0);this.numberLevf3.setValue(0);this.numberLevf2.disable();this.numberLevf3.disable();}else{this.numberLevf2.enable();this.numberLevf3.enable();}}});;Ext.define('Account.Saleperson.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Sale Person',closeAction:'hide',height:430,width:650,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Saleperson.Item.Form');this.items=this.form;return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);}else{this.dialogId=null;this.form.reset();this.show(false);}}});;Ext.define('Account.Saleperson.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Sale Persons Management',closeAction:'hide',height:550,minHeight:380,width:600,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true,defaultFocus:'code'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('SP')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('SP')||UMS.CAN.CREATE('SP')||UMS.CAN.EDIT('SP'))});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('SP')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disabled:!UMS.CAN.EXPORT('SP')});this.itemDialog=Ext.create('Account.Saleperson.Item.Window');this.grid=Ext.create('Account.Saleperson.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.Saleperson.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(form){_this.itemDialog.hide();_this.grid.load();});this.itemDialog.form.on('afterDelete',function(form){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/saleperson/index?'+query;});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.SAp.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from AP No., Vendor or GR No.',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{name:'lifnr',xtype:'hiddenfield'},{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.SAp.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"ap/loads_inp",reader:{type:'json',root:'rows',idProperty:'invnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['invnr','ebeln','bldat','lifnr','name1','netwr','statx','refnr','sgtxt','ctype','wht01','vat01','loekz'],remoteSort:true,sorters:[{property:'invnr',direction:'ASC'}]});this.columns=[{text:"AP Doc",flex:true,dataIndex:'invnr',align:'center',sortable:true},{text:"AP Date",width:125,format:'d/m/Y',align:'center',dataIndex:'bldat',sortable:true},{text:"Ref Doc",flex:true,dataIndex:'ebeln',align:'center',sortable:true},{text:"Vendor Code",flex:true,align:'center',dataIndex:'lifnr',sortable:true},{text:"Vendor Name",flex:true,dataIndex:'name1',sortable:true},{text:"Net Amount",flex:true,xtype:'numbercolumn',align:'right',dataIndex:'netwr',sortable:true},{text:"AP Status",width:80,align:'center',dataIndex:'statx',sortable:true},{text:"Currency",flex:true,align:'center',dataIndex:'ctype',sortable:true},{text:"1",hidden:true,width:0,dataIndex:'wht01',sortable:false},{text:"2",hidden:true,width:0,dataIndex:'vat01',sortable:false},{text:"3",hidden:true,width:0,dataIndex:'loekz',sortable:false}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.SAp.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Account Payable List',closeAction:'hide',height:600,minHeight:380,width:1090,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.SAp.Grid',{region:'center',border:false});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.SAp.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.SAsset.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Material Code, Name or Type',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'textfield',name:'matnr',hideLabel:false,fieldLabel:'Material Code',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'textfield',name:'matnr2',hideLabel:false,fieldLabel:'To',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.SAsset.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"asset/loads",reader:{type:'json',root:'rows',idProperty:'matnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['matnr','maktx','mtart','mtype','matkl','mgrpp','meins','saknr','sgtxt','erdat'],remoteSort:true,sorters:[{property:'matnr',direction:'ASC'}]});this.columns=[{text:"Asset No",width:80,dataIndex:'matnr',sortable:true},{text:"Asset Name",width:130,dataIndex:'maktx',sortable:true},{text:"Asset Type",width:50,dataIndex:'mtart',sortable:true},{text:"Asset Type Desc",width:120,dataIndex:'mtype',sortable:true},{text:"Asset Grp",width:50,dataIndex:'matkl',sortable:true},{text:"Asset Grp Desc",width:120,dataIndex:'mgrpp',sortable:true},{text:"GL No",width:80,dataIndex:'saknr',sortable:true},{text:"GL Desc",width:130,dataIndex:'sgtxt',sortable:true},{text:"Unit",width:50,dataIndex:'meins',sortable:true},{text:"Create Date",width:120,dataIndex:'erdat',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.SAsset.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Fixed Asset List',closeAction:'hide',height:600,minHeight:380,width:800,minWidth:600,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.SAsset.Grid',{region:'center',border:false});this.searchForm=Ext.create('Account.SAsset.FormSearch',{region:'north',height:100});this.items=[this.searchForm,this.grid];this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.SCurrency.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Currency Code, Name',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});this.items=this.txtQuery;this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.SCurrency.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({pageSize:25,proxy:{type:'ajax',url:__site_url+"currency/loads",reader:{type:'json',root:'rows',idProperty:'ctype',totalProperty:'totalCount'},simpleSortMode:true},fields:['ctype','curtx'],remoteSort:true,sorters:[{property:'ctype',direction:'ASC'}]});this.columns=[{text:"Currency Code",width:80,align:'center',dataIndex:'ctype',sortable:true},{text:"Currency Name",width:250,dataIndex:'curtx',sortable:true}];this.bbar=Ext.create('Ext.PagingToolbar',{store:this.store,displayInfo:true});return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.SCurrency.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Currency List',closeAction:'hide',height:600,minHeight:380,width:350,minWidth:300,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.SCurrency.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});this.searchForm=Ext.create('Account.SCurrency.FormSearch',{region:'north',height:60});this.items=[this.searchForm,this.grid];this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.SCustomer.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Customer Code, Name or Type',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'textfield',name:'kunnr',hideLabel:false,fieldLabel:'Customer Code',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'textfield',name:'kunnr2',hideLabel:false,fieldLabel:'To',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.SCustomer.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"customer/loads",reader:{type:'json',root:'rows',idProperty:'kunnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['kunnr','name1','adr01','distx','pstlz','telf1','telfx','email','pson1','statx'],remoteSort:true,sorters:[{property:'kunnr',direction:'ASC'}]});this.columns=[{text:"Customer Code",width:100,dataIndex:'kunnr',sortable:true},{text:"Name",width:150,dataIndex:'name1',sortable:true},{text:"Address",width:200,dataIndex:'adr01',sortable:true},{text:"District",flex:true,dataIndex:'distx',sortable:true},{text:"Post Code",width:60,dataIndex:'pstlz',sortable:true},{text:"Telephon",flex:true,dataIndex:'telf1',sortable:true},{text:"Fax No",flex:true,dataIndex:'telfx',sortable:true},{text:"Email",width:120,dataIndex:'email',sortable:true},{text:"Contact Person",flex:true,dataIndex:'pson1',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.SCustomer.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Customer List',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:600,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.SCustomer.Grid',{region:'center',border:false});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.SCustomer.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(this.gridParams&&!Ext.isEmpty(this.gridParams)){this.grid.store.on('beforeload',function(store,opts){opts.params=opts.params||{};if(opts.params){opts.params=Ext.apply(opts.params,_this.gridParams);}});}
this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.SDepartment.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.tbar=[this.addAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'sposition/loads_dep',reader:{type:'json',root:'rows',idProperty:'id_depnr2',totalProperty:'totalCount'}},fields:[{name:'id_depnr2',type:'int'},'depnr','deptx'],remoteSort:true,sorters:['id_depnr2 ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{id:'PMiRowNumber05',header:"No",dataIndex:'id_depnr2',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Department Code",width:100,dataIndex:'depnr',sortable:true,field:{type:'textfield'}},{text:"Department",width:125,dataIndex:'deptx',sortable:true,field:{type:'textfield'}}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord2();});return this.callParent(arguments);},load:function(options){this.store.load(options);},addRecord2:function(){var newId=-1;var i=0;this.store.each(function(r){i++;if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(i,rec);edit.startEditByPosition({row:i,column:0});this.runNumRow();},save:function(){var _this=this;var r_data=this.getData();Ext.Ajax.request({url:__site_url+'sposition/save_dep',method:'POST',params:{depn:Ext.encode(r_data)},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){}else{Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}}});},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},reset:function(){this.grid.load({depnr:0});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('id_depnr2',row_num++);});}});;Ext.define('Account.SDepartment.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Position',closeAction:'hide',height:500,minHeight:380,width:600,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true,defaultFocus:'code'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.SDepartment.Grid',{region:'center',border:false});this.items=[this.grid];this.buttons=[{text:'Save',handler:function(){Ext.Msg.show({title:"Warning",msg:"Are you sure you want to update item(s) ?",icon:Ext.Msg.WARNING,buttons:Ext.Msg.YESNO,fn:function(bt){if(bt=="yes"){_this.grid.save();}}});}},{text:'Cancel',handler:function(){_this.hide();}}];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.SDistrict.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'sdistrict/loads',reader:{type:'json',root:'rows',idProperty:'distr',totalProperty:'totalCount'}},fields:['distr','distx'],remoteSort:true,sorters:['distr ASC']});this.columns=[{text:"District no",width:125,dataIndex:'distr',sortable:true},{text:"District Description",flex:true,dataIndex:'distx',sortable:true},];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.SDistrict.MainWindow',{extend:'Ext.window.Window',requires:['Account.SDistrict.Grid',],constructor:function(config){Ext.apply(this,{title:'District',closeAction:'hide',height:380,minHeight:380,width:500,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true,defaultFocus:'code'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.SDistrict.Grid',{region:'center',border:false});this.items=[this.grid];this.tbar=[this.addAct,this.editAct,this.deleteAct];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.SEmployee.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Employee Code, Employee Name',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'textfield',name:'empnr',hideLabel:false,fieldLabel:'Employee Code',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'textfield',name:'empnr2',hideLabel:false,fieldLabel:'To',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.SEmployee.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'semployee/loads',reader:{type:'json',root:'rows',idProperty:'empnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['empnr','name1','postx','deptx'],remoteSort:true,sorters:[{property:'empnr',direction:'ASC'}]});this.columns=[{text:"Employee Code",width:90,dataIndex:'empnr',sortable:true},{text:"Employee Name",width:150,dataIndex:'name1',sortable:true},{text:"Department",width:125,dataIndex:'deptx',sortable:true},{text:"Position",width:125,dataIndex:'postx',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.SEmployee.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Position',closeAction:'hide',height:500,minHeight:380,width:500,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true,defaultFocus:'code'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.SEmployee.Grid',{region:'center',border:false});this.searchForm=Ext.create('Account.SEmployee.FormSearch',{region:'north',height:100});this.items=[this.searchForm,this.grid];this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Service.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Service No., Service Type or Group',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Service.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"service/loads",reader:{type:'json',root:'rows',idProperty:'matnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['matnr','maktx','matkl','mgrpp','sgtxt','meins','saknr','erdat','statx','cost1','unit1','cost2','unit2','cost3','unit3'],remoteSort:true,sorters:[{property:'matnr',direction:'ASC'}]});this.columns=[{text:"Service No",width:80,dataIndex:'matnr',sortable:true},{text:"Service Name",width:130,dataIndex:'maktx',sortable:true},{text:"Group",width:50,dataIndex:'matkl',sortable:true},{text:"Group Desc",width:100,dataIndex:'mgrpp',sortable:true},{text:"GL No",width:80,dataIndex:'saknr',sortable:true},{text:"GL Description",width:130,dataIndex:'sgtxt',sortable:true},{text:"Unit",width:50,dataIndex:'meins',sortable:true},{text:"Create Date",width:120,dataIndex:'erdat',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Unit 1",width:50,dataIndex:'unit1',sortable:true},{text:"Cost 1",width:80,dataIndex:'cost1',sortable:true},{text:"Unit 2",width:50,dataIndex:'unit2',sortable:true},{text:"Cost 2",width:80,dataIndex:'cost2',sortable:true},{text:"Unit 3",width:50,dataIndex:'unit3',sortable:true},{text:"Cost 3",width:80,dataIndex:'cost3',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Service.Import.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center',border:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.uploadAct=new Ext.Action({text:'Upload',iconCls:'b-small-save'});this.items=[{xtype:'filefield',name:'userfile',fieldLabel:'Excel file',labelAlign:'right',msgTarget:'side',allowBlank:false,anchor:'70%',buttonText:'Select Excel file...',allowBlank:false}];this.buttons=[this.uploadAct];this.uploadAct.setHandler(function(){_this.save();});return this.callParent(arguments);},save:function(){var _this=this,form=this.getForm();if(form.isValid()){_this.fireEvent('upload_click');form.submit({url:__site_url+'import/upload/do_upload',waitMsg:'Uploading excel file...',success:function(form,action){_this.fireEvent('upload_success',action.result.file);},failure:function(form,action){Ext.Msg.show({title:'An error occured.',msg:action.result.msg.error,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});}},reset:function(){this.getForm().reset();}});;Ext.define('Account.Service.Import.Grid',{extend:'Ext.grid.Panel',constructor:function(config){Ext.apply(this,{viewConfig:{getRowClass:function(r,rowIndex,rowParams,store){var s=r.get('error');if(s&&s.length>0)
return'red-bg-row';}},buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.importAct=new Ext.Action({text:'Import',iconCls:'b-small-save'});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"import/service/read",reader:{type:'json',root:'rows',idProperty:'row_id'},simpleSortMode:true},fields:['row_id','matnr','maktx','matkl','mtart','meins','saknr','beqty','beval','cosav','enqty','enval','unit1','cost1','unit2','cost2','unit3','cost3','statu','error'],remoteSort:false});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{text:"Service Code",width:100,align:'center',dataIndex:'matnr',sortable:false},{text:"Service Name",width:150,align:'center',dataIndex:'maktx',sortable:false},{text:"Service Group",width:100,align:'center',dataIndex:'matkl',sortable:false},{text:"Service Type",width:80,align:'center',dataIndex:'mtart',sortable:false},{text:"Unit",width:80,align:'center',dataIndex:'unit1',sortable:false},{text:"Cost",width:80,align:'center',dataIndex:'cost1',sortable:false},{text:"Error",width:250,dataIndex:'error',sortable:false,renderer:function(v,p,r){return(v&&v.length>0)?v:'-';}}];this.buttons=[this.importAct];this.importAct.setHandler(function(){_this.importData();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},showMask:function(msg,msgClass){msg=msg||'Please select excel file for upload.';msgClass=msgClass||'grid-disable';this.importAct.setDisabled(true);this.getEl().mask(msg,msgClass);},hideMask:function(){this.importAct.setDisabled(false);this.getEl().unmask();},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();grid.getSelectionModel().deselectAll();},importData:function(){var _this=this;var rs=[];this.store.each(function(r){rs.push(r.getData());});if(rs.length>0){this.showMask('Importing please wait','');var data_json=Ext.encode(rs);Ext.Ajax.request({url:__site_url+'import/service/import',params:{data:data_json},success:function(response){var text=response.responseText;var data=Ext.decode(text);if(data.success){Ext.Msg.show({title:'Import success.',msg:'Import '+data.rows.length+' rows success.',buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO});_this.fireEvent('import_success',data);}else{_this.hideMask();Ext.Msg.show({title:'An error occured.',msg:response,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}},failure:function(response){Ext.Msg.show({title:'An error occured.',msg:response.responseText,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});}else{Ext.Msg.alert('Status','No datas to import.');}}});;Ext.define('Account.Service.Import.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Material Import',closeAction:'hide',height:600,minHeight:480,width:900,minWidth:600,resizable:true,modal:true,layout:'border',maximizable:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Service.Import.Form',{region:'north',height:80});this.grid=Ext.create('Account.Service.Import.Grid',{region:'center',disbled:true});this.items=[this.form,this.grid];this.form.on('upload_success',function(file_name){_this.grid.hideMask();_this.grid.load({file:file_name});});return this.callParent(arguments);},openDialog:function(){this.form.reset();this.grid.store.removeAll();this.show(false,function(){this.grid.showMask();});}});;Ext.define('Account.Service.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'service/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'right',msgTarget:'qtip',labelWidth:105}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grpDialog=Ext.create('Account.Materialgrp.Window');this.trigGrp=Ext.create('Ext.form.field.Trigger',{name:'matkl',fieldLabel:'Service Group',triggerCls:'x-form-search-trigger',enableKeyEvents:true});this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('SV'),fieldLabel:'Service Status',name:'statu',labelAlign:'right',editable:false,allowBlank:false,triggerAction:'all',margin:'0 0 0 10',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.glnoDialog=Ext.create('Account.GL.MainWindow');this.trigGlno=Ext.create('Ext.form.field.Trigger',{name:'saknr',fieldLabel:'GL Account',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false});this.unitDialog=Ext.create('Account.Unit.Window');this.trigUnit=Ext.create('Ext.form.field.Trigger',{name:'meins',fieldLabel:'Unit',triggerCls:'x-form-search-trigger',editable:false,enableKeyEvents:true});this.unit1Dialog=Ext.create('Account.Unit.Window');this.trigUnit1=Ext.create('Ext.form.field.Trigger',{name:'unit1',fieldLabel:'Unit 1',triggerCls:'x-form-search-trigger',editable:false,enableKeyEvents:true});this.unit2Dialog=Ext.create('Account.Unit.Window');this.trigUnit2=Ext.create('Ext.form.field.Trigger',{name:'unit2',fieldLabel:'Unit 2',triggerCls:'x-form-search-trigger',editable:false,enableKeyEvents:true});this.unit3Dialog=Ext.create('Account.Unit.Window');this.trigUnit3=Ext.create('Ext.form.field.Trigger',{name:'unit3',fieldLabel:'Unit 3',triggerCls:'x-form-search-trigger',editable:false,enableKeyEvents:true});this.items=[{xtype:'hidden',name:'id'},{xtype:'fieldset',title:'Service Data',collapsible:true,defaultType:'textfield',layout:'anchor',items:[{xtype:'displayfield',fieldLabel:'Service Code',name:'matnr',readOnly:true,value:'XXXXX'},{xtype:'textfield',fieldLabel:'Service Name',name:'maktx',width:400,allowBlank:false},{xtype:'container',layout:'hbox',items:[{xtype:'textfield',name:'mtart',value:'SV',fieldLabel:'Service Type',readOnly:true},{xtype:'displayfield',name:'mtype',margins:'4 0 0 6',value:'Service Material',width:286}]},{xtype:'container',layout:'hbox',items:[this.trigGrp,{xtype:'displayfield',name:'mgrpp',margins:'4 0 0 6',width:286}]},this.trigUnit,{xtype:'container',layout:'hbox',items:[this.trigGlno,{xtype:'displayfield',name:'sgtxt',margins:'4 0 0 6',width:286}]}]},{xtype:'fieldset',title:'Costing Data',collapsible:true,defaultType:'textfield',layout:'anchor',items:[{xtype:'container',layout:'hbox',items:[{xtype:'container',flex:1,layout:'anchor',items:[this.trigUnit1,this.trigUnit2,this.trigUnit3]},{xtype:'container',flex:1,layout:'anchor',items:[{xtype:'numberfield',fieldLabel:'Cost 1',name:'cost1',labelWidth:90,allowBlank:true},{xtype:'numberfield',fieldLabel:'Cost 2',minValue:0,name:'cost2',labelWidth:90,allowBlank:true},{xtype:'numberfield',fieldLabel:'Cost 3',minValue:0,name:'cost3',labelWidth:90,allowBlank:true}]}]}]},this.comboQStatus];this.trigGrp.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'material/load_grp',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.trigGrp.setValue(r.data.matkl);_this.getForm().findField('mgrpp').setValue(r.data.matxt);_this.getForm().findField('saknr').setValue(r.data.saknr);_this.getForm().findField('sgtxt').setValue(r.data.sgtxt);}else{o.markInvalid('Could not find material group : '+o.getValue());}}});}},this);_this.grpDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigGrp.setValue(record.data.matkl);_this.getForm().findField('mgrpp').setValue(record.data.matxt);_this.getForm().findField('saknr').setValue(record.data.saknr);_this.getForm().findField('sgtxt').setValue(record.data.sgtxt);grid.getSelectionModel().deselectAll();_this.grpDialog.hide();});this.trigGrp.onTriggerClick=function(){_this.grpDialog.show();};this.trigUnit.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'unit/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.meins);}else{o.markInvalid('Could not find Unit : '+o.getValue());}}});}},this);_this.unitDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigUnit.setValue(record.data.meins);grid.getSelectionModel().deselectAll();_this.unitDialog.hide();});this.trigUnit.onTriggerClick=function(){_this.unitDialog.grid.load();_this.unitDialog.show();};this.trigUnit1.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'unit/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.meins);}else{o.markInvalid('Could not find Unit : '+o.getValue());}}});}},this);_this.unit1Dialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigUnit1.setValue(record.data.meins);grid.getSelectionModel().deselectAll();_this.unit1Dialog.hide();});this.trigUnit1.onTriggerClick=function(){_this.unit1Dialog.grid.load();_this.unit1Dialog.show();};this.trigUnit2.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'unit/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.meins);}else{o.markInvalid('Could not find Unit : '+o.getValue());}}});}},this);_this.unit2Dialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigUnit2.setValue(record.data.meins);grid.getSelectionModel().deselectAll();_this.unit2Dialog.hide();});this.trigUnit2.onTriggerClick=function(){_this.unit2Dialog.grid.load();_this.unit2Dialog.show();};this.trigUnit3.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'unit/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.meins);}else{o.markInvalid('Could not find Unit : '+o.getValue());}}});}},this);_this.unit3Dialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigUnit3.setValue(record.data.meins);grid.getSelectionModel().deselectAll();_this.unit3Dialog.hide();});this.trigUnit3.onTriggerClick=function(){_this.unit3Dialog.grid.load();_this.unit3Dialog.show();};this.trigGlno.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'gl/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){o.setValue(r.data.saknr);_this.getForm().findField('sgtxt').setValue(record.data.sgtxt);}else{o.markInvalid('Could not find GL Account : '+o.getValue());}}});}},this);_this.glnoDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigGlno.setValue(record.data.saknr);_this.getForm().findField('sgtxt').setValue(record.data.sgtxt);grid.getSelectionModel().deselectAll();_this.glnoDialog.hide();});this.trigGlno.onTriggerClick=function(){_this.glnoDialog.show();};return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'service/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},reset:function(){this.getForm().reset();this.comboQStatus.setValue('01');},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'service/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});}});;Ext.define('Account.Service.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Service',closeAction:'hide',height:400,width:550,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Service.Item.Form');this.items=this.form;this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);}else{this.dialogId=null;this.form.reset();this.show(false);}}});;Ext.define('Account.Service.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Service Management',closeAction:'hide',height:600,minHeight:380,width:1250,minWidth:100,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil'});this.deleteAct=new Ext.Action({text:'Delete',disabled:true,iconCls:'b-small-minus'});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel'});this.importAct=new Ext.Action({text:'Import',iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.Service.Item.Window');this.importDialog=Ext.create('Account.Service.Import.Window');this.grid=Ext.create('Account.Service.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});this.searchForm=Ext.create('Account.Service.FormSearch',{region:'north',height:100});this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/service/index?'+query;});this.importAct.setHandler(function(){_this.importDialog.openDialog();});this.itemDialog.form.on('afterSave',function(){_this.itemDialog.hide();_this.grid.load();});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();opts.params=Ext.apply(opts.params,formValues);}});if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.importDialog.grid.on('import_success',function(){_this.importDialog.hide();_this.grid.load();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.SInvoice.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Invoice No., Customer or Sale Order',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{name:'kunnr',xtype:'hiddenfield'},{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'datefield',name:'bldat',hideLabel:false,fieldLabel:'Start Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'datefield',name:'bldat2',hideLabel:false,fieldLabel:'End Date',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.SInvoice.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"invoice/loads_inv",reader:{type:'json',root:'rows',idProperty:'invnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['invnr','bldat','kunnr','name1','vbeln','jobtx','sname','statx','paytx','netwr','ctype','refnr','txz01','wht01','vat01','loekz'],remoteSort:true,sorters:[{property:'invnr',direction:'ASC'}]});this.columns=[{text:"Invoice No",width:80,align:'center',dataIndex:'invnr',sortable:true},{text:"Invoice Date",xtype:'datecolumn',format:'d/m/Y',width:80,align:'center',dataIndex:'bldat',sortable:true},{text:"Customer No",width:80,align:'center',dataIndex:'kunnr',sortable:true},{text:"Customer Name",width:150,dataIndex:'name1',sortable:true},{text:"Quotation No",width:80,align:'center',dataIndex:'vbeln',sortable:true},{text:"Project Name",width:150,dataIndex:'jobtx',sortable:true},{text:"Sale Person",width:120,dataIndex:'sname',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Payment Method",width:100,dataIndex:'paytx',sortable:true},{text:"Amount",xtype:'numbercolumn',width:80,align:'right',dataIndex:'netwr',sortable:true},{text:"Currency",width:60,align:'center',dataIndex:'ctype',sortable:true},{text:"1",hidden:true,width:0,dataIndex:'refnr',sortable:false},{text:"2",hidden:true,width:0,dataIndex:'txz01',sortable:false},{text:"3",hidden:true,width:0,dataIndex:'wht01',sortable:false},{text:"4",hidden:true,width:0,dataIndex:'vat01',sortable:false},{text:"5",hidden:true,width:0,dataIndex:'loekz',sortable:false}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.SInvoice.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Invoice List',closeAction:'hide',height:600,minHeight:380,width:1090,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.SInvoice.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.SInvoice.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.SMatAsset.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Mat/Service/Asset Code, Name or Type',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'textfield',name:'matnr',hideLabel:false,fieldLabel:'Material Code',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'textfield',name:'matnr2',hideLabel:false,fieldLabel:'To',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.SMatAsset.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"asset/load2",reader:{type:'json',root:'rows',idProperty:'matnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['matnr','maktx','mtart','mtype','matkl','mgrpp','meins','saknr','sgtxt','statx','erdat'],remoteSort:true,sorters:[{property:'matnr',direction:'ASC'}]});this.columns=[{text:"Mat&Asset No",width:80,dataIndex:'matnr',sortable:true},{text:"Mat&Asset Name",width:130,dataIndex:'maktx',sortable:true},{text:"Type",width:50,dataIndex:'mtart',sortable:true},{text:"Type Desc",width:100,dataIndex:'mtype',sortable:true},{text:"Group",width:50,dataIndex:'matkl',sortable:true},{text:"Group Desc",width:100,dataIndex:'mgrpp',sortable:true},{text:"GL No",width:80,dataIndex:'saknr',sortable:true},{text:"GL Desc",width:130,dataIndex:'sgtxt',sortable:true},{text:"Unit",width:50,dataIndex:'meins',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true},{text:"Create Date",width:120,dataIndex:'erdat',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.SMatAsset.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Material,Service & Asset List',closeAction:'hide',height:700,minHeight:380,width:1050,minWidth:600,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.SMatAsset.Grid',{region:'center',border:false});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.SMatAsset.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.SMaterial.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Material Code, Name or Type',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});this.comboQStatus=Ext.create('Ext.form.ComboBox',{fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'textfield',name:'matnr',hideLabel:false,fieldLabel:'Material Code',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'textfield',name:'matnr2',hideLabel:false,fieldLabel:'To',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.SMaterial.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"material/load2",reader:{type:'json',root:'rows',idProperty:'matnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['matnr','maktx','mtart','mtype','matkl','mgrpp','meins','saknr','sgtxt','erdat'],remoteSort:true,sorters:[{property:'matnr',direction:'ASC'}]});this.columns=[{text:"Material No",width:80,dataIndex:'matnr',sortable:true},{text:"Material Name",width:130,dataIndex:'maktx',sortable:true},{text:"Material Type",width:50,dataIndex:'mtart',sortable:true},{text:"Material Type Desc",width:120,dataIndex:'mtype',sortable:true},{text:"Material Grp",width:50,dataIndex:'matkl',sortable:true},{text:"Material Grp Desc",width:120,dataIndex:'mgrpp',sortable:true},{text:"GL No",width:80,dataIndex:'saknr',sortable:true},{text:"GL Desc",width:130,dataIndex:'sgtxt',sortable:true},{text:"Unit",width:50,dataIndex:'meins',sortable:true},{text:"Create Date",width:120,dataIndex:'erdat',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.SMaterial.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Material&Service List',closeAction:'hide',height:600,minHeight:380,width:800,minWidth:600,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.SMaterial.Grid',{region:'center',border:false});this.searchForm=Ext.create('Account.SMaterial.FormSearch',{region:'north',height:100});this.items=[this.searchForm,this.grid];this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.SPosition.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.depnrDialog=Ext.create('Account.SDepartment.MainWindow');this.tbar=[this.addAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'sposition/loads',reader:{type:'json',root:'rows',idProperty:'id_depnr',totalProperty:'totalCount'}},fields:[{name:'id_depnr',type:'int'},'depnr','posnr','postx','deptx'],remoteSort:true,sorters:['id_depnr ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{id:'PMiRowNumber005',header:"No",dataIndex:'id_depnr',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Department Code",width:100,dataIndex:'depnr',sortable:true,field:{xtype:'triggerfield',enableKeyEvents:true,allowBlank:false,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.depnrDialog.show();}}},{text:"Department",width:125,dataIndex:'deptx',sortable:true},{text:"Position Code",width:100,dataIndex:'posnr',sortable:true,field:{type:'textfield'}},{text:"Position",width:150,dataIndex:'postx',sortable:true,field:{type:'textfield'}}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='depnr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'sposition/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.depnr);rModel.set('deptx',r.data.deptx);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.depnrDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('depnr',record.data.depnr);rModel.set('deptx',record.data.deptx);}
grid.getSelectionModel().deselectAll();_this.depnrDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load(options);},addRecord:function(){var newId=-1;var i=0;this.store.each(function(r){i++;if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(i,rec);edit.startEditByPosition({row:i,column:0});this.runNumRow();},save:function(){var _this=this;var r_data=this.getData();Ext.Ajax.request({url:__site_url+'sposition/save',method:'POST',params:{posi:Ext.encode(r_data)},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){}else{Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}}});},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},reset:function(){this.grid.load({depnr:0});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('id_depnr',row_num++);});}});;Ext.define('Account.SPosition.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Position',closeAction:'hide',height:500,minHeight:380,width:600,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true,defaultFocus:'code'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.SPosition.Grid',{region:'center',border:false});this.items=[this.grid];this.buttons=[{text:'Save',handler:function(){Ext.Msg.show({title:"Warning",msg:"Are you sure you want to update item(s) ?",icon:Ext.Msg.WARNING,buttons:Ext.Msg.YESNO,fn:function(bt){if(bt=="yes"){_this.grid.save();}}});}},{text:'Cancel',handler:function(){_this.hide();}}];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.SVendor.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Vendor Code, Name or Type',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'textfield',name:'lifnr',hideLabel:false,fieldLabel:'Vendor Code',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'textfield',name:'lifnr2',hideLabel:false,fieldLabel:'To',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.SVendor.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"vendor/loads",reader:{type:'json',root:'rows',idProperty:'lifnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['lifnr','name1','adr01','distx','pstlz','telf1','telfx','email','pson1','statx'],remoteSort:true,sorters:[{property:'lifnr',direction:'ASC'}]});this.columns=[{text:"Vendor Code",width:90,dataIndex:'lifnr',sortable:true},{text:"Name",width:150,dataIndex:'name1',sortable:true},{text:"Address",width:200,dataIndex:'adr01',sortable:true},{text:"District",flex:true,dataIndex:'distx',sortable:true},{text:"Post Code",width:60,dataIndex:'pstlz',sortable:true},{text:"Telephon",flex:true,dataIndex:'telf1',sortable:true},{text:"Fax No",flex:true,dataIndex:'telfx',sortable:true},{text:"Email",width:120,dataIndex:'email',sortable:true},{text:"Contact Person",flex:true,dataIndex:'pson1',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.SVendor.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Vendor List',closeAction:'hide',height:600,minHeight:380,width:1000,minWidth:600,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.SVendor.Grid',{region:'center',border:false});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.SVendor.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.UMS.Employee.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'ums/loads_employee',reader:{type:'json',root:'rows',idProperty:'empnr'},simpleSortMode:true},fields:['empnr','name1','adr01','distx','pstlz','telf1','cidno','email','pson1'],remoteSort:true,sorters:[{property:'empnr',direction:'ASC'}]});this.columns=[{text:"Code",width:50,dataIndex:'empnr',sortable:true},{text:"Name",width:150,dataIndex:'name1',sortable:true},{text:"Address",width:200,dataIndex:'adr01',sortable:true},{text:"District",flex:true,dataIndex:'distx',sortable:true},{text:"Post Code",width:60,dataIndex:'pstlz',sortable:true},{text:"Telephon",flex:true,dataIndex:'telf1',sortable:true},{text:"Email",width:120,dataIndex:'email',sortable:true},{text:"Contact Person",flex:true,dataIndex:'pson1',sortable:true}];this.bbar={xtype:'pagingtoolbar',store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.UMS.Employee.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Choose employee',closeAction:'hide',height:380,minHeight:380,width:1000,minWidth:1000,resizable:true,modal:true,layout:'border',maximizable:true,defaultFocus:'code'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.UMS.Employee.Grid',{region:'center',border:false});this.searchForm=Ext.create('Account.Employee.FormSearch',{region:'north',height:100});this.items=[this.searchForm,this.grid];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.UMS.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'ums/loads_user',reader:{type:'json',root:'rows',idProperty:function(o){return o.comid+'$'+o.uname;}},simpleSortMode:true},fields:['comid','empnr','uname','name1','name2','adr01','adr02','ort01','distr','pstlz','telf1','telfx','posit','autnr','posnr','depnr','postx','deptx'],remoteSort:true,sorters:[{property:'empnr',direction:'ASC'}]});this.columns=[{text:"Company ID",width:90,dataIndex:'comid',sortable:false},{text:"Employee No",width:100,dataIndex:'empnr',sortable:false},{text:"Username",width:100,dataIndex:'uname',sortable:false},{text:"Name",width:135,dataIndex:'name1',sortable:false},{text:"Position",width:105,dataIndex:'postx',sortable:false},{text:"Department",width:105,dataIndex:'deptx',sortable:false}];this.bbar={xtype:'pagingtoolbar',store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options});},getSelectionId:function(){var sel=this.getView().getSelectionModel().getSelection()[0];if(!sel)return;var retId=sel.data[sel.idField.name];var retIds=retId.split('$');if(retIds.length==2)
return retIds[1];else
return;}});;Ext.define('Account.UMS.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'ums/save',layout:'border',border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.UMS.Item.GridPermission',{region:'center',title:'Permission settings'});var dispEmployeeCode=Ext.create('Ext.form.field.Display',{fieldLabel:'Employee',labelWidth:65,name:'empnr',labelAlign:'right'});var dispEmployee=Ext.create('Ext.form.field.Display',{fieldLabel:'Name',labelWidth:65,name:'name1',labelAlign:'right'});var dispUsername=Ext.create('Ext.form.field.Display',{fieldLabel:'Username',labelWidth:65,name:'uname',labelAlign:'right'});var mainFormPanel={title:'User description',xtype:'panel',border:true,region:'west',split:true,width:230,bodyPadding:'5 5 0 5',defaults:{labelAlign:'right',msgTarget:'qtip',labelWidth:65,width:200},items:[dispEmployeeCode,dispEmployee,dispUsername,{xtype:'hiddenfield',name:'uname'},{xtype:'textfield',fieldLabel:'Password',inputType:'password',name:'passw',allowBlank:false}]};this.items=[mainFormPanel,this.grid];return this.callParent(arguments);},form_params:null,load:function(id){var _this=this;_this.form_params={id:id};this.getForm().load({params:_this.form_params,url:__site_url+'ums/load',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});this.grid.load({uname:id});},save:function(){var _this=this;var _form_basic=this.getForm();var rsItem=this.grid.getData();var form_params=Ext.apply(_this.form_params,{autx:Ext.encode(rsItem)});if(_form_basic.isValid()){_form_basic.submit({clientValidation:true,waitMsg:'Update user, please wait...',params:form_params,success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'quotation/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},reset:function(){this.getForm().reset();this.grid.load({uname:'-1'});}});;Ext.define('Account.UMS.Item.GridLimit',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'ums/loads_doctype_limit',reader:{type:'json',root:'rows',idProperty:'empnr'},simpleSortMode:true},fields:[{name:'comid',type:'string'},{name:'empnr',type:'string'},{name:'docty',type:'string'},{name:'doctx',type:'string'},{name:'limam',type:'float'}],remoteSort:false,sorters:[{property:'docty',direction:'ASC'}]});this.columns=[{text:"Employee Code",align:'center',width:80,dataIndex:'comid',sortable:false,hidden:true},{text:"Document Type",align:'left',width:150,dataIndex:'doctx',sortable:false},{text:"Limit",align:'right',width:80,dataIndex:'limam',sortable:false,field:{type:'numberfield',decimalPrecision:2},renderer:Ext.util.Format.numberRenderer('0,0.##')}];this.plugins=[this.editing];return this.callParent(arguments);},load:function(options,cb,scope){var prms={params:options};if(cb&&typeof(cb)=='function')
prms['callback']=cb;if(scope)
prms['scope']=scope;this.store.load(prms);},getSelectionId:function(){var sel=this.getView().getSelectionModel().getSelection()[0];if(!sel)return;return sel.data[sel.idField.name];},getData:function(){var rs=[];this.store.each(function(r){if(r.data['limam']>0)
rs.push(r.getData());});return rs;}});;Ext.define('Account.UMS.Item.GridPermission',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'ums/loads_permission',reader:{type:'json',root:'rows',idProperty:'empnr'},simpleSortMode:true},fields:[{name:'doctx',type:'string'},{name:'docty',type:'string'},{name:'grpmo',type:'string'},{name:'display',type:'string'},{name:'create',type:'string'},{name:'edit',type:'string'},{name:'delete',type:'string'},{name:'export',type:'string'},{name:'approve',type:'string'},{name:'uname',type:'string'}],remoteSort:false,sorters:[{property:'grpmo',direction:'ASC'}]});this.columns=[{id:'doctx',text:"Doc Type",align:'left',width:160,dataIndex:'doctx',sortable:true},{text:"Module",align:'center',width:70,dataIndex:'grpmo',sortable:true},{text:"Display",align:'center',width:70,renderer:this.renderAuthenField,dataIndex:'display',sortable:false},{text:"Create",align:'center',width:70,renderer:this.renderAuthenField,dataIndex:'create',sortable:false},{text:"Edit",align:'center',width:70,renderer:this.renderAuthenField,dataIndex:'edit',sortable:false},{text:"Delete",align:'center',width:70,renderer:this.renderAuthenField,dataIndex:'delete',sortable:false},{text:"Export",align:'center',width:70,renderer:this.renderAuthenField,dataIndex:'export',sortable:false},{text:"Approve",align:'center',width:70,renderer:this.renderAuthenField,dataIndex:'approve',sortable:false}];this.on('cellclick',function(grid,td,cellIndex,record,tr,rowIndex,e,eOpts){if(cellIndex>=2&&cellIndex<=7){var fieldName=this.columns[cellIndex].dataIndex,val=record.get(fieldName);record.set(fieldName,(val=='0')?'1':'0');}});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},getSelectionId:function(){var sel=this.getView().getSelectionModel().getSelection()[0];if(!sel)return;return sel.data[sel.idField.name];},renderAuthenField:function(v,p,r)
{return(v==1)?"<img src='"+__base_url+"assets/images/icons/accept.png' />":"<img src='"+__base_url+"assets/images/icons/cross2.png' />";},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},getDocTypeApprovable:function(){var rs=[];this.store.each(function(r){if(r.data['display']==1&&r.data['approve']==1)
rs.push(r.data['docty']);});return rs;}});;Ext.define('Account.UMS.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'User authorization setting',closeAction:'hide',height:570,width:910,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.UMS.Item.Form',{region:'center'});this.items=[this.form];this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);}else{this.dialogId=null;this.form.reset();this.show(false);}}});;Ext.define('Account.UMS.Login.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,waitMsgTarget:true,defaults:{allowBlank:false,labelAlign:'right',width:380}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.comboCompany=Ext.create('Ext.form.ComboBox',{fieldLabel:'Company',name:'comid',labelAlign:'right',width:380,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Company --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'umslimit/loads_company_combo',reader:{type:'json',root:'rows',idProperty:'comid'}},fields:['comid','name1']}),queryMode:'remote',displayField:'name1',valueField:'comid'});this.items=[this.comboCompany,{xtype:'textfield',fieldLabel:'Username',name:"username",emptyText:'',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.fireEvent('form_key_enter');}}},{xtype:'textfield',inputType:'password',fieldLabel:'Password',name:"password",emptyText:'',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.fireEvent('form_key_enter');}}}];this.comboCompany.on('render',function(){_this.comboCompany.setValue('1000');_this.comboCompany.store.load();});return this.callParent(arguments);},submit:function(){var _this=this,formBasic=this.getForm();if(formBasic.isValid()){var progress=Ext.Msg.show({msg:'Processing login, please wait...',closable:false,draggable:false,toFrontOnShow:true,progress:true,wait:true,waitConfig:{interval:250,animate:true,text:'Loggin in...'}});formBasic.submit({clientValidation:true,waitMsg:'Loging in...',url:__site_url+'ums/do_login',success:function(formBasic,action){_this.fireEvent('login_success',action.result.msg);},failure:function(formBasic,action){var showError=function(title,msg){Ext.Msg.show({title:title,msg:msg,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});};switch(action.failureType){case Ext.form.action.Action.CLIENT_INVALID:showError('Failure','Form fields may not be submitted with invalid values');break;case Ext.form.action.Action.CONNECT_FAILURE:showError('Failure','Ajax communication failed');break;case Ext.form.action.Action.SERVER_INVALID:showError('Failure',action.result.msg);}}});}},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.UMS.Login.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Login',closeAction:'hide',width:440,minWidth:440,height:300,minHeight:300,resizable:true,modal:true,layout:'border',closable:false,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.UMS.Login.Form',{region:'center'});this.submitAct=new Ext.Action({text:'Login',iconCls:'b-small-key',animate:true});this.buttons=[new Ext.button.Button(this.submitAct)];this.items=[{xtype:'panel',region:'north',border:false,height:140,html:'<div style="height:120px; background:#f3f3f5 url('+__base_url+'assets/images/icons/bmblogo.jpg) no-repeat center center;"></div>'},this.form];this.submitAct.setHandler(function(){_this.form.submit(function(err,result){if(err)
Ext.Msg.alert('Failure',err);else
Ext.Msg.alert('Success',result);});});this.form.on('form_key_enter',function(){_this.submitAct.execute();});return this.callParent(arguments);}});;Ext.define('Account.UMS.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Authorize setting',closeAction:'hide',height:500,minHeight:500,width:650,minWidth:650,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil'});this.tbar=[this.addAct,this.editAct];this.grid=Ext.create('Account.UMS.Grid',{region:'center',border:false});this.itemDialog=Ext.create('Account.UMS.Item.Window');this.items=[this.grid];this.editAct.setHandler(function(){var id=_this.grid.getSelectionId();if(id){_this.itemDialog.openDialog(id);}});this.itemDialog.form.on('afterSave',function(){_this.itemDialog.hide();_this.grid.load();});this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.UMSLimit.Item.DocForm',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'umslimit/save_document',border:true,bodyPadding:'15 5 0 5',defaults:{labelAlign:'right',msgTarget:'qtip',labelWidth:145,width:250}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.items=[{xtype:'combo',fieldLabel:'Depend on department',name:'depdp',editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'Please select',fields:['value','text'],store:[['1','Yes'],['0','No']],valueField:'value',displayField:'text'}];return this.callParent(arguments);},form_params:null,load:function(prms){var _this=this;this.form_params=prms;this.getForm().load({waitMsg:'Loading, please wait...',params:_this.form_params,url:__site_url+'umslimit/load_document',success:function(form,act){_this.fireEvent('afterLoad',form,act);}});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({clientValidation:true,waitMsg:'Saving, please wait...',params:this.form_params,success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},reset:function(){this.getForm().reset();}});;Ext.define('Account.UMSLimit.Item.DocWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Document setting',closeAction:'hide',height:130,width:300,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.UMSLimit.Item.DocForm',{region:'center'});this.items=[this.form];this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];return this.callParent(arguments);},openDialog:function(action,params){this.form.form_action=action;this.form.form_params=params;if(action=='edit'){this.show(false);this.show();this.form.load(params);}else{this.form.reset();this.show(false);}}});;Ext.define('Account.UMSLimit.Item.LimitForm',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'umslimit/save_limit',border:true,bodyPadding:'15 5 0 5',defaults:{labelAlign:'right',msgTarget:'qtip',labelWidth:95,width:280}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.items=[{xtype:'numberfield',fieldLabel:'Limit amount',name:'limam',allowBlank:false,allowDecimals:true,minValue:0}];return this.callParent(arguments);},form_params:null,load:function(prms){var _this=this;this.form_params=prms;this.getForm().load({waitMsg:'Loading, please wait...',params:_this.form_params,url:__site_url+'umslimit/load_limit',success:function(form,act){_this.fireEvent('afterLoad',form,act);},failure:_this.failureAlert});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({clientValidation:true,waitMsg:'Saving, please wait...',params:this.form_params,success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:_this.failureAlert});}},remove:function(params){var _this=this;Ext.Msg.show({title:"Warning",msg:"Do you want to delete item?",icon:Ext.Msg.WARNING,buttons:Ext.Msg.YESNO,fn:function(bt){if(bt=="yes"){var url=__site_url+'umslimit/remove_limit';_this.form.load({url:url,success:function(form,act){_this.fireEvent('afterDelete',_this,act);},failure:_this.failureAlert,waitMsg:'Deleting...',waitTitle:'Please wait...',params:params});}}});},failureAlert:function(form,action){var showError=function(title,msg){Ext.Msg.show({title:title,msg:msg,icon:Ext.Msg.ERROR,buttons:Ext.Msg.OK});};switch(action.failureType){case Ext.form.action.Action.CLIENT_INVALID:showError('Failure','Form fields may not be submitted with invalid values');break;case Ext.form.action.Action.CONNECT_FAILURE:showError('Failure','Ajax communication failed');break;case Ext.form.action.Action.SERVER_INVALID:showError('Failure',action.response.responseText);}},reset:function(){this.getForm().reset();}});;Ext.define('Account.UMSLimit.Item.LimitWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Limit amount setting',closeAction:'hide',height:130,width:340,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.UMSLimit.Item.LimitForm',{region:'center'});this.items=[this.form];this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];return this.callParent(arguments);},openDialog:function(action,params){var _this=this;this.form.form_action=action;this.form.form_params=params;if(action=='edit'){this.show(false);this.form.load(params);}else if(action=='remove'){this.hide();this.form.remove(params);}else{this.form.reset();this.show(false);}}});;Ext.define('Account.UMSLimit.Item.UserForm',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'umslimit/save_user',border:true,bodyPadding:'15 5 0 5',defaults:{labelAlign:'right',msgTarget:'qtip',labelWidth:95,width:280}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.employeeDialog=Ext.create('Account.UMSLimit.User.Window');this.trigEmployee=Ext.create('Ext.form.field.Trigger',{name:'empnr',fieldLabel:'Employee',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false,labelAlign:'right',msgTarget:'qtip',labelWidth:95,width:280});this.items=[this.trigEmployee];this.trigEmployee.onTriggerClick=function(){_this.employeeDialog.show();};this.employeeDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigEmployee.setValue(record.data.empnr);grid.getSelectionModel().deselectAll();_this.employeeDialog.hide();});return this.callParent(arguments);},form_params:null,load:function(prms){var _this=this;this.form_params=prms;this.getForm().load({waitMsg:'Loading, please wait...',params:_this.form_params,url:__site_url+'umslimit/load_limit',success:function(form,act){_this.fireEvent('afterLoad',form,act);},failure:_this.failureAlert});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({clientValidation:true,waitMsg:'Saving, please wait...',params:this.form_params,success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this,action);},failure:_this.failureAlert});}},remove:function(params){var _this=this;Ext.Msg.show({title:"Warning",msg:"Do you want to delete item?",icon:Ext.Msg.WARNING,buttons:Ext.Msg.YESNO,fn:function(bt){if(bt=="yes"){var url=__site_url+'umslimit/remove_user';_this.form.load({url:url,success:function(form,act){_this.fireEvent('afterDelete',_this,act);},failure:_this.failureAlert,waitMsg:'Deleting...',waitTitle:'Please wait...',params:params});}}});},failureAlert:function(form,action){var showError=function(title,msg){Ext.Msg.show({title:title,msg:msg,icon:Ext.Msg.ERROR,buttons:Ext.Msg.OK});};switch(action.failureType){case Ext.form.action.Action.CLIENT_INVALID:showError('Failure','Form fields may not be submitted with invalid values');break;case Ext.form.action.Action.CONNECT_FAILURE:showError('Failure','Ajax communication failed');break;case Ext.form.action.Action.SERVER_INVALID:showError('Failure',action.response.responseText);}},reset:function(){this.getForm().reset();}});;Ext.define('Account.UMSLimit.Item.UserWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Limit amount setting',closeAction:'hide',height:150,width:340,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.UMSLimit.Item.UserForm',{region:'center'});this.items=[this.form];this.buttons=[{text:'Save',handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];return this.callParent(arguments);},openDialog:function(action,params){this.form.form_action=action;this.form.form_params=params;if(action=='edit'){this.show(false);this.show();this.form.load(params);}else if(action=='remove'){this.hide();this.form.remove(params);}else{this.form.reset();this.show(false);}}});;Ext.define('Account.UMSLimit.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Limitation setting',closeAction:'destroy',height:500,minHeight:500,width:550,minWidth:550,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.tree=Ext.create('Account.UMSLimit.TreeDocType',{region:'center',border:false,extraParams:this.treeExtraParams});this.items=[this.tree];return this.callParent(arguments);},dialogParams:null,openDialog:function(params){this.dialogParams=params;this.show(false,function(){this.tree.load(params);});}});;Ext.define('Account.UMSLimit.SelectCompanyWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Select company',closeAction:'hide',height:130,width:340,layout:'border',border:false,resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.comboCompany=Ext.create('Ext.form.ComboBox',{fieldLabel:'Company',name:'statu',labelAlign:'right',width:240,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Company --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'umslimit/loads_company_combo',reader:{type:'json',root:'rows',idProperty:'comid'}},fields:['comid','name1']}),queryMode:'remote',displayField:'name1',valueField:'comid'});var form=Ext.create('Ext.form.Panel',{region:'center',bodyPadding:'15 5 0 5',defaults:{labelAlign:'right',msgTarget:'qtip',labelWidth:95,width:280},items:[this.comboCompany]});this.items=form;this.buttons=[{text:'Select',handler:function(){if(form.isValid()){var mainWindow=Ext.create('Account.UMSLimit.MainWindow',{treeExtraParams:{comid:_this.comboCompany.getValue()}});mainWindow.openDialog({comid:_this.comboCompany.getValue()});}}}];return this.callParent(arguments);}});;Ext.define('Account.UMSLimit.TreeDocType',{extend:'Ext.tree.Panel',constructor:function(config){Ext.apply(this,{rootVisible:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.editDocAct=new Ext.Action({text:'Edit document',iconCls:'b-small-page_edit'});this.addLimitAct=new Ext.Action({text:'Add limit',iconCls:'b-small-money_add'});this.editLimitAct=new Ext.Action({text:'Edit limit',iconCls:'b-small-money'});this.removeLimitAct=new Ext.Action({text:'Remove limit',iconCls:'b-small-money_delete'});this.addEmp=new Ext.Action({text:'Add employee',iconCls:'b-small-user_add'});this.removeEmp=new Ext.Action({text:'Remove employee',iconCls:'b-small-user_delete'});var menuDocty=new Ext.menu.Menu({items:[this.editDocAct,this.addLimitAct]});var menuLimit=new Ext.menu.Menu({items:[this.editLimitAct,this.removeLimitAct,this.addEmp]});var menuUser=new Ext.menu.Menu({items:[this.removeEmp]});this.docWindow=Ext.create('Account.UMSLimit.Item.DocWindow');this.limitWindow=Ext.create('Account.UMSLimit.Item.LimitWindow');this.userWindow=Ext.create('Account.UMSLimit.Item.UserWindow');this.store=new Ext.data.TreeStore({autoLoad:false,clearOnLoad:true,proxy:{type:'ajax',url:__site_url+'umslimit/loads_tree_doctype',extraParams:this.extraParams,reader:{type:'json',root:'rows',}},root:{text:'Document',id:'root'}});$splitter='$';function is_node_root($id){return $id=='root';}
function is_node_docty($id){$id=$id||'';return $id.split($splitter).length==2;}
function is_node_limam($id){$id=$id||'';return $id.split($splitter).length==3;}
function is_node_empnr($id){$id=$id||'';return $id.split($splitter).length==4;}
function get_id($id){$id=$id||'';$splits=$id.split($splitter);if($split.length>0)
return $splits[$split.length-1];else
return null;}
this.on('itemcontextmenu',function(tree,record,item,index,e,eOpts){e.preventDefault();var id=_this.getSelectedId();if(Ext.isEmpty(id))return;if(is_node_docty(id))
menuDocty.showAt(e.xy);else if(is_node_limam(id))
menuLimit.showAt(e.xy);else if(is_node_empnr(id))
menuUser.showAt(e.xy);});this.editDocAct.setHandler(function(){var id=_this.getSelectedId();if(Ext.isEmpty(id))return;_this.docWindow.openDialog('edit',{id:id,comid:_this.extraParams.comid});});this.addLimitAct.setHandler(function(){var id=_this.getSelectedId();if(Ext.isEmpty(id))return;_this.limitWindow.openDialog('add',{id:id,comid:_this.extraParams.comid});});this.editLimitAct.setHandler(function(){var id=_this.getSelectedId();if(Ext.isEmpty(id))return;_this.limitWindow.openDialog('edit',{id:id,comid:_this.extraParams.comid});});this.removeLimitAct.setHandler(function(){var id=_this.getSelectedId();if(Ext.isEmpty(id))return;_this.limitWindow.openDialog('remove',{id:id,comid:_this.extraParams.comid});});this.addEmp.setHandler(function(){var id=_this.getSelectedId();if(Ext.isEmpty(id))return;_this.userWindow.openDialog('add',{id:id,comid:_this.extraParams.comid});});this.removeEmp.setHandler(function(){var id=_this.getSelectedId();if(Ext.isEmpty(id))return;_this.userWindow.openDialog('remove',{id:id,comid:_this.extraParams.comid});});this.limitWindow.form.on('afterSave',function(form,action){_this.limitWindow.hide();if(form.form_action=='edit'){_this.reloadParentNode();}else
_this.reloadCurrentNode();});this.limitWindow.form.on('afterDelete',function(form,action){_this.reloadParentNode();});this.docWindow.form.on('afterSave',function(form,action){_this.docWindow.hide();_this.reloadParentNode();});this.userWindow.form.on('afterSave',function(form,action){_this.userWindow.hide();if(form.form_action=='edit'){_this.reloadParentNode();}else
_this.reloadCurrentNode();});this.userWindow.form.on('afterDelete',function(form,action){_this.reloadParentNode();});return this.callParent(arguments);},extraParams:null,load:function(params){var _this=this;this.store.load({params:params,callback:function(){_this.expandAll();}});},getSelectedRecord:function(){var sel=this.getSelectionModel(),rs=sel.getSelection();if(Ext.isArray(rs))
return rs[0];else
return null;},getSelectedId:function(){var sel=this.getSelectionModel(),rs=sel.getSelection();if(Ext.isArray(rs))
return rs[0].data.id;else
return null;},reloadCurrentNode:function(){var _this=this;var r=this.getSelectedRecord();this.store.load({node:r,callback:function(){_this.expandAll();}});},reloadParentNode:function(){var _this=this;var r=this.getSelectedRecord();var parentNode=_this.store.getById(r.data.parentId);this.store.load({node:parentNode,callback:function(){_this.expandAll();}});}});;Ext.define('Account.UMSLimit.User.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'ums/loads_user',reader:{type:'json',root:'rows',idProperty:'empnr'},simpleSortMode:true},fields:['empnr','uname','name1'],remoteSort:true,sorters:[{property:'empnr',direction:'ASC'}]});this.columns=[{text:"Code",width:60,dataIndex:'empnr',sortable:true},{text:"Username",width:80,dataIndex:'uname',sortable:true},{text:"Name",width:150,dataIndex:'name1',sortable:true}];this.bbar={xtype:'pagingtoolbar',store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load({params:options});}});;Ext.define('Account.UMSLimit.User.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Choose user',closeAction:'hide',height:320,minHeight:320,width:400,minWidth:400,resizable:true,modal:true,layout:'border',maximizable:true,defaultFocus:'code'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.UMSLimit.User.Grid',{region:'center',border:false});this.items=[this.grid];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Unit.GridItem',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.tbar=[this.addAct,this.deleteAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'unit/loads',reader:{type:'json',root:'rows',idProperty:'id_unit',totalProperty:'totalCount'}},fields:[{name:'id_unit',type:'int'},'meins','metxt'],remoteSort:false,sorters:['id_unit ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{id:'PMiRowNumber23',header:"Unit No",dataIndex:'id_unit',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Unit Code ",width:80,dataIndex:'meins',sortable:true,field:{type:'textfield'},},{text:"Unit Description",width:100,dataIndex:'metxt',sortable:true,field:{type:'textfield'},}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});return this.callParent(arguments);},load:function(options){this.store.load({params:options,proxy:{type:'ajax',url:__site_url+'unit/loads',reader:{type:'json',root:'rows',idProperty:'id_unit'}},fields:[{name:'id_unit',type:'int'},'meins','metxt'],remoteSort:false,sorters:['id_unit ASC']});},addRecord:function(){var newId=-1;var i=0;this.store.each(function(r){i++;if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(i,rec);edit.startEditByPosition({row:i,column:0});this.runNumRow();},save:function(){var _this=this;var r_data=this.getData();Ext.Ajax.request({url:__site_url+'unit/save',method:'POST',params:{unit:Ext.encode(r_data)},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){}else{Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}}});},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();},reset:function(){this.grid.load({meins:0});},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('id_unit',row_num++);});}});;Ext.define('Account.Unit.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Unit',closeAction:'hide',height:700,width:450,layout:'border',resizable:true,modal:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.Unit.GridItem',{region:'center'});this.items=[this.grid];this.buttons=[{text:'Save',handler:function(){Ext.Msg.show({title:"Warning",msg:"Are you sure you want to update item(s) ?",icon:Ext.Msg.WARNING,buttons:Ext.Msg.YESNO,fn:function(bt){if(bt=="yes"){_this.grid.save();}}});}},{text:'Cancel',handler:function(){_this.hide();}}];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Vendor.FormSearch',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.searchAct=new Ext.Action({text:'Search',iconCls:'b-small-search',handler:function(){var formValues=_this.getValues();_this.fireEvent('search_click',formValues);}});this.resetAct=new Ext.Action({text:'Reset',iconCls:'b-small-cross',handler:function(){_this.reset();_this.fireEvent('reset_click');}});this.txtQuery=new Ext.form.TextField({fieldLabel:'Keyword',name:"query",emptyText:'Find from Vendor Code, Vendor Name',labelAlign:'right',listeners:{specialkey:function(o,e){if(e.getKey()==e.ENTER)
_this.searchAct.execute();}}});var statusOptions={fieldLabel:'Status',name:'statu',labelAlign:'right',width:240,editable:false,triggerAction:'all',margin:'0 0 0 6',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'quotation/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu',value:(this.statu)?this.statu:undefined};if(this.status_options){statusOptions=Ext.apply(statusOptions,this.status_options);}
this.comboQStatus=Ext.create('Ext.form.ComboBox',statusOptions);this.items=[{layout:'column',border:false,defaults:{columnWidth:0.5,layout:'form',border:false,xtype:'panel',bodyStyle:'padding:0 18px 0 0'},items:[{defaults:{anchor:'100%'},items:[this.txtQuery,{xtype:'textfield',name:'lifnr',hideLabel:false,fieldLabel:'Vendor Code',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]},{defaults:{anchor:'100%'},items:[this.comboQStatus,{xtype:'textfield',name:'lifnr2',hideLabel:false,fieldLabel:'To',labelAlign:'right',format:'d/m/Y',altFormats:'Y-m-d|d/m/Y',submitFormat:'Y-m-d'}]}]}];this.buttons=[this.searchAct,this.resetAct];return this.callParent(arguments);},getValues:function(){return this.getForm().getValues();},reset:function(){this.getForm().reset();}});;Ext.define('Account.Vendor.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'vendor/loads',reader:{type:'json',root:'rows',idProperty:'lifnr',totalProperty:'totalCount'},simpleSortMode:true},fields:['lifnr','name1','adr01','distx','pstlz','telf1','telfx','email','pson1','statx'],remoteSort:true,sorters:[{property:'lifnr',direction:'ASC'}]});this.columns=[{text:"Vendor Code",width:90,dataIndex:'lifnr',sortable:true},{text:"Name",width:150,dataIndex:'name1',sortable:true},{text:"Address",width:200,dataIndex:'adr01',sortable:true},{text:"District",flex:true,dataIndex:'distx',sortable:true},{text:"Post Code",width:60,dataIndex:'pstlz',sortable:true},{text:"Telephon",flex:true,dataIndex:'telf1',sortable:true},{text:"Fax No",flex:true,dataIndex:'telfx',sortable:true},{text:"Email",width:120,dataIndex:'email',sortable:true},{text:"Contact Person",flex:true,dataIndex:'pson1',sortable:true},{text:"Status",width:100,dataIndex:'statx',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Vendor.Import.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{border:false,bodyStyle:'padding:5px 0px 5px 0px;',labelWidth:80,buttonAlign:'center',border:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.uploadAct=new Ext.Action({text:'Upload',iconCls:'b-small-save'});this.items=[{xtype:'filefield',name:'userfile',fieldLabel:'Excel file',labelAlign:'right',msgTarget:'side',allowBlank:false,anchor:'70%',buttonText:'Select Excel file...',allowBlank:false}];this.buttons=[this.uploadAct];this.uploadAct.setHandler(function(){_this.save();});return this.callParent(arguments);},save:function(){var _this=this,form=this.getForm();if(form.isValid()){_this.fireEvent('upload_click');form.submit({url:__site_url+'import/upload/do_upload',waitMsg:'Uploading excel file...',success:function(form,action){_this.fireEvent('upload_success',action.result.file);},failure:function(form,action){Ext.Msg.show({title:'An error occured.',msg:action.result.msg.error,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});}},reset:function(){this.getForm().reset();}});;Ext.define('Account.Vendor.Import.Grid',{extend:'Ext.grid.Panel',constructor:function(config){Ext.apply(this,{viewConfig:{getRowClass:function(r,rowIndex,rowParams,store){var s=r.get('error');if(s&&s.length>0)
return'red-bg-row';}},buttonAlign:'center'});return this.callParent(arguments);},initComponent:function(){var _this=this;this.importAct=new Ext.Action({text:'Import',iconCls:'b-small-save'});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"import/vendor/read",reader:{type:'json',root:'rows',idProperty:'row_id'},simpleSortMode:true},fields:['row_id','lifnr','vtype','name1','adr01','distx','cunty','pstlz','telf1','telfx','email','pson1','disct','apamt','begin','endin','ptype','terms','taxnr','vat01','taxid','saknr','note1','statu','error'],remoteSort:false});this.columns=[{xtype:'actioncolumn',text:" ",width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{text:"Vendor Code",width:100,align:'center',dataIndex:'lifnr',sortable:false},{text:"Vendor Name",width:150,align:'center',dataIndex:'name1',sortable:false},{text:"Address",width:200,align:'center',dataIndex:'adr01',sortable:false},{text:"Province",width:80,align:'center',dataIndex:'distx',sortable:false},{text:"Post Code",width:80,align:'center',dataIndex:'pstlz',sortable:false},{text:"GL Number",width:80,align:'center',dataIndex:'saknr',sortable:false},{text:"Email",width:100,align:'center',dataIndex:'email',sortable:false},{text:"Error",width:250,dataIndex:'error',sortable:false,renderer:function(v,p,r){return(v&&v.length>0)?v:'-';}}];this.buttons=[this.importAct];this.importAct.setHandler(function(){_this.importData();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},showMask:function(msg,msgClass){msg=msg||'Please select excel file for upload.';msgClass=msgClass||'grid-disable';this.importAct.setDisabled(true);this.getEl().mask(msg,msgClass);},hideMask:function(){this.importAct.setDisabled(false);this.getEl().unmask();},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);this.runNumRow();grid.getSelectionModel().deselectAll();},importData:function(){var _this=this;var rs=[];this.store.each(function(r){rs.push(r.getData());});if(rs.length>0){this.showMask('Importing please wait','');var data_json=Ext.encode(rs);Ext.Ajax.request({url:__site_url+'import/vendor/import',params:{data:data_json},success:function(response){var text=response.responseText;var data=Ext.decode(text);if(data.success){Ext.Msg.show({title:'Import success.',msg:'Import '+data.rows.length+' rows success.',buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO});_this.fireEvent('import_success',data);}else{_this.hideMask();Ext.Msg.show({title:'An error occured.',msg:response,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}},failure:function(response){Ext.Msg.show({title:'An error occured.',msg:response.responseText,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});}else{Ext.Msg.alert('Status','No datas to import.');}}});;Ext.define('Account.Vendor.Import.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Vendor Import',closeAction:'hide',height:600,minHeight:480,width:1000,minWidth:600,resizable:true,modal:true,layout:'border',maximizable:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Vendor.Import.Form',{region:'north',height:80});this.grid=Ext.create('Account.Vendor.Import.Grid',{region:'center',disbled:true});this.items=[this.form,this.grid];this.form.on('upload_success',function(file_name){_this.grid.hideMask();_this.grid.load({file:file_name});});return this.callParent(arguments);},openDialog:function(){this.form.reset();this.grid.store.removeAll();this.show(false,function(){this.grid.showMask();});}});;Ext.define('Account.Vendor.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'vendor/save',border:false,fieldDefaults:{msgTarget:'side',labelWidth:120,}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.distrDialog=Ext.create('Account.SDistrict.MainWindow');this.trigDistr=Ext.create('Ext.form.field.Trigger',{name:'distx',fieldLabel:'Province',triggerCls:'x-form-search-trigger',enableKeyEvents:true,labelWidth:110,width:290,});this.trigDistr.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'sdistrict/loads',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.trigDistr.setValue(record.data.distx);}else{o.markInvalid('Could not find Province : '+o.getValue());}}});}},this);_this.distrDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigDistr.setValue(record.data.distx);grid.getSelectionModel().deselectAll();_this.distrDialog.hide();});this.trigDistr.onTriggerClick=function(){_this.distrDialog.show();};this.vtypDialog=Ext.create('Account.Vendortype.Window');this.trigVtyp=Ext.create('Ext.form.field.Trigger',{name:'ventx',fieldLabel:'Vendor Type',triggerCls:'x-form-search-trigger',enableKeyEvents:true,allowBlank:false,width:290,});this.trigVtyp.on('keyup',function(o,e){var v=o.getValue();if(Ext.isEmpty(v))return;if(e.getKey()==e.ENTER){Ext.Ajax.request({url:__site_url+'vendortype/load',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){_this.trigVtyp.setValue(record.data.ventx);_this.getForm().findField('vtype').setValue(record.data.vtype);_this.getForm().findField('saknr').setValue(record.data.saknr);_this.getForm().findField('sgtxt').setValue(record.data.sgtxt);}else{o.markInvalid('Could not find vendor type : '+o.getValue());}}});}},this);_this.vtypDialog.grid.on('beforeitemdblclick',function(grid,record,item){_this.trigVtyp.setValue(record.data.ventx);_this.getForm().findField('vtype').setValue(record.data.vtype);_this.getForm().findField('saknr').setValue(record.data.saknr);_this.getForm().findField('sgtxt').setValue(record.data.sgtxt);grid.getSelectionModel().deselectAll();_this.vtypDialog.hide();});this.trigVtyp.onTriggerClick=function(){_this.vtypDialog.grid.load();_this.vtypDialog.show();};this.comboQStatus=Ext.create('Ext.form.ComboBox',{readOnly:!UMS.CAN.APPROVE('VD'),fieldLabel:'Vendor Status',name:'statu',labelAlign:'right',editable:false,allowBlank:false,triggerAction:'all',margin:'0 0 0 56',clearFilterOnReset:true,emptyText:'-- Select Status --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'customer/loads_acombo',reader:{type:'json',root:'rows',idProperty:'statu'}},fields:['statu','statx'],remoteSort:true,sorters:'statu ASC'}),queryMode:'remote',displayField:'statx',valueField:'statu'});this.comboPay=Ext.create('Ext.form.ComboBox',{fieldLabel:'Payment type',name:'ptype',width:290,editable:false,allowBlank:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Select Payments --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'customer/loads_tcombo',reader:{type:'json',root:'rows',idProperty:'ptype'}},fields:['ptype','paytx'],remoteSort:true,sorters:'ptype ASC'}),queryMode:'remote',displayField:'paytx',valueField:'ptype'});this.comboTax=Ext.create('Ext.form.ComboBox',{fieldLabel:'Vat Type',name:'taxnr',width:290,labelWidth:120,editable:false,triggerAction:'all',clearFilterOnReset:true,emptyText:'-- Please select Type --',store:new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'vendor/loads_combo/tax1/taxnr/taxtx',reader:{type:'json',root:'rows',idProperty:'taxnr'}},fields:['taxnr','taxtx'],remoteSort:true,sorters:'taxnr ASC'}),queryMode:'remote',displayField:'taxtx',valueField:'taxnr'});this.numberCredit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Terms',name:'terms',labelAlign:'right',width:200,hideTrigger:false,allowBlank:false,minValue:0,align:'right',margin:'0 0 0 56'});this.numberDiscount=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Discount Amount',name:'disct',labelAlign:'left',minValue:0,width:290,hideTrigger:false});this.numberLimit=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Credit Limit Amt',name:'apamt',labelAlign:'right',hideTrigger:false,allowBlank:false,minValue:0,align:'right',margin:'0 0 0 56'});this.numberMin=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Minimum Amount',name:'begin',labelAlign:'left',allowBlank:false,minValue:0,width:290,hideTrigger:false});this.numberMax=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Maximum Amount',name:'endin',labelAlign:'right',allowBlank:false,minValue:0,hideTrigger:false,align:'right',margin:'0 0 0 56'});this.numberVat=Ext.create('Ext.ux.form.NumericField',{fieldLabel:'Vat Value',name:'vat01',labelAlign:'right',hideTrigger:false,minValue:0,align:'right',margin:'0 0 0 56'});this.items=[{xtype:'hidden',name:'id'},{xtype:'hidden',name:'vtype'},{items:[{xtype:'container',layout:'anchor',margin:'10',items:[{xtype:'container',flex:1,layout:'hbox',padding:2,items:[this.trigVtyp,{},{xtype:'displayfield',fieldLabel:'Vendor Code',name:'lifnr',emptyText:'XXXXX',labelAlign:'right',readOnly:true,width:160,margin:'0 0 0 60',value:'XXXXX',labelStyle:'font-weight:bold'}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',fieldLabel:'Vendor Name',name:'name1',allowBlank:false,width:470}]},{xtype:'fieldset',title:'Address',items:[{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textarea',fieldLabel:'Address',name:'adr01',allowBlank:false,labelWidth:110,width:460}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[this.trigDistr,{},{xtype:'textfield',fieldLabel:'Post Code',name:'pstlz',emptyText:'xxxxx',labelAlign:'right',maskRe:/[\d\-]/,regex:/^\d{5}$/,regexText:'Must be in the format xxxxx',margin:'0 0 0 43'}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',fieldLabel:'Phone Number',name:'telf1',labelWidth:110,width:290,emptyText:'xxx-xxxxxxx',maskRe:/[\d\-]/,},{xtype:'textfield',fieldLabel:'Fax Number',name:'telfx',labelAlign:'right',margin:'0 0 0 46'}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',fieldLabel:'Email',name:'email',labelWidth:110,width:460},{}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',fieldLabel:'Contact Person',name:'pson1',labelWidth:110,width:460},{}]}],},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[this.numberDiscount,this.numberLimit]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[this.numberMin,this.numberMax]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[this.comboPay,this.numberCredit,{xtype:'displayfield',margin:'0 0 0 5',width:25,value:'Days'}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[this.comboTax,this.numberVat]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',fieldLabel:'Tax ID',name:'taxid',allowBlank:false,emptyText:'xxxxxxxxxxxxx',maskRe:/[\d\-]/,regex:/^\d{13}$/,width:290},this.comboQStatus]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textfield',name:'saknr',fieldLabel:'GL Account',redOnly:true,allowBlank:false,width:290},{xtype:'displayfield',name:'sgtxt',margins:'0 0 0 6',width:286}]},{xtype:'container',flex:1,layout:'hbox',padding:2,items:[{xtype:'textarea',fieldLabel:'Text Note',name:'note1',allowBlank:true,width:470}]}]}]}];this.comboTax.on('select',this.selectTax,this);return this.callParent(arguments);},load:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'vendor/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},reset:function(){this.getForm().reset();this.comboQStatus.setValue('01');},remove:function(lifnr){var _this=this;this.getForm().load({params:{lifnr:lifnr},url:__site_url+'vendor/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});},selectTax:function(combo,record,index){var _this=this;if(combo.getValue()=='03'||combo.getValue()=='04'){this.numberVat.setValue(0);this.numberVat.disable();}else{this.numberVat.enable();}}});;Ext.define('Account.Vendor.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Vendor',closeAction:'hide',height:600,width:660,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Vendor.Item.Form');this.items=this.form;this.buttons=[{text:'Save',disabled:!(UMS.CAN.CREATE('VD')||UMS.CAN.EDIT('VD')),handler:function(){_this.form.save();}},{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}}];return this.callParent(arguments);},dialogId:null,openDialog:function(id){if(id){this.dialogId=id;this.show(false);this.show();this.form.load(id);}else{this.dialogId=null;this.form.reset();this.show(false);}}});;Ext.define('Account.Vendor.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Vendor Management',closeAction:'hide',height:580,minHeight:580,width:1050,minWidth:1000,resizable:true,modal:true,layout:'border',maximizable:true,defaultFocus:'code'});return this.callParent(arguments);},initComponent:function(){var _this=this;var fibasic=Ext.create('Ext.form.field.File',{width:200,x:50,y:50,hideLabel:true});this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus',disabled:!UMS.CAN.CREATE('VD')});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil',disabled:!(UMS.CAN.DISPLAY('VD')||UMS.CAN.CREATE('VD')||UMS.CAN.EDIT('VD'))});this.deleteAct=new Ext.Action({text:'Delete',disabled:true,iconCls:'b-small-minus',disabled:!UMS.CAN.DELETE('VD')});this.excelAct=new Ext.Action({text:'Excel',iconCls:'b-small-excel',disable:!UMS.CAN.EXPORT('VD')});this.importAct=new Ext.Action({text:'Import',iconCls:'b-small-import'});this.itemDialog=Ext.create('Account.Vendor.Item.Window');this.importDialog=Ext.create('Account.Vendor.Import.Window');this.grid=Ext.create('Account.Vendor.Grid',{region:'center',border:false,tbar:[this.addAct,this.editAct,this.deleteAct,this.excelAct,this.importAct]});var searchOptions={region:'north',height:100};if(this.isApproveOnly){searchOptions.status_options={value:'02',readOnly:true};}
this.searchForm=Ext.create('Account.Vendor.FormSearch',searchOptions);this.items=[this.searchForm,this.grid];this.addAct.setHandler(function(){_this.itemDialog.openDialog();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.openDialog(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.importAct.setHandler(function(){_this.importDialog.openDialog();});this.itemDialog.form.on('afterSave',function(form){_this.itemDialog.hide();_this.grid.load();});this.itemDialog.form.on('afterDelete',function(form){_this.grid.load();});this.searchForm.on('search_click',function(values){_this.grid.load();});this.searchForm.on('reset_click',function(values){_this.grid.load();});this.grid.store.on("beforeload",function(store,opts){opts.params=opts.params||{};if(opts.params){var formValues=_this.searchForm.getValues();Ext.apply(opts.params,formValues);}});if(!this.disableGridDoubleClick){this.grid.getView().on('itemdblclick',function(grid,record,item,index){_this.editAct.execute();});}
this.excelAct.setHandler(function(){var params=_this.searchForm.getValues(),sorters=(_this.grid.store.sorters&&_this.grid.store.sorters.length)?_this.grid.store.sorters.items[0]:{};params=Ext.apply({sort:sorters.property,dir:sorters.direction},params);query=Ext.urlEncode(params);window.location=__site_url+'export/vendor/index?'+query;});this.importDialog.grid.on('import_success',function(){_this.importDialog.hide();_this.grid.load();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Vendortype.GridItem',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.glnoDialog=Ext.create('Account.GL.MainWindow');this.tbar=[this.addAct,this.deleteAct];this.editing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'vendortype/loads',reader:{type:'json',root:'rows',idProperty:'id_vtype',totalProperty:'totalCount'}},fields:[{name:'id_vtype',type:'int'},'vtype','ventx','saknr','sgtxt'],remoteSort:false,sorters:['id_vtype ASC']});this.columns=[{xtype:'actioncolumn',width:30,sortable:false,menuDisabled:true,items:[{icon:__base_url+'assets/images/icons/bin.gif',tooltip:'Delete Item',scope:this,handler:this.removeRecord}]},{id:'PMiRowNumber01',header:"No",dataIndex:'id_vtype',width:60,align:'center',resizable:false,sortable:false,renderer:function(value,metaData,record,rowIndex){return rowIndex+1;}},{text:"Vendor Type",width:80,dataIndex:'vtype',sortable:true,field:{type:'textfield'},},{text:"Type Description",width:100,dataIndex:'ventx',sortable:true,field:{type:'textfield'},},{text:"GL no",flex:true,dataIndex:'saknr',sortable:true,field:{xtype:'triggerfield',enableKeyEvents:true,allowBlank:false,triggerCls:'x-form-search-trigger',onTriggerClick:function(){_this.editing.completeEdit();_this.glnoDialog.show();}},sortable:false},{text:"GL Description",width:100,dataIndex:'sgtxt',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};this.plugins=[this.editing];this.addAct.setHandler(function(){_this.addRecord();});this.editing.on('edit',function(editor,e){if(e.column.dataIndex=='saknr'){var v=e.value;if(Ext.isEmpty(v))return;Ext.Ajax.request({url:__site_url+'sglAccount/loads',method:'POST',params:{id:v},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){var rModel=_this.store.getById(e.record.data.id);rModel.set(e.field,r.data.saknr);rModel.set('sgtxt',r.data.sgtxt);}else{_this.editing.startEdit(e.record,e.column);}}});}});_this.glnoDialog.grid.on('beforeitemdblclick',function(grid,record,item){var rModels=_this.getView().getSelectionModel().getSelection();if(rModels.length>0){rModel=rModels[0];rModel.set('saknr',record.data.saknr);rModel.set('sgtxt',record.data.sgtxt);}
grid.getSelectionModel().deselectAll();_this.glnoDialog.hide();});return this.callParent(arguments);},load:function(options){this.store.load({params:options});},save:function(){var _this=this;var r_data=this.getData();Ext.Ajax.request({url:__site_url+'vendortype/save',method:'POST',params:{ktyp:Ext.encode(r_data)},success:function(response){var r=Ext.decode(response.responseText);if(r&&r.success){}else{Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}}});},addRecord:function(){var newId=-1;var i=0;this.store.each(function(r){i++;if(r.get('id')<newId)
newId=r.get('id');});newId--;rec={id:newId};edit=this.editing;edit.cancelEdit();var sel=this.getView().getSelectionModel().getSelection()[0];var selIndex=this.store.indexOf(sel);this.store.insert(i,rec);edit.startEditByPosition({row:i,column:0});this.runNumRow();},removeRecord:function(grid,rowIndex){this.store.removeAt(rowIndex);},getData:function(){var rs=[];this.store.each(function(r){rs.push(r.getData());});return rs;},runNumRow:function(){var row_num=0;this.store.each(function(r){r.set('id_vtype',row_num++);});},});;Ext.define('Account.Vendortype.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Vendor Type',closeAction:'hide',height:420,width:450,layout:'border',resizable:true,modal:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.Vendortype.GridItem',{region:'center'});this.items=[this.form,this.grid];this.buttons=[{text:'Save',handler:function(){Ext.Msg.show({title:"Warning",msg:"Are you sure you want to update item(s) ?",icon:Ext.Msg.WARNING,buttons:Ext.Msg.YESNO,fn:function(bt){if(bt=="yes"){_this.grid.save();}}});}},{text:'Cancel',handler:function(){_this.hide();}}];this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.Warehouse.Grid',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+"warehouse/loads",reader:{type:'json',root:'rows',idProperty:'warnr',totalProperty:'totalCount'}},fields:['warnr','watxt'],remoteSort:true,sorters:['warnr ASC']});this.columns=[{text:"Warehouse Code",width:120,dataIndex:'warnr',sortable:true},{text:"Warehouse Name",width:120,dataIndex:'watxt',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.Warehouse.Item.Form',{extend:'Ext.form.Panel',constructor:function(config){Ext.apply(this,{url:__site_url+'warehouse/save',border:false,bodyPadding:10,fieldDefaults:{labelAlign:'right',labelWidth:100,width:300,labelStyle:'font-weight:bold'}});return this.callParent(arguments);},initComponent:function(){var _this=this;this.items=[{xtype:'hidden',name:'id'},{xtype:'textfield',fieldLabel:'warnr',name:'warnr',allowBlank:false},{xtype:'textfield',fieldLabel:'watxt',name:'watxt',allowBlank:false}];return this.callParent(arguments);},load:function(id){this.getForm().load({params:{id:id},url:__site_url+'warehouse/load'});},save:function(){var _this=this;var _form_basic=this.getForm();if(_form_basic.isValid()){_form_basic.submit({success:function(form_basic,action){form_basic.reset();_this.fireEvent('afterSave',_this);},failure:function(form_basic,action){Ext.Msg.alert('Failed',action.result?action.result.message:'No response');}});}},remove:function(id){var _this=this;this.getForm().load({params:{id:id},url:__site_url+'warehouse/remove',success:function(res){_this.fireEvent('afterDelete',_this);}});}});;Ext.define('Account.Warehouse.Item.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Create/Edit Warehouse',closeAction:'hide',height:500,width:400,layout:'border',resizable:true,modal:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.form=Ext.create('Account.Warehouse.Item.Form',{region:'north'});this.grid=Ext.create('Account.Warehouse.Grid',{title:'grid 1'});this.grid2=Ext.create('Account.Warehouse.Grid',{border:false,region:'center'});this.formTotal=Ext.create('Account.Warehouse.Item.Form',{border:false,split:true,region:'south'});this.items=[this.form,{xtype:'tabpanel',region:'center',activeTab:0,items:[this.grid,{xtype:'panel',border:false,title:'grid2',layout:'border',items:[this.grid2,this.formTotal]}]}];this.buttons=[{text:'Cancel',handler:function(){_this.form.getForm().reset();_this.hide();}},{text:'Save',handler:function(){_this.form.save();}}];return this.callParent(arguments);}});;Ext.define('Account.Warehouse.MainWindow',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'Warehouse management',closeAction:'hide',height:380,minHeight:380,width:500,minWidth:500,resizable:true,modal:true,layout:'border',maximizable:true});return this.callParent(arguments);},initComponent:function(){var _this=this;this.addAct=new Ext.Action({text:'Add',iconCls:'b-small-plus'});this.editAct=new Ext.Action({text:'Edit',iconCls:'b-small-pencil'});this.deleteAct=new Ext.Action({text:'Delete',iconCls:'b-small-minus'});this.tbar=[this.addAct,this.editAct,this.deleteAct];this.grid=Ext.create('Account.Warehouse.Grid',{region:'center',border:false});this.itemDialog=Ext.create('Account.Warehouse.Item.Window');this.items=[this.grid];this.addAct.setHandler(function(){_this.itemDialog.show();});this.editAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.show();_this.itemDialog.form.load(id);}});this.deleteAct.setHandler(function(){var sel=_this.grid.getView().getSelectionModel().getSelection()[0];var id=sel.data[sel.idField.name];if(id){_this.itemDialog.form.remove(id);}});this.itemDialog.form.on('afterSave',function(){_this.itemDialog.hide();_this.grid.load();});this.itemDialog.form.on('afterDelete',function(){_this.grid.load();});this.grid.load();return this.callParent(arguments);}});;Ext.define('Account.WHT.GridItem',{extend:'Ext.grid.Panel',constructor:function(config){return this.callParent(arguments);},initComponent:function(){this.store=new Ext.data.JsonStore({proxy:{type:'ajax',url:__site_url+'invoice/loads_wht',reader:{type:'json',root:'rows',idProperty:'whtnr',totalProperty:'totalCount'}},fields:['whtnr','whtxt','whtpr'],remoteSort:true,sorters:['whtnr ASC']});this.columns=[{text:"WHT No",align:'center',width:80,dataIndex:'whtnr',sortable:true},{text:"WHT Description",flex:true,dataIndex:'whtxt',sortable:true},{text:"WHT Value",flex:true,dataIndex:'whtpr',sortable:true}];this.bbar={xtype:'pagingtoolbar',pageSize:10,store:this.store,displayInfo:true};return this.callParent(arguments);},load:function(options){this.store.load(options);}});;Ext.define('Account.WHT.Window',{extend:'Ext.window.Window',constructor:function(config){Ext.apply(this,{title:'WHT Search Help',closeAction:'hide',height:420,width:450,layout:'border',resizable:true,modal:true,border:false});return this.callParent(arguments);},initComponent:function(){var _this=this;this.grid=Ext.create('Account.WHT.GridItem',{region:'center'});this.items=[this.grid];this.grid.load();return this.callParent(arguments);}});